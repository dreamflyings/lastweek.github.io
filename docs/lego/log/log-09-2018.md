# Sep 2018

## Sep 07

Set up Infiniswap again. What a fucking crap code, and crash the kernel out of nowhere. crap crap crap.

Hmm, Linux will tune the CPU freq during runtime, will be higher than 2.4GHz. So disable it, make it a fair comparison with Lego.

`intel_pstate=disable.`


### swap-to-ssd
```
echo 3 > /proc/sys/vm/drop_caches
rm -rf /tmp/mnist_model/
lxc-execute -n test -s lxc.cgroup.memory.limit_in_bytes=128M -- python mnist.py
```

### swap-to-ramdisk
```
modprobe brd rd_size=16777216
dd if=/dev/zero of=/dev/ram0 bs=4K
mkswap /dev/ram0
swapon /dev/ram0
swapoff others
```
Q: difference between this BLK_DEV_RAM (RAM block device)?

## Sep 06

Did two optimizations on pcache, both are buffer management.
Especially the pcache rmap case. In both opts, we kind of use static/pre-allocated array to serve dynamic allocation.

This is a better solution than using kmem_cache, faster. kmem_cache will be a more general solution here.

kmem_cache, FIFO queue (thpool buffer), static preallocated array (rmap, clflush)... Buffer management is really a very important thing in system building. I should be aware at the beginning next time.

These changes are in commits:
```
6e0cf6c5c64edbe445a27cf55f86ac51f8a897b3
73377cafce95ffa0cfb155f77cac97456a5e4a71
```

## Sep 05

Alright. Besides some flaws/bugs in some kfree stuff, LegoOS now actually is very robust! Ran a quick git summary:

```
 project  : LegoOS
 repo age : 1 year, 11 months
 active   : 358 days
 commits  : 1540
 files    : 1161
 authors  :
  1317	Yizhou Shan                  85.5%
   120	root                         7.8%
    36	hythzz                       2.3%
    27	yilun                        1.8%
    16	Yutong Huang                 1.0%
    10	Build Android                0.6%
     8	Yiying Zhang                 0.5%
     4	sumukh1991                   0.3%
     1	Yizhou SHan                  0.1%
     1	Sumukh Hallymysore Ravindra  0.1%
```

Of course, there are still PLENY room for improvement, and I know where. At this time, I really think we need something like kmem_cache, which is so fucking useful. It can probably further reduce much overhead.

## Sep 04

Trying the perset eviction list mechanism, instead of victim cache. The benefit of using this is: we will no longer be bottelnecked by victim cache anymore. Each faulting thread will do eviction/flush within its own context.

For 4 threads MNIST, I saw 3 seconds reduction.

Removed the bitmap, use per pcache set counter for quick reference.

## Sep 03


With DEBUG_MM, try enable HAVE_FREE directory by directory

-
-
-

update_wall_time+0x44 is where we call tsc_read. And this has been called many times (HZ per second). All of a sudden, the pointer got crashed. Who wrote to this code memory?? Remote RDMA?
```c
[ 1052.470714] general protection fault: 0000 [#1] SMP PROCESSOR
[ 1052.477113] CPU: 0 PID: 15 Comm: ib_mad1 4.0.0-lego+ #509
[ 1052.483125] RIP: 0010:[<ffffffff81015764>]  [<ffffffff81015764>] update_wall_time+0x44/0x6f0
[ 1052.492530] RSP: 0000:ffff88103ad9fc88  EFLAGS: 00010046
[ 1052.498445] RAX: 4510ffffffff8118 RBX: 0380ffffffffffff RCX: 0000000000000001
[ 1052.506396] RDX: ffff88103ad9fd28 RSI: 0000000000000000 RDI: 4510ffffffff8118
[ 1052.514346] RBP: ffff88103ad9fcd0 R08: 000000000000001f R09: 0000000000000000
[ 1052.522298] R10: 0000000000000029 R11: ffff881013f8e130 R12: aaff0000024a2677
[ 1052.530248] R13: 0000000000000000 R14: ffff88103ad85228 R15: ffff88103ae0c000
[ 1052.538199] FS:  0000000000000000(0000) GS:ffff88107fc00000(0000) knlGS:0000000000000000
[ 1052.547216] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 1052.553616] CR2: 0000000000000000 CR3: 000000000117b000 CR4: 00000000000406b0
[ 1052.561567] Stack:
[ 1052.563797] 0000000000000086 ffff88107fc05d80 ffff88103ad85000 0000000000000000
[ 1052.571941] ffff88107fc04980 0000000000000000 0000000000000000 ffff88103ad85228
[ 1052.580085] ffff88103ae0c000 ffff88103ad9fce8 ffffffff81017557 000000003ad9fe10
[ 1052.588230] ffff88103ad9fd10 ffffffff810067a4 ffffffff81088040 ffff88107fc05d80
[ 1052.596375] ffff88103ad85000 ffff88103ad9fdf8 ffffffff8100e8ea ffff88103ad9fd28
[ 1052.604520] Call Trace:
[ 1052.607236] <TSK>
[ 1052.609368] [<ffffffff81017557>] tick_handle_periodic+0x67/0x70
[ 1052.615961] [<ffffffff810067a4>] apic_timer_interrupt+0x54/0x90
[ 1052.622555] [<ffffffff8100e8ea>] smp__apic_timer_interrupt+0x6a/0x70
[ 1052.629633] [<ffffffff8107b488>] ? __schedule+0xf8/0x1e0
[ 1052.635548] [<ffffffff8107b583>] schedule+0x13/0x30
[ 1052.640978] [<ffffffff8106c98e>] ib_mad_completion_handler+0x5de/0xc20
[ 1052.648250] [<ffffffff8101de3b>] ? dequeue_task_rt+0x1b/0x180
[ 1052.654648] [<ffffffff8106c3b0>] ? ib_mad_send_done_handler.isra.22+0x4e0/0x4e0
[ 1052.662793] [<ffffffff81022af6>] kthread+0xf6/0x110
[ 1052.668223] [<ffffffff81022a00>] ? __kthread_parkme+0x70/0x70
[ 1052.674622] [<ffffffff8100eb72>] ret_from_fork+0x22/0x30
[ 1052.680538] <EOT>
[ 1052.682670] Code: db e4 16 00 79 0d f3 90 80 3d d0 e4 16 00 00 7e f5 eb ea 48 8b 1d fd fa 1f 00 48 8b 05 e6 fa 1f 00 4c 8b 25 f7 fa 1f 00 48 89 c7 <ff> 50 28 49 89 c7 48 89 d8 4d 29 e7 48 d1 e8 49 21 df 48 f7 d0
[ 1052.703711] RIP  [<ffffffff81015764>] update_wall_time+0x44/0x6f0
[ 1052.710498]  RSP <ffff88103ad9fc88>

```
