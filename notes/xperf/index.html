



<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
        <link rel="canonical" href="http://lastweek.io/notes/xperf/">
      
      
        <meta name="author" content="Yizhou Shan">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-0.17.2, mkdocs-material-2.6.2">
    
    
      
        <title>Measure-x86-Ring-Switch-Overhead - Yizhou Shan's Home Page</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.9b572555.css">
      
    
    
      <script src="../../assets/javascripts/modernizr.1aa3b519.js"></script>
    
    
      
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,400i,700|">
        <style>body,input{font-family:"Open Sans","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="search">
    <label class="md-overlay" data-md-component="overlay" for="drawer"></label>
    
      <a href="#x86-ring-switch-overhead-page-fault-version" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="http://lastweek.io" title="Yizhou Shan's Home Page" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                Yizhou Shan's Home Page
              </span>
              <span class="md-header-nav__topic">
                Measure-x86-Ring-Switch-Overhead
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="drawer">
    <span class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </span>
    Yizhou Shan's Home Page
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Blog
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Blog
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../blog/20200404-on-read-once/" title="2020-04 On-Read-Once-and-Compiler-Opts" class="md-nav__link">
      2020-04 On-Read-Once-and-Compiler-Opts
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../blog/20200404-on-net-transport/" title="2020-04 On-Hardware-based-Network-Transport" class="md-nav__link">
      2020-04 On-Hardware-based-Network-Transport
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      Notes
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Notes
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../source_code/" title="Open-Source-Code-Study" class="md-nav__link">
      Open-Source-Code-Study
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../program_advice/" title="Programming-Guidelines-and-Advice" class="md-nav__link">
      Programming-Guidelines-and-Advice
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../virt/" title="Virtualization-Software" class="md-nav__link">
      Virtualization-Software
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../cache_coherence/" title="Practical-Cache-Coherence" class="md-nav__link">
      Practical-Cache-Coherence
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="toc">
        Measure-x86-Ring-Switch-Overhead
      </label>
    
    <a href="./" title="Measure-x86-Ring-Switch-Overhead" class="md-nav__link md-nav__link--active">
      Measure-x86-Ring-Switch-Overhead
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#numbers" title="Numbers" class="md-nav__link">
    Numbers
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mechanisms" title="Mechanisms" class="md-nav__link">
    Mechanisms
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#files-changed" title="Files changed" class="md-nav__link">
    Files changed
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#user-to-kernel-u2k" title="User to kernel (u2k)" class="md-nav__link">
    User to kernel (u2k)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kernel-to-user-k2u" title="Kernel to user (k2u)" class="md-nav__link">
    Kernel to user (k2u)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xperfxperfc" title="xperf/xperf.c" class="md-nav__link">
    xperf/xperf.c
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tsc-measurement" title="TSC Measurement" class="md-nav__link">
    TSC Measurement
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#misc" title="Misc" class="md-nav__link">
    Misc
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#howto-run" title="HOWTO Run" class="md-nav__link">
    HOWTO Run
  </a>
  
</li>
      
      
      
      
      
        <li class="md-nav__item">
          <a href="#__comments" title="Comments" class="md-nav__link md-nav__link--active">
            Comments
          </a>
        </li>
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../paper_perf_shadows/" title="Performance-Shadows" class="md-nav__link">
      Performance-Shadows
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../rmap/" title="Linux Reverse Map (rmap)" class="md-nav__link">
      Linux Reverse Map (rmap)
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../userfaultfd/" title="Linux Userfaultfd" class="md-nav__link">
      Linux Userfaultfd
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../trace/" title="Linux Trace/Profile" class="md-nav__link">
      Linux Trace/Profile
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../cgroup-swap/" title="Linux Cgroup and Swap" class="md-nav__link">
      Linux Cgroup and Swap
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../proc/" title="Linux Special Files" class="md-nav__link">
      Linux Special Files
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../linux-resource/" title="Linux Resource" class="md-nav__link">
      Linux Resource
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../kvm-basic/" title="Linux KVM" class="md-nav__link">
      Linux KVM
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../misc/essential/" title="Essential" class="md-nav__link">
      Essential
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../benchmark/" title="Benchmarks" class="md-nav__link">
      Benchmarks
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../misc/cheatsheet/" title="Cheatsheet" class="md-nav__link">
      Cheatsheet
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      FPGA
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        FPGA
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../paper_fpga/" title="Papers" class="md-nav__link">
      Papers
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../fpga/bitstream/" title="Bitstream Explained" class="md-nav__link">
      Bitstream Explained
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../fpga/pr/" title="Morphous PR" class="md-nav__link">
      Morphous PR
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../fpga/vivado/" title="Vivado Practice" class="md-nav__link">
      Vivado Practice
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../fpga/hls_axi/" title="Efficient AXI-MM" class="md-nav__link">
      Efficient AXI-MM
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      LegoOS
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        LegoOS
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-1" type="checkbox" id="nav-5-1">
    
    <label class="md-nav__link" for="nav-5-1">
      Kernel
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-1">
        Kernel
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/kernel/boot/" title="GRUB2 and Boot" class="md-nav__link">
      GRUB2 and Boot
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/kernel/kconfig/" title="Kconfig" class="md-nav__link">
      Kconfig
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/kernel/debug/" title="Debug" class="md-nav__link">
      Debug
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/kernel/grub/" title="GRUB" class="md-nav__link">
      GRUB
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/kernel/profile/" title="Profile" class="md-nav__link">
      Profile
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/kernel/profile_strace/" title="Profile strace" class="md-nav__link">
      Profile strace
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/kernel/profile_heatmap/" title="Profile heatmap" class="md-nav__link">
      Profile heatmap
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/kernel/profile_points/" title="Profile points" class="md-nav__link">
      Profile points
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/kernel/trampoline/" title="Trampoline" class="md-nav__link">
      Trampoline
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/kernel/pagefault_disable/" title="Disable pgfault" class="md-nav__link">
      Disable pgfault
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/kernel/stop_machine/" title="Stop machine" class="md-nav__link">
      Stop machine
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/kernel/loader/" title="Program Loader" class="md-nav__link">
      Program Loader
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/kernel/vDSO/" title="vDSO" class="md-nav__link">
      vDSO
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/kernel/vfs/" title="Virtual File System" class="md-nav__link">
      Virtual File System
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/kernel/vm/" title="Process Virtual Memory" class="md-nav__link">
      Process Virtual Memory
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/kernel/fpu/" title="x86 FPU" class="md-nav__link">
      x86 FPU
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/kernel/irq/" title="IRQ" class="md-nav__link">
      IRQ
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/kernel/net_thpool/" title="Network Thpool" class="md-nav__link">
      Network Thpool
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-2" type="checkbox" id="nav-5-2">
    
    <label class="md-nav__link" for="nav-5-2">
      Syscall
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-2">
        Syscall
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/syscall/facts/" title="Facts" class="md-nav__link">
      Facts
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/kernel/profile_strace/" title="strace" class="md-nav__link">
      strace
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/syscall/compat/" title="compat" class="md-nav__link">
      compat
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/syscall/msync/" title="msync()" class="md-nav__link">
      msync()
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/syscall/mremap/" title="mremap()" class="md-nav__link">
      mremap()
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/syscall/fork/" title="fork()" class="md-nav__link">
      fork()
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/syscall/getrusage/" title="getrusage()" class="md-nav__link">
      getrusage()
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/syscall/wait_and_exit/" title="wait4 and exit()" class="md-nav__link">
      wait4 and exit()
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-3" type="checkbox" id="nav-5-3">
    
    <label class="md-nav__link" for="nav-5-3">
      Pcache
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-3">
        Pcache
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/pcache/config/" title="Config" class="md-nav__link">
      Config
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/pcache/sweep/" title="Sweep" class="md-nav__link">
      Sweep
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/pcache/tlb/" title="TLB Coherence" class="md-nav__link">
      TLB Coherence
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/pcache/pgtable-lock/" title="PageTable Lock" class="md-nav__link">
      PageTable Lock
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/pcache/victim/" title="Victim Cache" class="md-nav__link">
      Victim Cache
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/pcache/virtual_cache/" title="Virtual Cache" class="md-nav__link">
      Virtual Cache
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/pcache/rmap/" title="Reverse Mapping" class="md-nav__link">
      Reverse Mapping
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/pcache/evict_and_ref/" title="Evict and Refcount" class="md-nav__link">
      Evict and Refcount
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/pcache/smp_design/" title="SMP Design" class="md-nav__link">
      SMP Design
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/pcache/replication/" title="Replication" class="md-nav__link">
      Replication
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-4" type="checkbox" id="nav-5-4">
    
    <label class="md-nav__link" for="nav-5-4">
      Driver
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-4">
        Driver
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/driver/pci/" title="PCI" class="md-nav__link">
      PCI
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/driver/ib/" title="Infiniband" class="md-nav__link">
      Infiniband
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-5" type="checkbox" id="nav-5-5">
    
    <label class="md-nav__link" for="nav-5-5">
      Paper
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-5">
        Paper
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/paper/nmp/" title="NMP" class="md-nav__link">
      NMP
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/paper/processor_oom/" title="Processor OOM" class="md-nav__link">
      Processor OOM
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/paper/genz/" title="Gen-Z" class="md-nav__link">
      Gen-Z
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/paper/replication/" title="Replication" class="md-nav__link">
      Replication
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../lego/paper/related/" title="Related" class="md-nav__link">
      Related
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#numbers" title="Numbers" class="md-nav__link">
    Numbers
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mechanisms" title="Mechanisms" class="md-nav__link">
    Mechanisms
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#files-changed" title="Files changed" class="md-nav__link">
    Files changed
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#user-to-kernel-u2k" title="User to kernel (u2k)" class="md-nav__link">
    User to kernel (u2k)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kernel-to-user-k2u" title="Kernel to user (k2u)" class="md-nav__link">
    Kernel to user (k2u)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xperfxperfc" title="xperf/xperf.c" class="md-nav__link">
    xperf/xperf.c
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tsc-measurement" title="TSC Measurement" class="md-nav__link">
    TSC Measurement
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#misc" title="Misc" class="md-nav__link">
    Misc
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#howto-run" title="HOWTO Run" class="md-nav__link">
    HOWTO Run
  </a>
  
</li>
      
      
      
      
      
        <li class="md-nav__item">
          <a href="#__comments" title="Comments" class="md-nav__link md-nav__link--active">
            Comments
          </a>
        </li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="x86-ring-switch-overhead-page-fault-version">x86 Ring Switch Overhead (Page Fault version)<a class="headerlink" href="#x86-ring-switch-overhead-page-fault-version" title="Permanent link">&para;</a></h1>
<details class="note"><summary>Version History</summary><table><thead><tr><th align="left">Date</th><th>Description</th></tr></thead><tbody><tr><td align="left">Feb 2, 2020</td><td>Move github content to here</td></tr><tr><td align="left">Aug 7, 2019</td><td>Initial draft</td></tr></tbody></table></details><p><img alt="🚸" class="emojione" src="https://cdn.jsdelivr.net/emojione/assets/svg/1f6b8.svg" title=":children_crossing:" /></p>
<p>This page describes the mechanisms to measure the pure
x86 ring switch overhead, i.e., from ring 3 to ring 0 and back.</p>
<p>It is not straightforward to measure this in Linux kernel.
Because when a user program traps from user space to kernel space,
kernel will first run some assembly instructions
to save the registers and load some new ones for kernel usage
(i.e., <a href="https://github.com/torvalds/linux/blob/master/arch/x86/entry/entry_64.S#L145">syscall</a>,
 <a href="https://github.com/torvalds/linux/blob/master/arch/x86/entry/entry_64.S#L603">common IDT</a>,
 and some <a href="https://github.com/torvalds/linux/blob/master/arch/x86/entry/entry_64.S#L1193">directly registered</a>).
And only then, the kernel will run the C code.
Thus if we place the measurement code
in the first C function that will run (e.g., <a href="https://github.com/torvalds/linux/blob/master/arch/x86/entry/common.c#L282"><code class="codehilite">do_syscall_64</code></a>), it will be much larger than the actual ring switch overhead.</p>
<p>My proposed solutions hacks the <code class="codehilite">entry_64.S</code> and tries to save a timestamp as soon as possible.
The first version centers around page fault handler,
whose trapping mechanism is different from syscalls.
However, I think it could be easily ported.
The code is <a href="https://github.com/lastweek/linux-xperf-4.19.44">here</a>.</p>
<p>Takeaways:</p>
<ul>
<li>It ain&rsquo;t cheap! It usually take ~400 cycles to trap from user to kernel space.</li>
<li>User-to-kernel crossing is more expansive than kernel-to-user crossing!</li>
<li>Virtilization adds more overhead</li>
</ul>
<p>The following content is adopted from the Github repo.</p>
<h2 id="numbers">Numbers<a class="headerlink" href="#numbers" title="Permanent link">&para;</a></h2>
<p>The numbers reported by this repo are slightly larger than the
real crossing overhead because some instructions are needed in between
to do bookkeeping. Check below for details.</p>
<p>Some preliminary numbers measured on top of Intel Xeon E5-v3 2.4GHz</p>
<table>
<thead>
<tr>
<th>Platform</th>
<th>User to Kernel (Cycles)</th>
<th>Kernel to User (Cycles)</th>
</tr>
</thead>
<tbody>
<tr>
<td>VM</td>
<td>~600</td>
<td>~370</td>
</tr>
<tr>
<td>Bare-metal</td>
<td>~440</td>
<td>~270</td>
</tr>
</tbody>
</table>
<h2 id="mechanisms">Mechanisms<a class="headerlink" href="#mechanisms" title="Permanent link">&para;</a></h2>
<h3 id="files-changed">Files changed<a class="headerlink" href="#files-changed" title="Permanent link">&para;</a></h3>
<p>The whole patch is <a href="https://github.com/lastweek/linux-xperf-4.19.44/blob/master/xperf.patch"><code class="codehilite">xperf.patch</code></a></p>
<ul>
<li><code class="codehilite">arch/x86/entry/entry_64.S</code></li>
<li><code class="codehilite">arch/x86/mm/fault.c</code>: save u2k_k to user stack</li>
<li><code class="codehilite">xperf/xperf.c</code>: userspace test code</li>
</ul>
<h3 id="user-to-kernel-u2k">User to kernel (u2k)<a class="headerlink" href="#user-to-kernel-u2k" title="Permanent link">&para;</a></h3>
<p>At a high-level, the flow is:</p>
<ul>
<li>User save TSC into stack</li>
<li>User pgfault</li>
<li>Cross to kernel, get TSC, and save to user stack</li>
</ul>
<p>But devil is in the details, especially this low-level assembly code.
There are several difficulties:</p>
<ul>
<li>Once in kernel, we need to save TSC without corrupting any other
      registers and memory content. Any corruption leads to panic etc.
      The challenge is to find somewhere to save stuff.
      Options are: kernel stack, user stack, per-cpu. Using user stack
      is dangerous, because we can&rsquo;t use safe probe in this assembly (i.e., copy_from/to_user()).
      Using kernel stack is not flexible because we need to manually
      find a spot above pt_regs, and this subject to number of <code class="codehilite">call</code> invoked.</li>
<li>We need to ensure the measuring only applied to measure program,
      but not all user program. We let user save a MAGIC on user stack.</li>
</ul>
<p>The approach:</p>
<ul>
<li><code class="codehilite">entry_64.S</code>: Save rax/rdx into kernel stack, because they are known to be good
      if the exceptions came from user space.</li>
<li><code class="codehilite">entry_64.S</code>: Save TSC into a per-cpu area. With swapgs surrounded.</li>
<li><code class="codehilite">entry_64.S</code>: Restore rax/rdx</li>
<li><code class="codehilite">fault.c</code>: use <code class="codehilite">copy_to_user</code> to save <code class="codehilite">u2k_k</code> in user stack.</li>
</ul>
<p>Enable/Disable:</p>
<ul>
<li><code class="codehilite">entry_64.S</code>: Change <code class="codehilite">xperf_idtentry</code> back to <code class="codehilite">idtentry</code> for both <code class="codehilite">page_fault</code> and <code class="codehilite">async_page_fault</code>.</li>
</ul>
<p>Note: u2k hack is safe because we don&rsquo;t probe user virtual address directly in assembly.
Userspace accessing is done via <code class="codehilite">copy_from_user()</code>.</p>
<h3 id="kernel-to-user-k2u">Kernel to user (k2u)<a class="headerlink" href="#kernel-to-user-k2u" title="Permanent link">&para;</a></h3>
<p>At a high-level, the flow is:</p>
<ul>
<li>Kernel save TSC into user stack</li>
<li>Kernel IRET</li>
<li>Cross to user, get TSC, and calculate latency</li>
</ul>
<p>This is relatively simpiler than measuring u2k because we can safely use kernel stack.
The approach:</p>
<ul>
<li>Save scratch %rax, %rdx, %rcx into kernel stack</li>
<li>Check if MAGIC match</li>
<li>rdtsc</li>
<li>save to user stack</li>
<li>restore scratch registers</li>
</ul>
<p>Enable/Disable:</p>
<ul>
<li><code class="codehilite">entry_64.S:</code> There is a <code class="codehilite">xperf_return_kernel_tsc</code> code block.</li>
</ul>
<p>Note: k2u hack is <strong>NOT SAFE</strong> because we probe user virtual address directly in assembly,
i.e., <code class="codehilite">movq    %rax, (%rcx)</code> in our hack. During my experiments, sometimes it will crash,
but not always.</p>
<h3 id="xperfxperfc">xperf/xperf.c<a class="headerlink" href="#xperfxperfc" title="Permanent link">&para;</a></h3>
<p>This user program will report both u2k and k2u crossing numbers.
After compilation, use <code class="codehilite">objdump xperf.o -d</code> to check assembly,
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>  <span class="n">mfence</span> 
  <span class="n">rdtsc</span>                 <span class="o">&lt;-</span> <span class="n">u2k_u</span>

  <span class="n">shl</span>    <span class="err">$</span><span class="mh">0x20</span><span class="p">,</span><span class="o">%</span><span class="n">rdx</span>
  <span class="n">or</span>     <span class="o">%</span><span class="n">rdx</span><span class="p">,</span><span class="o">%</span><span class="n">rax</span>
  <span class="n">mov</span>    <span class="o">%</span><span class="n">rax</span><span class="p">,(</span><span class="o">%</span><span class="n">rdi</span><span class="p">)</span>            <span class="o">&lt;-</span> <span class="n">save</span> <span class="n">to</span> <span class="n">user</span> <span class="n">stack</span>

  <span class="n">movl</span>   <span class="err">$</span><span class="mh">0x12345678</span><span class="p">,(</span><span class="o">%</span><span class="n">rsi</span><span class="p">)</span>     <span class="o">&lt;-</span> <span class="n">pgfault</span>

  <span class="n">rdtsc</span>                 <span class="o">&lt;-</span> <span class="n">k2u_u</span>
  <span class="n">mfence</span> 
</pre></div>
</td></tr></table></p>
<p>The user stack layout upon pgfault is:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>  <span class="o">|</span> <span class="p">..</span>       <span class="o">|</span>
  <span class="o">|</span> <span class="mi">8</span><span class="n">B</span> <span class="n">magic</span> <span class="o">|</span> <span class="p">(</span><span class="n">filled</span> <span class="n">by</span> <span class="n">user</span><span class="p">)</span>   <span class="o">+</span><span class="mi">24</span>
  <span class="o">|</span> <span class="mi">8</span><span class="n">B</span> <span class="n">u2k_u</span> <span class="o">|</span> <span class="p">(</span><span class="n">filled</span> <span class="n">by</span> <span class="n">user</span><span class="p">)</span>   <span class="o">+</span><span class="mi">16</span>
  <span class="o">|</span> <span class="mi">8</span><span class="n">B</span> <span class="n">u2k_k</span> <span class="o">|</span> <span class="p">(</span><span class="n">filled</span> <span class="n">by</span> <span class="n">kernel</span><span class="p">)</span> <span class="o">+</span><span class="mi">8</span>
  <span class="o">|</span> <span class="mi">8</span><span class="n">B</span> <span class="n">k2u_k</span> <span class="o">|</span> <span class="p">(</span><span class="n">filled</span> <span class="n">by</span> <span class="n">kernel</span><span class="p">)</span> <span class="o">&lt;--</span> <span class="o">%</span><span class="n">rsp</span>
</pre></div>
</td></tr></table></p>
<h3 id="tsc-measurement">TSC Measurement<a class="headerlink" href="#tsc-measurement" title="Permanent link">&para;</a></h3>
<p>TSC will be reodered if no actions are taken. We use <code class="codehilite">mfence</code> to mimize runtime errors.</p>
<p>Ideally, we want a test sequence like this:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="cm">/*</span>
<span class="cm"> * User to Kernel </span>
<span class="cm"> *</span>
<span class="cm"> *          mfence</span>
<span class="cm"> *          rdtsc   &lt;- u2k_u</span>
<span class="cm"> * (user)</span>
<span class="cm"> * -------  pgfault  --------</span>
<span class="cm"> * (kernel)</span>
<span class="cm"> *          rdtsc   &lt;- u2k_k</span>
<span class="cm"> *          mfence</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Kernel to User</span>
<span class="cm"> *</span>
<span class="cm"> *          mfence</span>
<span class="cm"> *          rdtsc   &lt;- k2u_k</span>
<span class="cm"> * (kernel)</span>
<span class="cm"> * -------  IRET --------</span>
<span class="cm"> * (user)</span>
<span class="cm"> *          rdtsc   &lt;- k2u_k</span>
<span class="cm"> *          mfence</span>
<span class="cm"> */</span>
</pre></div>
</td></tr></table></p>
<p>But we need some instructions in between to do essential setup.
So the real instruction flow is:</p>
<p>U2K
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="p">(</span>User<span class="p">)</span>
    mfence 
    rdtsc                   <span class="o">&lt;-</span> u2k_u

    shl    <span class="o">$</span><span class="mh">0x20</span><span class="p">,</span><span class="o">%rdx</span>
<span class="o">    or     %</span>rdx<span class="p">,</span><span class="o">%rax</span>
<span class="o">    mov    %</span>rax<span class="p">,(</span><span class="o">%rdi)</span>

<span class="o">    movl   $0x12345678,(%</span>rsi<span class="p">)</span>
       <span class="o">--------------------------------</span>         Crossing
<span class="p">(</span>Kernel<span class="p">)</span>
    testb   <span class="o">$</span><span class="m">3</span><span class="p">,</span> CS<span class="o">-</span>ORIG_RAX<span class="p">(</span><span class="o">%rsp)</span>
<span class="o">    jz  1f</span>

<span class="o">    movq    %</span>rax<span class="p">,</span> <span class="m">-8</span><span class="p">(</span><span class="o">%rsp)</span>
<span class="o">    movq    %</span>rdx<span class="p">,</span> <span class="m">-16</span><span class="p">(</span>%rsp<span class="p">)</span>

    rdtsc                   <span class="o">&lt;-</span> u2k_k
    mfence
</pre></div>
</td></tr></table></p>
<p>K2U
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="p">(</span>Kernel<span class="p">)</span>
    mfence
    rdtsc                   <span class="o">&lt;-</span> k2u_k

    shl <span class="o">$</span><span class="m">32</span><span class="p">,</span> <span class="o">%rdx</span>
<span class="o">    or  %</span>rdx<span class="p">,</span> <span class="o">%rax</span>

<span class="o">    movq    %</span>rax<span class="p">,</span> <span class="p">(</span><span class="o">%rcx)</span>
<span class="o">    popq    %</span>rcx
    popq    <span class="o">%rdx</span>
<span class="o">    popq    %</span>rax

    INTERRUPT_RETURN
       <span class="o">--------------------------------</span>         Crossing
<span class="p">(</span>User<span class="p">)</span>
    rdtsc                   <span class="o">&lt;-</span> k2u_u
    mfence
</pre></div>
</td></tr></table></p>
<h2 id="misc">Misc<a class="headerlink" href="#misc" title="Permanent link">&para;</a></h2>
<ul>
<li>For VM scenario, the page fault entry point is <code class="codehilite">async_page_fault</code>, not the <code class="codehilite">page_fault</code>.</li>
</ul>
<h2 id="howto-run">HOWTO Run<a class="headerlink" href="#howto-run" title="Permanent link">&para;</a></h2>
<p>FAT NOTE:</p>
<ul>
<li>Enabling k2u code might bring crash</li>
<li>It&rsquo;s not safe to disable KPTI</li>
<li>Switch back to normal kernel after testing</li>
<li>Make sure if you have a way to reboot your machine!</li>
</ul>
<p>Steps:</p>
<ul>
<li>Copy your current kernel&rsquo;s .config into this repo</li>
<li>make oldconfig</li>
<li>Disable <code class="codehilite">CONFIG_PAGE_TABLE_ISOLATION</code></li>
<li>Compile kernel and install.</li>
<li>Reboot into new kernel</li>
<li>Disable hugepage</li>
<li><code class="codehilite">echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled</code></li>
<li>Run <code class="codehilite">xperf/xperf.c</code>, you will get a report.</li>
</ul>
                
                  
                
              
              
                
                  


  <h2 id="__comments">Comments</h2>
  <div id="disqus_thread"></div>
  <script>
    var disqus_config = function () {
      this.page.url = "http://lastweek.io/notes/xperf/";
      this.page.identifier =
        "/notes/xperf/";
    };
    (function() {
      var d = document, s = d.createElement("script");
      s.src = "//lastweek-io.disqus.com/embed.js";
      s.setAttribute("data-timestamp", +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>

                
              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../cache_coherence/" title="Practical-Cache-Coherence" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Practical-Cache-Coherence
              </span>
            </div>
          </a>
        
        
          <a href="../paper_perf_shadows/" title="Performance-Shadows" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Performance-Shadows
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="http://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
  <div class="md-footer-social">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    
      <a href="https://github.com/lastweek" class="md-footer-social__link fa fa-github"></a>
    
      <a href="https://twitter.com/Yizhou_Shan" class="md-footer-social__link fa fa-twitter"></a>
    
      <a href="https://www.linkedin.com/in/lastweek/" class="md-footer-social__link fa fa-linkedin"></a>
    
  </div>

      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.abd7b172.js"></script>
      
      <script>app.initialize({version:"0.17.2",url:{base:"../.."}})</script>
      
    
    
      
        <script>!function(e,a,t,n,o,c,i){e.GoogleAnalyticsObject=o,e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=1*new Date,c=a.createElement(t),i=a.getElementsByTagName(t)[0],c.async=1,c.src="https://www.google-analytics.com/analytics.js",i.parentNode.insertBefore(c,i)}(window,document,"script",0,"ga"),ga("create","UA-143772066-1","auto"),ga("set","anonymizeIp",!0),ga("send","pageview");var links=document.getElementsByTagName("a");if(Array.prototype.map.call(links,function(e){e.host!=document.location.host&&e.addEventListener("click",function(){var a=e.getAttribute("data-md-action")||"follow";ga("send","event","outbound",a,e.href)})}),document.forms.search){var query=document.forms.search.query;query.addEventListener("blur",function(){if(this.value){var e=document.location.pathname;ga("send","pageview",e+"?q="+this.value)}})}</script>
      
    
  </body>
</html>