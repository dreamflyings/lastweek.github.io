<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>[Linux] Tracing - Yizhou Shan's Home Page</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../../css/highlight.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "[Linux] Tracing";
    var mkdocs_page_input_path = "notes/trace.md";
    var mkdocs_page_url = "/notes/trace/";
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js"></script>
  <script src="../../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../../js/highlight.pack.js"></script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> Yizhou Shan's Home Page</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="../..">Home</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Impl Notes</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../paper_perf_shadows/">Perf Shadows</a>
                </li>
                <li class="">
                    
    <a class="" href="../cache_coherence/">[Arch] Cache Coherence</a>
                </li>
                <li class="">
                    
    <a class="" href="../rmap/">[Linux] Reverse Mmap (rmap)</a>
                </li>
                <li class=" current">
                    
    <a class="current" href="./">[Linux] Tracing</a>
    <ul class="subnav">
            
    <li class="toctree-l3"><a href="#linux-tracing">Linux Tracing</a></li>
    

    </ul>
                </li>
                <li class="">
                    
    <a class="" href="../cgroup-swap/">[Linux] Cgroup and Swap</a>
                </li>
                <li class="">
                    
    <a class="" href="../userfaultfd/">[Linux] Userfaultfd</a>
                </li>
                <li class="">
                    
    <a class="" href="../xperf/">[Linux] User/kern Cross Perf</a>
                </li>
                <li class="">
                    
    <a class="" href="../kvm-basic/">[Linux] KVM</a>
                </li>
                <li class="">
                    
    <a class="" href="../../misc/essential/">[Misc] Essential</a>
                </li>
                <li class="">
                    
    <a class="" href="../../misc/cheatsheet/">[Misc] Cheatsheet</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">LegoOS</span>
    <ul class="subnav">
                <li class="">
                    
    <span class="caption-text">Log</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../../lego/log/TODO/">TODO</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../lego/log/misc/">MISC</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../lego/log/test-note/">Test Script</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../lego/log/log-09-2018/">Sep 2018</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../lego/log/log-08-2018/">Aug 2018</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../lego/log/log-04-2018/">April 2018</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../lego/log/log-03-2018/">March 2018</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../lego/log/log-02-2018/">Feb 2018</a>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <span class="caption-text">Kernel</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../../lego/kernel/kconfig/">Kconfig</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../lego/kernel/debug/">Debug</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../lego/kernel/grub/">GRUB</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../lego/kernel/profile/">Profile</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../lego/kernel/profile_strace/">Profile strace</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../lego/kernel/profile_heatmap/">Profile heatmap</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../lego/kernel/profile_points/">Profile points</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../lego/kernel/trampoline/">Trampoline</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../lego/kernel/pagefault_disable/">Disable pgfault</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../lego/kernel/stop_machine/">Stop machine</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../lego/kernel/loader/">Program Loader</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../lego/kernel/vDSO/">vDSO</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../lego/kernel/vfs/">Virtual File System</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../lego/kernel/vm/">Process Virtual Memory</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../lego/kernel/fpu/">x86 FPU</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../lego/kernel/irq/">IRQ</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../lego/kernel/net_thpool/">Network Thpool</a>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <span class="caption-text">Syscall</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../../lego/syscall/facts/">Facts</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../lego/kernel/profile_strace/">strace</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../lego/syscall/compat/">compat</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../lego/syscall/msync/">msync()</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../lego/syscall/mremap/">mremap()</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../lego/syscall/fork/">fork()</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../lego/syscall/getrusage/">getrusage()</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../lego/syscall/wait_and_exit/">wait4 and exit()</a>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <span class="caption-text">Pcache</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../../lego/pcache/config/">Config</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../lego/pcache/sweep/">Sweep</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../lego/pcache/tlb/">TLB Coherence</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../lego/pcache/pgtable-lock/">PageTable Lock</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../lego/pcache/victim/">Victim Cache</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../lego/pcache/virtual_cache/">Virtual Cache</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../lego/pcache/rmap/">Reverse Mapping</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../lego/pcache/evict_and_ref/">Evict and Refcount</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../lego/pcache/smp_design/">SMP Design</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../lego/pcache/replication/">Replication</a>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <span class="caption-text">Driver</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../../lego/driver/pci/">PCI</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../lego/driver/ib/">Infiniband</a>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <span class="caption-text">Paper</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../../lego/paper/nmp/">NMP</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../lego/paper/processor_oom/">Processor OOM</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../lego/paper/genz/">Gen-Z</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../lego/paper/replication/">Replication</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../lego/paper/related/">Related</a>
                </li>
    </ul>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">FPGA</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../fpga/hls_axi/">HLS: Usage of AXI-Stream</a>
                </li>
                <li class="">
                    
    <a class="" href="../../fpga/hls_axi/">HLS: High-performance AXI-MM</a>
                </li>
    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">Yizhou Shan's Home Page</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>Impl Notes &raquo;</li>
        
      
    
    <li>[Linux] Tracing</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="linux-tracing">Linux Tracing</h1>
<p>Some general notes about the various tracers inside Linux kernel.</p>
<p>Link to my old notes about the profilers/tracers in LegoOS: <a href="http://lastweek.io/lego/kernel/profile/">notes</a>.
The <a href="http://lastweek.io/lego/kernel/profile_points/">profile points</a>,
which is able to profile arbitray code piece is still my favorite thing.</p>
<p>In Linux kernel, we have:</p>
<ul>
<li>ftrace</li>
<li>kprobe</li>
<li>uprobe</li>
<li>perf_event</li>
<li>tracepoints</li>
<li>eBPF</li>
</ul>
<p>I tend to think this way:</p>
<ul>
<li>Tracing needs two parts, <code class="codehilite">1)</code> <strong>Mechanims to do callback.</strong> This means we need a way to
    let our tracing/profiling code got invoked on a running system. This can be static
    or dynamic. Static means we added our tracing code to source code, like tracepoints.
    Dynamic means we added our tracing code when system is running, like ftrace and kprobe.
    <code class="codehilite">2)</code> <strong>Do stuff within callback.</strong> All of them provide some sort of handling. But eBPF is the
    most extensive one.</li>
<li>For example, <code class="codehilite">ftrace</code>, <code class="codehilite">kprobe</code>, and <code class="codehilite">perf_event</code> include the callback facilities,
    although they are not just limited to this.
    <code class="codehilite">ftrace</code> has the <code class="codehilite">call mount</code> way to do callback on every single function invocation.
    <code class="codehilite">kprobe</code> dynamically patch instructions and to do callback within exception handlers.
    <code class="codehilite">perf_event</code> can let CPU fire NMI interrupt. Those are all mechanisms to catch perf data.</li>
<li>The blog from Julia explains it well: <a href="https://jvns.ca/blog/2017/07/05/linux-tracing-systems/">Linux tracing systems &amp; how they fit together</a></li>
</ul>
<p><code class="codehilite">ftrace</code>:</p>
<ul>
<li>Mechanism<ul>
<li>For each un-inlined function, gcc inserts a <code class="codehilite">call mcount</code>, or a <code class="codehilite">call fentry</code>
instruction at the very beginning. This means whenever a function is called,
the <code class="codehilite">mcount()</code> or the <code class="codehilite">fentry()</code> callback will be invoked.</li>
<li>Having these <code class="codehilite">call</code> instructions introduce a lot overheads. So by default kernel
replace <code class="codehilite">call</code> with <code class="codehilite">nop</code>. Only after we <code class="codehilite">echo something &gt; setup_filter_functions</code>
will the ftrace code replace <code class="codehilite">nop</code> with <code class="codehilite">call</code>. Do note, Linux uses the linker
magic again here, check Steven&rsquo;s slides.</li>
<li>You can do a <code class="codehilite">objdump vmlinux -d</code>, and able to see the following instructions for
almost all functions: <code class="codehilite">callq  ffffffff81a01560 &lt;__fentry__&gt;</code>.</li>
<li>x86 related code: <code class="codehilite">arch/x86/kernel/ftrace_64.S</code>, <code class="codehilite">arch/x86/kernel/ftrace.c</code></li>
<li>Questions: it seems we can know when a function got called by using fentry, but
how can we know the function has returned? The trick is: the returning address
is pushed to stack when a function got called. So ftrace, again, can replace
that return address, so it can catch the exit time, and calculate the latency
of a function. Neat!!</li>
</ul>
</li>
<li>Resources<ul>
<li><a href="https://blog.linuxplumbersconf.org/2014/ocw/system/presentations/1773/original/ftrace-kernel-hooks-2014.pdf">ftrace internal from Steven</a></li>
</ul>
</li>
<li>Usage<ul>
<li><code class="codehilite">Files under /sys/kernel/debug/tracing/*</code></li>
<li><code class="codehilite">perf help ftrace</code></li>
</ul>
</li>
</ul>
<p><code class="codehilite">kprobe</code>:</p>
<ul>
<li>Mechanism<ul>
<li>Kprobe replaces the original assembly instruction with an <code class="codehilite">int3</code> trap instruction.
  So when we ran into the PC of the original instruction, an int3 CPU exception will happen.
  Within <code class="codehilite">do_in3()</code>, kernel will callback to core kprobe layer to do <code class="codehilite">pre-handler</code>.
  After singlestep, CPU have debug exception. Kernel walks into <code class="codehilite">do_debug()</code>,
  where kprobe run <code class="codehilite">post-handler</code>.</li>
<li>Kprobe is powerful, because it&rsquo;s able to trace almost everything at instruction level.</li>
<li>Kprobe can NOT touch things inside <code class="codehilite">entry.S</code>. It needs a valid <code class="codehilite">pt_regs</code> to operate.</li>
</ul>
</li>
<li>Resources<ul>
<li><a href="https://lwn.net/Articles/132196/">An introduction to kprobes (LWN)</a></li>
</ul>
</li>
</ul>
<p><code class="codehilite">eBPF</code>:</p>
<ul>
<li>Mechanism<ul>
<li>I think the most important thing is to understand what&rsquo;s the relationship between
eBPF and the others.</li>
<li>Part I: Hook. eBPF attach its program to kprobe/uprobe/ftrace/perf_event.
You can think eBPF of <strong>a generic callback layer</strong> for kprobe/uprobe/ftrace/perf_event.
It&rsquo;s essentially the second part of tracing as we mentioned above.</li>
<li>Part II Run: eBPF run program when the above hook got invoked. eBPF is event-driven.
The program can be user-written eBPF code. Other articles explained it well.</li>
</ul>
</li>
<li>Resources<ul>
<li><a href="http://www.brendangregg.com/index.html">Brendan D. Gregg Blog</a></li>
<li><a href="https://github.com/zoidbergwill/awesome-ebpf">Github: Awesome-eBPF</a></li>
<li><a href="https://cilium.readthedocs.io/en/latest/bpf/">Cilium: BPF and XDP Reference Guide</a></li>
<li><a href="https://www.collabora.com/news-and-blog/blog/2019/04/05/an-ebpf-overview-part-1-introduction/">Blog: An eBPF overview</a></li>
<li><a href="https://github.com/iovisor/bcc">Github: Bcc</a></li>
</ul>
</li>
</ul>
<p><code class="codehilite">perf</code>:</p>
<ul>
<li>perf tool is simply amazing. It not only use CPU PMU, but also integrated with ftrace/kprobe/eBPF.</li>
<li>perf is a tool to present data, but also a tool to collect data.</li>
<li>Read this: <a href="http://www.brendangregg.com/perf.html">http://www.brendangregg.com/perf.html</a></li>
</ul>
<p>&ndash;<br />
Yizhou Shan<br />
Created: Jun 10, 2019<br />
Last Updated: Jun 10, 2019</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../cgroup-swap/" class="btn btn-neutral float-right" title="[Linux] Cgroup and Swap">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../rmap/" class="btn btn-neutral" title="[Linux] Reverse Mmap (rmap)"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../rmap/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../cgroup-swap/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme.js"></script>
      <script src="../../search/require.js"></script>
      <script src="../../search/search.js"></script>

</body>
</html>
