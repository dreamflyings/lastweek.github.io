



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
        <link rel="canonical" href="http://lastweek.io/lego/kernel/irq/">
      
      
        <meta name="author" content="Yizhou Shan">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.4.3">
    
    
      
        <title>IRQ - Yizhou Shan's Home Page</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/application.30686662.css">
      
      
    
    
      <script src="../../../assets/javascripts/modernizr.74668098.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,400i,700|&display=fallback">
        <style>body,input{font-family:"Open Sans","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../../assets/fonts/material-icons.css">
    
    
    
      
        
<script>
  window.ga = window.ga || function() {
    (ga.q = ga.q || []).push(arguments)
  }
  ga.l = +new Date
  /* Setup integration and send page view */
  ga("create", "UA-143772066-1", "auto")
  ga("set", "anonymizeIp", true)
  ga("send", "pageview")
  /* Register handler to log search on blur */
  document.addEventListener("DOMContentLoaded", () => {
    if (document.forms.search) {
      var query = document.forms.search.query
      query.addEventListener("blur", function() {
        if (this.value) {
          var path = document.location.pathname;
          ga("send", "pageview", path + "?q=" + this.value)
        }
      })
    }
  })
</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#irq" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="http://lastweek.io" title="Yizhou Shan's Home Page" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Yizhou Shan's Home Page
            </span>
            <span class="md-header-nav__topic">
              
                IRQ
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="http://lastweek.io" title="Yizhou Shan's Home Page" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Yizhou Shan's Home Page
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Blog
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Blog
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../blog/20200501-on-graphic-softwares/" title="2020-05 On-Unix-Graphic-Softwares" class="md-nav__link">
      2020-05 On-Unix-Graphic-Softwares
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../blog/20200404-on-read-once/" title="2020-04 On-Read-Once-and-Compiler-Opts" class="md-nav__link">
      2020-04 On-Read-Once-and-Compiler-Opts
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../blog/20200404-on-net-transport/" title="2020-04 On-Hardware-based-Network-Transport" class="md-nav__link">
      2020-04 On-Hardware-based-Network-Transport
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Notes
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Notes
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/source_code/" title="Open-Source-Code-Study" class="md-nav__link">
      Open-Source-Code-Study
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/program_advice/" title="Programming-Guidelines-and-Advice" class="md-nav__link">
      Programming-Guidelines-and-Advice
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/virt/" title="Virtualization-Software" class="md-nav__link">
      Virtualization-Software
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/cache_coherence/" title="Practical-Cache-Coherence" class="md-nav__link">
      Practical-Cache-Coherence
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/xperf/" title="Measure-x86-Ring-Switch-Overhead" class="md-nav__link">
      Measure-x86-Ring-Switch-Overhead
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/paper_perf_shadows/" title="Performance-Shadows" class="md-nav__link">
      Performance-Shadows
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/rmap/" title="Linux Reverse Map (rmap)" class="md-nav__link">
      Linux Reverse Map (rmap)
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/userfaultfd/" title="Linux Userfaultfd" class="md-nav__link">
      Linux Userfaultfd
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/trace/" title="Linux Trace/Profile" class="md-nav__link">
      Linux Trace/Profile
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/cgroup-swap/" title="Linux Cgroup and Swap" class="md-nav__link">
      Linux Cgroup and Swap
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/proc/" title="Linux Special Files" class="md-nav__link">
      Linux Special Files
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/linux-resource/" title="Linux Resource" class="md-nav__link">
      Linux Resource
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/kvm-basic/" title="Linux KVM" class="md-nav__link">
      Linux KVM
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../misc/essential/" title="Essential" class="md-nav__link">
      Essential
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/benchmark/" title="Benchmarks" class="md-nav__link">
      Benchmarks
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../misc/cheatsheet/" title="Cheatsheet" class="md-nav__link">
      Cheatsheet
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      FPGA
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        FPGA
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/paper_fpga/" title="Papers" class="md-nav__link">
      Papers
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../fpga/bitstream/" title="Bitstream Explained" class="md-nav__link">
      Bitstream Explained
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../fpga/pr/" title="Morphous PR" class="md-nav__link">
      Morphous PR
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../fpga/vivado/" title="Vivado Practice" class="md-nav__link">
      Vivado Practice
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../fpga/hls_axi/" title="Efficient AXI-MM" class="md-nav__link">
      Efficient AXI-MM
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5" checked>
    
    <label class="md-nav__link" for="nav-5">
      LegoOS
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        LegoOS
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-1" type="checkbox" id="nav-5-1" checked>
    
    <label class="md-nav__link" for="nav-5-1">
      Kernel
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-1">
        Kernel
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../boot/" title="GRUB2 and Boot" class="md-nav__link">
      GRUB2 and Boot
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../kconfig/" title="Kconfig" class="md-nav__link">
      Kconfig
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../debug/" title="Debug" class="md-nav__link">
      Debug
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../grub/" title="GRUB" class="md-nav__link">
      GRUB
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../profile/" title="Profile" class="md-nav__link">
      Profile
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../profile_strace/" title="Profile strace" class="md-nav__link">
      Profile strace
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../profile_heatmap/" title="Profile heatmap" class="md-nav__link">
      Profile heatmap
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../profile_points/" title="Profile points" class="md-nav__link">
      Profile points
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../trampoline/" title="Trampoline" class="md-nav__link">
      Trampoline
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../pagefault_disable/" title="Disable pgfault" class="md-nav__link">
      Disable pgfault
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../stop_machine/" title="Stop machine" class="md-nav__link">
      Stop machine
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../loader/" title="Program Loader" class="md-nav__link">
      Program Loader
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../vDSO/" title="vDSO" class="md-nav__link">
      vDSO
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../vfs/" title="Virtual File System" class="md-nav__link">
      Virtual File System
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../vm/" title="Process Virtual Memory" class="md-nav__link">
      Process Virtual Memory
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../fpu/" title="x86 FPU" class="md-nav__link">
      x86 FPU
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        IRQ
      </label>
    
    <a href="./" title="IRQ" class="md-nav__link md-nav__link--active">
      IRQ
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#init" class="md-nav__link">
    Init
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#irq-domain" class="md-nav__link">
    IRQ Domain
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aug-20-2018" class="md-nav__link">
    Aug 20, 2018
  </a>
  
</li>
      
      
      
      
      
        <li class="md-nav__item">
          <a href="#__comments" class="md-nav__link md-nav__link--active">
            Comments
          </a>
        </li>
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../net_thpool/" title="Network Thpool" class="md-nav__link">
      Network Thpool
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-2" type="checkbox" id="nav-5-2">
    
    <label class="md-nav__link" for="nav-5-2">
      Syscall
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-2">
        Syscall
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../syscall/facts/" title="Facts" class="md-nav__link">
      Facts
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../profile_strace/" title="strace" class="md-nav__link">
      strace
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../syscall/compat/" title="compat" class="md-nav__link">
      compat
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../syscall/msync/" title="msync()" class="md-nav__link">
      msync()
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../syscall/mremap/" title="mremap()" class="md-nav__link">
      mremap()
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../syscall/fork/" title="fork()" class="md-nav__link">
      fork()
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../syscall/getrusage/" title="getrusage()" class="md-nav__link">
      getrusage()
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../syscall/wait_and_exit/" title="wait4 and exit()" class="md-nav__link">
      wait4 and exit()
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-3" type="checkbox" id="nav-5-3">
    
    <label class="md-nav__link" for="nav-5-3">
      Pcache
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-3">
        Pcache
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/config/" title="Config" class="md-nav__link">
      Config
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/sweep/" title="Sweep" class="md-nav__link">
      Sweep
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/tlb/" title="TLB Coherence" class="md-nav__link">
      TLB Coherence
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/pgtable-lock/" title="PageTable Lock" class="md-nav__link">
      PageTable Lock
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/victim/" title="Victim Cache" class="md-nav__link">
      Victim Cache
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/virtual_cache/" title="Virtual Cache" class="md-nav__link">
      Virtual Cache
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/rmap/" title="Reverse Mapping" class="md-nav__link">
      Reverse Mapping
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/evict_and_ref/" title="Evict and Refcount" class="md-nav__link">
      Evict and Refcount
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/smp_design/" title="SMP Design" class="md-nav__link">
      SMP Design
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/replication/" title="Replication" class="md-nav__link">
      Replication
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-4" type="checkbox" id="nav-5-4">
    
    <label class="md-nav__link" for="nav-5-4">
      Driver
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-4">
        Driver
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../driver/pci/" title="PCI" class="md-nav__link">
      PCI
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../driver/ib/" title="Infiniband" class="md-nav__link">
      Infiniband
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-5" type="checkbox" id="nav-5-5">
    
    <label class="md-nav__link" for="nav-5-5">
      Paper
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-5">
        Paper
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../paper/nmp/" title="NMP" class="md-nav__link">
      NMP
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../paper/processor_oom/" title="Processor OOM" class="md-nav__link">
      Processor OOM
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../paper/genz/" title="Gen-Z" class="md-nav__link">
      Gen-Z
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../paper/replication/" title="Replication" class="md-nav__link">
      Replication
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../paper/related/" title="Related" class="md-nav__link">
      Related
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#init" class="md-nav__link">
    Init
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#irq-domain" class="md-nav__link">
    IRQ Domain
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aug-20-2018" class="md-nav__link">
    Aug 20, 2018
  </a>
  
</li>
      
      
      
      
      
        <li class="md-nav__item">
          <a href="#__comments" class="md-nav__link md-nav__link--active">
            Comments
          </a>
        </li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="irq">IRQ<a class="headerlink" href="#irq" title="Permanent link">&para;</a></h1>
<p>IRQ is majorly ported based on <code class="codehilite"><span class="n">linux</span><span class="o">-</span><span class="mi">4</span><span class="p">.</span><span class="mi">4</span></code>. The decision of porting of whole IRQ stack from linux was made at early stage of Lego, when I&rsquo;m not so familiar with this stuff. This technique decision has pros and cons.</p>
<p>The whole thing is made complicated by having IRQ domain. IRQ domain is introduced to address the multiple interrupt controller issue. And in x86, we kind of have mutiple as well: IO-APIC, REMAP, LAPIC. Although we are not supporting IRQ remap now.</p>
<h2 id="init">Init<a class="headerlink" href="#init" title="Permanent link">&para;</a></h2>
<ul>
<li>The first part of initialization is <code class="codehilite"><span class="n">trap_init</span><span class="p">()</span></code> at early <code class="codehilite"><span class="n">setup_arch</span><span class="p">()</span></code>.</li>
<li>The second major entry point is <code class="codehilite"><span class="n">irq_init</span><span class="p">()</span></code> at <code class="codehilite"><span class="n">start_kernel</span><span class="p">()</span></code>. This <code class="codehilite"><span class="n">irq_init</span><span class="p">()</span></code> is actually a combination of linux&rsquo;s:<ul>
<li><code class="codehilite"><span class="n">early_irq_init</span><span class="p">()</span></code>: 1) setup <code class="codehilite"><span class="n">irq_desc</span><span class="p">[]</span></code> array, and then call <code class="codehilite"><span class="n">arch_early_irq_init</span><span class="p">()</span></code>, which will register two IRQ domains (x86_vector_domain, msi_domain).</li>
<li><code class="codehilite"><span class="n">init_IRQ</span><span class="p">()</span></code>: is actually a callback to low-level x86 interrupt setup. It mainly setup the desc&rsquo;s data/chip etc, and register all different handlers.</li>
<li>In Lego, you will be able to find all the functionalitis are moved into <code class="codehilite"><span class="n">arch_irq_init</span><span class="p">()</span></code>. And, to this point, we have a complete setup.</li>
</ul>
</li>
<li>The third (and last) entry point is <code class="codehilite"><span class="n">smp_prepare_cpus</span><span class="p">()</span></code>:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">smp_prepare_cpus</span><span class="p">()</span>
<span class="o">-&gt;</span> <span class="n">apic_bsp_setup</span><span class="p">()</span>
   <span class="o">-&gt;</span> <span class="n">setup_local_APIC</span><span class="p">()</span>
   <span class="o">-&gt;</span> <span class="n">setup_IO_APIC</span><span class="p">()</span>
   <span class="o">-&gt;</span> <span class="n">x86_init</span><span class="p">.</span><span class="n">timers</span><span class="p">.</span><span class="n">setup_percpu_clockev</span><span class="p">()</span>
</pre></div>
</td></tr></table></li>
</ul>
<h2 id="irq-domain">IRQ Domain<a class="headerlink" href="#irq-domain" title="Permanent link">&para;</a></h2>
<p>We should have at least 2 or 3 IRQ domains:</p>
<ul>
<li>x86_vector</li>
<li>x86_msi</li>
<li>x86_ioapic-N (each ioapic has one)</li>
</ul>
<p>The first two guys are created during <code class="codehilite"><span class="n">arch_irq_init</span><span class="p">()</span></code>. While the latter ioapic ones are created during <code class="codehilite"><span class="n">setup_IO_APIC</span><span class="p">()</span></code>. All of them are allocated eventually by <code class="codehilite"><span class="n">__irq_domain_add</span><span class="p">()</span></code>, and linked at <code class="codehilite"><span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">irq_domain_list</span><span class="p">)</span></code>.</p>
<p>So....  Lego or Linux maintains its own IRQ numbers, starting from 0 to NR_IRQs.
However, this IRQ number MAY not have a identical mapping to hardware&rsquo;s own IRQ number (let us call it hwirq). Given this, we want to know the mapping between IRQ and hwirq. That&rsquo;s the purpose of having <code class="codehilite"><span class="n">linear_revmap</span></code> and <code class="codehilite"><span class="n">revmap_tree</span></code> within each domain, it is used to translate hwirq to IRQ.</p>
<p>Why two different data structures? <code class="codehilite"><span class="n">linear_revmap</span></code> is fairly simple, an array, which is indexed by hwirq. However, the hwirq maybe very large, we don&rsquo;t want to waste memory, that&rsquo;s how we want to use trees.</p>
<p>These two can be used together. If we fail to insert into <code class="codehilite"><span class="n">linear_revmap</span></code>, we insert into tree. During search time, we need to look up both.</p>
<p>By default, <code class="codehilite"><span class="n">x86_vector</span></code> and <code class="codehilite"><span class="n">x86_msi</span></code> use radix tree only. <code class="codehilite"><span class="n">x86_ioapic</span><span class="o">-</span><span class="n">N</span></code> uses a mix of linear and radix tree.</p>
<p>To dump all IRQ domains, call <code class="codehilite"><span class="n">dump_irq_domain_list</span><span class="p">()</span></code>, which give you something like this:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="p">[</span>  <span class="mf">118.308544</span><span class="p">]</span>  <span class="n">name</span>              <span class="n">mapped</span>  <span class="n">linear</span><span class="o">-</span><span class="n">max</span>  <span class="n">direct</span><span class="o">-</span><span class="n">max</span>  <span class="n">devtree</span><span class="o">-</span><span class="n">node</span>
<span class="p">[</span>  <span class="mf">118.316114</span><span class="p">]</span>  <span class="n">x86_ioapic</span><span class="o">-</span><span class="mi">2</span>          <span class="mi">24</span>          <span class="mi">24</span>           <span class="mi">0</span>    
<span class="p">[</span>  <span class="mf">118.322707</span><span class="p">]</span>  <span class="n">x86_ioapic</span><span class="o">-</span><span class="mi">1</span>          <span class="mi">24</span>          <span class="mi">24</span>           <span class="mi">0</span>    
<span class="p">[</span>  <span class="mf">118.329299</span><span class="p">]</span>  <span class="n">x86_ioapic</span><span class="o">-</span><span class="mi">0</span>          <span class="mi">24</span>          <span class="mi">24</span>           <span class="mi">0</span>    
<span class="p">[</span>  <span class="mf">118.335893</span><span class="p">]</span>  <span class="n">x86_msi</span>               <span class="mi">25</span>           <span class="mi">0</span>           <span class="mi">0</span>    
<span class="p">[</span>  <span class="mf">118.342486</span><span class="p">]</span> <span class="o">*</span><span class="n">x86_vector</span>            <span class="mi">40</span>           <span class="mi">0</span>           <span class="mi">0</span>    
<span class="p">[</span>  <span class="mf">118.349078</span><span class="p">]</span> <span class="n">irq</span>    <span class="n">hwirq</span>    <span class="n">chip</span> <span class="n">name</span>        <span class="n">chip</span> <span class="n">data</span>           <span class="n">active</span>  <span class="n">type</span>            <span class="n">domain</span>
<span class="p">[</span>  <span class="mf">118.358775</span><span class="p">]</span>     <span class="mi">1</span>  <span class="mh">0x00001</span>  <span class="n">IO</span><span class="o">-</span><span class="n">APIC</span>          <span class="mh">0xffff88107fcae000</span>        <span class="n">LINEAR</span>          <span class="n">x86_ioapic</span><span class="o">-</span><span class="mi">0</span>
<span class="p">[</span>  <span class="mf">118.368858</span><span class="p">]</span>     <span class="mi">3</span>  <span class="mh">0x00003</span>  <span class="n">IO</span><span class="o">-</span><span class="n">APIC</span>          <span class="mh">0xffff88107fc8f000</span>        <span class="n">LINEAR</span>          <span class="n">x86_ioapic</span><span class="o">-</span><span class="mi">0</span>
<span class="p">[</span>  <span class="mf">118.378940</span><span class="p">]</span>     <span class="mi">4</span>  <span class="mh">0x00004</span>  <span class="n">IO</span><span class="o">-</span><span class="n">APIC</span>          <span class="mh">0xffff88107fc6e000</span>        <span class="n">LINEAR</span>          <span class="n">x86_ioapic</span><span class="o">-</span><span class="mi">0</span>
<span class="p">[</span>  <span class="mf">118.389025</span><span class="p">]</span>     <span class="mi">5</span>  <span class="mh">0x00005</span>  <span class="n">IO</span><span class="o">-</span><span class="n">APIC</span>          <span class="mh">0xffff88107fc6f000</span>        <span class="n">LINEAR</span>          <span class="n">x86_ioapic</span><span class="o">-</span><span class="mi">0</span>
<span class="p">[</span>  <span class="mf">118.399109</span><span class="p">]</span>     <span class="mi">6</span>  <span class="mh">0x00006</span>  <span class="n">IO</span><span class="o">-</span><span class="n">APIC</span>          <span class="mh">0xffff88107fc4e000</span>        <span class="n">LINEAR</span>          <span class="n">x86_ioapic</span><span class="o">-</span><span class="mi">0</span>
<span class="p">[</span>  <span class="mf">118.409192</span><span class="p">]</span>     <span class="mi">7</span>  <span class="mh">0x00007</span>  <span class="n">IO</span><span class="o">-</span><span class="n">APIC</span>          <span class="mh">0xffff88107fc4f000</span>        <span class="n">LINEAR</span>          <span class="n">x86_ioapic</span><span class="o">-</span><span class="mi">0</span>
<span class="p">[</span>  <span class="mf">118.419276</span><span class="p">]</span>     <span class="mi">8</span>  <span class="mh">0x00008</span>  <span class="n">IO</span><span class="o">-</span><span class="n">APIC</span>          <span class="mh">0xffff88107fc2e000</span>        <span class="n">LINEAR</span>          <span class="n">x86_ioapic</span><span class="o">-</span><span class="mi">0</span>
<span class="p">[</span>  <span class="mf">118.429358</span><span class="p">]</span>     <span class="mi">9</span>  <span class="mh">0x00009</span>  <span class="n">IO</span><span class="o">-</span><span class="n">APIC</span>          <span class="mh">0xffff88107fc2f000</span>        <span class="n">LINEAR</span>          <span class="n">x86_ioapic</span><span class="o">-</span><span class="mi">0</span>
<span class="p">[</span>  <span class="mf">118.439442</span><span class="p">]</span>    <span class="mi">10</span>  <span class="mh">0x0000a</span>  <span class="n">IO</span><span class="o">-</span><span class="n">APIC</span>          <span class="mh">0xffff88107fc0e000</span>        <span class="n">LINEAR</span>          <span class="n">x86_ioapic</span><span class="o">-</span><span class="mi">0</span>
<span class="p">[</span>  <span class="mf">118.449525</span><span class="p">]</span>    <span class="mi">11</span>  <span class="mh">0x0000b</span>  <span class="n">IO</span><span class="o">-</span><span class="n">APIC</span>          <span class="mh">0xffff88107fc0f000</span>        <span class="n">LINEAR</span>          <span class="n">x86_ioapic</span><span class="o">-</span><span class="mi">0</span>
<span class="p">[</span>  <span class="mf">118.459609</span><span class="p">]</span>    <span class="mi">12</span>  <span class="mh">0x0000c</span>  <span class="n">IO</span><span class="o">-</span><span class="n">APIC</span>          <span class="mh">0xffff88107fff0000</span>        <span class="n">LINEAR</span>          <span class="n">x86_ioapic</span><span class="o">-</span><span class="mi">0</span>
<span class="p">[</span>  <span class="mf">118.469692</span><span class="p">]</span>    <span class="mi">13</span>  <span class="mh">0x0000d</span>  <span class="n">IO</span><span class="o">-</span><span class="n">APIC</span>          <span class="mh">0xffff88107fff1000</span>        <span class="n">LINEAR</span>          <span class="n">x86_ioapic</span><span class="o">-</span><span class="mi">0</span>
<span class="p">[</span>  <span class="mf">118.479776</span><span class="p">]</span>    <span class="mi">14</span>  <span class="mh">0x0000e</span>  <span class="n">IO</span><span class="o">-</span><span class="n">APIC</span>          <span class="mh">0xffff88107fff2000</span>        <span class="n">LINEAR</span>          <span class="n">x86_ioapic</span><span class="o">-</span><span class="mi">0</span>
<span class="p">[</span>  <span class="mf">118.489860</span><span class="p">]</span>    <span class="mi">15</span>  <span class="mh">0x0000f</span>  <span class="n">IO</span><span class="o">-</span><span class="n">APIC</span>          <span class="mh">0xffff88107fff3000</span>        <span class="n">LINEAR</span>          <span class="n">x86_ioapic</span><span class="o">-</span><span class="mi">0</span>
<span class="p">[</span>  <span class="mf">118.499943</span><span class="p">]</span>    <span class="mi">24</span>  <span class="mh">0x300000</span>  <span class="n">PCI</span><span class="o">-</span><span class="n">MSI</span>                      <span class="p">(</span><span class="n">null</span><span class="p">)</span>     <span class="o">*</span>     <span class="n">RADIX</span>          <span class="n">x86_msi</span>
<span class="p">[</span>  <span class="mf">118.509833</span><span class="p">]</span>    <span class="mi">25</span>  <span class="mh">0x300001</span>  <span class="n">PCI</span><span class="o">-</span><span class="n">MSI</span>                      <span class="p">(</span><span class="n">null</span><span class="p">)</span>     <span class="o">*</span>     <span class="n">RADIX</span>          <span class="n">x86_msi</span>
<span class="p">[</span>  <span class="mf">118.519722</span><span class="p">]</span>    <span class="mi">26</span>  <span class="mh">0x300002</span>  <span class="n">PCI</span><span class="o">-</span><span class="n">MSI</span>                      <span class="p">(</span><span class="n">null</span><span class="p">)</span>     <span class="o">*</span>     <span class="n">RADIX</span>          <span class="n">x86_msi</span>
<span class="p">[</span>  <span class="mf">118.529612</span><span class="p">]</span>    <span class="mi">27</span>  <span class="mh">0x300003</span>  <span class="n">PCI</span><span class="o">-</span><span class="n">MSI</span>                      <span class="p">(</span><span class="n">null</span><span class="p">)</span>     <span class="o">*</span>     <span class="n">RADIX</span>          <span class="n">x86_msi</span>
<span class="p">[</span>  <span class="mf">118.539501</span><span class="p">]</span>    <span class="mi">28</span>  <span class="mh">0x300004</span>  <span class="n">PCI</span><span class="o">-</span><span class="n">MSI</span>                      <span class="p">(</span><span class="n">null</span><span class="p">)</span>           <span class="n">RADIX</span>          <span class="n">x86_msi</span>
</pre></div>
</td></tr></table></p>
<h2 id="aug-20-2018">Aug 20, 2018<a class="headerlink" href="#aug-20-2018" title="Permanent link">&para;</a></h2>
<p>Well, I&rsquo;ve ported the IRQ stuff at early days of Lego. At that time, I mainly ported the low-level APIC, IO-APIC, and ACPI stuff, along with the upper layer irqchip, irqdesc stuff.</p>
<p>These days, I was verifying our IB code and tried to add back mlx4en&rsquo;s interrupt handler, somehow, there is no interrupt after <code class="codehilite"><span class="n">request_irq</span><span class="p">()</span></code>.</p>
<p>Two possible reasons: 1) I missed something during PCI setup, 2) underlying APIC and IO-APIC need more work.</p>
<p>&ndash;
Last Updated: Aug 28, 2018</p>
                
                  
                
              
              
                


  <h2 id="__comments">Comments</h2>
  <div id="disqus_thread"></div>
  <script>
    var disqus_config = function () {
      this.page.url = "http://lastweek.io/lego/kernel/irq/";
      this.page.identifier =
        "/lego/kernel/irq/";
    };
    (function() {
      var d = document, s = d.createElement("script");
      s.src = "//lastweek-io.disqus.com/embed.js";
      s.setAttribute("data-timestamp", +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>

              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../fpu/" title="x86 FPU" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                x86 FPU
              </span>
            </div>
          </a>
        
        
          <a href="../net_thpool/" title="Network Thpool" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Network Thpool
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
  <div class="md-footer-social">
    <link rel="stylesheet" href="../../../assets/fonts/font-awesome.css">
    
      <a href="https://github.com/lastweek" class="md-footer-social__link fa fa-github"></a>
    
      <a href="https://twitter.com/Yizhou_Shan" class="md-footer-social__link fa fa-twitter"></a>
    
      <a href="https://www.linkedin.com/in/lastweek/" class="md-footer-social__link fa fa-linkedin"></a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../../assets/javascripts/application.ac79c3b0.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../../.."}})</script>
      
    
  </body>
</html>