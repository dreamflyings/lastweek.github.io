



<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
        <link rel="canonical" href="http://lastweek.io/lego/kernel/irq/">
      
      
        <meta name="author" content="Yizhou Shan">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-0.17.2, mkdocs-material-2.6.2">
    
    
      
        <title>IRQ - Yizhou Shan's Home Page</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/application.9b572555.css">
      
    
    
      <script src="../../../assets/javascripts/modernizr.1aa3b519.js"></script>
    
    
      
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=:300,400,400i,700|Courier">
        <style>body,input{font-family:"","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Courier","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="search">
    <label class="md-overlay" data-md-component="overlay" for="drawer"></label>
    
      <a href="#irq" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="http://lastweek.io" title="Yizhou Shan's Home Page" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                Yizhou Shan's Home Page
              </span>
              <span class="md-header-nav__topic">
                IRQ
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="drawer">
    <span class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </span>
    Yizhou Shan's Home Page
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Notes
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Notes
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/benchmark/" title="Benchmarks" class="md-nav__link">
      Benchmarks
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/paper_perf_shadows/" title="Perf Shadows" class="md-nav__link">
      Perf Shadows
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/cache_coherence/" title="Cache Coherence" class="md-nav__link">
      Cache Coherence
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/paper_fpga/" title="Papers of FPGA" class="md-nav__link">
      Papers of FPGA
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/proc/" title="[Linux] Special Files" class="md-nav__link">
      [Linux] Special Files
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/rmap/" title="[Linux] Reverse Mmap (rmap)" class="md-nav__link">
      [Linux] Reverse Mmap (rmap)
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/trace/" title="[Linux] Trace/Profile" class="md-nav__link">
      [Linux] Trace/Profile
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/cgroup-swap/" title="[Linux] Cgroup and Swap" class="md-nav__link">
      [Linux] Cgroup and Swap
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/userfaultfd/" title="[Linux] Userfaultfd" class="md-nav__link">
      [Linux] Userfaultfd
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/xperf/" title="[Linux] User/kern Cross Perf" class="md-nav__link">
      [Linux] User/kern Cross Perf
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/kvm-basic/" title="[Linux] KVM" class="md-nav__link">
      [Linux] KVM
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../misc/essential/" title="Essential" class="md-nav__link">
      Essential
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../misc/cheatsheet/" title="Cheatsheet" class="md-nav__link">
      Cheatsheet
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-14" type="checkbox" id="nav-2-14">
    
    <label class="md-nav__link" for="nav-2-14">
      Log
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-14">
        Log
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../general_log/0919/" title="Sep 2019" class="md-nav__link">
      Sep 2019
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../general_log/0819/" title="Aug 2019" class="md-nav__link">
      Aug 2019
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../general_log/0719/" title="Jul 2019" class="md-nav__link">
      Jul 2019
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      FPGA
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        FPGA
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../fpga/hls_axi/" title="HLS: Usage of AXI-Stream" class="md-nav__link">
      HLS: Usage of AXI-Stream
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../fpga/hls_axi/" title="HLS: High-performance AXI-MM" class="md-nav__link">
      HLS: High-performance AXI-MM
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../fpga/vivado_tricks/" title="Vivado Tricks" class="md-nav__link">
      Vivado Tricks
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4" checked>
    
    <label class="md-nav__link" for="nav-4">
      LegoOS-Dev
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        LegoOS-Dev
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-1" type="checkbox" id="nav-4-1">
    
    <label class="md-nav__link" for="nav-4-1">
      Log
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-4-1">
        Log
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../log/TODO/" title="TODO" class="md-nav__link">
      TODO
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../log/misc/" title="MISC" class="md-nav__link">
      MISC
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../log/test-note/" title="Test Script" class="md-nav__link">
      Test Script
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../log/log-09-2018/" title="Sep 2018" class="md-nav__link">
      Sep 2018
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../log/log-08-2018/" title="Aug 2018" class="md-nav__link">
      Aug 2018
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../log/log-04-2018/" title="April 2018" class="md-nav__link">
      April 2018
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../log/log-03-2018/" title="March 2018" class="md-nav__link">
      March 2018
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../log/log-02-2018/" title="Feb 2018" class="md-nav__link">
      Feb 2018
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-2" type="checkbox" id="nav-4-2" checked>
    
    <label class="md-nav__link" for="nav-4-2">
      Kernel
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-4-2">
        Kernel
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../kconfig/" title="Kconfig" class="md-nav__link">
      Kconfig
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../debug/" title="Debug" class="md-nav__link">
      Debug
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../grub/" title="GRUB" class="md-nav__link">
      GRUB
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../profile/" title="Profile" class="md-nav__link">
      Profile
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../profile_strace/" title="Profile strace" class="md-nav__link">
      Profile strace
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../profile_heatmap/" title="Profile heatmap" class="md-nav__link">
      Profile heatmap
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../profile_points/" title="Profile points" class="md-nav__link">
      Profile points
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../trampoline/" title="Trampoline" class="md-nav__link">
      Trampoline
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../pagefault_disable/" title="Disable pgfault" class="md-nav__link">
      Disable pgfault
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../stop_machine/" title="Stop machine" class="md-nav__link">
      Stop machine
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../loader/" title="Program Loader" class="md-nav__link">
      Program Loader
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../vDSO/" title="vDSO" class="md-nav__link">
      vDSO
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../vfs/" title="Virtual File System" class="md-nav__link">
      Virtual File System
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../vm/" title="Process Virtual Memory" class="md-nav__link">
      Process Virtual Memory
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../fpu/" title="x86 FPU" class="md-nav__link">
      x86 FPU
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="toc">
        IRQ
      </label>
    
    <a href="./" title="IRQ" class="md-nav__link md-nav__link--active">
      IRQ
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#init" title="Init" class="md-nav__link">
    Init
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#irq-domain" title="IRQ Domain" class="md-nav__link">
    IRQ Domain
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aug-20-2018" title="Aug 20, 2018" class="md-nav__link">
    Aug 20, 2018
  </a>
  
</li>
      
      
      
      
      
        <li class="md-nav__item">
          <a href="#__comments" title="Comments" class="md-nav__link md-nav__link--active">
            Comments
          </a>
        </li>
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../net_thpool/" title="Network Thpool" class="md-nav__link">
      Network Thpool
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-3" type="checkbox" id="nav-4-3">
    
    <label class="md-nav__link" for="nav-4-3">
      Syscall
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-4-3">
        Syscall
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../syscall/facts/" title="Facts" class="md-nav__link">
      Facts
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../profile_strace/" title="strace" class="md-nav__link">
      strace
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../syscall/compat/" title="compat" class="md-nav__link">
      compat
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../syscall/msync/" title="msync()" class="md-nav__link">
      msync()
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../syscall/mremap/" title="mremap()" class="md-nav__link">
      mremap()
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../syscall/fork/" title="fork()" class="md-nav__link">
      fork()
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../syscall/getrusage/" title="getrusage()" class="md-nav__link">
      getrusage()
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../syscall/wait_and_exit/" title="wait4 and exit()" class="md-nav__link">
      wait4 and exit()
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-4" type="checkbox" id="nav-4-4">
    
    <label class="md-nav__link" for="nav-4-4">
      Pcache
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-4-4">
        Pcache
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/config/" title="Config" class="md-nav__link">
      Config
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/sweep/" title="Sweep" class="md-nav__link">
      Sweep
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/tlb/" title="TLB Coherence" class="md-nav__link">
      TLB Coherence
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/pgtable-lock/" title="PageTable Lock" class="md-nav__link">
      PageTable Lock
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/victim/" title="Victim Cache" class="md-nav__link">
      Victim Cache
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/virtual_cache/" title="Virtual Cache" class="md-nav__link">
      Virtual Cache
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/rmap/" title="Reverse Mapping" class="md-nav__link">
      Reverse Mapping
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/evict_and_ref/" title="Evict and Refcount" class="md-nav__link">
      Evict and Refcount
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/smp_design/" title="SMP Design" class="md-nav__link">
      SMP Design
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/replication/" title="Replication" class="md-nav__link">
      Replication
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-5" type="checkbox" id="nav-4-5">
    
    <label class="md-nav__link" for="nav-4-5">
      Driver
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-4-5">
        Driver
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../driver/pci/" title="PCI" class="md-nav__link">
      PCI
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../driver/ib/" title="Infiniband" class="md-nav__link">
      Infiniband
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-6" type="checkbox" id="nav-4-6">
    
    <label class="md-nav__link" for="nav-4-6">
      Paper
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-4-6">
        Paper
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../paper/nmp/" title="NMP" class="md-nav__link">
      NMP
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../paper/processor_oom/" title="Processor OOM" class="md-nav__link">
      Processor OOM
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../paper/genz/" title="Gen-Z" class="md-nav__link">
      Gen-Z
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../paper/replication/" title="Replication" class="md-nav__link">
      Replication
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../paper/related/" title="Related" class="md-nav__link">
      Related
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#init" title="Init" class="md-nav__link">
    Init
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#irq-domain" title="IRQ Domain" class="md-nav__link">
    IRQ Domain
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aug-20-2018" title="Aug 20, 2018" class="md-nav__link">
    Aug 20, 2018
  </a>
  
</li>
      
      
      
      
      
        <li class="md-nav__item">
          <a href="#__comments" title="Comments" class="md-nav__link md-nav__link--active">
            Comments
          </a>
        </li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="irq">IRQ<a class="headerlink" href="#irq" title="Permanent link">&para;</a></h1>
<p>IRQ is majorly ported based on <code class="codehilite">linux-4.4</code>. The decision of porting of whole IRQ stack from linux was made at early stage of Lego, when I&rsquo;m not so familiar with this stuff. This technique decision has pros and cons.</p>
<p>The whole thing is made complicated by having IRQ domain. IRQ domain is introduced to address the multiple interrupt controller issue. And in x86, we kind of have mutiple as well: IO-APIC, REMAP, LAPIC. Although we are not supporting IRQ remap now.</p>
<h2 id="init">Init<a class="headerlink" href="#init" title="Permanent link">&para;</a></h2>
<ul>
<li>The first part of initialization is <code class="codehilite">trap_init()</code> at early <code class="codehilite">setup_arch()</code>.</li>
<li>The second major entry point is <code class="codehilite">irq_init()</code> at <code class="codehilite">start_kernel()</code>. This <code class="codehilite">irq_init()</code> is actually a combination of linux&rsquo;s:<ul>
<li><code class="codehilite">early_irq_init()</code>: 1) setup <code class="codehilite">irq_desc[]</code> array, and then call <code class="codehilite">arch_early_irq_init()</code>, which will register two IRQ domains (x86_vector_domain, msi_domain).</li>
<li><code class="codehilite">init_IRQ()</code>: is actually a callback to low-level x86 interrupt setup. It mainly setup the desc&rsquo;s data/chip etc, and register all different handlers.</li>
<li>In Lego, you will be able to find all the functionalitis are moved into <code class="codehilite">arch_irq_init()</code>. And, to this point, we have a complete setup.</li>
</ul>
</li>
<li>The third (and last) entry point is <code class="codehilite">smp_prepare_cpus()</code>:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>smp_prepare_cpus()
-&gt; apic_bsp_setup()
   -&gt; setup_local_APIC()
   -&gt; setup_IO_APIC()
   -&gt; x86_init.timers.setup_percpu_clockev()
</pre></div>
</td></tr></table></li>
</ul>
<h2 id="irq-domain">IRQ Domain<a class="headerlink" href="#irq-domain" title="Permanent link">&para;</a></h2>
<p>We should have at least 2 or 3 IRQ domains:</p>
<ul>
<li>x86_vector</li>
<li>x86_msi</li>
<li>x86_ioapic-N (each ioapic has one)</li>
</ul>
<p>The first two guys are created during <code class="codehilite">arch_irq_init()</code>. While the latter ioapic ones are created during <code class="codehilite">setup_IO_APIC()</code>. All of them are allocated eventually by <code class="codehilite">__irq_domain_add()</code>, and linked at <code class="codehilite">LIST_HEAD(irq_domain_list)</code>.</p>
<p>So....  Lego or Linux maintains its own IRQ numbers, starting from 0 to NR_IRQs.
However, this IRQ number MAY not have a identical mapping to hardware&rsquo;s own IRQ number (let us call it hwirq). Given this, we want to know the mapping between IRQ and hwirq. That&rsquo;s the purpose of having <code class="codehilite">linear_revmap</code> and <code class="codehilite">revmap_tree</code> within each domain, it is used to translate hwirq to IRQ.</p>
<p>Why two different data structures? <code class="codehilite">linear_revmap</code> is fairly simple, an array, which is indexed by hwirq. However, the hwirq maybe very large, we don&rsquo;t want to waste memory, that&rsquo;s how we want to use trees.</p>
<p>These two can be used together. If we fail to insert into <code class="codehilite">linear_revmap</code>, we insert into tree. During search time, we need to look up both.</p>
<p>By default, <code class="codehilite">x86_vector</code> and <code class="codehilite">x86_msi</code> use radix tree only. <code class="codehilite">x86_ioapic-N</code> uses a mix of linear and radix tree.</p>
<p>To dump all IRQ domains, call <code class="codehilite">dump_irq_domain_list()</code>, which give you something like this:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="p">[</span>  <span class="mf">118.308544</span><span class="p">]</span>  <span class="n">name</span>              <span class="n">mapped</span>  <span class="n">linear</span><span class="o">-</span><span class="n">max</span>  <span class="n">direct</span><span class="o">-</span><span class="n">max</span>  <span class="n">devtree</span><span class="o">-</span><span class="n">node</span>
<span class="p">[</span>  <span class="mf">118.316114</span><span class="p">]</span>  <span class="n">x86_ioapic</span><span class="o">-</span><span class="mi">2</span>          <span class="mi">24</span>          <span class="mi">24</span>           <span class="mi">0</span>    
<span class="p">[</span>  <span class="mf">118.322707</span><span class="p">]</span>  <span class="n">x86_ioapic</span><span class="o">-</span><span class="mi">1</span>          <span class="mi">24</span>          <span class="mi">24</span>           <span class="mi">0</span>    
<span class="p">[</span>  <span class="mf">118.329299</span><span class="p">]</span>  <span class="n">x86_ioapic</span><span class="o">-</span><span class="mi">0</span>          <span class="mi">24</span>          <span class="mi">24</span>           <span class="mi">0</span>    
<span class="p">[</span>  <span class="mf">118.335893</span><span class="p">]</span>  <span class="n">x86_msi</span>               <span class="mi">25</span>           <span class="mi">0</span>           <span class="mi">0</span>    
<span class="p">[</span>  <span class="mf">118.342486</span><span class="p">]</span> <span class="o">*</span><span class="n">x86_vector</span>            <span class="mi">40</span>           <span class="mi">0</span>           <span class="mi">0</span>    
<span class="p">[</span>  <span class="mf">118.349078</span><span class="p">]</span> <span class="n">irq</span>    <span class="n">hwirq</span>    <span class="n">chip</span> <span class="n">name</span>        <span class="n">chip</span> <span class="n">data</span>           <span class="n">active</span>  <span class="n">type</span>            <span class="n">domain</span>
<span class="p">[</span>  <span class="mf">118.358775</span><span class="p">]</span>     <span class="mi">1</span>  <span class="mh">0x00001</span>  <span class="n">IO</span><span class="o">-</span><span class="n">APIC</span>          <span class="mh">0xffff88107fcae000</span>        <span class="n">LINEAR</span>          <span class="n">x86_ioapic</span><span class="o">-</span><span class="mi">0</span>
<span class="p">[</span>  <span class="mf">118.368858</span><span class="p">]</span>     <span class="mi">3</span>  <span class="mh">0x00003</span>  <span class="n">IO</span><span class="o">-</span><span class="n">APIC</span>          <span class="mh">0xffff88107fc8f000</span>        <span class="n">LINEAR</span>          <span class="n">x86_ioapic</span><span class="o">-</span><span class="mi">0</span>
<span class="p">[</span>  <span class="mf">118.378940</span><span class="p">]</span>     <span class="mi">4</span>  <span class="mh">0x00004</span>  <span class="n">IO</span><span class="o">-</span><span class="n">APIC</span>          <span class="mh">0xffff88107fc6e000</span>        <span class="n">LINEAR</span>          <span class="n">x86_ioapic</span><span class="o">-</span><span class="mi">0</span>
<span class="p">[</span>  <span class="mf">118.389025</span><span class="p">]</span>     <span class="mi">5</span>  <span class="mh">0x00005</span>  <span class="n">IO</span><span class="o">-</span><span class="n">APIC</span>          <span class="mh">0xffff88107fc6f000</span>        <span class="n">LINEAR</span>          <span class="n">x86_ioapic</span><span class="o">-</span><span class="mi">0</span>
<span class="p">[</span>  <span class="mf">118.399109</span><span class="p">]</span>     <span class="mi">6</span>  <span class="mh">0x00006</span>  <span class="n">IO</span><span class="o">-</span><span class="n">APIC</span>          <span class="mh">0xffff88107fc4e000</span>        <span class="n">LINEAR</span>          <span class="n">x86_ioapic</span><span class="o">-</span><span class="mi">0</span>
<span class="p">[</span>  <span class="mf">118.409192</span><span class="p">]</span>     <span class="mi">7</span>  <span class="mh">0x00007</span>  <span class="n">IO</span><span class="o">-</span><span class="n">APIC</span>          <span class="mh">0xffff88107fc4f000</span>        <span class="n">LINEAR</span>          <span class="n">x86_ioapic</span><span class="o">-</span><span class="mi">0</span>
<span class="p">[</span>  <span class="mf">118.419276</span><span class="p">]</span>     <span class="mi">8</span>  <span class="mh">0x00008</span>  <span class="n">IO</span><span class="o">-</span><span class="n">APIC</span>          <span class="mh">0xffff88107fc2e000</span>        <span class="n">LINEAR</span>          <span class="n">x86_ioapic</span><span class="o">-</span><span class="mi">0</span>
<span class="p">[</span>  <span class="mf">118.429358</span><span class="p">]</span>     <span class="mi">9</span>  <span class="mh">0x00009</span>  <span class="n">IO</span><span class="o">-</span><span class="n">APIC</span>          <span class="mh">0xffff88107fc2f000</span>        <span class="n">LINEAR</span>          <span class="n">x86_ioapic</span><span class="o">-</span><span class="mi">0</span>
<span class="p">[</span>  <span class="mf">118.439442</span><span class="p">]</span>    <span class="mi">10</span>  <span class="mh">0x0000a</span>  <span class="n">IO</span><span class="o">-</span><span class="n">APIC</span>          <span class="mh">0xffff88107fc0e000</span>        <span class="n">LINEAR</span>          <span class="n">x86_ioapic</span><span class="o">-</span><span class="mi">0</span>
<span class="p">[</span>  <span class="mf">118.449525</span><span class="p">]</span>    <span class="mi">11</span>  <span class="mh">0x0000b</span>  <span class="n">IO</span><span class="o">-</span><span class="n">APIC</span>          <span class="mh">0xffff88107fc0f000</span>        <span class="n">LINEAR</span>          <span class="n">x86_ioapic</span><span class="o">-</span><span class="mi">0</span>
<span class="p">[</span>  <span class="mf">118.459609</span><span class="p">]</span>    <span class="mi">12</span>  <span class="mh">0x0000c</span>  <span class="n">IO</span><span class="o">-</span><span class="n">APIC</span>          <span class="mh">0xffff88107fff0000</span>        <span class="n">LINEAR</span>          <span class="n">x86_ioapic</span><span class="o">-</span><span class="mi">0</span>
<span class="p">[</span>  <span class="mf">118.469692</span><span class="p">]</span>    <span class="mi">13</span>  <span class="mh">0x0000d</span>  <span class="n">IO</span><span class="o">-</span><span class="n">APIC</span>          <span class="mh">0xffff88107fff1000</span>        <span class="n">LINEAR</span>          <span class="n">x86_ioapic</span><span class="o">-</span><span class="mi">0</span>
<span class="p">[</span>  <span class="mf">118.479776</span><span class="p">]</span>    <span class="mi">14</span>  <span class="mh">0x0000e</span>  <span class="n">IO</span><span class="o">-</span><span class="n">APIC</span>          <span class="mh">0xffff88107fff2000</span>        <span class="n">LINEAR</span>          <span class="n">x86_ioapic</span><span class="o">-</span><span class="mi">0</span>
<span class="p">[</span>  <span class="mf">118.489860</span><span class="p">]</span>    <span class="mi">15</span>  <span class="mh">0x0000f</span>  <span class="n">IO</span><span class="o">-</span><span class="n">APIC</span>          <span class="mh">0xffff88107fff3000</span>        <span class="n">LINEAR</span>          <span class="n">x86_ioapic</span><span class="o">-</span><span class="mi">0</span>
<span class="p">[</span>  <span class="mf">118.499943</span><span class="p">]</span>    <span class="mi">24</span>  <span class="mh">0x300000</span>  <span class="n">PCI</span><span class="o">-</span><span class="n">MSI</span>                      <span class="p">(</span><span class="n">null</span><span class="p">)</span>     <span class="o">*</span>     <span class="n">RADIX</span>          <span class="n">x86_msi</span>
<span class="p">[</span>  <span class="mf">118.509833</span><span class="p">]</span>    <span class="mi">25</span>  <span class="mh">0x300001</span>  <span class="n">PCI</span><span class="o">-</span><span class="n">MSI</span>                      <span class="p">(</span><span class="n">null</span><span class="p">)</span>     <span class="o">*</span>     <span class="n">RADIX</span>          <span class="n">x86_msi</span>
<span class="p">[</span>  <span class="mf">118.519722</span><span class="p">]</span>    <span class="mi">26</span>  <span class="mh">0x300002</span>  <span class="n">PCI</span><span class="o">-</span><span class="n">MSI</span>                      <span class="p">(</span><span class="n">null</span><span class="p">)</span>     <span class="o">*</span>     <span class="n">RADIX</span>          <span class="n">x86_msi</span>
<span class="p">[</span>  <span class="mf">118.529612</span><span class="p">]</span>    <span class="mi">27</span>  <span class="mh">0x300003</span>  <span class="n">PCI</span><span class="o">-</span><span class="n">MSI</span>                      <span class="p">(</span><span class="n">null</span><span class="p">)</span>     <span class="o">*</span>     <span class="n">RADIX</span>          <span class="n">x86_msi</span>
<span class="p">[</span>  <span class="mf">118.539501</span><span class="p">]</span>    <span class="mi">28</span>  <span class="mh">0x300004</span>  <span class="n">PCI</span><span class="o">-</span><span class="n">MSI</span>                      <span class="p">(</span><span class="n">null</span><span class="p">)</span>           <span class="n">RADIX</span>          <span class="n">x86_msi</span>
</pre></div>
</td></tr></table></p>
<h2 id="aug-20-2018">Aug 20, 2018<a class="headerlink" href="#aug-20-2018" title="Permanent link">&para;</a></h2>
<p>Well, I&rsquo;ve ported the IRQ stuff at early days of Lego. At that time, I mainly ported the low-level APIC, IO-APIC, and ACPI stuff, along with the upper layer irqchip, irqdesc stuff.</p>
<p>These days, I was verifying our IB code and tried to add back mlx4en&rsquo;s interrupt handler, somehow, there is no interrupt after <code class="codehilite">request_irq()</code>.</p>
<p>Two possible reasons: 1) I missed something during PCI setup, 2) underlying APIC and IO-APIC need more work.</p>
<p>&ndash;
Last Updated: Aug 28, 2018</p>
                
                  
                
              
              
                
                  


  <h2 id="__comments">Comments</h2>
  <div id="disqus_thread"></div>
  <script>
    var disqus_config = function () {
      this.page.url = "http://lastweek.io/lego/kernel/irq/";
      this.page.identifier =
        "/lego/kernel/irq/";
    };
    (function() {
      var d = document, s = d.createElement("script");
      s.src = "//lastweek-io.disqus.com/embed.js";
      s.setAttribute("data-timestamp", +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>

                
              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../fpu/" title="x86 FPU" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                x86 FPU
              </span>
            </div>
          </a>
        
        
          <a href="../net_thpool/" title="Network Thpool" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Network Thpool
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="http://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
  <div class="md-footer-social">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    
      <a href="https://github.com/lastweek" class="md-footer-social__link fa fa-github"></a>
    
  </div>

      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../../assets/javascripts/application.abd7b172.js"></script>
      
      <script>app.initialize({version:"0.17.2",url:{base:"../../.."}})</script>
      
    
    
      
        <script>!function(e,a,t,n,o,c,i){e.GoogleAnalyticsObject=o,e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=1*new Date,c=a.createElement(t),i=a.getElementsByTagName(t)[0],c.async=1,c.src="https://www.google-analytics.com/analytics.js",i.parentNode.insertBefore(c,i)}(window,document,"script",0,"ga"),ga("create","UA-143772066-1","auto"),ga("set","anonymizeIp",!0),ga("send","pageview");var links=document.getElementsByTagName("a");if(Array.prototype.map.call(links,function(e){e.host!=document.location.host&&e.addEventListener("click",function(){var a=e.getAttribute("data-md-action")||"follow";ga("send","event","outbound",a,e.href)})}),document.forms.search){var query=document.forms.search.query;query.addEventListener("blur",function(){if(this.value){var e=document.location.pathname;ga("send","pageview",e+"?q="+this.value)}})}</script>
      
    
  </body>
</html>