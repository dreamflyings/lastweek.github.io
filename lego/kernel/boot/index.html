



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
        <link rel="canonical" href="http://lastweek.io/lego/kernel/boot/">
      
      
        <meta name="author" content="Yizhou Shan">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.4.3">
    
    
      
        <title>GRUB2 and Boot - Yizhou Shan's Home Page</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/application.30686662.css">
      
      
    
    
      <script src="../../../assets/javascripts/modernizr.74668098.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,400i,700|&display=fallback">
        <style>body,input{font-family:"Open Sans","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../../assets/fonts/material-icons.css">
    
    
    
      
        
<script>
  window.ga = window.ga || function() {
    (ga.q = ga.q || []).push(arguments)
  }
  ga.l = +new Date
  /* Setup integration and send page view */
  ga("create", "UA-143772066-1", "auto")
  ga("set", "anonymizeIp", true)
  ga("send", "pageview")
  /* Register handler to log search on blur */
  document.addEventListener("DOMContentLoaded", () => {
    if (document.forms.search) {
      var query = document.forms.search.query
      query.addEventListener("blur", function() {
        if (this.value) {
          var path = document.location.pathname;
          ga("send", "pageview", path + "?q=" + this.value)
        }
      })
    }
  })
</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#notes-on-grub2-and-boot-sequence" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="http://lastweek.io" title="Yizhou Shan's Home Page" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Yizhou Shan's Home Page
            </span>
            <span class="md-header-nav__topic">
              
                GRUB2 and Boot
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="http://lastweek.io" title="Yizhou Shan's Home Page" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Yizhou Shan's Home Page
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Blog
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Blog
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../blog/20200501-on-graphic-softwares/" title="2020-05 On-Unix-Graphic-Softwares" class="md-nav__link">
      2020-05 On-Unix-Graphic-Softwares
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../blog/20200404-on-read-once/" title="2020-04 On-Read-Once-and-Compiler-Opts" class="md-nav__link">
      2020-04 On-Read-Once-and-Compiler-Opts
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../blog/20200404-on-net-transport/" title="2020-04 On-Hardware-based-Network-Transport" class="md-nav__link">
      2020-04 On-Hardware-based-Network-Transport
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Notes
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Notes
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/source_code/" title="Open-Source-Code-Study" class="md-nav__link">
      Open-Source-Code-Study
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/program_advice/" title="Programming-Guidelines-and-Advice" class="md-nav__link">
      Programming-Guidelines-and-Advice
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/virt/" title="Virtualization-Software" class="md-nav__link">
      Virtualization-Software
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/cache_coherence/" title="Practical-Cache-Coherence" class="md-nav__link">
      Practical-Cache-Coherence
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/xperf/" title="Measure-x86-Ring-Switch-Overhead" class="md-nav__link">
      Measure-x86-Ring-Switch-Overhead
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/paper_perf_shadows/" title="Performance-Shadows" class="md-nav__link">
      Performance-Shadows
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/rmap/" title="Linux Reverse Map (rmap)" class="md-nav__link">
      Linux Reverse Map (rmap)
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/userfaultfd/" title="Linux Userfaultfd" class="md-nav__link">
      Linux Userfaultfd
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/trace/" title="Linux Trace/Profile" class="md-nav__link">
      Linux Trace/Profile
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/cgroup-swap/" title="Linux Cgroup and Swap" class="md-nav__link">
      Linux Cgroup and Swap
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/proc/" title="Linux Special Files" class="md-nav__link">
      Linux Special Files
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/linux-resource/" title="Linux Resource" class="md-nav__link">
      Linux Resource
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/kvm-basic/" title="Linux KVM" class="md-nav__link">
      Linux KVM
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../misc/essential/" title="Essential" class="md-nav__link">
      Essential
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/benchmark/" title="Benchmarks" class="md-nav__link">
      Benchmarks
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../misc/cheatsheet/" title="Cheatsheet" class="md-nav__link">
      Cheatsheet
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      FPGA
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        FPGA
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/paper_fpga/" title="Papers" class="md-nav__link">
      Papers
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../fpga/bitstream/" title="Bitstream Explained" class="md-nav__link">
      Bitstream Explained
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../fpga/pr/" title="Morphous PR" class="md-nav__link">
      Morphous PR
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../fpga/vivado/" title="Vivado Practice" class="md-nav__link">
      Vivado Practice
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../fpga/hls_axi/" title="Efficient AXI-MM" class="md-nav__link">
      Efficient AXI-MM
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5" checked>
    
    <label class="md-nav__link" for="nav-5">
      LegoOS
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        LegoOS
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-1" type="checkbox" id="nav-5-1" checked>
    
    <label class="md-nav__link" for="nav-5-1">
      Kernel
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-1">
        Kernel
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        GRUB2 and Boot
      </label>
    
    <a href="./" title="GRUB2 and Boot" class="md-nav__link md-nav__link--active">
      GRUB2 and Boot
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#about-grub2" class="md-nav__link">
    About GRUB2
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#linux-vs-linux16" class="md-nav__link">
    linux v.s. linux16
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#boot-protocol-and-sequence" class="md-nav__link">
    Boot Protocol and Sequence
  </a>
  
</li>
      
      
      
      
      
        <li class="md-nav__item">
          <a href="#__comments" class="md-nav__link md-nav__link--active">
            Comments
          </a>
        </li>
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../kconfig/" title="Kconfig" class="md-nav__link">
      Kconfig
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../debug/" title="Debug" class="md-nav__link">
      Debug
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../grub/" title="GRUB" class="md-nav__link">
      GRUB
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../profile/" title="Profile" class="md-nav__link">
      Profile
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../profile_strace/" title="Profile strace" class="md-nav__link">
      Profile strace
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../profile_heatmap/" title="Profile heatmap" class="md-nav__link">
      Profile heatmap
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../profile_points/" title="Profile points" class="md-nav__link">
      Profile points
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../trampoline/" title="Trampoline" class="md-nav__link">
      Trampoline
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../pagefault_disable/" title="Disable pgfault" class="md-nav__link">
      Disable pgfault
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../stop_machine/" title="Stop machine" class="md-nav__link">
      Stop machine
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../loader/" title="Program Loader" class="md-nav__link">
      Program Loader
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../vDSO/" title="vDSO" class="md-nav__link">
      vDSO
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../vfs/" title="Virtual File System" class="md-nav__link">
      Virtual File System
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../vm/" title="Process Virtual Memory" class="md-nav__link">
      Process Virtual Memory
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../fpu/" title="x86 FPU" class="md-nav__link">
      x86 FPU
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../irq/" title="IRQ" class="md-nav__link">
      IRQ
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../net_thpool/" title="Network Thpool" class="md-nav__link">
      Network Thpool
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-2" type="checkbox" id="nav-5-2">
    
    <label class="md-nav__link" for="nav-5-2">
      Syscall
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-2">
        Syscall
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../syscall/facts/" title="Facts" class="md-nav__link">
      Facts
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../profile_strace/" title="strace" class="md-nav__link">
      strace
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../syscall/compat/" title="compat" class="md-nav__link">
      compat
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../syscall/msync/" title="msync()" class="md-nav__link">
      msync()
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../syscall/mremap/" title="mremap()" class="md-nav__link">
      mremap()
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../syscall/fork/" title="fork()" class="md-nav__link">
      fork()
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../syscall/getrusage/" title="getrusage()" class="md-nav__link">
      getrusage()
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../syscall/wait_and_exit/" title="wait4 and exit()" class="md-nav__link">
      wait4 and exit()
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-3" type="checkbox" id="nav-5-3">
    
    <label class="md-nav__link" for="nav-5-3">
      Pcache
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-3">
        Pcache
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/config/" title="Config" class="md-nav__link">
      Config
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/sweep/" title="Sweep" class="md-nav__link">
      Sweep
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/tlb/" title="TLB Coherence" class="md-nav__link">
      TLB Coherence
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/pgtable-lock/" title="PageTable Lock" class="md-nav__link">
      PageTable Lock
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/victim/" title="Victim Cache" class="md-nav__link">
      Victim Cache
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/virtual_cache/" title="Virtual Cache" class="md-nav__link">
      Virtual Cache
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/rmap/" title="Reverse Mapping" class="md-nav__link">
      Reverse Mapping
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/evict_and_ref/" title="Evict and Refcount" class="md-nav__link">
      Evict and Refcount
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/smp_design/" title="SMP Design" class="md-nav__link">
      SMP Design
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/replication/" title="Replication" class="md-nav__link">
      Replication
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-4" type="checkbox" id="nav-5-4">
    
    <label class="md-nav__link" for="nav-5-4">
      Driver
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-4">
        Driver
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../driver/pci/" title="PCI" class="md-nav__link">
      PCI
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../driver/ib/" title="Infiniband" class="md-nav__link">
      Infiniband
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-5" type="checkbox" id="nav-5-5">
    
    <label class="md-nav__link" for="nav-5-5">
      Paper
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-5">
        Paper
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../paper/nmp/" title="NMP" class="md-nav__link">
      NMP
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../paper/processor_oom/" title="Processor OOM" class="md-nav__link">
      Processor OOM
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../paper/genz/" title="Gen-Z" class="md-nav__link">
      Gen-Z
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../paper/replication/" title="Replication" class="md-nav__link">
      Replication
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../paper/related/" title="Related" class="md-nav__link">
      Related
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#about-grub2" class="md-nav__link">
    About GRUB2
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#linux-vs-linux16" class="md-nav__link">
    linux v.s. linux16
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#boot-protocol-and-sequence" class="md-nav__link">
    Boot Protocol and Sequence
  </a>
  
</li>
      
      
      
      
      
        <li class="md-nav__item">
          <a href="#__comments" class="md-nav__link md-nav__link--active">
            Comments
          </a>
        </li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="notes-on-grub2-and-boot-sequence">Notes on GRUB2 and Boot Sequence<a class="headerlink" href="#notes-on-grub2-and-boot-sequence" title="Permanent link">&para;</a></h1>
<details class="note"><summary>Version History</summary><table>
<thead>
<tr>
<th align="left">Date</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">Mar 31, 2020</td>
<td>Copied from <a href="https://github.com/lastweek/source-grub2">https://github.com/lastweek/source-grub2</a>.</td>
</tr>
</tbody>
</table>
</details>
<h2 id="about-grub2">About GRUB2<a class="headerlink" href="#about-grub2" title="Permanent link">&para;</a></h2>
<p>GRUB2: <a href="https://www.gnu.org/software/grub/manual/grub/grub.html#Introduction">https://www.gnu.org/software/grub/manual/grub/grub.html#Introduction</a></p>
<p>Source code: <a href="https://github.com/lastweek/source-grub2">https://github.com/lastweek/source-grub2</a></p>
<h3 id="linux-vs-linux16">linux v.s. linux16<a class="headerlink" href="#linux-vs-linux16" title="Permanent link">&para;</a></h3>
<p>An interesting thing is that there are two ways to
load an kernel image in <code class="codehilite"><span class="n">grub</span><span class="p">.</span><span class="n">cfg</span></code>, either
<code class="codehilite"><span class="n">linux</span> <span class="n">vmlinuz</span><span class="o">-</span><span class="mi">3</span><span class="p">.</span><span class="mi">10</span><span class="p">.</span><span class="mi">0</span></code> or <code class="codehilite"><span class="n">linux16</span> <span class="n">vmlinuz</span><span class="o">-</span><span class="mi">3</span><span class="p">.</span><span class="mi">10</span><span class="p">.</span><span class="mi">0</span></code>.
They have different effects, but not sure what are those differences.
I remember only the linux16 one works for me,
but not remembering why either. At least on CentOS 7, it&rsquo;s all linux16.</p>
<p>The <code class="codehilite"><span class="n">linux16</span></code> and <code class="codehilite"><span class="n">initrd16</span></code> in <code class="codehilite"><span class="n">grub</span><span class="o">-</span><span class="n">core</span><span class="o">/</span><span class="n">loader</span><span class="o">/</span><span class="n">i386</span><span class="o">/</span><span class="n">pc</span><span class="o">/</span><span class="n">linux</span><span class="p">.</span><span class="k">c</span></code>:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">GRUB_MOD_INIT</span><span class="p">(</span><span class="n">linux16</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">cmd_linux</span> <span class="o">=</span>
    <span class="n">grub_register_command</span> <span class="p">(</span><span class="s">&quot;linux16&quot;</span><span class="p">,</span> <span class="n">grub_cmd_linux</span><span class="p">,</span>
               <span class="mi">0</span><span class="p">,</span> <span class="n">N_</span><span class="p">(</span><span class="s">&quot;Load Linux.&quot;</span><span class="p">));</span>
  <span class="n">cmd_initrd</span> <span class="o">=</span>
    <span class="n">grub_register_command</span> <span class="p">(</span><span class="s">&quot;initrd16&quot;</span><span class="p">,</span> <span class="n">grub_cmd_initrd</span><span class="p">,</span>
               <span class="mi">0</span><span class="p">,</span> <span class="n">N_</span><span class="p">(</span><span class="s">&quot;Load initrd.&quot;</span><span class="p">));</span>
  <span class="n">my_mod</span> <span class="o">=</span> <span class="n">mod</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></p>
<p>The <code class="codehilite"><span class="n">linux</span></code> and <code class="codehilite"><span class="n">initrd</span></code> in <code class="codehilite"><span class="n">grub</span><span class="o">-</span><span class="n">core</span><span class="o">/</span><span class="n">loader</span><span class="o">/</span><span class="n">i386</span><span class="o">/</span><span class="n">linux</span><span class="p">.</span><span class="k">c</span></code>:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="k">static</span> <span class="n">grub_command_t</span> <span class="n">cmd_linux</span><span class="p">,</span> <span class="n">cmd_initrd</span><span class="p">;</span>

<span class="n">GRUB_MOD_INIT</span><span class="p">(</span><span class="n">linux</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">cmd_linux</span> <span class="o">=</span> <span class="n">grub_register_command</span> <span class="p">(</span><span class="s">&quot;linux&quot;</span><span class="p">,</span> <span class="n">grub_cmd_linux</span><span class="p">,</span>
                     <span class="mi">0</span><span class="p">,</span> <span class="n">N_</span><span class="p">(</span><span class="s">&quot;Load Linux.&quot;</span><span class="p">));</span>
  <span class="n">cmd_initrd</span> <span class="o">=</span> <span class="n">grub_register_command</span> <span class="p">(</span><span class="s">&quot;initrd&quot;</span><span class="p">,</span> <span class="n">grub_cmd_initrd</span><span class="p">,</span>
                      <span class="mi">0</span><span class="p">,</span> <span class="n">N_</span><span class="p">(</span><span class="s">&quot;Load initrd.&quot;</span><span class="p">));</span>
  <span class="n">my_mod</span> <span class="o">=</span> <span class="n">mod</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></p>
<h2 id="boot-protocol-and-sequence">Boot Protocol and Sequence<a class="headerlink" href="#boot-protocol-and-sequence" title="Permanent link">&para;</a></h2>
<p>This was written for <a href="https://github.com/lastweek/source-grub2">https://github.com/lastweek/source-grub2</a>. I just copied it here.</p>
<p>Linux (x86) has a boot protocol, described by <a href="https://www.kernel.org/doc/html/latest/x86/boot.html">https://www.kernel.org/doc/html/latest/x86/boot.html</a>.
Essentially, it is a contiguous memory region, just like a big C <code class="codehilite"><span class="n">struct</span></code>:
some fields are filled by kernel duing compile time (<code class="codehilite"><span class="n">arch</span><span class="o">/</span><span class="n">x86</span><span class="o">/</span><span class="n">boot</span><span class="o">/</span><span class="n">tools</span><span class="o">/</span><span class="n">build</span><span class="p">.</span><span class="k">c</span></code> and some in code),
some fields are filled by GRUB2 during boot time to tell kernel some
important addresses, e.g., kernel parameters, ramdisk locations etc.</p>
<p>GRUB2 code follows the protocol, and you can partially tell from the <code class="codehilite"><span class="n">grub_cmd_linux</span><span class="p">()</span></code> function.</p>
<p>Last time I working on this was late 2016, I truly spent a lot investigating
how GRUB and linux boot works. I will try to document a bit, if my memory serves:</p>
<ol>
<li>
<p>In the Linux kernel, file <code class="codehilite"><span class="n">arch</span><span class="o">/</span><span class="n">x86</span><span class="o">/</span><span class="n">boot</span><span class="o">/</span><span class="n">header</span><span class="p">.</span><span class="n">S</span></code> is the first file got run after GRUB2.
This file is a bit complicated but not hard to understand!
It has 3 parts.
For the first part, it detects if it was loaded by a bootloader, if not, just by printing an error message and reboot.
It the kernel was loaded by a bootloader like GRUB2, the first part will never execute.
The bootload will directly jump to the second part. This is part of the boot protocol.
For the second part, it lists all the fields described by the boot protocol.
And finally the third part is real-mode instructions that got run after the GRUB2 jumo.
The starting function is called <code class="codehilite"><span class="n">start_of_setup</span></code>, which will do some stack checking,
and then jump to C code in <code class="codehilite"><span class="n">arch</span><span class="o">/</span><span class="n">x86</span><span class="o">/</span><span class="n">boot</span><span class="o">/</span><span class="n">main</span><span class="p">.</span><span class="k">c</span></code>.</p>
</li>
<li>
<p><code class="codehilite"><span class="n">arch</span><span class="o">/</span><span class="n">x86</span><span class="o">/</span><span class="n">boot</span><span class="o">/</span><span class="n">main</span><span class="p">.</span><span class="k">c</span></code> runs on real-mode, it will do some setup and jump to protected-mode (32-bit).
It is running after BIOS but before the actual Linux kernel.
Thus this piece of code must rely on BIOS to do stuff, which makes it very unique.
The major task of the setup code is to prepare the <code class="codehilite"><span class="n">struct</span> <span class="n">boot_params</span></code>, which has all the boot information, some of them were extracted from the <code class="codehilite"><span class="n">header</span><span class="p">.</span><span class="n">S</span></code>. The <code class="codehilite"><span class="n">struct</span> <span class="n">boot_params</span></code> will be passed down and used by many kernel subsystems later on.
The final jump happens in <code class="codehilite"><span class="n">arch</span><span class="o">/</span><span class="n">x86</span><span class="o">/</span><span class="n">boot</span><span class="o">/</span><span class="n">pmjump</span><span class="p">.</span><span class="n">S</span></code>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>        <span class="cp">#</span>
        <span class="cp"># Jump to protected-mode kernel, 0x100000</span>
        <span class="cp"># which is the compressed/head_$(BITS).o</span>
        <span class="cp">#</span>
        <span class="n">jmp</span>     <span class="o">*%</span><span class="n">eax</span>
</pre></div>
</td></tr></table></p>
</li>
<li>
<p>Then, we are in <code class="codehilite"><span class="n">arch</span><span class="o">/</span><span class="n">x86</span><span class="o">/</span><span class="n">boot</span><span class="o">/</span><span class="n">compressed</span><span class="o">/</span><span class="n">head_64</span><span class="p">.</span><span class="n">S</span></code>.
Above pmjump jumps to <code class="codehilite"><span class="n">startup_32</span></code>, it will enable paging, tweak GDT table etc, setup pagetable, and transition to 64-bit entry point <code class="codehilite"><span class="n">startup_64</span></code>. 
And finally, we are in 64-bit. The final jump will go to <code class="codehilite"><span class="n">arch</span><span class="o">/</span><span class="n">x86</span><span class="o">/</span><span class="n">kernel</span><span class="o">/</span><span class="n">head_64</span><span class="p">.</span><span class="n">S</span></code>. We are close!</p>
</li>
<li>
<p>Now we are in <code class="codehilite"><span class="n">arch</span><span class="o">/</span><span class="n">x86</span><span class="o">/</span><span class="n">kernel</span><span class="o">/</span><span class="n">head_64</span><span class="p">.</span><span class="n">S</span></code>. We are in 64-bit. But some further setup is needed. This part is really low-level and engaging. I would never know I how managed to understand and port all this shit. It setup a lot GDT, IDT stuff, and some pgfault handlers. It turns out those early pgfault handlers are NECESSARY and I remember they played an very interesting role! Finally, this assembly will jump to <code class="codehilite"><span class="n">arch</span><span class="o">/</span><span class="n">x86</span><span class="o">/</span><span class="n">kernel</span><span class="o">/</span><span class="n">head64</span><span class="p">.</span><span class="k">c</span></code>, the C code!</p>
<ul>
<li>I guess an interesting part is <code class="codehilite"><span class="n">secondary_startup_64</span></code>. This code is actually run by non-booting CPUs, or secondary CPUs.
  After the major boot CPU is up and running (already within <code class="codehilite"><span class="n">start_kernel</span><span class="p">()</span></code>), I believe its the <code class="codehilite"><span class="n">smp_init</span><span class="p">()</span></code> that will send IPI wakeup interrupts to all present secondary CPUs.
  The secondary CPUs will start from real-mode, obviously. Then they will transition from 16bit to 32bit, from 32bit to 64bit. That code is in <a href="https://github.com/WukLab/LegoOS/blob/master/arch/x86/realmode/rm/trampoline.S"><code class="codehilite"><span class="n">arch</span><span class="o">/</span><span class="n">x86</span><span class="o">/</span><span class="n">realmode</span><span class="o">/</span><span class="n">rm</span><span class="o">/</span><span class="n">trampoline</span><span class="p">.</span><span class="n">S</span></code></a>!</li>
<li><code class="codehilite"><span class="n">arch</span><span class="o">/</span><span class="n">x86</span><span class="o">/</span><span class="n">realmode</span></code> is interesting. It uses piggyback technique. All the real-mode and 32bit code are in <code class="codehilite"><span class="n">arch</span><span class="o">/</span><span class="n">x86</span><span class="o">/</span><span class="n">realmode</span><span class="o">/</span><span class="n">rm</span><span class="cm">/*</span></code>, a special <a href="https://github.com/WukLab/LegoOS/blob/master/arch/x86/realmode/rm/ld.lds.S">linker script</a> is used to construct the code in a specific way! Think about mix 16bit, 32bit, 64bit code together, nasty!</li>
</ul>
</li>
<li>
<p>Hooray, C world. We are in <code class="codehilite"><span class="n">arch</span><span class="o">/</span><span class="n">x86</span><span class="o">/</span><span class="n">kernel</span><span class="o">/</span><span class="n">head64</span><span class="p">.</span><span class="k">c</span></code>. The starting function is <code class="codehilite"><span class="n">x86_64_start_kernel</span></code>! And the end is the <code class="codehilite"><span class="n">start_kernel</span></code>, the one in <code class="codehilite"><span class="n">init</span><span class="o">/</span><span class="n">main</span><span class="p">.</span><span class="k">c</span></code>.</p>
</li>
</ol>
<p>In all, there are a lot jumps after GRUB2 load the kernel, and its a long road before we can reach <code class="codehilite"><span class="n">start_kernel</span><span class="p">()</span></code>. It probably should not be this complex, but the x86 architecture really makes it worse. Happy hacking!</p>
                
                  
                
              
              
                


  <h2 id="__comments">Comments</h2>
  <div id="disqus_thread"></div>
  <script>
    var disqus_config = function () {
      this.page.url = "http://lastweek.io/lego/kernel/boot/";
      this.page.identifier =
        "/lego/kernel/boot/";
    };
    (function() {
      var d = document, s = d.createElement("script");
      s.src = "//lastweek-io.disqus.com/embed.js";
      s.setAttribute("data-timestamp", +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>

              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../../../fpga/hls_axi/" title="Efficient AXI-MM" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Efficient AXI-MM
              </span>
            </div>
          </a>
        
        
          <a href="../kconfig/" title="Kconfig" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Kconfig
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
  <div class="md-footer-social">
    <link rel="stylesheet" href="../../../assets/fonts/font-awesome.css">
    
      <a href="https://github.com/lastweek" class="md-footer-social__link fa fa-github"></a>
    
      <a href="https://twitter.com/Yizhou_Shan" class="md-footer-social__link fa fa-twitter"></a>
    
      <a href="https://www.linkedin.com/in/lastweek/" class="md-footer-social__link fa fa-linkedin"></a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../../assets/javascripts/application.ac79c3b0.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../../.."}})</script>
      
    
  </body>
</html>