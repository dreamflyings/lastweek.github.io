<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../../../img/favicon.ico">
  <title>Profile points - Yizhou Shan's Home Page</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../../../css/highlight.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Profile points";
    var mkdocs_page_input_path = "lego/kernel/profile_points.md";
    var mkdocs_page_url = "/lego/kernel/profile_points/";
  </script>
  
  <script src="../../../js/jquery-2.1.1.min.js"></script>
  <script src="../../../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../../../js/highlight.pack.js"></script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../../.." class="icon icon-home"> Yizhou Shan's Home Page</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="../../..">Home</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Notes</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../../notes/paper_perf_shadows/">Perf Shadows</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../notes/cache_coherence/">[Arch] Cache Coherence</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../notes/rmap/">[Linux] Reverse Mmap (rmap)</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../notes/trace/">[Linux] Tracing</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../notes/cgroup-swap/">[Linux] Cgroup and Swap</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../notes/userfaultfd/">[Linux] Userfaultfd</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../notes/xperf/">[Linux] User/kern Cross Perf</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../notes/kvm-basic/">[Linux] KVM</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../misc/essential/">[Misc] Essential</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../misc/cheatsheet/">[Misc] Cheatsheet</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">FPGA</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../../fpga/hls_axi/">HLS: Usage of AXI-Stream</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../fpga/hls_axi/">HLS: High-performance AXI-MM</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">LegoOS Dev Note</span>
    <ul class="subnav">
                <li class="">
                    
    <span class="caption-text">Log</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../../log/TODO/">TODO</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../log/misc/">MISC</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../log/test-note/">Test Script</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../log/log-09-2018/">Sep 2018</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../log/log-08-2018/">Aug 2018</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../log/log-04-2018/">April 2018</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../log/log-03-2018/">March 2018</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../log/log-02-2018/">Feb 2018</a>
                </li>
    </ul>
                </li>
                <li class=" current">
                    
    <span class="caption-text">Kernel</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../kconfig/">Kconfig</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../debug/">Debug</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../grub/">GRUB</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../profile/">Profile</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../profile_strace/">Profile strace</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../profile_heatmap/">Profile heatmap</a>
                </li>
                <li class="toctree-l3 current">
                    
    <a class="current" href="./">Profile points</a>
    <ul class="subnav">
            
    <li class="toctree-l4"><a href="#lego-profile-points">Lego Profile Points</a></li>
    
        <ul>
        
            <li><a class="toctree-l5" href="#example">Example</a></li>
        
            <li><a class="toctree-l5" href="#mechanism">Mechanism</a></li>
        
        </ul>
    

    </ul>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../trampoline/">Trampoline</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../pagefault_disable/">Disable pgfault</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../stop_machine/">Stop machine</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../loader/">Program Loader</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../vDSO/">vDSO</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../vfs/">Virtual File System</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../vm/">Process Virtual Memory</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../fpu/">x86 FPU</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../irq/">IRQ</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../net_thpool/">Network Thpool</a>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <span class="caption-text">Syscall</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../../syscall/facts/">Facts</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../profile_strace/">strace</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../syscall/compat/">compat</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../syscall/msync/">msync()</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../syscall/mremap/">mremap()</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../syscall/fork/">fork()</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../syscall/getrusage/">getrusage()</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../syscall/wait_and_exit/">wait4 and exit()</a>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <span class="caption-text">Pcache</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../../pcache/config/">Config</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../pcache/sweep/">Sweep</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../pcache/tlb/">TLB Coherence</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../pcache/pgtable-lock/">PageTable Lock</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../pcache/victim/">Victim Cache</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../pcache/virtual_cache/">Virtual Cache</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../pcache/rmap/">Reverse Mapping</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../pcache/evict_and_ref/">Evict and Refcount</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../pcache/smp_design/">SMP Design</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../pcache/replication/">Replication</a>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <span class="caption-text">Driver</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../../driver/pci/">PCI</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../driver/ib/">Infiniband</a>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <span class="caption-text">Paper</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../../paper/nmp/">NMP</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../paper/processor_oom/">Processor OOM</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../paper/genz/">Gen-Z</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../paper/replication/">Replication</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../paper/related/">Related</a>
                </li>
    </ul>
                </li>
    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../..">Yizhou Shan's Home Page</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../..">Docs</a> &raquo;</li>
    
      
        
          <li>LegoOS Dev Note &raquo;</li>
        
      
        
          <li>Kernel &raquo;</li>
        
      
    
    <li>Profile points</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="lego-profile-points">Lego Profile Points</h1>
<p>Lego profile points facility is added to trace specific functions, or even a small piece of code. It is added in the hope that it can help to find performance bottleneck. It is added in the hope that it can reduce the redundant coding chore.</p>
<h2 id="example">Example</h2>
<p>To trace TLB shootdown cost.
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="hll"><span class="n">DEFINE_PROFILE_POINT</span><span class="p">(</span><span class="n">flush_tlb_others</span><span class="p">)</span>
</span>
<span class="kt">void</span> <span class="n">flush_tlb_others</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">cpumask</span> <span class="o">*</span><span class="n">cpumask</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mm_struct</span> <span class="o">*</span><span class="n">mm</span><span class="p">,</span>
                      <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end</span><span class="p">)</span>
<span class="p">{</span>       
        <span class="k">struct</span> <span class="n">flush_tlb_info</span> <span class="n">info</span><span class="p">;</span>
<span class="hll">        <span class="n">PROFILE_POINT_TIME</span><span class="p">(</span><span class="n">flush_tlb_others</span><span class="p">)</span>
</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">end</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
        <span class="n">info</span><span class="p">.</span><span class="n">flush_mm</span> <span class="o">=</span> <span class="n">mm</span><span class="p">;</span>
        <span class="n">info</span><span class="p">.</span><span class="n">flush_start</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
        <span class="n">info</span><span class="p">.</span><span class="n">flush_end</span> <span class="o">=</span> <span class="n">end</span><span class="p">;</span>

<span class="hll">        <span class="n">profile_point_start</span><span class="p">(</span><span class="n">flush_tlb_others</span><span class="p">);</span>
</span>        <span class="n">smp_call_function_many</span><span class="p">(</span><span class="n">cpumask</span><span class="p">,</span> <span class="n">flush_tlb_func</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="hll">        <span class="n">profile_point_leave</span><span class="p">(</span><span class="n">flush_tlb_others</span><span class="p">);</span>
</span><span class="p">}</span>
</pre></div>
</td></tr></table></p>
<p>Explanation: <code class="codehilite">DEFINE_PROFILE_POINT()</code> will define a local structure, that contains the profile point name, number of invoked times, and total execution time. <code class="codehilite">PROFILE_POINT_TIME()</code> will define a stack local variable, to save the starting time. <code class="codehilite">profile_point_start()</code> will save the current time in nanosecond, while <code class="codehilite">profile_point_leave()</code> will calculate the execution of this run, and update the global counters defined by <code class="codehilite">DEFINE_PROFILE_POINT()</code>.</p>
<p>System-wide profile points will be printed together if you invoke <code class="codehilite">print_profile_points()</code>:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="p">[</span> <span class="mf">1017.422911</span><span class="p">]</span> <span class="n">Kernel</span> <span class="n">Profile</span> <span class="n">Points</span>
<span class="p">[</span> <span class="mf">1017.426594</span><span class="p">]</span>  <span class="n">status</span>                  <span class="n">name</span>             <span class="n">total</span>                <span class="n">nr</span>            <span class="n">avg</span><span class="p">.</span><span class="n">ns</span>
<span class="p">[</span> <span class="mf">1017.436292</span><span class="p">]</span> <span class="o">-------</span>  <span class="o">--------------------</span>  <span class="o">----------------</span>  <span class="o">----------------</span>  <span class="o">----------------</span>
<span class="p">[</span> <span class="mf">1017.445988</span><span class="p">]</span>     <span class="n">off</span>      <span class="n">flush_tlb_others</span>       <span class="mf">0.000153470</span>                <span class="mi">55</span>              <span class="mi">2791</span>
<span class="p">[</span> <span class="mf">1017.455685</span><span class="p">]</span>     <span class="n">off</span>     <span class="n">pcache_cache_miss</span>      <span class="mf">16.147020152</span>            <span class="mi">274698</span>             <span class="mi">58781</span>
<span class="p">[</span> <span class="mf">1017.465381</span><span class="p">]</span> <span class="o">-------</span>  <span class="o">--------------------</span>  <span class="o">----------------</span>  <span class="o">----------------</span>  <span class="o">----------------</span>
</pre></div>
</td></tr></table></p>
<h2 id="mechanism">Mechanism</h2>
<p>Once again, the profile points are aggregated by linker script. Each profile point will be in a special section <code class="codehilite"><span class="na">.profile.point</span></code>. The linker will merge them into one section, and export the starting and ending address of this section.</p>
<p>Part I. Annotate.
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="cp">#define __profile_point         __section(.profile.point)</span>

<span class="cp">#define DEFINE_PROFILE_POINT(name)                                                      \</span>
<span class="cp">        struct profile_point _PP_NAME(name) __profile_point = {</span>
        <span class="p">...</span>
        <span class="p">...</span>
        <span class="p">};</span>
</pre></div>
</td></tr></table></p>
<p>Part II. Link script merge.
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="p">.</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">L1_CACHE_BYTES</span><span class="p">);</span>
<span class="p">.</span><span class="n">profile</span><span class="p">.</span><span class="nl">point</span> <span class="p">:</span> <span class="n">AT</span><span class="p">(</span><span class="n">ADDR</span><span class="p">(.</span><span class="n">profile</span><span class="p">.</span><span class="n">point</span><span class="p">)</span> <span class="o">-</span> <span class="n">LOAD_OFFSET</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">__sprofilepoint</span> <span class="o">=</span> <span class="p">.;</span>
    <span class="o">*</span><span class="p">(.</span><span class="n">profile</span><span class="p">.</span><span class="n">point</span><span class="p">)</span>
    <span class="n">__eprofilepoint</span> <span class="o">=</span> <span class="p">.;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></p>
<p>Part III. Walk through.
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kt">void</span> <span class="nf">print_profile_points</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="n">profile_point</span> <span class="o">*</span><span class="n">pp</span><span class="p">;</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">pp</span> <span class="o">=</span> <span class="n">__sprofilepoint</span><span class="p">;</span> <span class="n">pp</span> <span class="o">&lt;</span> <span class="n">__eprofilepoint</span><span class="p">;</span> <span class="n">pp</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">print_profile_point</span><span class="p">(</span><span class="n">pp</span><span class="p">);</span>
        <span class="p">...</span>
    <span class="p">}</span>  
</pre></div>
</td></tr></table></p>
<p>I really love the linker script. ;-)</p>
<p>&ndash;<br />
Yizhou Shan<br />
Created: April 06, 2018<br />
Last Updated: April 06, 2018</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../trampoline/" class="btn btn-neutral float-right" title="Trampoline">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../profile_heatmap/" class="btn btn-neutral" title="Profile heatmap"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../profile_heatmap/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../trampoline/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '../../..';</script>
    <script src="../../../js/theme.js"></script>
      <script src="../../../search/require.js"></script>
      <script src="../../../search/search.js"></script>

</body>
</html>
