<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <meta name="author" content="Yizhou Shan">
  <link rel="shortcut icon" href="../../../img/favicon.ico">
  <title>strace - Yizhou Shan's Home Page</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>
  <link href='https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../../../css/highlight.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "strace";
    var mkdocs_page_input_path = "lego/kernel/profile_strace.md";
    var mkdocs_page_url = "/lego/kernel/profile_strace/";
  </script>
  
  <script src="../../../js/jquery-2.1.1.min.js"></script>
  <script src="../../../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../../../js/highlight.pack.js"></script> 
  
  <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-143772066-1', 'auto');
      ga('send', 'pageview');
  </script>
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../../.." class="icon icon-home"> Yizhou Shan's Home Page</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	  
          
		  
  <ul class="" href="../../..">
    <li class="toctree-l1">
  <a class="" href="../../..">Home</a>
  </li></ul>
          
		  
  <p class="caption">Notes</p>
  <ul class="">
          <li class="toctree-l1">
            
  <a class="" href="../../../notes/cache_coherence/">Cache Coherence</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="../../../notes/benchmark/">Benchmarks</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="../../../notes/paper_perf_shadows/">Perf Shadows</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="../../../notes/linux-articles/">Linux Articles</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="../../../notes/proc/">[Linux] Special Files</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="../../../notes/rmap/">[Linux] Reverse Mmap (rmap)</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="../../../notes/trace/">[Linux] Trace/Profile</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="../../../notes/cgroup-swap/">[Linux] Cgroup and Swap</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="../../../notes/userfaultfd/">[Linux] Userfaultfd</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="../../../notes/xperf/">[Linux] User/kern Cross Perf</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="../../../notes/kvm-basic/">[Linux] KVM</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="../../../misc/essential/">Essential</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="../../../misc/cheatsheet/">Cheatsheet</a>
        </li>
  </ul>

          
		  
  <p class="caption">FPGA</p>
  <ul class="">
          <li class="toctree-l1">
            
  <a class="" href="../../../notes/paper_fpga/">FPGA Papers</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="../../../fpga/vivado/">Vivado Practice</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="../../../fpga/bitstream/">Bitstream Explained</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="../../../fpga/hls_axi/">HLS: Usage of AXI-Stream</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="../../../fpga/hls_axi/">HLS: High-performance AXI-MM</a>
        </li>
  </ul>

          
		  
  <p class="caption">LegoOS-Dev</p>
  <ul class="current">
          <li class="toctree-l1">
            
  <a class="" href="/lego/log/TODO">Log</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="/lego/kernel/kconfig">Kernel</a>
        </li>
          <li class="toctree-l1 current">
            
  <a class="current" href="/lego/syscall/facts">Syscall</a>
  <ul class="subnav">
        <li class="toctree-l2 1">
            
  <a class="" href="../../syscall/facts/">Facts</a>
        </li>
        <li class="toctree-l2 current 1">
            
  <a class="current" href="./">strace</a>
  <ul class="subnav">
      
  <li class="toctree-l2 current">
  
    <a class="current"  href="#lego-profile-strace">Lego Profile strace</a>
  
  
    <ul class="">
    
        <li class="toctree-l3 toc-item" >
          <a class="toctree-l3" href="#design">Design</a>
        </li>
    
        <li class="toctree-l3 toc-item" >
          <a class="toctree-l3" href="#details">Details</a>
        </li>
    
        <li class="toctree-l3 toc-item" >
          <a class="toctree-l3" href="#example-output">Example Output</a>
        </li>
    
    </ul>
  
  </li>

  </ul>
        </li>
        <li class="toctree-l2 1">
            
  <a class="" href="../../syscall/compat/">compat</a>
        </li>
        <li class="toctree-l2 1">
            
  <a class="" href="../../syscall/msync/">msync()</a>
        </li>
        <li class="toctree-l2 1">
            
  <a class="" href="../../syscall/mremap/">mremap()</a>
        </li>
        <li class="toctree-l2 1">
            
  <a class="" href="../../syscall/fork/">fork()</a>
        </li>
        <li class="toctree-l2 1">
            
  <a class="" href="../../syscall/getrusage/">getrusage()</a>
        </li>
        <li class="toctree-l2 1">
            
  <a class="" href="../../syscall/wait_and_exit/">wait4 and exit()</a>
        </li>
  </ul>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="/lego/pcache/config">Pcache</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="/lego/driver/pci">Driver</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="/lego/paper/nmp">Paper</a>
        </li>
  </ul>

          
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../..">Yizhou Shan's Home Page</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../..">Docs</a> &raquo;</li>
    
      
        
          <li>LegoOS-Dev &raquo;</li>
        
      
        
          <li>Syscall &raquo;</li>
        
      
    
    <li>strace</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="lego-profile-strace">Lego Profile strace<a class="headerlink" href="#lego-profile-strace" title="Permanent link">&para;</a></h1>
<p>Lego has a built-in kernel-version syscall tracer, similar to <code class="codehilite">strace</code> utility in the user space. Below we will just call our Lego&rsquo;s syscall tracer as strace for simplicity.</p>
<h2 id="design">Design<a class="headerlink" href="#design" title="Permanent link">&para;</a></h2>
<p>There are essentially three important metrics to track for each syscall</p>
<ul>
<li>number of times invoked</li>
<li>number of times error happened</li>
<li>total execution, or per-call latency</li>
</ul>
<p>Besides, there is another important design decision: 1) should all threads within a process share one copy of data to maintain bookkeeping, or 2) should each thread do its bookkeeping on its own set of data? Our answer is 2). For two reasons:</p>
<ul>
<li>Performance: set of counters are <code class="codehilite">atomic_t</code>, updating is performed by a locked instruction. The first solution will add huge overhead while tracing heavily multithreaded applications.</li>
<li>Simplicity: in order to track the latency of each syscall, we need to know when it enter and when it finish. As threads come and go, it is hard to maintain such information. To make it worse, a preemptable kernel, or schedule-related syscalls will move threads around cores.</li>
</ul>
<p>Below is our simple design, where each thread has a <code class="codehilite">struct strace_info</code>, which include a set of counters for each syscall. All <code class="codehilite">strace_info</code> within a process are chained together by a doubly-linked list.</p>
<p><img alt="img_1" src="../strace_1.jpg" /></p>
<p>When we want to look at the strace statistic numbers, we need to <code class="codehilite">accumulate</code> counters from all threads within a process, including those dead threads. We do the <code class="codehilite">accumulate</code> when the last thread of this process is going to exit.</p>
<p>The benefit of doubly-linked <code class="codehilite">strace_info</code> is we can walk through the list starting anywhere. There is really no list head here. In fact, everyone can be the head. See how we respect equality? Besides, even if <code class="codehilite">task_struct</code> is reaped, <code class="codehilite">strace_info</code> is still there and linked.</p>
<p>For example, assume thread_3 has a SIGSEGV, and did a <code class="codehilite">zap_other_threads</code>. And he is the last standing live thread of this process. When it is going to exit, it will accumulate all the statistic and do the necessary printing.
<img alt="img_2" src="../strace_2.jpg" /></p>
<h2 id="details">Details<a class="headerlink" href="#details" title="Permanent link">&para;</a></h2>
<p>There are essentially three hooks in core kernel:</p>
<ul>
<li><strong>syscall</strong>: before and after <code class="codehilite">sys_call_table</code></li>
<li><strong>fork/clone</strong>: create <code class="codehilite">strace_info</code> for each thread</li>
<li><strong>do_exit()</strong>: when group_dead(signal-&gt;live==1), accumulate</li>
</ul>
<h2 id="example-output">Example Output<a class="headerlink" href="#example-output" title="Permanent link">&para;</a></h2>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="p">[</span> <span class="mf">1017.047366</span><span class="p">]</span> <span class="n">Kernel</span> <span class="n">strace</span>
<span class="p">[</span> <span class="mf">1017.050276</span><span class="p">]</span> <span class="nl">Task</span><span class="p">:</span> <span class="mi">20</span><span class="o">:</span><span class="mi">20</span> <span class="nl">nr_accumulated_threads</span><span class="p">:</span> <span class="mi">46</span>
<span class="p">[</span> <span class="mf">1017.055837</span><span class="p">]</span> <span class="o">%</span> <span class="n">time</span>        <span class="n">seconds</span>  <span class="n">usecs</span><span class="o">/</span><span class="n">call</span>     <span class="n">calls</span>    <span class="n">errors</span> <span class="n">syscall</span>
<span class="p">[</span> <span class="mf">1017.063213</span><span class="p">]</span> <span class="o">------</span> <span class="o">--------------</span> <span class="o">-----------</span> <span class="o">---------</span> <span class="o">---------</span> <span class="o">----------------</span>
<span class="p">[</span> <span class="mf">1017.071648</span><span class="p">]</span>  <span class="mf">98.16</span>   <span class="mf">33.839597842</span>     <span class="mi">1879978</span>        <span class="mi">18</span>         <span class="mi">0</span> <span class="n">sys_futex</span>
<span class="p">[</span> <span class="mf">1017.079406</span><span class="p">]</span>   <span class="mf">0.26</span>    <span class="mf">0.260143997</span>      <span class="mi">260144</span>         <span class="mi">1</span>         <span class="mi">0</span> <span class="n">sys_execve</span>
<span class="p">[</span> <span class="mf">1017.087260</span><span class="p">]</span>   <span class="mf">0.18</span>    <span class="mf">0.185456860</span>        <span class="mi">7133</span>        <span class="mi">26</span>         <span class="mi">0</span> <span class="n">sys_write</span>
<span class="p">[</span> <span class="mf">1017.095017</span><span class="p">]</span>   <span class="mf">0.50</span>    <span class="mf">0.050189546</span>         <span class="mi">913</span>        <span class="mi">55</span>         <span class="mi">0</span> <span class="n">sys_munmap</span>
<span class="p">[</span> <span class="mf">1017.102870</span><span class="p">]</span>   <span class="mf">0.25</span>    <span class="mf">0.025223661</span>         <span class="mi">255</span>        <span class="mi">99</span>         <span class="mi">0</span> <span class="n">sys_mmap</span>
<span class="p">[</span> <span class="mf">1017.110531</span><span class="p">]</span>   <span class="mf">0.50</span>    <span class="mf">0.000505134</span>          <span class="mi">12</span>        <span class="mi">45</span>         <span class="mi">0</span> <span class="n">sys_clone</span>
<span class="p">[</span> <span class="mf">1017.118288</span><span class="p">]</span>   <span class="mf">0.20</span>    <span class="mf">0.000202327</span>          <span class="mi">26</span>         <span class="mi">8</span>         <span class="mi">0</span> <span class="n">sys_read</span>
<span class="p">[</span> <span class="mf">1017.125947</span><span class="p">]</span>   <span class="mf">0.14</span>    <span class="mf">0.000144065</span>          <span class="mi">17</span>         <span class="mi">9</span>         <span class="mi">0</span> <span class="n">sys_open</span>
<span class="p">[</span> <span class="mf">1017.133608</span><span class="p">]</span>   <span class="mf">0.67</span>    <span class="mf">0.000067251</span>           <span class="mi">7</span>        <span class="mi">11</span>         <span class="mi">0</span> <span class="n">sys_brk</span>
<span class="p">[</span> <span class="mf">1017.141171</span><span class="p">]</span>   <span class="mf">0.30</span>    <span class="mf">0.000030361</span>           <span class="mi">7</span>         <span class="mi">5</span>         <span class="mi">0</span> <span class="n">sys_newfstat</span>
<span class="p">[</span> <span class="mf">1017.149219</span><span class="p">]</span>   <span class="mf">0.64</span>    <span class="mf">0.000006410</span>           <span class="mi">1</span>         <span class="mi">9</span>         <span class="mi">0</span> <span class="n">sys_close</span>
<span class="p">[</span> <span class="mf">1017.156976</span><span class="p">]</span>   <span class="mf">0.48</span>    <span class="mf">0.000004842</span>           <span class="mi">1</span>        <span class="mi">45</span>         <span class="mi">0</span> <span class="n">sys_madvise</span>
<span class="p">[</span> <span class="mf">1017.164927</span><span class="p">]</span>   <span class="mf">0.34</span>    <span class="mf">0.000003443</span>           <span class="mi">1</span>        <span class="mi">47</span>         <span class="mi">0</span> <span class="n">sys_set_robust_list</span>
<span class="p">[</span> <span class="mf">1017.173653</span><span class="p">]</span>   <span class="mf">0.21</span>    <span class="mf">0.000002137</span>           <span class="mi">1</span>        <span class="mi">52</span>         <span class="mi">0</span> <span class="n">sys_mprotect</span>
<span class="p">[</span> <span class="mf">1017.181702</span><span class="p">]</span>   <span class="mf">0.71</span>    <span class="mf">0.000000717</span>           <span class="mi">1</span>         <span class="mi">4</span>         <span class="mi">0</span> <span class="n">sys_gettimeofday</span>
<span class="p">[</span> <span class="mf">1017.190137</span><span class="p">]</span>   <span class="mf">0.60</span>    <span class="mf">0.000000608</span>           <span class="mi">1</span>         <span class="mi">3</span>         <span class="mi">0</span> <span class="n">sys_time</span>
<span class="p">[</span> <span class="mf">1017.197797</span><span class="p">]</span>   <span class="mf">0.51</span>    <span class="mf">0.000000513</span>           <span class="mi">1</span>         <span class="mi">2</span>         <span class="mi">0</span> <span class="n">sys_getrlimit</span>
<span class="p">[</span> <span class="mf">1017.205942</span><span class="p">]</span>   <span class="mf">0.49</span>    <span class="mf">0.000000498</span>           <span class="mi">1</span>         <span class="mi">2</span>         <span class="mi">0</span> <span class="n">sys_rt_sigprocmask</span>
<span class="p">[</span> <span class="mf">1017.214572</span><span class="p">]</span>   <span class="mf">0.46</span>    <span class="mf">0.000000469</span>           <span class="mi">1</span>         <span class="mi">4</span>         <span class="mi">0</span> <span class="n">sys_rt_sigaction</span>
<span class="p">[</span> <span class="mf">1017.223008</span><span class="p">]</span>   <span class="mf">0.45</span>    <span class="mf">0.000000453</span>           <span class="mi">1</span>         <span class="mi">2</span>         <span class="mi">0</span> <span class="n">sys_arch_prctl</span>
<span class="p">[</span> <span class="mf">1017.231249</span><span class="p">]</span>   <span class="mf">0.27</span>    <span class="mf">0.000000272</span>           <span class="mi">1</span>         <span class="mi">2</span>         <span class="mi">0</span> <span class="n">sys_newuname</span>
<span class="p">[</span> <span class="mf">1017.239298</span><span class="p">]</span>   <span class="mf">0.13</span>    <span class="mf">0.000000135</span>           <span class="mi">1</span>         <span class="mi">2</span>         <span class="mi">0</span> <span class="n">sys_set_tid_address</span>
<span class="p">[</span> <span class="mf">1017.248025</span><span class="p">]</span> <span class="o">------</span> <span class="o">--------------</span> <span class="o">-----------</span> <span class="o">---------</span> <span class="o">---------</span> <span class="o">----------------</span>
<span class="p">[</span> <span class="mf">1017.256460</span><span class="p">]</span> <span class="mf">100.00</span>   <span class="mf">34.361581541</span>                   <span class="mi">451</span>         <span class="mi">0</span> <span class="n">total</span>
</pre></div>
</td></tr></table>

<p>&ndash;<br />
Yizhou Shan<br />
Created: April 05, 2018<br />
Last Updated: April 05, 2018</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../../syscall/compat/" class="btn btn-neutral float-right" title="compat">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../../syscall/facts/" class="btn btn-neutral" title="Facts"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../../syscall/facts/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../../syscall/compat/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '../../..';</script>
    <script src="../../../js/theme.js"></script>
      <script src="../../../search/require.js"></script>
      <script src="../../../search/search.js"></script>

</body>
</html>
