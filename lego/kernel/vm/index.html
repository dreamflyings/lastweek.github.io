<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../../../img/favicon.ico">
  <title>Process Virtual Memory - Yizhou Shan's Home Page</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../../../css/highlight.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Process Virtual Memory";
    var mkdocs_page_input_path = "lego/kernel/vm.md";
    var mkdocs_page_url = "/lego/kernel/vm/";
  </script>
  
  <script src="../../../js/jquery-2.1.1.min.js"></script>
  <script src="../../../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../../../js/highlight.pack.js"></script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../../.." class="icon icon-home"> Yizhou Shan's Home Page</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="../../..">Home</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Notes</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../../notes/paper_perf_shadows/">Perf Shadows</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../notes/cache_coherence/">[Arch] Cache Coherence</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../notes/rmap/">[Linux] Reverse Mmap (rmap)</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../notes/trace/">[Linux] Tracing</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../notes/cgroup-swap/">[Linux] Cgroup and Swap</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../notes/userfaultfd/">[Linux] Userfaultfd</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../notes/xperf/">[Linux] User/kern Cross Perf</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../notes/kvm-basic/">[Linux] KVM</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../misc/essential/">[Misc] Essential</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../misc/cheatsheet/">[Misc] Cheatsheet</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">FPGA</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../../fpga/hls_axi/">HLS: Usage of AXI-Stream</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../fpga/hls_axi/">HLS: High-performance AXI-MM</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">LegoOS Dev Note</span>
    <ul class="subnav">
                <li class="">
                    
    <span class="caption-text">Log</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../../log/TODO/">TODO</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../log/misc/">MISC</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../log/test-note/">Test Script</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../log/log-09-2018/">Sep 2018</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../log/log-08-2018/">Aug 2018</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../log/log-04-2018/">April 2018</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../log/log-03-2018/">March 2018</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../log/log-02-2018/">Feb 2018</a>
                </li>
    </ul>
                </li>
                <li class=" current">
                    
    <span class="caption-text">Kernel</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../kconfig/">Kconfig</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../debug/">Debug</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../grub/">GRUB</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../profile/">Profile</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../profile_strace/">Profile strace</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../profile_heatmap/">Profile heatmap</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../profile_points/">Profile points</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../trampoline/">Trampoline</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../pagefault_disable/">Disable pgfault</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../stop_machine/">Stop machine</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../loader/">Program Loader</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../vDSO/">vDSO</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../vfs/">Virtual File System</a>
                </li>
                <li class="toctree-l3 current">
                    
    <a class="current" href="./">Process Virtual Memory</a>
    <ul class="subnav">
            
    <li class="toctree-l4"><a href="#process-virtual-memory">Process Virtual Memory</a></li>
    
        <ul>
        
            <li><a class="toctree-l5" href="#limits">Limits</a></li>
        
            <li><a class="toctree-l5" href="#facts">Facts</a></li>
        
        </ul>
    

    </ul>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../fpu/">x86 FPU</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../irq/">IRQ</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../net_thpool/">Network Thpool</a>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <span class="caption-text">Syscall</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../../syscall/facts/">Facts</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../profile_strace/">strace</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../syscall/compat/">compat</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../syscall/msync/">msync()</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../syscall/mremap/">mremap()</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../syscall/fork/">fork()</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../syscall/getrusage/">getrusage()</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../syscall/wait_and_exit/">wait4 and exit()</a>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <span class="caption-text">Pcache</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../../pcache/config/">Config</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../pcache/sweep/">Sweep</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../pcache/tlb/">TLB Coherence</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../pcache/pgtable-lock/">PageTable Lock</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../pcache/victim/">Victim Cache</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../pcache/virtual_cache/">Virtual Cache</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../pcache/rmap/">Reverse Mapping</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../pcache/evict_and_ref/">Evict and Refcount</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../pcache/smp_design/">SMP Design</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../pcache/replication/">Replication</a>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <span class="caption-text">Driver</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../../driver/pci/">PCI</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../driver/ib/">Infiniband</a>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <span class="caption-text">Paper</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../../paper/nmp/">NMP</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../paper/processor_oom/">Processor OOM</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../paper/genz/">Gen-Z</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../paper/replication/">Replication</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../paper/related/">Related</a>
                </li>
    </ul>
                </li>
    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../..">Yizhou Shan's Home Page</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../..">Docs</a> &raquo;</li>
    
      
        
          <li>LegoOS Dev Note &raquo;</li>
        
      
        
          <li>Kernel &raquo;</li>
        
      
    
    <li>Process Virtual Memory</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="process-virtual-memory">Process Virtual Memory</h1>
<h2 id="limits">Limits</h2>
<h3 id="max-number-of-vmas">Max Number of VMAs</h3>
<p>By default, the maximum number of VMAs is: <code class="codehilite">65530</code>. It is defined by the following variable:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="cp">#define MAPCOUNT_ELF_CORE_MARGIN        (5)</span>
<span class="cp">#define DEFAULT_MAX_MAP_COUNT   (USHRT_MAX - MAPCOUNT_ELF_CORE_MARGIN)</span>

<span class="kt">int</span> <span class="n">sysctl_max_map_count</span> <span class="n">__read_mostly</span> <span class="o">=</span> <span class="n">DEFAULT_MAX_MAP_COUNT</span><span class="p">;</span>
</pre></div>
</td></tr></table></p>
<h2 id="facts">Facts</h2>
<h3 id="munmap-can-split-vma"><code class="codehilite">munmap</code> can split vma</h3>
<p><code class="codehilite">munmap</code> can create a hole with an existing vma, thus divide one existing vma to two new vmas. Do note that, <code class="codehilite">munmap</code> can create hole for both anonymous vma <em><strong>and</strong></em> file-backed vma.</p>
<h3 id="msync-is-not-atomic"><code class="codehilite">msync()</code> is not atomic</h3>
<p>During <code class="codehilite">msync()</code>, pages are being written back to disk one by one (or batched). Consider the case where few pages have been flushed back, while some other few pages are still in the memory. This premature writeback is not atomic and will be affected by failure.</p>
<h3 id="msync-need-concurrency-control"><code class="codehilite">msync()</code> need concurrency control</h3>
<p>With a multi-threaded application, does msync() provide the synchronization semantic? The answer is NO. Other threads within the same process are able to write to pages currently under <code class="codehilite">msync()</code>. This implies that application need to handle concurrency by themselves, e.g., rwlocks.</p>
<p>&ndash;<br />
Yizhou Shan<br />
Created: Feb 19, 2018<br />
Last Updated: Feb 19, 2018</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../fpu/" class="btn btn-neutral float-right" title="x86 FPU">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../vfs/" class="btn btn-neutral" title="Virtual File System"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../vfs/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../fpu/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '../../..';</script>
    <script src="../../../js/theme.js"></script>
      <script src="../../../search/require.js"></script>
      <script src="../../../search/search.js"></script>

</body>
</html>
