



<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
        <link rel="canonical" href="http://lastweek.io/lego/kernel/loader/">
      
      
        <meta name="author" content="Yizhou Shan">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-0.17.2, mkdocs-material-2.6.2">
    
    
      
        <title>Program Loader - Yizhou Shan's Home Page</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/application.9b572555.css">
      
    
    
      <script src="../../../assets/javascripts/modernizr.1aa3b519.js"></script>
    
    
      
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,400,400i,700|">
        <style>body,input{font-family:"Lato","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="search">
    <label class="md-overlay" data-md-component="overlay" for="drawer"></label>
    
      <a href="#lego-program-loader" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="http://lastweek.io" title="Yizhou Shan's Home Page" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                Yizhou Shan's Home Page
              </span>
              <span class="md-header-nav__topic">
                Program Loader
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="drawer">
    <span class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </span>
    Yizhou Shan's Home Page
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Notes
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Notes
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/source_code/" title="Open-Source-Code-Study" class="md-nav__link">
      Open-Source-Code-Study
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/program_advice/" title="Programming-Guidelines-and-Advice" class="md-nav__link">
      Programming-Guidelines-and-Advice
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/virt/" title="Virtualization-Software" class="md-nav__link">
      Virtualization-Software
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/cache_coherence/" title="Practical-Cache-Coherence" class="md-nav__link">
      Practical-Cache-Coherence
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/xperf/" title="Measure-x86-Ring-Switch-Overhead" class="md-nav__link">
      Measure-x86-Ring-Switch-Overhead
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/paper_perf_shadows/" title="Performance-Shadows" class="md-nav__link">
      Performance-Shadows
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/rmap/" title="Linux Reverse Map (rmap)" class="md-nav__link">
      Linux Reverse Map (rmap)
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/userfaultfd/" title="Linux Userfaultfd" class="md-nav__link">
      Linux Userfaultfd
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/trace/" title="Linux Trace/Profile" class="md-nav__link">
      Linux Trace/Profile
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/cgroup-swap/" title="Linux Cgroup and Swap" class="md-nav__link">
      Linux Cgroup and Swap
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/proc/" title="Linux Special Files" class="md-nav__link">
      Linux Special Files
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/linux-articles/" title="Linux Articles" class="md-nav__link">
      Linux Articles
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/kvm-basic/" title="Linux KVM" class="md-nav__link">
      Linux KVM
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../misc/essential/" title="Essential" class="md-nav__link">
      Essential
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/benchmark/" title="Benchmarks" class="md-nav__link">
      Benchmarks
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../misc/cheatsheet/" title="Cheatsheet" class="md-nav__link">
      Cheatsheet
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      FPGA
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        FPGA
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/paper_fpga/" title="Papers" class="md-nav__link">
      Papers
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../fpga/bitstream/" title="Bitstream Explained" class="md-nav__link">
      Bitstream Explained
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../fpga/pr/" title="Morphous PR" class="md-nav__link">
      Morphous PR
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../fpga/vivado/" title="Vivado Practice" class="md-nav__link">
      Vivado Practice
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../fpga/hls_axi/" title="Efficient AXI-MM" class="md-nav__link">
      Efficient AXI-MM
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4" checked>
    
    <label class="md-nav__link" for="nav-4">
      LegoOS
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        LegoOS
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-1" type="checkbox" id="nav-4-1" checked>
    
    <label class="md-nav__link" for="nav-4-1">
      Kernel
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-4-1">
        Kernel
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../kconfig/" title="Kconfig" class="md-nav__link">
      Kconfig
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../debug/" title="Debug" class="md-nav__link">
      Debug
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../grub/" title="GRUB" class="md-nav__link">
      GRUB
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../profile/" title="Profile" class="md-nav__link">
      Profile
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../profile_strace/" title="Profile strace" class="md-nav__link">
      Profile strace
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../profile_heatmap/" title="Profile heatmap" class="md-nav__link">
      Profile heatmap
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../profile_points/" title="Profile points" class="md-nav__link">
      Profile points
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../trampoline/" title="Trampoline" class="md-nav__link">
      Trampoline
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../pagefault_disable/" title="Disable pgfault" class="md-nav__link">
      Disable pgfault
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../stop_machine/" title="Stop machine" class="md-nav__link">
      Stop machine
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="toc">
        Program Loader
      </label>
    
    <a href="./" title="Program Loader" class="md-nav__link md-nav__link--active">
      Program Loader
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#status" title="Status" class="md-nav__link">
    Status
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#overall" title="Overall" class="md-nav__link">
    Overall
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#legos-loader" title="Lego's Loader" class="md-nav__link">
    Lego's Loader
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#entry-point" title="Entry Point" class="md-nav__link">
    Entry Point
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#memory-managers-job" title="Memory Manager's Job" class="md-nav__link">
    Memory Manager's Job
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#load-ld-linux" title="Load ld-linux" class="md-nav__link">
    Load ld-linux
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#processor-managers-job" title="Processor Manager's Job" class="md-nav__link">
    Processor Manager's Job
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#destroy-old-context-flush_old_exec" title="Destroy old context: flush_old_exec()" class="md-nav__link">
    Destroy old context: flush_old_exec()
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#zap-other-threads" title="Zap other threads" class="md-nav__link">
    Zap other threads
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#switch-to-new-address-space" title="Switch to new address space" class="md-nav__link">
    Switch to new address space
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clear-architecture-specific-state" title="Clear Architecture-Specific state" class="md-nav__link">
    Clear Architecture-Specific state
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#setup-new-context-setup_new_exec" title="Setup new context: setup_new_exec()" class="md-nav__link">
    Setup new context: setup_new_exec()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#change-return-frame-in-stack" title="Change return frame in stack" class="md-nav__link">
    Change return frame in stack
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#features" title="Features" class="md-nav__link">
    Features
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#virtual-address-space-range" title="Virtual Address Space Range" class="md-nav__link">
    Virtual Address Space Range
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pre-populated-bss-and-brk" title="Pre-Populated .bss and .brk" class="md-nav__link">
    Pre-Populated .bss and .brk
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#un-populated-stack" title="Un-Populated stack" class="md-nav__link">
    Un-Populated stack
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#un-populated-text-and-data" title="Un-Populated .text and .data" class="md-nav__link">
    Un-Populated .text and .data
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#disabled-randomized-top-of-stack" title="Disabled Randomized Top of Stack" class="md-nav__link">
    Disabled Randomized Top of Stack
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#no-vdso" title="No vDSO" class="md-nav__link">
    No vDSO
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
        <li class="md-nav__item">
          <a href="#__comments" title="Comments" class="md-nav__link md-nav__link--active">
            Comments
          </a>
        </li>
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../vDSO/" title="vDSO" class="md-nav__link">
      vDSO
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../vfs/" title="Virtual File System" class="md-nav__link">
      Virtual File System
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../vm/" title="Process Virtual Memory" class="md-nav__link">
      Process Virtual Memory
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../fpu/" title="x86 FPU" class="md-nav__link">
      x86 FPU
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../irq/" title="IRQ" class="md-nav__link">
      IRQ
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../net_thpool/" title="Network Thpool" class="md-nav__link">
      Network Thpool
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-2" type="checkbox" id="nav-4-2">
    
    <label class="md-nav__link" for="nav-4-2">
      Syscall
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-4-2">
        Syscall
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../syscall/facts/" title="Facts" class="md-nav__link">
      Facts
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../profile_strace/" title="strace" class="md-nav__link">
      strace
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../syscall/compat/" title="compat" class="md-nav__link">
      compat
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../syscall/msync/" title="msync()" class="md-nav__link">
      msync()
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../syscall/mremap/" title="mremap()" class="md-nav__link">
      mremap()
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../syscall/fork/" title="fork()" class="md-nav__link">
      fork()
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../syscall/getrusage/" title="getrusage()" class="md-nav__link">
      getrusage()
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../syscall/wait_and_exit/" title="wait4 and exit()" class="md-nav__link">
      wait4 and exit()
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-3" type="checkbox" id="nav-4-3">
    
    <label class="md-nav__link" for="nav-4-3">
      Pcache
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-4-3">
        Pcache
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/config/" title="Config" class="md-nav__link">
      Config
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/sweep/" title="Sweep" class="md-nav__link">
      Sweep
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/tlb/" title="TLB Coherence" class="md-nav__link">
      TLB Coherence
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/pgtable-lock/" title="PageTable Lock" class="md-nav__link">
      PageTable Lock
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/victim/" title="Victim Cache" class="md-nav__link">
      Victim Cache
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/virtual_cache/" title="Virtual Cache" class="md-nav__link">
      Virtual Cache
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/rmap/" title="Reverse Mapping" class="md-nav__link">
      Reverse Mapping
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/evict_and_ref/" title="Evict and Refcount" class="md-nav__link">
      Evict and Refcount
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/smp_design/" title="SMP Design" class="md-nav__link">
      SMP Design
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/replication/" title="Replication" class="md-nav__link">
      Replication
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-4" type="checkbox" id="nav-4-4">
    
    <label class="md-nav__link" for="nav-4-4">
      Driver
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-4-4">
        Driver
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../driver/pci/" title="PCI" class="md-nav__link">
      PCI
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../driver/ib/" title="Infiniband" class="md-nav__link">
      Infiniband
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-5" type="checkbox" id="nav-4-5">
    
    <label class="md-nav__link" for="nav-4-5">
      Paper
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-4-5">
        Paper
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../paper/nmp/" title="NMP" class="md-nav__link">
      NMP
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../paper/processor_oom/" title="Processor OOM" class="md-nav__link">
      Processor OOM
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../paper/genz/" title="Gen-Z" class="md-nav__link">
      Gen-Z
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../paper/replication/" title="Replication" class="md-nav__link">
      Replication
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../paper/related/" title="Related" class="md-nav__link">
      Related
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#status" title="Status" class="md-nav__link">
    Status
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#overall" title="Overall" class="md-nav__link">
    Overall
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#legos-loader" title="Lego's Loader" class="md-nav__link">
    Lego's Loader
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#entry-point" title="Entry Point" class="md-nav__link">
    Entry Point
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#memory-managers-job" title="Memory Manager's Job" class="md-nav__link">
    Memory Manager's Job
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#load-ld-linux" title="Load ld-linux" class="md-nav__link">
    Load ld-linux
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#processor-managers-job" title="Processor Manager's Job" class="md-nav__link">
    Processor Manager's Job
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#destroy-old-context-flush_old_exec" title="Destroy old context: flush_old_exec()" class="md-nav__link">
    Destroy old context: flush_old_exec()
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#zap-other-threads" title="Zap other threads" class="md-nav__link">
    Zap other threads
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#switch-to-new-address-space" title="Switch to new address space" class="md-nav__link">
    Switch to new address space
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clear-architecture-specific-state" title="Clear Architecture-Specific state" class="md-nav__link">
    Clear Architecture-Specific state
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#setup-new-context-setup_new_exec" title="Setup new context: setup_new_exec()" class="md-nav__link">
    Setup new context: setup_new_exec()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#change-return-frame-in-stack" title="Change return frame in stack" class="md-nav__link">
    Change return frame in stack
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#features" title="Features" class="md-nav__link">
    Features
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#virtual-address-space-range" title="Virtual Address Space Range" class="md-nav__link">
    Virtual Address Space Range
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pre-populated-bss-and-brk" title="Pre-Populated .bss and .brk" class="md-nav__link">
    Pre-Populated .bss and .brk
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#un-populated-stack" title="Un-Populated stack" class="md-nav__link">
    Un-Populated stack
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#un-populated-text-and-data" title="Un-Populated .text and .data" class="md-nav__link">
    Un-Populated .text and .data
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#disabled-randomized-top-of-stack" title="Disabled Randomized Top of Stack" class="md-nav__link">
    Disabled Randomized Top of Stack
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#no-vdso" title="No vDSO" class="md-nav__link">
    No vDSO
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
        <li class="md-nav__item">
          <a href="#__comments" title="Comments" class="md-nav__link md-nav__link--active">
            Comments
          </a>
        </li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="lego-program-loader">Lego Program Loader<a class="headerlink" href="#lego-program-loader" title="Permanent link">&para;</a></h1>
<p>This document explains the high-level workflow of Lego&rsquo;s program loader, and how we change the normal loader to fit the disaggregated operating system model. Background on linking and loading is recommended.</p>
<h2 id="status">Status<a class="headerlink" href="#status" title="Permanent link">&para;</a></h2>
<table>
<thead>
<tr>
<th>Formats</th>
<th>Supported</th>
</tr>
</thead>
<tbody>
<tr>
<td>ELF (static-linked)</td>
<td><img alt="✔️" class="emojione" src="https://cdn.jsdelivr.net/emojione/assets/svg/2714.svg" title=":heavy_check_mark:" /></td>
</tr>
<tr>
<td>ELF (dynamic-linked)</td>
<td><img alt="✔️" class="emojione" src="https://cdn.jsdelivr.net/emojione/assets/svg/2714.svg" title=":heavy_check_mark:" /></td>
</tr>
</tbody>
</table>
<h2 id="overall">Overall<a class="headerlink" href="#overall" title="Permanent link">&para;</a></h2>
<p>In order to support different executable formats, Lego has a <code class="codehilite">virtual loader layer</code> above all specific formats, which is quite similar to <code class="codehilite">virtual file system</code>. In Lego, <code class="codehilite">execve()</code> is divided into two parts: <code class="codehilite">1)</code> syscall hook at processor side, <code class="codehilite">2)</code> real loader at memory side. Combined together, they provide the same semantic of <code class="codehilite">execve()</code> as described in Linux man page. Also for the code, we divide the Linux implementation into parts. But our emulation model introduces several interesting workarounds.</p>
<h2 id="legos-loader">Lego&rsquo;s Loader<a class="headerlink" href="#legos-loader" title="Permanent link">&para;</a></h2>
<p>Lego basically divide the Linux loader into two parts, one in memory manager and other in processor manager. Most dirty work is done by memory manager. Processor manager only needs to make sure the new execution has a fresh environment to start.</p>
<h3 id="entry-point">Entry Point<a class="headerlink" href="#entry-point" title="Permanent link">&para;</a></h3>
<p>So the normal entry point is <code class="codehilite">do_execve()</code>. Above that, it can be invoked by syscall from user space, or from kernel space by calling <code class="codehilite">do_execve()</code> directly. There are not too many places that will call <code class="codehilite">do_execve</code> within kernel. One notable case is how kernel starts the <code class="codehilite">pid 1</code> user program. This happens after kernel finished all initialization. The code is:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="k">static</span> <span class="kt">int</span> <span class="nf">run_init_process</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">init_filename</span><span class="p">)</span>                                                    
<span class="p">{</span>
        <span class="n">argv_init</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">init_filename</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">do_execve</span><span class="p">(</span><span class="n">init_filename</span><span class="p">,</span> <span class="n">argv_init</span><span class="p">,</span> <span class="n">envp_init</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></p>
<h3 id="memory-managers-job">Memory Manager&rsquo;s Job<a class="headerlink" href="#memory-managers-job" title="Permanent link">&para;</a></h3>
<p>Memory manager side will do most of the dirty loading work. It will parse the ELF image, create new VMAs based on ELF information. After that, it only pass <code class="codehilite">start_ip</code> and <code class="codehilite">start_stack</code> back to processor manager. Once processor manager starts running this new execution, pages will be fetched from memory component on demand.</p>
<h4 id="load-ld-linux">Load ld-linux<a class="headerlink" href="#load-ld-linux" title="Permanent link">&para;</a></h4>
<p>For dynamically-linked images, kernel ELF loader needs to load the <code class="codehilite">ld-linux.so</code> as well. It will first try to map the <code class="codehilite">ld-linux.so</code> into this process&rsquo;s virtual address space. Furthermore, the first user instruction that will run is no longer <code class="codehilite">__libc_main_start</code>, kernel will transfer the kernel to <code class="codehilite">ld-linux.so</code> instead. Thus, for a normal user program, <code class="codehilite">ld-linux.so</code> will load all the shared libraries before running glibc.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="k">static</span> <span class="kt">int</span> <span class="nf">load_elf_binary</span><span class="p">(</span><span class="k">struct</span> <span class="n">lego_task_struct</span> <span class="o">*</span><span class="n">tsk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lego_binprm</span> <span class="o">*</span><span class="n">bprm</span><span class="p">,</span>
                           <span class="n">u64</span> <span class="o">*</span><span class="n">new_ip</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">new_sp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">argv_len</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">envp_len</span><span class="p">)</span>
<span class="p">{</span>

        <span class="p">...</span>
        <span class="cm">/* Dynamically-linked */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">elf_interpreter</span><span class="p">)</span> <span class="p">{</span>
                <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">interp_map_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="hll">                <span class="n">elf_entry</span> <span class="o">=</span> <span class="n">load_elf_interp</span><span class="p">(</span><span class="n">tsk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">loc</span><span class="o">-&gt;</span><span class="n">interp_elf_ex</span><span class="p">,</span>
</span>                                            <span class="n">interpreter</span><span class="p">,</span>
                                            <span class="o">&amp;</span><span class="n">interp_map_addr</span><span class="p">,</span>
                                            <span class="n">load_bias</span><span class="p">,</span> <span class="n">interp_elf_phdata</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">elf_entry</span><span class="p">))</span> <span class="p">{</span>
                        <span class="cm">/*</span>
<span class="cm">                         * load_elf_interp() returns relocation</span>
<span class="cm">                         * adjustment</span>
<span class="cm">                         */</span>
                        <span class="n">interp_load_addr</span> <span class="o">=</span> <span class="n">elf_entry</span><span class="p">;</span>
                        <span class="n">elf_entry</span> <span class="o">+=</span> <span class="n">loc</span><span class="o">-&gt;</span><span class="n">interp_elf_ex</span><span class="p">.</span><span class="n">e_entry</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">BAD_ADDR</span><span class="p">(</span><span class="n">elf_entry</span><span class="p">))</span> <span class="p">{</span>
                        <span class="n">retval</span> <span class="o">=</span> <span class="n">IS_ERR</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">elf_entry</span><span class="p">)</span> <span class="o">?</span>
                                        <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="nl">elf_entry</span> <span class="p">:</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
                        <span class="k">goto</span> <span class="n">out_free_dentry</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="n">reloc_func_desc</span> <span class="o">=</span> <span class="n">interp_load_addr</span><span class="p">;</span>

                <span class="n">put_lego_file</span><span class="p">(</span><span class="n">interpreter</span><span class="p">);</span>
                <span class="n">kfree</span><span class="p">(</span><span class="n">elf_interpreter</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="cm">/* Statically-linked */</span>
                <span class="cm">/*</span>
<span class="cm">                 * e_entry is the VA to which the system first transfers control</span>
<span class="cm">                 * Not the start_code! Normally, it is the &lt;_start&gt; function.</span>
<span class="cm">                 */</span>
<span class="hll">                <span class="n">elf_entry</span> <span class="o">=</span> <span class="n">loc</span><span class="o">-&gt;</span><span class="n">elf_ex</span><span class="p">.</span><span class="n">e_entry</span><span class="p">;</span>
</span>                <span class="k">if</span> <span class="p">(</span><span class="n">BAD_ADDR</span><span class="p">(</span><span class="n">elf_entry</span><span class="p">))</span> <span class="p">{</span>
                        <span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
                        <span class="k">goto</span> <span class="n">out_free_dentry</span><span class="p">;</span>
                <span class="p">}</span>
        <span class="p">}</span>
        <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<h3 id="processor-managers-job">Processor Manager&rsquo;s Job<a class="headerlink" href="#processor-managers-job" title="Permanent link">&para;</a></h3>
<p>It needs to flush old execution environment, and setup the new execution environment, such as signal, FPU. Notably, processor manager need to run <code class="codehilite">flush_old_exec()</code>, and <code class="codehilite">setup_new_exec()</code>.</p>
<h4 id="destroy-old-context-flush_old_exec">Destroy old context: flush_old_exec()<a class="headerlink" href="#destroy-old-context-flush_old_exec" title="Permanent link">&para;</a></h4>
<h5 id="zap-other-threads">Zap other threads<a class="headerlink" href="#zap-other-threads" title="Permanent link">&para;</a></h5>
<p><code class="codehilite">de_thread</code> is used to kill other threads within the same thread group, thus make sure this process has its own signal table. Furthermore, A <code class="codehilite">exec</code> starts a new thread group with the same TGID of the previous thread group, so we probably also need to switch PID if calling thread is not a leader.</p>
<h5 id="switch-to-new-address-space">Switch to new address space<a class="headerlink" href="#switch-to-new-address-space" title="Permanent link">&para;</a></h5>
<p>We also need to release the old mm, and allocate a new mm. The new mm only has the high address kernel mapping established. Do note that in Lego, pgtable is used to emulate the processor cache:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="k">static</span> <span class="kt">int</span> <span class="nf">exec_mmap</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="n">mm_struct</span> <span class="o">*</span><span class="n">new_mm</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">mm_struct</span> <span class="o">*</span><span class="n">old_mm</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">tsk</span><span class="p">;</span>

        <span class="n">new_mm</span> <span class="o">=</span> <span class="n">mm_alloc</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new_mm</span><span class="p">)</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

        <span class="n">tsk</span> <span class="o">=</span> <span class="n">current</span><span class="p">;</span>
        <span class="n">old_mm</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">;</span>
        <span class="n">mm_release</span><span class="p">(</span><span class="n">tsk</span><span class="p">,</span> <span class="n">old_mm</span><span class="p">);</span>

        <span class="n">task_lock</span><span class="p">(</span><span class="n">tsk</span><span class="p">);</span>
        <span class="n">tsk</span><span class="o">-&gt;</span><span class="n">mm</span> <span class="o">=</span> <span class="n">new_mm</span><span class="p">;</span>
        <span class="n">tsk</span><span class="o">-&gt;</span><span class="n">active_mm</span> <span class="o">=</span> <span class="n">new_mm</span><span class="p">;</span>
        <span class="n">activate_mm</span><span class="p">(</span><span class="n">old_mm</span><span class="p">,</span> <span class="n">new_mm</span><span class="p">);</span>
        <span class="n">task_unlock</span><span class="p">(</span><span class="n">tsk</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">old_mm</span><span class="p">)</span>
                <span class="n">mmput</span><span class="p">(</span><span class="n">old_mm</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></p>
<h5 id="clear-architecture-specific-state">Clear Architecture-Specific state<a class="headerlink" href="#clear-architecture-specific-state" title="Permanent link">&para;</a></h5>
<p>This is performed by <code class="codehilite">flush_thread()</code>, which is an architecture-specific callback. In x86, we need to clear FPU state, and reset TLS array:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kt">void</span> <span class="nf">flush_thread</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">tsk</span> <span class="o">=</span> <span class="n">current</span><span class="p">;</span>
        <span class="n">memset</span><span class="p">(</span><span class="n">tsk</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">tls_array</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tsk</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">tls_array</span><span class="p">));</span>

        <span class="n">fpu__clear</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tsk</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fpu</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></p>
<h4 id="setup-new-context-setup_new_exec">Setup new context: setup_new_exec()<a class="headerlink" href="#setup-new-context-setup_new_exec" title="Permanent link">&para;</a></h4>
<p>Lego&rsquo;s <code class="codehilite">setup_new_exec()</code> is quite different from Linux&rsquo;s default implementation. Lego moves several functions to memory component, like the <code class="codehilite">arch_pick_mmap_layout</code> stuff. Thus, Lego only flush the signal handlers and reset the signal stack stuff:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="k">static</span> <span class="kt">void</span> <span class="nf">setup_new_exec</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">)</span>
<span class="p">{</span>
        <span class="cm">/* This is the point of no return */</span>
        <span class="n">current</span><span class="o">-&gt;</span><span class="n">sas_ss_sp</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">sas_ss_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="n">set_task_comm</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">kbasename</span><span class="p">(</span><span class="n">filename</span><span class="p">));</span>

        <span class="n">flush_signal_handlers</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></p>
<h4 id="change-return-frame-in-stack">Change return frame in stack<a class="headerlink" href="#change-return-frame-in-stack" title="Permanent link">&para;</a></h4>
<p>We do not return to user mode here, we simply replace the return IP of the regs frame. While the kernel thread returns, it will simply merge to syscall return path (check ret_from_fork() in entry.S for detail).
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="cm">/**</span>
<span class="cm"> * start_thread - Starting a new user thread</span>
<span class="cm"> * @regs: pointer to pt_regs</span>
<span class="cm"> * @new_ip: the first instruction IP of user thread</span>
<span class="cm"> * @new_sp: the new stack pointer of user thread</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">start_thread</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">new_ip</span><span class="p">,</span>
                  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">new_sp</span><span class="p">)</span>
<span class="p">{</span>
        <span class="n">loadsegment</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="n">loadsegment</span><span class="p">(</span><span class="n">es</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="n">loadsegment</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="n">load_gs_index</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
        <span class="n">regs</span><span class="o">-&gt;</span><span class="n">ip</span>                <span class="o">=</span> <span class="n">new_ip</span><span class="p">;</span>
        <span class="n">regs</span><span class="o">-&gt;</span><span class="n">sp</span>                <span class="o">=</span> <span class="n">new_sp</span><span class="p">;</span>
        <span class="n">regs</span><span class="o">-&gt;</span><span class="n">cs</span>                <span class="o">=</span> <span class="n">__USER_CS</span><span class="p">;</span>
        <span class="n">regs</span><span class="o">-&gt;</span><span class="n">ss</span>                <span class="o">=</span> <span class="n">__USER_DS</span><span class="p">;</span>
        <span class="n">regs</span><span class="o">-&gt;</span><span class="n">flags</span>             <span class="o">=</span> <span class="n">X86_EFLAGS_IF</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></p>
<p>If calling <code class="codehilite">execve()</code> from userspace, the return frame is saved in the stack, we can simply do <code class="codehilite">start_thread</code> above, and merge to syscall return path. However, if calling <code class="codehilite">execve()</code> from a kernel thread, things changed. As you can see, all forked threads will run from <code class="codehilite">ret_from_fork</code> when it wakes for the first time. If it is a kernel thread, it jumps to <code class="codehilite">line 23</code>, to execute the kernel function. Normally, the function should not return. If it does return, it normally has called an <code class="codehilite">execve()</code>, and return frame has been changed by <code class="codehilite">start_thread()</code>. So we jump to <code class="codehilite">line 16</code> to let it merge to syscall return path.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="err">/*</span>
 <span class="err">*</span> <span class="nf">A</span> <span class="no">newly</span> <span class="no">forked</span> <span class="no">process</span> <span class="no">directly</span> <span class="no">context</span> <span class="no">switches</span> <span class="no">into</span> <span class="no">this</span> <span class="no">address.</span>
 <span class="err">*</span>
 <span class="err">*</span> <span class="nl">rax:</span> <span class="nf">prev</span> <span class="no">task</span> <span class="no">we</span> <span class="no">switched</span> <span class="no">from</span>
 <span class="err">*</span> <span class="nl">rbx:</span> <span class="nf">kernel</span> <span class="no">thread</span> <span class="no">func</span> <span class="p">(</span><span class="no">NULL</span> <span class="no">for</span> <span class="no">user</span> <span class="no">thread</span><span class="p">)</span>
 <span class="err">*</span> <span class="nl">r12:</span> <span class="nf">kernel</span> <span class="no">thread</span> <span class="no">arg</span>
 <span class="err">*/</span>
<span class="nf">ENTRY</span><span class="p">(</span><span class="no">ret_from_fork</span><span class="p">)</span>
        <span class="nf">movq</span>    <span class="nv">%rax</span><span class="p">,</span> <span class="nv">%rdi</span>
        <span class="nf">call</span>    <span class="no">schedule_tail</span>           <span class="err">/</span><span class="p">*</span> <span class="no">rdi</span><span class="p">:</span> <span class="err">&#39;</span><span class="no">prev</span><span class="err">&#39;</span> <span class="no">task</span> <span class="no">parameter</span> <span class="p">*</span><span class="err">/</span>

        <span class="nf">testq</span>   <span class="nv">%rbx</span><span class="p">,</span> <span class="nv">%rbx</span>              <span class="err">/</span><span class="p">*</span> <span class="no">from</span> <span class="no">kernel_thread</span><span class="err">?</span> <span class="p">*</span><span class="err">/</span>
        <span class="nf">jnz</span>     <span class="mi">1</span><span class="no">f</span>                      <span class="err">/</span><span class="p">*</span> <span class="no">kernel</span> <span class="no">threads</span> <span class="no">are</span> <span class="no">uncommon</span> <span class="p">*</span><span class="err">/</span>

<span class="err">2:</span>
<span class="hll">        <span class="nf">movq</span>    <span class="nv">%rsp</span><span class="p">,</span> <span class="nv">%rdi</span>
</span>        <span class="nf">call</span>    <span class="no">syscall_return_slowpath</span> <span class="err">/</span><span class="p">*</span> <span class="no">return</span> <span class="no">with</span> <span class="no">IRQs</span> <span class="no">disabled</span> <span class="p">*</span><span class="err">/</span>
        <span class="nf">SWAPGS</span>                          <span class="err">/</span><span class="p">*</span> <span class="no">switch</span> <span class="no">to</span> <span class="no">user</span> <span class="no">gs.base</span> <span class="p">*</span><span class="err">/</span>
        <span class="nf">jmp</span>     <span class="no">restore_regs_and_iret</span>

<span class="err">1:</span>
        <span class="err">/*</span> <span class="nf">kernel</span> <span class="no">thread</span> <span class="p">*</span><span class="err">/</span>
<span class="hll">        <span class="nf">movq</span>    <span class="nv">%r12</span><span class="p">,</span> <span class="nv">%rdi</span>
</span>        <span class="nf">call</span>    <span class="p">*</span><span class="nv">%rbx</span>
        <span class="err">/*</span>  
         <span class="err">*</span> <span class="nf">A</span> <span class="no">kernel</span> <span class="no">thread</span> <span class="no">is</span> <span class="no">allowed</span> <span class="no">to</span> <span class="no">return</span> <span class="no">here</span> <span class="no">after</span> <span class="no">successfully</span>
         <span class="err">*</span> <span class="nf">calling</span> <span class="no">do_execve</span><span class="p">().</span>  <span class="no">Exit</span> <span class="no">to</span> <span class="no">userspace</span> <span class="no">to</span> <span class="no">complete</span> <span class="no">the</span> <span class="no">execve</span><span class="p">()</span>
         <span class="err">*</span> <span class="nl">syscall:</span>
         <span class="err">*/</span>
        <span class="nf">movq</span>    <span class="no">$0</span><span class="p">,</span> <span class="no">RAX</span><span class="p">(</span><span class="nv">%rsp</span><span class="p">)</span>
        <span class="nf">jmp</span>     <span class="mi">2</span><span class="no">b</span>  
<span class="no">END</span><span class="p">(</span><span class="no">ret_from_fork</span><span class="p">)</span>
</pre></div>
</td></tr></table>

<p>This is such a typical control flow hijacking. :-)</p>
<h3 id="features">Features<a class="headerlink" href="#features" title="Permanent link">&para;</a></h3>
<p>This section lists various features, or behaviors and Lego&rsquo;s program loader.</p>
<hr />
<h4 id="virtual-address-space-range">Virtual Address Space Range<a class="headerlink" href="#virtual-address-space-range" title="Permanent link">&para;</a></h4>
<p>User&rsquo;s virtual address falls into this range:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>[sysctl_mmap_min_addr, TASK_SIZE)
</pre></div>
</td></tr></table></p>
<p>By default,
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sysctl_mmap_min_addr</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * User space process size. 47bits minus one guard page.  The guard</span>
<span class="cm"> * page is necessary on Intel CPUs: if a SYSCALL instruction is at</span>
<span class="cm"> * the highest possible canonical userspace address, then that</span>
<span class="cm"> * syscall will enter the kernel with a non-canonical return</span>
<span class="cm"> * address, and SYSRET will explode dangerously.  We avoid this</span>
<span class="cm"> * particular problem by preventing anything from being mapped</span>
<span class="cm"> * at the maximum canonical address.</span>
<span class="cm"> */</span>                                                                                                       
<span class="cp">#define TASK_SIZE       ((1UL &lt;&lt; 47) - PAGE_SIZE)</span>
</pre></div>
</td></tr></table></p>
<p>Essentially:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>[0x1000, 0x7ffffffff000)
</pre></div>
</td></tr></table></p>
<hr />
<h4 id="pre-populated-bss-and-brk">Pre-Populated <code class="codehilite"><span class="na">.bss</span></code> and <code class="codehilite"><span class="na">.brk</span></code><a class="headerlink" href="#pre-populated-bss-and-brk" title="Permanent link">&para;</a></h4>
<p>The heap vma created at loading time is a combination of <code class="codehilite"><span class="na">.bss</span></code> and <code class="codehilite"><span class="na">.brk</span></code> segments. Since brk usage is 0 (will it be non-zero?) at this moment, so the heap vma is essentially just <code class="codehilite"><span class="na">.bss</span></code> pages. Normally, Linux kernel does not populate pages for this vma during loading, but Lego does. It can save several page allocation cost for heap pcache miss. It is controlled by <code class="codehilite">vm_brk()</code>.
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kt">int</span> <span class="nf">vm_brk</span><span class="p">(</span><span class="k">struct</span> <span class="n">lego_task_struct</span> <span class="o">*</span><span class="n">tsk</span><span class="p">,</span>
           <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">lego_mm_struct</span> <span class="o">*</span><span class="n">mm</span> <span class="o">=</span> <span class="n">tsk</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">down_write_killable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">mmap_sem</span><span class="p">))</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="n">do_brk</span><span class="p">(</span><span class="n">tsk</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
        <span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">mmap_sem</span><span class="p">);</span>

        <span class="cm">/* Prepopulate brk pages */</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
                <span class="n">lego_mm_populate</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

        <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></p>
<hr />
<h4 id="un-populated-stack">Un-Populated stack<a class="headerlink" href="#un-populated-stack" title="Permanent link">&para;</a></h4>
<p>Stack vma is manually expanded to <code class="codehilite">32 pages + pages for argv info</code> by loader to accommodate future usage. Only pages for argv are populated by default, the extra 32 pages are not. A typical program may need 1 page for saving argv info, plus the 32 extra, the layout will be:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>7ffffffde000-7ffffffff000 rw-p 00000000 [stack]
</pre></div>
</td></tr></table></p>
<p>The code to expand stack is done when ELF loader tries to finalize the stack vma, by calling <code class="codehilite">setup_arg_pages()</code>:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kt">int</span> <span class="nf">setup_arg_pages</span><span class="p">(</span><span class="k">struct</span> <span class="n">lego_task_struct</span> <span class="o">*</span><span class="n">tsk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lego_binprm</span> <span class="o">*</span><span class="n">bprm</span><span class="p">,</span>
                    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">stack_top</span><span class="p">,</span> <span class="kt">int</span> <span class="n">executable_stack</span><span class="p">)</span>
<span class="p">{</span>
        <span class="p">...</span>
        <span class="cm">/*</span>
<span class="cm">         * 32*4k (or 2*64k) pages</span>
<span class="cm">         */</span>
        <span class="n">stack_expand</span> <span class="o">=</span> <span class="mi">131072UL</span><span class="p">;</span>
        <span class="n">stack_size</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_end</span> <span class="o">-</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">;</span>
        <span class="n">stack_base</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span> <span class="o">-</span> <span class="n">stack_expand</span><span class="p">;</span>

        <span class="n">mm</span><span class="o">-&gt;</span><span class="n">start_stack</span> <span class="o">=</span> <span class="n">bprm</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">;</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">expand_stack</span><span class="p">(</span><span class="n">vma</span><span class="p">,</span> <span class="n">stack_base</span><span class="p">);</span>
        <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></p>
<hr />
<h4 id="un-populated-text-and-data">Un-Populated <code class="codehilite"><span class="na">.text</span></code> and <code class="codehilite"><span class="na">.data</span></code><a class="headerlink" href="#un-populated-text-and-data" title="Permanent link">&para;</a></h4>
<p>In essence, all PT_LOAD segments of ELF image are not pre-populated. They will be fetched from storage on demand. This is the traditional on-demand paging way. If we want to reduce the overhead of code and data&rsquo;s on-demand paging, we can prefault them in the future.</p>
<hr />
<h4 id="disabled-randomized-top-of-stack">Disabled Randomized Top of Stack<a class="headerlink" href="#disabled-randomized-top-of-stack" title="Permanent link">&para;</a></h4>
<p>Lego currently does not randomize the stack top. The stack vma is allocated by <code class="codehilite">bprm_mm_init()</code> at early execve time. There is no randomization at the allocation time, and this applies to all exectuable formats. The end of vma is just <code class="codehilite">TASK_SIZE</code>:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="k">static</span> <span class="kt">int</span> <span class="nf">__bprm_mm_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">lego_binprm</span> <span class="o">*</span><span class="n">bprm</span><span class="p">)</span>
<span class="p">{</span>
        <span class="p">...</span>
        <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_end</span> <span class="o">=</span> <span class="n">TASK_SIZE</span><span class="p">;</span>
        <span class="p">...</span>
<span class="p">}</span>
<span class="p">(</span><span class="n">managers</span><span class="o">/</span><span class="n">memory</span><span class="o">/</span><span class="n">loader</span><span class="o">/</span><span class="n">elf</span><span class="p">.</span><span class="n">c</span><span class="p">)</span>
</pre></div>
</td></tr></table></p>
<p>Top of stack randomization happens within each specific format loader. They do this by calling back to virtual loader layer&rsquo;s <code class="codehilite">setup_arg_pages()</code> function, which is used to finalize the top of stack:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kt">int</span> <span class="nf">setup_arg_pages</span><span class="p">(</span><span class="k">struct</span> <span class="n">lego_task_struct</span> <span class="o">*</span><span class="n">tsk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lego_binprm</span> <span class="o">*</span><span class="n">bprm</span><span class="p">,</span>
                    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">stack_top</span><span class="p">,</span> <span class="kt">int</span> <span class="n">executable_stack</span><span class="p">);</span>
</pre></div>
</td></tr></table></p>
<p>So, to actually randomize the top of stack, you can simply do the following:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">randomize_stack_top</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">stack_top</span><span class="p">)</span>
<span class="p">{</span>                                
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">random_variable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">((</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">PF_RANDOMIZE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                <span class="o">!</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">personality</span> <span class="o">&amp;</span> <span class="n">ADDR_NO_RANDOMIZE</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">random_variable</span> <span class="o">=</span> <span class="n">get_random_long</span><span class="p">();</span>
                <span class="n">random_variable</span> <span class="o">&amp;=</span> <span class="n">STACK_RND_MASK</span><span class="p">;</span>
                <span class="n">random_variable</span> <span class="o">&lt;&lt;=</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
        <span class="p">}</span>
<span class="cp">#ifdef CONFIG_STACK_GROWSUP</span>
        <span class="k">return</span> <span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">stack_top</span><span class="p">)</span> <span class="o">+</span> <span class="n">random_variable</span><span class="p">;</span>
<span class="cp">#else           </span>
        <span class="k">return</span> <span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">stack_top</span><span class="p">)</span> <span class="o">-</span> <span class="n">random_variable</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">load_elf_binary</span><span class="p">(</span><span class="k">struct</span> <span class="n">lego_task_struct</span> <span class="o">*</span><span class="n">tsk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lego_binprm</span> <span class="o">*</span><span class="n">bprm</span><span class="p">,</span>
                           <span class="n">u64</span> <span class="o">*</span><span class="n">new_ip</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">new_sp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">argv_len</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">envp_len</span><span class="p">)</span>
<span class="p">{</span>
        <span class="p">...</span>
        <span class="n">retval</span> <span class="o">=</span> <span class="n">setup_arg_pages</span><span class="p">(</span><span class="n">bprm</span><span class="p">,</span> <span class="n">randomize_stack_top</span><span class="p">(</span><span class="n">TASK_SIZE</span><span class="p">),</span>
                                 <span class="n">executable_stack</span><span class="p">);</span>
        <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></p>
<p>However, current Lego disables randomization by passing <code class="codehilite">TASK_SIZE</code>:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="k">static</span> <span class="kt">int</span> <span class="nf">load_elf_binary</span><span class="p">(</span><span class="k">struct</span> <span class="n">lego_task_struct</span> <span class="o">*</span><span class="n">tsk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lego_binprm</span> <span class="o">*</span><span class="n">bprm</span><span class="p">,</span>
                           <span class="n">u64</span> <span class="o">*</span><span class="n">new_ip</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">new_sp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">argv_len</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">envp_len</span><span class="p">)</span>
<span class="p">{</span>
        <span class="p">...</span>
        <span class="n">retval</span> <span class="o">=</span> <span class="n">setup_arg_pages</span><span class="p">(</span><span class="n">tsk</span><span class="p">,</span> <span class="n">bprm</span><span class="p">,</span> <span class="n">TASK_SIZE</span><span class="p">,</span> <span class="n">executable_stack</span><span class="p">);</span>
        <span class="p">...</span>
<span class="p">}</span>
<span class="p">(</span><span class="n">managers</span><span class="o">/</span><span class="n">memory</span><span class="o">/</span><span class="n">loader</span><span class="o">/</span><span class="n">elf</span><span class="p">.</span><span class="n">c</span><span class="p">)</span>
</pre></div>
</td></tr></table></p>
<hr />
<h4 id="no-vdso">No vDSO<a class="headerlink" href="#no-vdso" title="Permanent link">&para;</a></h4>
<p>Currently, Lego does not have <code class="codehilite">vDSO</code> support. There are not too many syscalls mapped in the vDSO, for <a href="http://man7.org/linux/man-pages/man7/vdso.7.html">x86-64</a>:</p>
<ul>
<li>clock_gettime</li>
<li>getcpu</li>
<li>gettimeofday</li>
<li>time</li>
</ul>
<p>The reason to add it back is simple: if those syscalls are used <code class="codehilite">a lot</code> and hurt overall performance. Do note that when we add it back, it will be different from the common design: vDSO <code class="codehilite">must</code> be mapped at processor side, mapped in our emulated pgtable.</p>
<p>Below is the original part where loader maps vDSO:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="k">static</span> <span class="kt">int</span> <span class="nf">load_elf_binary</span><span class="p">(</span><span class="k">struct</span> <span class="n">lego_task_struct</span> <span class="o">*</span><span class="n">tsk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lego_binprm</span> <span class="o">*</span><span class="n">bprm</span><span class="p">,</span>
                           <span class="n">u64</span> <span class="o">*</span><span class="n">new_ip</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">new_sp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">argv_len</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">envp_len</span><span class="p">)</span>
<span class="p">{</span>
        <span class="p">...</span>
<span class="cp">#ifdef ARCH_HAS_SETUP_ADDITIONAL_PAGES</span>
        <span class="cm">/*</span>
<span class="cm">         * TODO: vdso</span>
<span class="cm">         * x86 can map vdso vma here</span>
<span class="cm">         */</span>
<span class="cp">#endif</span>
        <span class="p">...</span>
<span class="p">}</span>
<span class="n">managers</span><span class="o">/</span><span class="n">memory</span><span class="o">/</span><span class="n">loader</span><span class="o">/</span><span class="n">elf</span><span class="p">.</span><span class="n">c</span>
</pre></div>
</td></tr></table></p>
<p>For lego, we should move it to processor right before <code class="codehilite">start_thread()</code>:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kt">int</span> <span class="nf">do_execve</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span>
              <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="o">*</span><span class="n">argv</span><span class="p">,</span>
              <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="o">*</span><span class="n">envp</span><span class="p">)</span>
<span class="p">{</span>
        <span class="p">...</span>
        <span class="cm">/* Should be here */</span>

        <span class="n">start_thread</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">new_ip</span><span class="p">,</span> <span class="n">new_sp</span><span class="p">);</span>
        <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></p>
<p>Besides, don&rsquo;t forget to report the <code class="codehilite">vDSO</code> address in the aux vector:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="k">static</span> <span class="kt">int</span> <span class="nf">create_elf_tables</span><span class="p">(</span><span class="k">struct</span> <span class="n">lego_task_struct</span> <span class="o">*</span><span class="n">tsk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lego_binprm</span> <span class="o">*</span><span class="n">bprm</span><span class="p">,</span>
                <span class="k">struct</span> <span class="n">elfhdr</span> <span class="o">*</span><span class="n">exec</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">load_addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">interp_load_addr</span><span class="p">,</span>
                <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">argv_len</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">envp_len</span><span class="p">)</span>
<span class="p">{</span>
        <span class="p">...</span>
<span class="cp">#ifdef ARCH_DLINFO</span>
        <span class="cm">/*</span>
<span class="cm">         * ARCH_DLINFO must come first so PPC can do its special alignment of</span>
<span class="cm">         * AUXV.</span>
<span class="cm">         * update AT_VECTOR_SIZE_ARCH if the number of NEW_AUX_ENT() in</span>
<span class="cm">         * ARCH_DLINFO changes</span>
<span class="cm">         */</span>
        <span class="n">ARCH_DLINFO</span><span class="p">;</span>
<span class="cp">#endif</span>
        <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></p>
<p>&ndash;<br />
Yizhou Shan<br />
Created: Feb 16, 2018<br />
Last Updated: Feb 27, 2018</p>
                
                  
                
              
              
                
                  


  <h2 id="__comments">Comments</h2>
  <div id="disqus_thread"></div>
  <script>
    var disqus_config = function () {
      this.page.url = "http://lastweek.io/lego/kernel/loader/";
      this.page.identifier =
        "/lego/kernel/loader/";
    };
    (function() {
      var d = document, s = d.createElement("script");
      s.src = "//lastweek-io.disqus.com/embed.js";
      s.setAttribute("data-timestamp", +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>

                
              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../stop_machine/" title="Stop machine" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Stop machine
              </span>
            </div>
          </a>
        
        
          <a href="../vDSO/" title="vDSO" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                vDSO
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="http://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
  <div class="md-footer-social">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    
      <a href="https://github.com/lastweek" class="md-footer-social__link fa fa-github"></a>
    
      <a href="https://twitter.com/Yizhou_Shan" class="md-footer-social__link fa fa-twitter"></a>
    
      <a href="https://www.linkedin.com/in/lastweek/" class="md-footer-social__link fa fa-linkedin"></a>
    
  </div>

      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../../assets/javascripts/application.abd7b172.js"></script>
      
      <script>app.initialize({version:"0.17.2",url:{base:"../../.."}})</script>
      
    
    
      
        <script>!function(e,a,t,n,o,c,i){e.GoogleAnalyticsObject=o,e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=1*new Date,c=a.createElement(t),i=a.getElementsByTagName(t)[0],c.async=1,c.src="https://www.google-analytics.com/analytics.js",i.parentNode.insertBefore(c,i)}(window,document,"script",0,"ga"),ga("create","UA-143772066-1","auto"),ga("set","anonymizeIp",!0),ga("send","pageview");var links=document.getElementsByTagName("a");if(Array.prototype.map.call(links,function(e){e.host!=document.location.host&&e.addEventListener("click",function(){var a=e.getAttribute("data-md-action")||"follow";ga("send","event","outbound",a,e.href)})}),document.forms.search){var query=document.forms.search.query;query.addEventListener("blur",function(){if(this.value){var e=document.location.pathname;ga("send","pageview",e+"?q="+this.value)}})}</script>
      
    
  </body>
</html>