<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <meta name="author" content="Yizhou Shan">
  <link rel="shortcut icon" href="../../../img/favicon.ico">
  <title>Profile heatmap - Yizhou Shan's Home Page</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>
  <link href='https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Profile heatmap";
    var mkdocs_page_input_path = "lego/kernel/profile_heatmap.md";
    var mkdocs_page_url = "/lego/kernel/profile_heatmap/";
  </script>
  
  <script src="../../../js/jquery-2.1.1.min.js" defer></script>
  <script src="../../../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
  <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-143772066-1', 'auto');
      ga('send', 'pageview');
  </script>
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../../.." class="icon icon-home"> Yizhou Shan's Home Page</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="tocbase current">
    
    
      


  <li class="navtree toctree-l1 inactive">
    <a class="" href="../../..">Home</a>
  </li>
    
      
  <li class="navtree toctree-l1 label">
    <p class="caption">Notes</p>
  </li>


  

  
    <li class="navtree toctree-l1 group">
      <ul class="navtree subnav-l1 current">
          


  <li class="navtree toctree-l2 inactive">
    <a class="" href="../../../notes/paper_fpga/">FPGA Papers</a>
  </li>
        
          


  <li class="navtree toctree-l2 inactive">
    <a class="" href="../../../notes/cache_coherence/">Cache Coherence</a>
  </li>
        
          


  <li class="navtree toctree-l2 inactive">
    <a class="" href="../../../notes/benchmark/">Benchmarks</a>
  </li>
        
          


  <li class="navtree toctree-l2 inactive">
    <a class="" href="../../../notes/paper_perf_shadows/">Perf Shadows</a>
  </li>
        
          


  <li class="navtree toctree-l2 inactive">
    <a class="" href="../../../notes/linux-articles/">Linux Articles</a>
  </li>
        
          


  <li class="navtree toctree-l2 inactive">
    <a class="" href="../../../notes/proc/">[Linux] Special Files</a>
  </li>
        
          


  <li class="navtree toctree-l2 inactive">
    <a class="" href="../../../notes/rmap/">[Linux] Reverse Mmap (rmap)</a>
  </li>
        
          


  <li class="navtree toctree-l2 inactive">
    <a class="" href="../../../notes/trace/">[Linux] Trace/Profile</a>
  </li>
        
          


  <li class="navtree toctree-l2 inactive">
    <a class="" href="../../../notes/cgroup-swap/">[Linux] Cgroup and Swap</a>
  </li>
        
          


  <li class="navtree toctree-l2 inactive">
    <a class="" href="../../../notes/userfaultfd/">[Linux] Userfaultfd</a>
  </li>
        
          


  <li class="navtree toctree-l2 inactive">
    <a class="" href="../../../notes/xperf/">[Linux] User/kern Cross Perf</a>
  </li>
        
          


  <li class="navtree toctree-l2 inactive">
    <a class="" href="../../../notes/kvm-basic/">[Linux] KVM</a>
  </li>
        
          


  <li class="navtree toctree-l2 inactive">
    <a class="" href="../../../misc/essential/">Essential</a>
  </li>
        
          


  <li class="navtree toctree-l2 inactive">
    <a class="" href="../../../misc/cheatsheet/">Cheatsheet</a>
  </li>
        
          
  <li class="navtree toctree-l2 label">
    <p class="caption">Log</p>
  </li>


  

  
    <li class="navtree toctree-l2 group">
      <ul class="navtree subnav-l2 current">
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../../general_log/0919/">Sep 2019</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../../general_log/0819/">Aug 2019</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../../general_log/0719/">Jul 2019</a>
  </li>
        
      </ul>
    </li>
        
      </ul>
    </li>
    
      
  <li class="navtree toctree-l1 label">
    <p class="caption">FPGA</p>
  </li>


  

  
    <li class="navtree toctree-l1 group">
      <ul class="navtree subnav-l1 current">
          


  <li class="navtree toctree-l2 inactive">
    <a class="" href="../../../fpga/hls_axi/">HLS: Usage of AXI-Stream</a>
  </li>
        
          


  <li class="navtree toctree-l2 inactive">
    <a class="" href="../../../fpga/hls_axi/">HLS: High-performance AXI-MM</a>
  </li>
        
          


  <li class="navtree toctree-l2 inactive">
    <a class="" href="../../../fpga/vivado_tricks/">Vivado Tricks</a>
  </li>
        
      </ul>
    </li>
    
      
  <li class="navtree toctree-l1 label">
    <p class="caption">LegoOS-Dev</p>
  </li>


  

  
    <li class="navtree toctree-l1 group">
      <ul class="navtree subnav-l1 current">
          
  <li class="navtree toctree-l2 label">
    <p class="caption">Log</p>
  </li>


  

  
    <li class="navtree toctree-l2 group">
      <ul class="navtree subnav-l2 current">
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../log/TODO/">TODO</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../log/misc/">MISC</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../log/test-note/">Test Script</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../log/log-09-2018/">Sep 2018</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../log/log-08-2018/">Aug 2018</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../log/log-04-2018/">April 2018</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../log/log-03-2018/">March 2018</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../log/log-02-2018/">Feb 2018</a>
  </li>
        
      </ul>
    </li>
        
          
  <li class="navtree toctree-l2 label">
    <p class="caption">Kernel</p>
  </li>


  

  
    <li class="navtree toctree-l2 group">
      <ul class="navtree subnav-l2 current">
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../kconfig/">Kconfig</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../debug/">Debug</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../grub/">GRUB</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../profile/">Profile</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../profile_strace/">Profile strace</a>
  </li>
        
          


  
    
    <li class="navtree toctree-l3 page current">
      <a class="current" href="./">
        Profile heatmap
      </a>
    </li>
    
      

  <li class="toctree-l3 current with-children">
    <a href="#lego-profile-kernel-heatmap">
      Lego Profile Kernel Heatmap
      <span class="toctree-expand"></span>
    </a>
  </li>



  <li class="toctree-l3 current">
    <ul class="subnav-l3 current">
    
      
        <li class="toctree-l4">
          <a class="toctree-l5" href="#mechanism">Mechanism</a>
        </li>
    
      
        <li class="toctree-l4">
          <a class="toctree-l5" href="#supported-features">Supported Features</a>
        </li>
    
      
        <li class="toctree-l4">
          <a class="toctree-l5" href="#example-output">Example Output</a>
        </li>
    
    </ul>
  </li>


  
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../profile_points/">Profile points</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../trampoline/">Trampoline</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../pagefault_disable/">Disable pgfault</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../stop_machine/">Stop machine</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../loader/">Program Loader</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../vDSO/">vDSO</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../vfs/">Virtual File System</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../vm/">Process Virtual Memory</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../fpu/">x86 FPU</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../irq/">IRQ</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../net_thpool/">Network Thpool</a>
  </li>
        
      </ul>
    </li>
        
          
  <li class="navtree toctree-l2 label">
    <p class="caption">Syscall</p>
  </li>


  

  
    <li class="navtree toctree-l2 group">
      <ul class="navtree subnav-l2 current">
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../syscall/facts/">Facts</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../profile_strace/">strace</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../syscall/compat/">compat</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../syscall/msync/">msync()</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../syscall/mremap/">mremap()</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../syscall/fork/">fork()</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../syscall/getrusage/">getrusage()</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../syscall/wait_and_exit/">wait4 and exit()</a>
  </li>
        
      </ul>
    </li>
        
          
  <li class="navtree toctree-l2 label">
    <p class="caption">Pcache</p>
  </li>


  

  
    <li class="navtree toctree-l2 group">
      <ul class="navtree subnav-l2 current">
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../pcache/config/">Config</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../pcache/sweep/">Sweep</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../pcache/tlb/">TLB Coherence</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../pcache/pgtable-lock/">PageTable Lock</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../pcache/victim/">Victim Cache</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../pcache/virtual_cache/">Virtual Cache</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../pcache/rmap/">Reverse Mapping</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../pcache/evict_and_ref/">Evict and Refcount</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../pcache/smp_design/">SMP Design</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../pcache/replication/">Replication</a>
  </li>
        
      </ul>
    </li>
        
          
  <li class="navtree toctree-l2 label">
    <p class="caption">Driver</p>
  </li>


  

  
    <li class="navtree toctree-l2 group">
      <ul class="navtree subnav-l2 current">
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../driver/pci/">PCI</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../driver/ib/">Infiniband</a>
  </li>
        
      </ul>
    </li>
        
          
  <li class="navtree toctree-l2 label">
    <p class="caption">Paper</p>
  </li>


  

  
    <li class="navtree toctree-l2 group">
      <ul class="navtree subnav-l2 current">
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../paper/nmp/">NMP</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../paper/processor_oom/">Processor OOM</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../paper/genz/">Gen-Z</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../paper/replication/">Replication</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../paper/related/">Related</a>
  </li>
        
      </ul>
    </li>
        
      </ul>
    </li>
    
  </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../..">Yizhou Shan's Home Page</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../..">Docs</a> &raquo;</li>
    
      
        
          <li>Kernel &raquo;</li>
        
      
        
          <li>LegoOS-Dev &raquo;</li>
        
      
    
    <li>Profile heatmap</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="lego-profile-kernel-heatmap">Lego Profile Kernel Heatmap<a class="headerlink" href="#lego-profile-kernel-heatmap" title="Permanent link">&para;</a></h1>
<p>To get a sense of what is the hottest function within kernel, Lego adds a  counter based heatmap. It is the same with Linux&rsquo;s <code class="codehilite"><span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="n">profile</span></code>.</p>
<h2 id="mechanism">Mechanism<a class="headerlink" href="#mechanism" title="Permanent link">&para;</a></h2>
<p>General idea: for each possible function/instruction byte in the kernel, we attach to a counter to it. Once we detect this function/instruction was executed, we increment its associated counter.</p>
<p>However, fine granularity counting will need a lot extra memory, and it is not necessary to track each single instruction byte. Besides, it is hard to track down every time the function was executed. Furthermore, we only need an approximate heatmap.</p>
<p>Thus, kernel&rsquo;s solutions are:</p>
<ul>
<li><strong>Coarse granularity</strong>: maintain a counter for each <code class="codehilite"><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">prof_shift</span></code> bytes.</li>
<li><strong>Update counter on timer interrupt tick</strong>, which is a constant stable entry.</li>
</ul>
<h2 id="supported-features">Supported Features<a class="headerlink" href="#supported-features" title="Permanent link">&para;</a></h2>
<p>Currently, we only support <code class="codehilite"><span class="n">CPU_PROFILING</span></code>, which profile on each timer interrupt tick. We could also add <code class="codehilite"><span class="n">SCHED_PROFILING</span></code>, or <code class="codehilite"><span class="n">SLEEP_PROFILING</span></code>. But we are fine with current setting.</p>
<p>Of course, we also have a simple dump function <code class="codehilite"><span class="n">void</span> <span class="n">print_profile_heatmap_nr</span><span class="p">(</span><span class="nb">int</span> <span class="n">nr</span><span class="p">)</span></code>, which is similar to userspace tool <code class="codehilite"><span class="n">readprofile</span></code>.</p>
<h2 id="example-output">Example Output<a class="headerlink" href="#example-output" title="Permanent link">&para;</a></h2>
<p>Workload is: MT-Phoenix word count, with 1GB data. (We probably want to rule out <code class="codehilite"><span class="n">cpu_idle</span><span class="p">()</span></code>)
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="p">[</span> <span class="mf">1017.309754</span><span class="p">]</span> <span class="n">Kernel</span> <span class="n">Heatmap</span> <span class="p">(</span><span class="n">top</span> <span class="err">#</span><span class="mi">10</span><span class="p">)</span>
<span class="p">[</span> <span class="mf">1017.313731</span><span class="p">]</span>          <span class="n">Address</span>              <span class="n">Function</span>          <span class="n">NR</span>          <span class="o">%</span>
<span class="p">[</span> <span class="mf">1017.321294</span><span class="p">]</span> <span class="o">----------------</span>  <span class="o">--------------------</span>  <span class="o">----------</span>  <span class="o">---------</span>
<span class="p">[</span> <span class="mf">1017.328858</span><span class="p">]</span> <span class="n">ffffffff8101a600</span>              <span class="n">cpu_idle</span>      <span class="mi">112082</span>      <span class="mf">73.11</span>
<span class="p">[</span> <span class="mf">1017.336421</span><span class="p">]</span> <span class="n">ffffffff810666f0</span>            <span class="n">__schedule</span>       <span class="mi">19192</span>      <span class="mf">12.95</span>
<span class="p">[</span> <span class="mf">1017.343983</span><span class="p">]</span> <span class="n">ffffffff8104f500</span>       <span class="n">mlx4_ib_poll_cq</span>        <span class="mi">5551</span>       <span class="mf">3.99</span>
<span class="p">[</span> <span class="mf">1017.351546</span><span class="p">]</span> <span class="n">ffffffff8103bf50</span>             <span class="n">delay_tsc</span>        <span class="mi">5393</span>       <span class="mf">3.83</span>
<span class="p">[</span> <span class="mf">1017.359110</span><span class="p">]</span> <span class="n">ffffffff81034a10</span>    <span class="n">victim_flush_async</span>        <span class="mi">3766</span>       <span class="mf">2.72</span>
<span class="p">[</span> <span class="mf">1017.366673</span><span class="p">]</span> <span class="n">ffffffff8102b220</span>   <span class="n">slob_alloc</span><span class="p">.</span><span class="n">constpro</span>        <span class="mi">1992</span>       <span class="mf">1.47</span>
<span class="p">[</span> <span class="mf">1017.374235</span><span class="p">]</span> <span class="n">ffffffff810668d0</span>              <span class="n">schedule</span>        <span class="mi">1519</span>       <span class="mf">0.15</span>
<span class="p">[</span> <span class="mf">1017.381800</span><span class="p">]</span> <span class="n">ffffffff810648f0</span>   <span class="n">fit_send_reply_with</span>         <span class="mi">956</span>       <span class="mf">0.95</span>
<span class="p">[</span> <span class="mf">1017.389362</span><span class="p">]</span> <span class="n">ffffffff81062370</span>   <span class="n">ibapi_send_reply_ti</span>         <span class="mi">307</span>       <span class="mf">0.30</span>
<span class="p">[</span> <span class="mf">1017.396925</span><span class="p">]</span> <span class="n">ffffffff8105a0d0</span>   <span class="n">ib_mad_completion_h</span>         <span class="mi">232</span>       <span class="mf">0.23</span>
<span class="p">[</span> <span class="mf">1017.404487</span><span class="p">]</span> <span class="o">----------------</span>  <span class="o">--------------------</span>  <span class="o">----------</span>  <span class="o">---------</span>
<span class="p">[</span> <span class="mf">1017.412052</span><span class="p">]</span>                                             <span class="mi">151994</span>     <span class="mf">100.00</span>
<span class="p">[</span> <span class="mf">1017.419613</span><span class="p">]</span>
</pre></div>
</td></tr></table></p>
<p>&ndash;<br />
Yizhou Shan<br />
Created: April 06, 2018<br />
Last Updated: April 06, 2018</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../profile_points/" class="btn btn-neutral float-right" title="Profile points">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../profile_strace/" class="btn btn-neutral" title="Profile strace"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../profile_strace/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../profile_points/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '../../..';</script>
    <script src="../../../js/theme.js" defer></script>
      <script src="../../../search/main.js" defer></script>

</body>
</html>
