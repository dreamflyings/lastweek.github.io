<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <meta name="author" content="Yizhou Shan">
  <link rel="shortcut icon" href="../../../img/favicon.ico">
  <title>Trampoline - Yizhou Shan's Home Page</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>
  <link href='https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../../../css/highlight.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Trampoline";
    var mkdocs_page_input_path = "lego/kernel/trampoline.md";
    var mkdocs_page_url = "/lego/kernel/trampoline/";
  </script>
  
  <script src="../../../js/jquery-2.1.1.min.js"></script>
  <script src="../../../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../../../js/highlight.pack.js"></script> 
  
  <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-143772066-1', 'auto');
      ga('send', 'pageview');
  </script>
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../../.." class="icon icon-home"> Yizhou Shan's Home Page</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	  
          
		  
  <ul class="" href="../../..">
    <li class="toctree-l1">
  <a class="" href="../../..">Home</a>
  </li></ul>
          
		  
  <p class="caption">Notes</p>
  <ul class="">
          <li class="toctree-l1">
            
  <a class="" href="../../../notes/paper_fpga/">FPGA Papers</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="../../../notes/cache_coherence/">Cache Coherence</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="../../../notes/benchmark/">Benchmarks</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="../../../notes/paper_perf_shadows/">Perf Shadows</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="../../../notes/linux-articles/">Linux Articles</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="../../../notes/proc/">[Linux] Special Files</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="../../../notes/rmap/">[Linux] Reverse Mmap (rmap)</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="../../../notes/trace/">[Linux] Trace/Profile</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="../../../notes/cgroup-swap/">[Linux] Cgroup and Swap</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="../../../notes/userfaultfd/">[Linux] Userfaultfd</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="../../../notes/xperf/">[Linux] User/kern Cross Perf</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="../../../notes/kvm-basic/">[Linux] KVM</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="../../../misc/essential/">Essential</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="../../../misc/cheatsheet/">Cheatsheet</a>
        </li>
  </ul>

          
		  
  <p class="caption">FPGA</p>
  <ul class="">
          <li class="toctree-l1">
            
  <a class="" href="../../../fpga/vivado/">Vivado Practice</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="../../../fpga/bitstream/">Bitstream Explained</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="../../../fpga/hls_axi/">HLS: Usage of AXI-Stream</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="../../../fpga/hls_axi/">HLS: High-performance AXI-MM</a>
        </li>
  </ul>

          
		  
  <p class="caption">LegoOS-Dev</p>
  <ul class="current">
          <li class="toctree-l1">
            
  <a class="" href="/lego/log/TODO">Log</a>
        </li>
          <li class="toctree-l1 current">
            
  <a class="current" href="/lego/kernel/kconfig">Kernel</a>
  <ul class="subnav">
        <li class="toctree-l2 1">
            
  <a class="" href="../kconfig/">Kconfig</a>
        </li>
        <li class="toctree-l2 1">
            
  <a class="" href="../debug/">Debug</a>
        </li>
        <li class="toctree-l2 1">
            
  <a class="" href="../grub/">GRUB</a>
        </li>
        <li class="toctree-l2 1">
            
  <a class="" href="../profile/">Profile</a>
        </li>
        <li class="toctree-l2 1">
            
  <a class="" href="../profile_strace/">Profile strace</a>
        </li>
        <li class="toctree-l2 1">
            
  <a class="" href="../profile_heatmap/">Profile heatmap</a>
        </li>
        <li class="toctree-l2 1">
            
  <a class="" href="../profile_points/">Profile points</a>
        </li>
        <li class="toctree-l2 current 1">
            
  <a class="current" href="./">Trampoline</a>
  <ul class="subnav">
      
  <li class="toctree-l2 current">
  
    <a class="current"  href="#how-trampoline-works-in-lego">How trampoline works in Lego</a>
  
  
    <ul class="">
    
        <li class="toctree-l3 toc-item" >
          <a class="toctree-l3" href="#what-is-trampoline-code">What is trampoline code?</a>
        </li>
    
        <li class="toctree-l3 toc-item" >
          <a class="toctree-l3" href="#where-is-the-trampoline-source-code">Where is the trampoline source code?</a>
        </li>
    
        <li class="toctree-l3 toc-item" >
          <a class="toctree-l3" href="#what-happened-at-runtime">What happened at runtime?</a>
        </li>
    
        <li class="toctree-l3 toc-item" >
          <a class="toctree-l3" href="#compare-with-linux">Compare with Linux</a>
        </li>
    
    </ul>
  
  </li>

  </ul>
        </li>
        <li class="toctree-l2 1">
            
  <a class="" href="../pagefault_disable/">Disable pgfault</a>
        </li>
        <li class="toctree-l2 1">
            
  <a class="" href="../stop_machine/">Stop machine</a>
        </li>
        <li class="toctree-l2 1">
            
  <a class="" href="../loader/">Program Loader</a>
        </li>
        <li class="toctree-l2 1">
            
  <a class="" href="../vDSO/">vDSO</a>
        </li>
        <li class="toctree-l2 1">
            
  <a class="" href="../vfs/">Virtual File System</a>
        </li>
        <li class="toctree-l2 1">
            
  <a class="" href="../vm/">Process Virtual Memory</a>
        </li>
        <li class="toctree-l2 1">
            
  <a class="" href="../fpu/">x86 FPU</a>
        </li>
        <li class="toctree-l2 1">
            
  <a class="" href="../irq/">IRQ</a>
        </li>
        <li class="toctree-l2 1">
            
  <a class="" href="../net_thpool/">Network Thpool</a>
        </li>
  </ul>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="/lego/syscall/facts">Syscall</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="/lego/pcache/config">Pcache</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="/lego/driver/pci">Driver</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="/lego/paper/nmp">Paper</a>
        </li>
  </ul>

          
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../..">Yizhou Shan's Home Page</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../..">Docs</a> &raquo;</li>
    
      
        
          <li>LegoOS-Dev &raquo;</li>
        
      
        
          <li>Kernel &raquo;</li>
        
      
    
    <li>Trampoline</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="how-trampoline-works-in-lego">How trampoline works in Lego<a class="headerlink" href="#how-trampoline-works-in-lego" title="Permanent link">&para;</a></h1>
<h2 id="what-is-trampoline-code">What is trampoline code?<a class="headerlink" href="#what-is-trampoline-code" title="Permanent link">&para;</a></h2>
<p>Trampoline code is used by <code class="codehilite">BSP</code> to boot other secondary CPUs.
At startup, <code class="codehilite">BSP</code> wakeup secondary CPUs by sending a <code class="codehilite">APIC INIT</code>
command, which carry the <code class="codehilite">[start_ip]</code> where the secondary CPUs should
start to run.</p>
<p>The trampoline code is the code starting from <code class="codehilite">[start_ip]</code>. Used
by the secondary CPU to jump from <code class="codehilite">16-bit realmode</code> to <code class="codehilite">64-bit</code> code
(the first instruction of 64-bit code will be in <code class="codehilite">arch/x86/kernel/head_64.S</code>).</p>
<h2 id="where-is-the-trampoline-source-code">Where is the trampoline source code?<a class="headerlink" href="#where-is-the-trampoline-source-code" title="Permanent link">&para;</a></h2>
<p>The source files are all in <code class="codehilite">arch/x86/realmode/</code>. There are two parts: <strong>1)</strong> <code class="codehilite">arch/x86/realmode/rm/trampoline.S</code>: which is the code that will run. And it is a mix of 16-bit, 32-bit, 64-bit code (ugh..). <strong>2)</strong> <code class="codehilite">arch/x86/realmode/piggy.S</code>: Since the trampoline code can not to linked
into kernel image directly. So we have to piggyback the trampoline.bin binary
code into a section, which is described by <code class="codehilite">trampoline_start</code> and <code class="codehilite">trampoline_end</code>. So the kernel can address the trampoline code via these two symbols.</p>
<p>The compile flow is:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>    arch/x86/realmode/rm/trmapoline.S
    -&gt; CC__ arch/x86/realmode/rm/trmapoline.o
       -&gt; LD arch/x86/realmode/rm/trampoline
          -&gt; OBJCOPY arch/x86/realmode/rm/trampoline.bin
             -&gt; This bin goes into piggy.o
            -&gt; piggy.o goes into vmImage
</pre></div>
</td></tr></table></p>
<h2 id="what-happened-at-runtime">What happened at runtime?<a class="headerlink" href="#what-happened-at-runtime" title="Permanent link">&para;</a></h2>
<p>The setup code was loaded by GRUB below 1MB. Inside <code class="codehilite">arch/x86/boot/main.c</code>, we
will save the <code class="codehilite">cs()</code> into the <code class="codehilite">boot_params</code> and pass it to kernel. In <code class="codehilite">setup_arch()</code>, we will copy the trampoline.bin code to the <code class="codehilite">cs()</code> address reported by <code class="codehilite">boot_param</code>. This means we will override setup code, which is okay.</p>
<p>At last, we wake up the secondary CPUs inside <code class="codehilite">smp_init()</code>.</p>
<h2 id="compare-with-linux">Compare with Linux<a class="headerlink" href="#compare-with-linux" title="Permanent link">&para;</a></h2>
<p>I vaguely remember how Linux implement this. The only thing I remember is that Linux use some sort of structure, which is filled by BSP and then passed, or used by secondary CPUs. The mechanism has no difference, though. Linux just has more robust debugging facilities.</p>
<p>&ndash;<br />
Yizhou Shan<br />
Mar 3, 2017</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../pagefault_disable/" class="btn btn-neutral float-right" title="Disable pgfault">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../profile_points/" class="btn btn-neutral" title="Profile points"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../profile_points/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../pagefault_disable/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '../../..';</script>
    <script src="../../../js/theme.js"></script>
      <script src="../../../search/require.js"></script>
      <script src="../../../search/search.js"></script>

</body>
</html>
