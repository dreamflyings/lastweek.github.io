<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <meta name="author" content="Yizhou Shan">
  <link rel="shortcut icon" href="../../../img/favicon.ico">
  <title>Trampoline - Yizhou Shan's Home Page</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>
  <link href='https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Trampoline";
    var mkdocs_page_input_path = "lego/kernel/trampoline.md";
    var mkdocs_page_url = "/lego/kernel/trampoline/";
  </script>
  
  <script src="../../../js/jquery-2.1.1.min.js" defer></script>
  <script src="../../../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
  <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-143772066-1', 'auto');
      ga('send', 'pageview');
  </script>
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../../.." class="icon icon-home"> Yizhou Shan's Home Page</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="tocbase current">
    
    
      


  <li class="navtree toctree-l1 inactive">
    <a class="" href="../../..">Home</a>
  </li>
    
      
  <li class="navtree toctree-l1 label">
    <p class="caption">Notes</p>
  </li>


  

  
    <li class="navtree toctree-l1 group">
      <ul class="navtree subnav-l1 current">
          


  <li class="navtree toctree-l2 inactive">
    <a class="" href="../../../notes/paper_fpga/">FPGA Papers</a>
  </li>
        
          


  <li class="navtree toctree-l2 inactive">
    <a class="" href="../../../notes/cache_coherence/">Cache Coherence</a>
  </li>
        
          


  <li class="navtree toctree-l2 inactive">
    <a class="" href="../../../notes/benchmark/">Benchmarks</a>
  </li>
        
          


  <li class="navtree toctree-l2 inactive">
    <a class="" href="../../../notes/paper_perf_shadows/">Perf Shadows</a>
  </li>
        
          


  <li class="navtree toctree-l2 inactive">
    <a class="" href="../../../notes/linux-articles/">Linux Articles</a>
  </li>
        
          


  <li class="navtree toctree-l2 inactive">
    <a class="" href="../../../notes/proc/">[Linux] Special Files</a>
  </li>
        
          


  <li class="navtree toctree-l2 inactive">
    <a class="" href="../../../notes/rmap/">[Linux] Reverse Mmap (rmap)</a>
  </li>
        
          


  <li class="navtree toctree-l2 inactive">
    <a class="" href="../../../notes/trace/">[Linux] Trace/Profile</a>
  </li>
        
          


  <li class="navtree toctree-l2 inactive">
    <a class="" href="../../../notes/cgroup-swap/">[Linux] Cgroup and Swap</a>
  </li>
        
          


  <li class="navtree toctree-l2 inactive">
    <a class="" href="../../../notes/userfaultfd/">[Linux] Userfaultfd</a>
  </li>
        
          


  <li class="navtree toctree-l2 inactive">
    <a class="" href="../../../notes/xperf/">[Linux] User/kern Cross Perf</a>
  </li>
        
          


  <li class="navtree toctree-l2 inactive">
    <a class="" href="../../../notes/kvm-basic/">[Linux] KVM</a>
  </li>
        
          


  <li class="navtree toctree-l2 inactive">
    <a class="" href="../../../misc/essential/">Essential</a>
  </li>
        
          


  <li class="navtree toctree-l2 inactive">
    <a class="" href="../../../misc/cheatsheet/">Cheatsheet</a>
  </li>
        
          
  <li class="navtree toctree-l2 label">
    <p class="caption">Log</p>
  </li>


  

  
    <li class="navtree toctree-l2 group">
      <ul class="navtree subnav-l2 current">
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../../general_log/0919/">Sep 2019</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../../general_log/0819/">Aug 2019</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../../general_log/0719/">Jul 2019</a>
  </li>
        
      </ul>
    </li>
        
      </ul>
    </li>
    
      
  <li class="navtree toctree-l1 label">
    <p class="caption">FPGA</p>
  </li>


  

  
    <li class="navtree toctree-l1 group">
      <ul class="navtree subnav-l1 current">
          


  <li class="navtree toctree-l2 inactive">
    <a class="" href="../../../fpga/hls_axi/">HLS: Usage of AXI-Stream</a>
  </li>
        
          


  <li class="navtree toctree-l2 inactive">
    <a class="" href="../../../fpga/hls_axi/">HLS: High-performance AXI-MM</a>
  </li>
        
          


  <li class="navtree toctree-l2 inactive">
    <a class="" href="../../../fpga/vivado_tricks/">Vivado Tricks</a>
  </li>
        
      </ul>
    </li>
    
      
  <li class="navtree toctree-l1 label">
    <p class="caption">LegoOS-Dev</p>
  </li>


  

  
    <li class="navtree toctree-l1 group">
      <ul class="navtree subnav-l1 current">
          
  <li class="navtree toctree-l2 label">
    <p class="caption">Log</p>
  </li>


  

  
    <li class="navtree toctree-l2 group">
      <ul class="navtree subnav-l2 current">
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../log/TODO/">TODO</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../log/misc/">MISC</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../log/test-note/">Test Script</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../log/log-09-2018/">Sep 2018</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../log/log-08-2018/">Aug 2018</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../log/log-04-2018/">April 2018</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../log/log-03-2018/">March 2018</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../log/log-02-2018/">Feb 2018</a>
  </li>
        
      </ul>
    </li>
        
          
  <li class="navtree toctree-l2 label">
    <p class="caption">Kernel</p>
  </li>


  

  
    <li class="navtree toctree-l2 group">
      <ul class="navtree subnav-l2 current">
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../kconfig/">Kconfig</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../debug/">Debug</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../grub/">GRUB</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../profile/">Profile</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../profile_strace/">Profile strace</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../profile_heatmap/">Profile heatmap</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../profile_points/">Profile points</a>
  </li>
        
          


  
    
    <li class="navtree toctree-l3 page current">
      <a class="current" href="./">
        Trampoline
      </a>
    </li>
    
      

  <li class="toctree-l3 current with-children">
    <a href="#how-trampoline-works-in-lego">
      How trampoline works in Lego
      <span class="toctree-expand"></span>
    </a>
  </li>



  <li class="toctree-l3 current">
    <ul class="subnav-l3 current">
    
      
        <li class="toctree-l4">
          <a class="toctree-l5" href="#what-is-trampoline-code">What is trampoline code?</a>
        </li>
    
      
        <li class="toctree-l4">
          <a class="toctree-l5" href="#where-is-the-trampoline-source-code">Where is the trampoline source code?</a>
        </li>
    
      
        <li class="toctree-l4">
          <a class="toctree-l5" href="#what-happened-at-runtime">What happened at runtime?</a>
        </li>
    
      
        <li class="toctree-l4">
          <a class="toctree-l5" href="#compare-with-linux">Compare with Linux</a>
        </li>
    
    </ul>
  </li>


  
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../pagefault_disable/">Disable pgfault</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../stop_machine/">Stop machine</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../loader/">Program Loader</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../vDSO/">vDSO</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../vfs/">Virtual File System</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../vm/">Process Virtual Memory</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../fpu/">x86 FPU</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../irq/">IRQ</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../net_thpool/">Network Thpool</a>
  </li>
        
      </ul>
    </li>
        
          
  <li class="navtree toctree-l2 label">
    <p class="caption">Syscall</p>
  </li>


  

  
    <li class="navtree toctree-l2 group">
      <ul class="navtree subnav-l2 current">
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../syscall/facts/">Facts</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../profile_strace/">strace</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../syscall/compat/">compat</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../syscall/msync/">msync()</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../syscall/mremap/">mremap()</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../syscall/fork/">fork()</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../syscall/getrusage/">getrusage()</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../syscall/wait_and_exit/">wait4 and exit()</a>
  </li>
        
      </ul>
    </li>
        
          
  <li class="navtree toctree-l2 label">
    <p class="caption">Pcache</p>
  </li>


  

  
    <li class="navtree toctree-l2 group">
      <ul class="navtree subnav-l2 current">
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../pcache/config/">Config</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../pcache/sweep/">Sweep</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../pcache/tlb/">TLB Coherence</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../pcache/pgtable-lock/">PageTable Lock</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../pcache/victim/">Victim Cache</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../pcache/virtual_cache/">Virtual Cache</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../pcache/rmap/">Reverse Mapping</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../pcache/evict_and_ref/">Evict and Refcount</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../pcache/smp_design/">SMP Design</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../pcache/replication/">Replication</a>
  </li>
        
      </ul>
    </li>
        
          
  <li class="navtree toctree-l2 label">
    <p class="caption">Driver</p>
  </li>


  

  
    <li class="navtree toctree-l2 group">
      <ul class="navtree subnav-l2 current">
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../driver/pci/">PCI</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../driver/ib/">Infiniband</a>
  </li>
        
      </ul>
    </li>
        
          
  <li class="navtree toctree-l2 label">
    <p class="caption">Paper</p>
  </li>


  

  
    <li class="navtree toctree-l2 group">
      <ul class="navtree subnav-l2 current">
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../paper/nmp/">NMP</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../paper/processor_oom/">Processor OOM</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../paper/genz/">Gen-Z</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../paper/replication/">Replication</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../paper/related/">Related</a>
  </li>
        
      </ul>
    </li>
        
      </ul>
    </li>
    
  </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../..">Yizhou Shan's Home Page</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../..">Docs</a> &raquo;</li>
    
      
        
          <li>Kernel &raquo;</li>
        
      
        
          <li>LegoOS-Dev &raquo;</li>
        
      
    
    <li>Trampoline</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="how-trampoline-works-in-lego">How trampoline works in Lego<a class="headerlink" href="#how-trampoline-works-in-lego" title="Permanent link">&para;</a></h1>
<h2 id="what-is-trampoline-code">What is trampoline code?<a class="headerlink" href="#what-is-trampoline-code" title="Permanent link">&para;</a></h2>
<p>Trampoline code is used by <code class="codehilite"><span class="n">BSP</span></code> to boot other secondary CPUs.
At startup, <code class="codehilite"><span class="n">BSP</span></code> wakeup secondary CPUs by sending a <code class="codehilite"><span class="n">APIC</span> <span class="n">INIT</span></code>
command, which carry the <code class="codehilite"><span class="o">[</span><span class="n">start_ip</span><span class="o">]</span><span class="w"></span></code> where the secondary CPUs should
start to run.</p>
<p>The trampoline code is the code starting from <code class="codehilite"><span class="o">[</span><span class="n">start_ip</span><span class="o">]</span><span class="w"></span></code>. Used
by the secondary CPU to jump from <code class="codehilite"><span class="mi">16</span><span class="o">-</span><span class="nb">bit</span> <span class="n">realmode</span></code> to <code class="codehilite"><span class="mi">64</span><span class="o">-</span><span class="nb">bit</span></code> code
(the first instruction of 64-bit code will be in <code class="codehilite"><span class="n">arch</span><span class="o">/</span><span class="n">x86</span><span class="o">/</span><span class="n">kernel</span><span class="o">/</span><span class="n">head_64</span><span class="p">.</span><span class="n">S</span></code>).</p>
<h2 id="where-is-the-trampoline-source-code">Where is the trampoline source code?<a class="headerlink" href="#where-is-the-trampoline-source-code" title="Permanent link">&para;</a></h2>
<p>The source files are all in <code class="codehilite"><span class="n">arch</span><span class="o">/</span><span class="n">x86</span><span class="o">/</span><span class="n">realmode</span><span class="o">/</span></code>. There are two parts: <strong>1)</strong> <code class="codehilite"><span class="n">arch</span><span class="o">/</span><span class="n">x86</span><span class="o">/</span><span class="n">realmode</span><span class="o">/</span><span class="n">rm</span><span class="o">/</span><span class="n">trampoline</span><span class="p">.</span><span class="n">S</span></code>: which is the code that will run. And it is a mix of 16-bit, 32-bit, 64-bit code (ugh..). <strong>2)</strong> <code class="codehilite"><span class="n">arch</span><span class="o">/</span><span class="n">x86</span><span class="o">/</span><span class="n">realmode</span><span class="o">/</span><span class="n">piggy</span><span class="p">.</span><span class="n">S</span></code>: Since the trampoline code can not to linked
into kernel image directly. So we have to piggyback the trampoline.bin binary
code into a section, which is described by <code class="codehilite"><span class="n">trampoline_start</span></code> and <code class="codehilite"><span class="n">trampoline_end</span></code>. So the kernel can address the trampoline code via these two symbols.</p>
<p>The compile flow is:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>    <span class="n">arch</span><span class="o">/</span><span class="n">x86</span><span class="o">/</span><span class="n">realmode</span><span class="o">/</span><span class="n">rm</span><span class="o">/</span><span class="n">trmapoline</span><span class="p">.</span><span class="n">S</span>
    <span class="o">-&gt;</span> <span class="n">CC__</span> <span class="n">arch</span><span class="o">/</span><span class="n">x86</span><span class="o">/</span><span class="n">realmode</span><span class="o">/</span><span class="n">rm</span><span class="o">/</span><span class="n">trmapoline</span><span class="p">.</span><span class="n">o</span>
       <span class="o">-&gt;</span> <span class="n">LD</span> <span class="n">arch</span><span class="o">/</span><span class="n">x86</span><span class="o">/</span><span class="n">realmode</span><span class="o">/</span><span class="n">rm</span><span class="o">/</span><span class="n">trampoline</span>
          <span class="o">-&gt;</span> <span class="n">OBJCOPY</span> <span class="n">arch</span><span class="o">/</span><span class="n">x86</span><span class="o">/</span><span class="n">realmode</span><span class="o">/</span><span class="n">rm</span><span class="o">/</span><span class="n">trampoline</span><span class="p">.</span><span class="n">bin</span>
             <span class="o">-&gt;</span> <span class="n">This</span> <span class="n">bin</span> <span class="n">goes</span> <span class="k">into</span> <span class="n">piggy</span><span class="p">.</span><span class="n">o</span>
            <span class="o">-&gt;</span> <span class="n">piggy</span><span class="p">.</span><span class="n">o</span> <span class="n">goes</span> <span class="k">into</span> <span class="n">vmImage</span>
</pre></div>
</td></tr></table></p>
<h2 id="what-happened-at-runtime">What happened at runtime?<a class="headerlink" href="#what-happened-at-runtime" title="Permanent link">&para;</a></h2>
<p>The setup code was loaded by GRUB below 1MB. Inside <code class="codehilite"><span class="n">arch</span><span class="o">/</span><span class="n">x86</span><span class="o">/</span><span class="n">boot</span><span class="o">/</span><span class="n">main</span><span class="p">.</span><span class="k">c</span></code>, we
will save the <code class="codehilite"><span class="n">cs</span><span class="p">()</span></code> into the <code class="codehilite"><span class="n">boot_params</span></code> and pass it to kernel. In <code class="codehilite"><span class="n">setup_arch</span><span class="p">()</span></code>, we will copy the trampoline.bin code to the <code class="codehilite"><span class="n">cs</span><span class="p">()</span></code> address reported by <code class="codehilite"><span class="n">boot_param</span></code>. This means we will override setup code, which is okay.</p>
<p>At last, we wake up the secondary CPUs inside <code class="codehilite"><span class="n">smp_init</span><span class="p">()</span></code>.</p>
<h2 id="compare-with-linux">Compare with Linux<a class="headerlink" href="#compare-with-linux" title="Permanent link">&para;</a></h2>
<p>I vaguely remember how Linux implement this. The only thing I remember is that Linux use some sort of structure, which is filled by BSP and then passed, or used by secondary CPUs. The mechanism has no difference, though. Linux just has more robust debugging facilities.</p>
<p>&ndash;<br />
Yizhou Shan<br />
Mar 3, 2017</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../pagefault_disable/" class="btn btn-neutral float-right" title="Disable pgfault">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../profile_points/" class="btn btn-neutral" title="Profile points"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../profile_points/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../pagefault_disable/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '../../..';</script>
    <script src="../../../js/theme.js" defer></script>
      <script src="../../../search/main.js" defer></script>

</body>
</html>
