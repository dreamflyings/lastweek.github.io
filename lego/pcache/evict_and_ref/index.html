<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../../../img/favicon.ico">
  <title>Evict and Refcount - Yizhou Shan's Home Page</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>
  <link href='https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../../../css/highlight.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Evict and Refcount";
    var mkdocs_page_input_path = "lego/pcache/evict_and_ref.md";
    var mkdocs_page_url = "/lego/pcache/evict_and_ref/";
  </script>
  
  <script src="../../../js/jquery-2.1.1.min.js"></script>
  <script src="../../../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../../../js/highlight.pack.js"></script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../../.." class="icon icon-home"> Yizhou Shan's Home Page</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	  
          
		  
  <ul class="" href="../../..">
    <li class="toctree-l1">
  <a class="" href="../../..">Home</a>
  </li></ul>
          
		  
  <ul class="" href="../../../misc/essential/">
    <li class="toctree-l1">
  <a class="" href="../../../misc/essential/">Essential</a>
  </li></ul>
          
		  
  <ul class="" href="../../../misc/cheatsheet/">
    <li class="toctree-l1">
  <a class="" href="../../../misc/cheatsheet/">Cheatsheet</a>
  </li></ul>
          
		  
  <p class="caption">Notes</p>
  <ul class="">
          <li class="toctree-l1">
            
  <a class="" href="../../../notes/rmap/">Linux: Reverse Mmap</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="../../../notes/trace/">Linux: Tracing</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="../../../notes/cgroup-swap/">Linux: Cgroup and Swap</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="../../../notes/userfaultfd/">Linux: Userfaultfd</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="../../../notes/xperf/">Linux: User/kern Cross Perf</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="../../../notes/kvm-basic/">KVM:   Basics</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="../../../notes/cache_coherence/">Arch:  Cache Coherence</a>
        </li>
  </ul>

          
		  
  <p class="caption">LegoOS</p>
  <ul class="current">
          <li class="toctree-l1">
            
  <a class="" href="/lego/log/TODO">Log</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="/lego/kernel/kconfig">Kernel</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="/lego/syscall/facts">Syscall</a>
        </li>
          <li class="toctree-l1 current">
            
  <a class="current" href="/lego/pcache/config">Pcache</a>
  <ul class="subnav">
        <li class="toctree-l2 1">
            
  <a class="" href="../config/">Config</a>
        </li>
        <li class="toctree-l2 1">
            
  <a class="" href="../sweep/">Sweep</a>
        </li>
        <li class="toctree-l2 1">
            
  <a class="" href="../tlb/">TLB Coherence</a>
        </li>
        <li class="toctree-l2 1">
            
  <a class="" href="../pgtable-lock/">PageTable Lock</a>
        </li>
        <li class="toctree-l2 1">
            
  <a class="" href="../victim/">Victim Cache</a>
        </li>
        <li class="toctree-l2 1">
            
  <a class="" href="../virtual_cache/">Virtual Cache</a>
        </li>
        <li class="toctree-l2 1">
            
  <a class="" href="../rmap/">Reverse Mapping</a>
        </li>
        <li class="toctree-l2 current 1">
            
  <a class="current" href="./">Evict and Refcount</a>
  <ul class="subnav">
      
  <li class="toctree-l2 current">
  
    <a class="current"  href="#mumble-pcache-eviction-and-refcount">Mumble pcache eviction and refcount</a>
  
  
  </li>

  </ul>
        </li>
        <li class="toctree-l2 1">
            
  <a class="" href="../smp_design/">SMP Design</a>
        </li>
        <li class="toctree-l2 1">
            
  <a class="" href="../replication/">Replication</a>
        </li>
  </ul>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="/lego/driver/pci">Driver</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="/lego/paper/nmp">Paper</a>
        </li>
  </ul>

          
		  
  <p class="caption">FPGA</p>
  <ul class="">
          <li class="toctree-l1">
            
  <a class="" href="../../../fpga/hls_axi/">HLS: Usage of AXI-Stream</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="../../../fpga/hls_axi/">HLS: High-performance AXI-MM</a>
        </li>
  </ul>

          
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../..">Yizhou Shan's Home Page</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../..">Docs</a> &raquo;</li>
    
      
        
          <li>LegoOS &raquo;</li>
        
      
        
          <li>Pcache &raquo;</li>
        
      
    
    <li>Evict and Refcount</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="mumble-pcache-eviction-and-refcount">Mumble pcache eviction and refcount</h1>
<p>This is about how Lego is doing eviction against live references of pcache. Unlike the <code class="codehilite">garbage collection</code> where it only reclaims object that has no references, pcache eviction may try to evict a pcache that is currently being used by another thread. Both parties need to be very careful. A tricky business.</p>
<p>To describe the issue in a high-level, let us consider this case: the system now has two threads running on two different cores. The first thread try to evict a pcache line, and it truly find a candidate and prepare to evict. Meanwhile, the other thread is currently using this pcache line to do some operations such as <code class="codehilite">zap_rmap()</code>. If the first thread evict the pcache line without synchronization with the second thread, oops, the second thread is playing with a wrong pcache.</p>
<p>The textbook idea is adding refcount. However, this is not enough in C. Because:</p>
<ul>
<li>There is no way to prevent the second thread from getting the <strong><code class="codehilite">pointer</code></strong> to that pcm.</li>
<li>A simple <code class="codehilite">inc_refcount()</code> from the second thread can happen anytime in the middle of first thread&rsquo;s eviction.</li>
</ul>
<p>Solutions:</p>
<ul>
<li>To actually prevent the second thread from getting the pointer, we should think about <em>how</em> it get the pointer? Luckily, in Lego, there is only one entry point, which is from <code class="codehilite">pte to pcm</code> (aka. pcache_meta). So to synchronize pte change becomes very important. Luckily, we are doing pte_lock before getting the pcm. So this simple pte lock ensures the second thread a safe, will-not-be-evicted pcm (of course, with some other checkings). This idea can also be generalized to any data structures that need pointer references: <strong>protect your pointer</strong>!</li>
<li>Refcount checking is also necessary. In the eviction routine, we need to use  <code class="codehilite">atomic_xchg</code> to reset the refcount. If this fails, it means someone else is using it. Do note, this <code class="codehilite">atomic_xchg</code> is carried out with pcm locked. Thus the ordering of locking, get/put matters in the code.</li>
</ul>
<p>The code itself tells a much more complete story, I strongly recommend you read the code if you are interested. Here I will list the most interesting part. For the other users except eviction, they need to do this:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">pcm</span> <span class="o">=</span> <span class="n">pte_to_pcache_meta</span><span class="p">(</span><span class="n">ptent</span><span class="p">);</span>
<span class="cm">/*   </span>
<span class="cm"> * We have a strict lock ordering everyone should obey:</span>
<span class="cm"> *      lock pcache</span>
<span class="cm"> *      lock pte</span>
<span class="cm"> * The caller already locked pte, thus we should avoid deadlock here</span>
<span class="cm"> * by droping pte lock first and then acquire both of them in order.</span>
<span class="cm"> */</span>
<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">trylock_pcache</span><span class="p">(</span><span class="n">pcm</span><span class="p">)))</span> <span class="p">{</span>
    <span class="cm">/* in case it got evicted and @pcm becomes invalid */</span>
    <span class="n">get_pcache</span><span class="p">(</span><span class="n">pcm</span><span class="p">);</span>

    <span class="cm">/*</span>
<span class="cm">     * Once we release the pte lock, this pcm may be</span>
<span class="cm">     * unmapped by another thread who is doing eviction.</span>
<span class="cm">     * Since we have grabbed one extra ref above, so even</span>
<span class="cm">     * it is unmapped, eviction thread will not fail to free it.</span>
<span class="cm">     */</span>
    <span class="n">spin_unlock</span><span class="p">(</span><span class="n">ptl</span><span class="p">);</span>

    <span class="n">lock_pcache</span><span class="p">(</span><span class="n">pcm</span><span class="p">);</span>
    <span class="n">spin_lock</span><span class="p">(</span><span class="n">ptl</span><span class="p">);</span>

    <span class="cm">/*   </span>
<span class="cm">     * Since we dropped the lock, the pcache line might</span>
<span class="cm">     * be got evicted in the middle.</span>
<span class="cm">     */</span>
<span class="hll">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pte_same</span><span class="p">(</span><span class="o">*</span><span class="n">pte</span><span class="p">,</span> <span class="n">ptent</span><span class="p">))</span> <span class="p">{</span>
</span>        <span class="n">unlock_pcache</span><span class="p">(</span><span class="n">pcm</span><span class="p">);</span>
        <span class="cm">/*   </span>
<span class="cm">         * This put maybe decreases the ref to 0</span>
<span class="cm">         * and eventually free the pcache line.</span>
<span class="cm">         * This happens if the @pcm was selected</span>
<span class="cm">         * to be evicted at the same time.</span>
<span class="cm">         */</span>
        <span class="n">put_pcache</span><span class="p">(</span><span class="n">pcm</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
    <span class="p">}</span>    
    <span class="n">put_pcache</span><span class="p">(</span><span class="n">pcm</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></p>
<p>As for the eviction thread, it needs to make sure it is the last user using this pcm:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="cm">/*  </span>
<span class="cm"> * Each rmap counts one refcount, plus the one grabbed</span>
<span class="cm"> * during evict_find_line(), we should have (nr_mapped + 1)</span>
<span class="cm"> * here if there are no any other users.</span>
<span class="cm"> *</span>
<span class="cm"> * Furthurmore, others can not go from munmap/mremap/wp to</span>
<span class="cm"> * put_pcache() within pcache_zap_pte(), pcache_move_pte()</span>
<span class="cm"> * or pcache_do_wp_page(). Thus the refcount must larger or</span>
<span class="cm"> * equal to (nr_mapped + 1).</span>
<span class="cm"> *</span>
<span class="cm"> * But if there truly other users (refcount &gt; nr_mapped + 1),</span>
<span class="cm"> * then we should manually sub the refcount. The other users</span>
<span class="cm"> * which are currently holding the ref, will free the pcache</span>
<span class="cm"> * once it call put_pcache.</span>
<span class="cm"> */</span>
<span class="n">PCACHE_BUG_ON_PCM</span><span class="p">(</span><span class="n">pcache_ref_count</span><span class="p">(</span><span class="n">pcm</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">nr_mapped</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">pcm</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">pcache_ref_freeze</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">nr_mapped</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">pcache_ref_sub_and_test</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">nr_mapped</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span> <span class="p">{</span>
        <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;BUG: pcm refcount, nr_mapped: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nr_mapped</span><span class="p">);</span>
        <span class="n">dump_pcache_meta</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="s">&quot;ref error&quot;</span><span class="p">);</span>
        <span class="n">BUG</span><span class="p">();</span>
    <span class="p">}</span>   

    <span class="n">ClearPcacheReclaim</span><span class="p">(</span><span class="n">pcm</span><span class="p">);</span>
    <span class="n">add_to_lru_list</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">pset</span><span class="p">);</span>
    <span class="n">unlock_pcache</span><span class="p">(</span><span class="n">pcm</span><span class="p">);</span>

    <span class="n">inc_pcache_event</span><span class="p">(</span><span class="n">PCACHE_EVICTION_EAGAIN_CONCURRENT</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">PCACHE_EVICT_EAGAIN_CONCURRENT</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></p>
<hr />
<p>My personal thought: live eviction against live objects/references is very hard. You first need to use refcount to ensure a correct ordering. You also need to have a way to prevent others from using the going-to-be-evicted pointer, or have a way to detect a under-use pointer.  In this Lego pcache case, we use the combination of pte lock, pcache lock, and pcache refcount, to ensure everyone is safe. And all these is quite similar to Linux page operations. I learned a lot from its code. But I still not fully understand how it ensures the page is not used by others, it has way more parties than lego that can use the page at the same time of eviction. Magic kernel folks.</p>
<p>&ndash;<br />
Yizhou Shan <img alt="🌿" class="emojione" src="https://cdn.jsdelivr.net/emojione/assets/svg/1f33f.svg" title=":herb:" /><br />
Created: Mar 15, 2018<br />
Last Updated: Mar 16, 2018</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../smp_design/" class="btn btn-neutral float-right" title="SMP Design">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../rmap/" class="btn btn-neutral" title="Reverse Mapping"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../rmap/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../smp_design/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '../../..';</script>
    <script src="../../../js/theme.js"></script>
      <script src="../../../search/require.js"></script>
      <script src="../../../search/search.js"></script>

</body>
</html>
