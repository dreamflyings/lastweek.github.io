<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../../../img/favicon.ico">
  <title>SMP Design - Yizhou Shan's Home Page</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>
  <link href='https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../../../css/highlight.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "SMP Design";
    var mkdocs_page_input_path = "lego/pcache/smp_design.md";
    var mkdocs_page_url = "/lego/pcache/smp_design/";
  </script>
  
  <script src="../../../js/jquery-2.1.1.min.js"></script>
  <script src="../../../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../../../js/highlight.pack.js"></script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../../.." class="icon icon-home"> Yizhou Shan's Home Page</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	  
          
		  
  <ul class="" href="../../..">
    <li class="toctree-l1">
  <a class="" href="../../..">Home</a>
  </li></ul>
          
		  
  <p class="caption">Notes</p>
  <ul class="">
          <li class="toctree-l1">
            
  <a class="" href="../../../notes/cache_coherence/">[Arch] Cache Coherence</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="../../../notes/rmap/">[Linux] Reverse Mmap (rmap)</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="../../../notes/trace/">[Linux] Tracing</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="../../../notes/cgroup-swap/">[Linux] Cgroup and Swap</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="../../../notes/userfaultfd/">[Linux] Userfaultfd</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="../../../notes/xperf/">[Linux] User/kern Cross Perf</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="../../../notes/kvm-basic/">[Linux] KVM</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="../../../misc/essential/">[Misc] Essential</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="../../../misc/cheatsheet/">[Misc] Cheatsheet</a>
        </li>
  </ul>

          
		  
  <p class="caption">LegoOS</p>
  <ul class="current">
          <li class="toctree-l1">
            
  <a class="" href="/lego/log/TODO">Log</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="/lego/kernel/kconfig">Kernel</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="/lego/syscall/facts">Syscall</a>
        </li>
          <li class="toctree-l1 current">
            
  <a class="current" href="/lego/pcache/config">Pcache</a>
  <ul class="subnav">
        <li class="toctree-l2 1">
            
  <a class="" href="../config/">Config</a>
        </li>
        <li class="toctree-l2 1">
            
  <a class="" href="../sweep/">Sweep</a>
        </li>
        <li class="toctree-l2 1">
            
  <a class="" href="../tlb/">TLB Coherence</a>
        </li>
        <li class="toctree-l2 1">
            
  <a class="" href="../pgtable-lock/">PageTable Lock</a>
        </li>
        <li class="toctree-l2 1">
            
  <a class="" href="../victim/">Victim Cache</a>
        </li>
        <li class="toctree-l2 1">
            
  <a class="" href="../virtual_cache/">Virtual Cache</a>
        </li>
        <li class="toctree-l2 1">
            
  <a class="" href="../rmap/">Reverse Mapping</a>
        </li>
        <li class="toctree-l2 1">
            
  <a class="" href="../evict_and_ref/">Evict and Refcount</a>
        </li>
        <li class="toctree-l2 current 1">
            
  <a class="current" href="./">SMP Design</a>
  <ul class="subnav">
      
  <li class="toctree-l2 current">
  
    <a class="current"  href="#smp-design-thought">SMP Design Thought</a>
  
  
    <ul class="">
    
        <li class="toctree-l3 toc-item" >
          <a class="toctree-l3" href="#pcache-and-victim-cache-organization">Pcache and Victim Cache Organization</a>
        </li>
    
        <li class="toctree-l3 toc-item" >
          <a class="toctree-l3" href="#allocationeviction-smp-consideration">Allocation/Eviction SMP Consideration</a>
        </li>
    
        <li class="toctree-l3 toc-item" >
          <a class="toctree-l3" href="#more-on-above-two-solutions">More on above two solutions</a>
        </li>
    
    </ul>
  
  </li>

  </ul>
        </li>
        <li class="toctree-l2 1">
            
  <a class="" href="../replication/">Replication</a>
        </li>
  </ul>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="/lego/driver/pci">Driver</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="/lego/paper/nmp">Paper</a>
        </li>
  </ul>

          
		  
  <p class="caption">FPGA</p>
  <ul class="">
          <li class="toctree-l1">
            
  <a class="" href="../../../fpga/hls_axi/">HLS: Usage of AXI-Stream</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="../../../fpga/hls_axi/">HLS: High-performance AXI-MM</a>
        </li>
  </ul>

          
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../..">Yizhou Shan's Home Page</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../..">Docs</a> &raquo;</li>
    
      
        
          <li>LegoOS &raquo;</li>
        
      
        
          <li>Pcache &raquo;</li>
        
      
    
    <li>SMP Design</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="smp-design-thought">SMP Design Thought</h1>
<p>Coding pcache is nothing different from coding mm code. It is the same with your familiar mixed pgfault, LRU, page cache and writeback code. Each pcache line can be involved with multiple activities at the same time. We have to use different states to synchronize among them. If you have ever read linux mm code, you will know that sometimes, comment is literally more than code. SMP pain in ass.</p>
<p>I don&rsquo;t think this document is well written. It is just some random thoughts I wrote down while coding. Some of them might be wrong. But it is still worth looking back.</p>
<h2 id="pcache-and-victim-cache-organization">Pcache and Victim Cache Organization</h2>
<p>Our pcache and victim cache are allocated and arranged as a big array. As for
pcache we look at it in a <em>cache set view</em>, which means consecutive pcache lines
are not relevant in natual. As for victim cache, we simply treat it as a big array
and walk through it one by one.</p>
<h2 id="allocationeviction-smp-consideration">Allocation/Eviction SMP Consideration</h2>
<p>The alloc/free of both pcache and victim cache are simple: each pcache line or
victim cache line has a <code class="codehilite">Allocated</code> bit to indicate if this line is free or not.
The <code class="codehilite">Allocated</code> bit is manipulated by atomic bit operations, thus SMP safe. This
further implies that we do not need another spinlock to guard allocation.</p>
<p>However, other activities such as explict eviction, background sweep may walk
through the cache lines at the same time of cache allocation, a single <code class="codehilite">Allocated</code>
bit is not enough. Because an allocated cache line will need some initial setup,
such as reset refcount, clear flags (prep_new_pcache),
thus there is a small time gap between Allocated bit being set and the cache line
being truly safe to use. Other activities must wait the cache line to be usable,
and then they can do further operations on this cache line.</p>
<p>To solve this race condition, there two possible solutions:
1) Add another bit: <code class="codehilite">Usable</code>, which is set once initial setup is done.
   In this case, functions excluding alloction code should always check if the <code class="codehilite">Usable</code>
   bit is set or not. a) If it is set, this means the cache line is safe for further operations
   b) If not, and <code class="codehilite">Allocated</code> bit is set, this means the cache line is under setup in another core,
   We should skip it.
   c) If not, and <code class="codehilite">Allocated</code> bit is not set, this means this cache line is simply free.
   We should skip it.</p>
<p>2) Add allocated cache lines to a list (such as LRU list), and functions excluding allocation
   code will only look into cache lines within this list. In other words, others will only
   look into surely usable cache lines.</p>
<p>Both solutions try to avoid others looking into <em>un-mature</em> cache lines in SMP envorinment.
The rule is simple: function should <em>NOT</em> look into data that is not supposed to be seen.
The cache line that has Allocated bit set but under setup is a typical case.</p>
<p>As an example, the physical page allocator, page reclaim, page cache in Linux are implemented with
the second solution. Pages freshly allocated will be added a LRU list or page cache own list.
And page reclaim code will only look into pages within the LRU list, it will not go through all
physical pages to do so. The reason for Linux to do so is simple: kernel can not scan the whole
physical pages to find out pages to operate.</p>
<p><code class="codehilite">Pcache:</code> When it comes to pcache, we use both.
In our envision, pcache will have high-associativity such as 64 or 128.
It will have very bad performance if our eviction algorithm or sweep thread need to go through every
cache lines within a set to find out candidates, while there might be only 1 or 2 allocated lines.
However, additional <code class="codehilite">Usable</code> bit is added for debug purpose.</p>
<p><code class="codehilite">Victim Cache:</code> When it comes to victim cache, the first solution seems a better choice.
Because victim cache only a few cache lines, e.g., 8 or 16. This means a whole victim cache line
walk is fast. While the list deletion and addition seem may introduce some unnecessary overhead.
It is all about trade-off.</p>
<p>These choices affect the usage of pcache and victim cache, mostly the eviction code.</p>
<h2 id="more-on-above-two-solutions">More on above two solutions</h2>
<p>The first solution is used if evict_random is configured. The second solution is used when
evict_lru is configured.</p>
<p>I do not have any doubt about second solution, it works, though with a lot SMP pain in ass.
But I do have more to say about the first solution, which is adding another usable bit.
The <code class="codehilite">Usable</code> bit <em>only</em> ensures other threads will not use unmature pcache, but it can not
prevent other threads seeing a going-to-be-freed pcache.</p>
<p>What is this going-to-be-freed asshole? Let us consider this case: CPU0 is doing eviction
and checked the <code class="codehilite">Usable</code> bit, which is set. Then CPU0 thought this cache line is all set,
ready to be torqued. Before doing all the dirty work, CPU0 will <code class="codehilite">get_pcache_unless_zero()</code>
first to make sure the pcache will not go away in the middle. However, meanwhile, CPU1 did
a <code class="codehilite">put_pcache()</code> <em>and</em> a consecutive <code class="codehilite">pcache_alloc()</code> right before CPU0 did called
<code class="codehilite">get_pcache_unless_zero()</code>. Bang! CPU0 may use an mature pcache line, cause CPU1&rsquo;s <code class="codehilite">pcache_init_ref_count()</code>
may come before CPU1&rsquo;s <code class="codehilite">get_pcache_unless_zero()</code>! How to solve this? CPU0 need to add
additional checking after <code class="codehilite">get_pcache_unless_zero()</code>.</p>
<p>For more details, please check the code in <code class="codehilite">pcache/evcit_random.c</code>, which has more pretty explanation.</p>
<p>&ndash;<br />
Yizhou Shan<br />
Jan 31, 2018</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../replication/" class="btn btn-neutral float-right" title="Replication">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../evict_and_ref/" class="btn btn-neutral" title="Evict and Refcount"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../evict_and_ref/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../replication/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '../../..';</script>
    <script src="../../../js/theme.js"></script>
      <script src="../../../search/require.js"></script>
      <script src="../../../search/search.js"></script>

</body>
</html>
