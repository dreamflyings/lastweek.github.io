<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <meta name="author" content="Yizhou Shan">
  <link rel="shortcut icon" href="../../../img/favicon.ico">
  <title>Virtual Cache - Yizhou Shan's Home Page</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>
  <link href='https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Virtual Cache";
    var mkdocs_page_input_path = "lego/pcache/virtual_cache.md";
    var mkdocs_page_url = "/lego/pcache/virtual_cache/";
  </script>
  
  <script src="../../../js/jquery-2.1.1.min.js" defer></script>
  <script src="../../../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
  <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-143772066-1', 'auto');
      ga('send', 'pageview');
  </script>
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../../.." class="icon icon-home"> Yizhou Shan's Home Page</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="tocbase current">
    
    
      


  <li class="navtree toctree-l1 inactive">
    <a class="" href="../../..">Home</a>
  </li>
    
      
  <li class="navtree toctree-l1 label">
    <p class="caption">Notes</p>
  </li>


  

  
    <li class="navtree toctree-l1 group">
      <ul class="navtree subnav-l1 current">
          


  <li class="navtree toctree-l2 inactive">
    <a class="" href="../../../notes/paper_fpga/">FPGA Papers</a>
  </li>
        
          


  <li class="navtree toctree-l2 inactive">
    <a class="" href="../../../notes/cache_coherence/">Cache Coherence</a>
  </li>
        
          


  <li class="navtree toctree-l2 inactive">
    <a class="" href="../../../notes/benchmark/">Benchmarks</a>
  </li>
        
          


  <li class="navtree toctree-l2 inactive">
    <a class="" href="../../../notes/paper_perf_shadows/">Perf Shadows</a>
  </li>
        
          


  <li class="navtree toctree-l2 inactive">
    <a class="" href="../../../notes/linux-articles/">Linux Articles</a>
  </li>
        
          


  <li class="navtree toctree-l2 inactive">
    <a class="" href="../../../notes/proc/">[Linux] Special Files</a>
  </li>
        
          


  <li class="navtree toctree-l2 inactive">
    <a class="" href="../../../notes/rmap/">[Linux] Reverse Mmap (rmap)</a>
  </li>
        
          


  <li class="navtree toctree-l2 inactive">
    <a class="" href="../../../notes/trace/">[Linux] Trace/Profile</a>
  </li>
        
          


  <li class="navtree toctree-l2 inactive">
    <a class="" href="../../../notes/cgroup-swap/">[Linux] Cgroup and Swap</a>
  </li>
        
          


  <li class="navtree toctree-l2 inactive">
    <a class="" href="../../../notes/userfaultfd/">[Linux] Userfaultfd</a>
  </li>
        
          


  <li class="navtree toctree-l2 inactive">
    <a class="" href="../../../notes/xperf/">[Linux] User/kern Cross Perf</a>
  </li>
        
          


  <li class="navtree toctree-l2 inactive">
    <a class="" href="../../../notes/kvm-basic/">[Linux] KVM</a>
  </li>
        
          


  <li class="navtree toctree-l2 inactive">
    <a class="" href="../../../misc/essential/">Essential</a>
  </li>
        
          


  <li class="navtree toctree-l2 inactive">
    <a class="" href="../../../misc/cheatsheet/">Cheatsheet</a>
  </li>
        
          
  <li class="navtree toctree-l2 label">
    <p class="caption">Log</p>
  </li>


  

  
    <li class="navtree toctree-l2 group">
      <ul class="navtree subnav-l2 current">
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../../general_log/0919/">Sep 2019</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../../general_log/0819/">Aug 2019</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../../general_log/0719/">Jul 2019</a>
  </li>
        
      </ul>
    </li>
        
      </ul>
    </li>
    
      
  <li class="navtree toctree-l1 label">
    <p class="caption">FPGA</p>
  </li>


  

  
    <li class="navtree toctree-l1 group">
      <ul class="navtree subnav-l1 current">
          


  <li class="navtree toctree-l2 inactive">
    <a class="" href="../../../fpga/hls_axi/">HLS: Usage of AXI-Stream</a>
  </li>
        
          


  <li class="navtree toctree-l2 inactive">
    <a class="" href="../../../fpga/hls_axi/">HLS: High-performance AXI-MM</a>
  </li>
        
          


  <li class="navtree toctree-l2 inactive">
    <a class="" href="../../../fpga/vivado_tricks/">Vivado Tricks</a>
  </li>
        
      </ul>
    </li>
    
      
  <li class="navtree toctree-l1 label">
    <p class="caption">LegoOS-Dev</p>
  </li>


  

  
    <li class="navtree toctree-l1 group">
      <ul class="navtree subnav-l1 current">
          
  <li class="navtree toctree-l2 label">
    <p class="caption">Log</p>
  </li>


  

  
    <li class="navtree toctree-l2 group">
      <ul class="navtree subnav-l2 current">
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../log/TODO/">TODO</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../log/misc/">MISC</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../log/test-note/">Test Script</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../log/log-09-2018/">Sep 2018</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../log/log-08-2018/">Aug 2018</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../log/log-04-2018/">April 2018</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../log/log-03-2018/">March 2018</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../log/log-02-2018/">Feb 2018</a>
  </li>
        
      </ul>
    </li>
        
          
  <li class="navtree toctree-l2 label">
    <p class="caption">Kernel</p>
  </li>


  

  
    <li class="navtree toctree-l2 group">
      <ul class="navtree subnav-l2 current">
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../kernel/kconfig/">Kconfig</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../kernel/debug/">Debug</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../kernel/grub/">GRUB</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../kernel/profile/">Profile</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../kernel/profile_strace/">Profile strace</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../kernel/profile_heatmap/">Profile heatmap</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../kernel/profile_points/">Profile points</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../kernel/trampoline/">Trampoline</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../kernel/pagefault_disable/">Disable pgfault</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../kernel/stop_machine/">Stop machine</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../kernel/loader/">Program Loader</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../kernel/vDSO/">vDSO</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../kernel/vfs/">Virtual File System</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../kernel/vm/">Process Virtual Memory</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../kernel/fpu/">x86 FPU</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../kernel/irq/">IRQ</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../kernel/net_thpool/">Network Thpool</a>
  </li>
        
      </ul>
    </li>
        
          
  <li class="navtree toctree-l2 label">
    <p class="caption">Syscall</p>
  </li>


  

  
    <li class="navtree toctree-l2 group">
      <ul class="navtree subnav-l2 current">
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../syscall/facts/">Facts</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../kernel/profile_strace/">strace</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../syscall/compat/">compat</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../syscall/msync/">msync()</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../syscall/mremap/">mremap()</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../syscall/fork/">fork()</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../syscall/getrusage/">getrusage()</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../syscall/wait_and_exit/">wait4 and exit()</a>
  </li>
        
      </ul>
    </li>
        
          
  <li class="navtree toctree-l2 label">
    <p class="caption">Pcache</p>
  </li>


  

  
    <li class="navtree toctree-l2 group">
      <ul class="navtree subnav-l2 current">
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../config/">Config</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../sweep/">Sweep</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../tlb/">TLB Coherence</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../pgtable-lock/">PageTable Lock</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../victim/">Victim Cache</a>
  </li>
        
          


  
    
    <li class="navtree toctree-l3 page current">
      <a class="current" href="./">
        Virtual Cache
      </a>
    </li>
    
      

  <li class="toctree-l3 current with-children">
    <a href="#virtual-cache">
      Virtual Cache
      <span class="toctree-expand"></span>
    </a>
  </li>




  
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../rmap/">Reverse Mapping</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../evict_and_ref/">Evict and Refcount</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../smp_design/">SMP Design</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../replication/">Replication</a>
  </li>
        
      </ul>
    </li>
        
          
  <li class="navtree toctree-l2 label">
    <p class="caption">Driver</p>
  </li>


  

  
    <li class="navtree toctree-l2 group">
      <ul class="navtree subnav-l2 current">
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../driver/pci/">PCI</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../driver/ib/">Infiniband</a>
  </li>
        
      </ul>
    </li>
        
          
  <li class="navtree toctree-l2 label">
    <p class="caption">Paper</p>
  </li>


  

  
    <li class="navtree toctree-l2 group">
      <ul class="navtree subnav-l2 current">
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../paper/nmp/">NMP</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../paper/processor_oom/">Processor OOM</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../paper/genz/">Gen-Z</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../paper/replication/">Replication</a>
  </li>
        
          


  <li class="navtree toctree-l3 inactive">
    <a class="" href="../../paper/related/">Related</a>
  </li>
        
      </ul>
    </li>
        
      </ul>
    </li>
    
  </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../..">Yizhou Shan's Home Page</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../..">Docs</a> &raquo;</li>
    
      
        
          <li>Pcache &raquo;</li>
        
      
        
          <li>LegoOS-Dev &raquo;</li>
        
      
    
    <li>Virtual Cache</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="virtual-cache">Virtual Cache<a class="headerlink" href="#virtual-cache" title="Permanent link">&para;</a></h1>
<ul>
<li>Synonymous<ul>
<li>impact Cache coherence</li>
<li>impact TLB shootdown</li>
<li>The good thing is, synonymous actually happen very rare in really workload. But when OS is invoked, it actually creates a lot synonymous. Because the physical page is mapped both low user virtual address and high kernel virtual address.</li>
<li>What is this?</li>
<li>What is bad about this?</li>
<li>When does this happen? (All cases: kernel, shared vma mapping)</li>
<li>How to solve this?<ul>
<li>Software solution: OS level detection, global virtual address, identical virtual address etc.</li>
<li>Hardware solution: detect and manage at runtime. Back pointer, Dynamic synonymous remapping, reverse mapping. Similar ideas.</li>
<li>A nice summary can be found on <code class="codehilite"><span class="nv">A</span> <span class="nv">new</span> <span class="nv">perspective</span> <span class="k">for</span> <span class="nv">efficient</span> <span class="nv">virtual</span><span class="o">-</span><span class="nv">cache</span> <span class="nv">coherence</span>, <span class="nv">ISCA</span><span class="s1">&#39;</span><span class="s">13</span></code>.</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>Let me share my reading list. I think I&rsquo;ve collected most of the important virtual cache papers:
<img alt="A" src="../pcache_img_3.png" /></p>
<ul>
<li>
<p>TLB and cache line lifetime:</p>
<ul>
<li><code class="codehilite"><span class="n">Enigma</span><span class="p">,</span> <span class="n">ISC</span><span class="err">&#39;</span><span class="mi">10</span></code>: For each case where valid data exists in the cache hierarchy without a corresponding valid translation entry, systems with physically-tagged caches have to resolve the translation miss. Only after the page table has been “walked” and a valid translation entry installed can the already cache-resident data be provided to the processing core. Especially in the faster levels of cache, the additional page table walk can add significant latency to what otherwise would have been a low-latency cache hit.
<img alt="Enigma" src="../pcache_img_1.png" /></li>
<li><code class="codehilite"><span class="n">GPU</span> <span class="n">virtual</span> <span class="k">cache</span><span class="p">,</span> <span class="n">ASPLOS</span><span class="err">&#39;</span><span class="mi">18</span></code>: We notice that the per-CU TLB miss ratio is high; however, many TLB misses hit in the GPU caches. Only 34% of references that miss in the 32-entry per-CU L1 TLB are also L2 cache misses and access main memory (blue bars). An average of 31% of total per-CU TLB misses find the corresponding data in private L1 caches (black bars), and an additional 35% of the total misses hit in a shared L2 virtual cache (red bars). These hits occur because blocks in the cache hierarchy are likely to reside longer than the lifetime of the corresponding per-CU TLB entries
<img alt="A" src="../pcache_img_2.png" /></li>
</ul>
</li>
<li>
<p>Reading the <code class="codehilite"><span class="n">GPU</span> <span class="n">virtual</span> <span class="k">cache</span> <span class="n">ASPLOS</span><span class="err">&#39;</span><span class="mi">18</span></code> paper today. I mostly interested in how they handle synonymous and mremap issue.</p>
<ul>
<li>Synonymous:</li>
<li>Their solution for synonymous is quite simple (not sure if practical or effective): use a <code class="codehilite"><span class="k">leading</span></code> virtual address, which is the first VA that has the virtual cache miss. Subsequent misses that from <code class="codehilite"><span class="n">different</span></code> VA will not have the their cache lines filled, instead, they will make subsequent VA forever miss, and fetch the content from the leading VA cache line (they call it replay). In all, synonymous is solved by only having one cache line, and does not fill other VA cache lines.</li>
<li>mremap:</li>
<li>They did not mention mremap. But I guess they do not need to care this. When remap happens, the original PTE is invalidated first, and TLB shootdown follows, all they need to do is to invalidate the virtual cache line (need to be flushed back to memory if dirty). When the new VA mapping established and accessed, it will be a normal virtual cache miss</li>
<li>OVC also does not need to care about this because they are doing a similar way (I guess).</li>
<li>Lego need to handle mremap differently. Because we don&rsquo;t want to flush the dirty line back to memory, to save 1) one clflush, 2) another pcache miss. This means Lego wants to keep the content in Pcache. So the set_index of new VA and old VA matters in our case.</li>
</ul>
</li>
</ul>
<p>&ndash;<br />
Yizhou Shan<br />
Created: Mar 28, 2018<br />
Last Updated: Mar 29, 2018  </p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../rmap/" class="btn btn-neutral float-right" title="Reverse Mapping">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../victim/" class="btn btn-neutral" title="Victim Cache"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../victim/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../rmap/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '../../..';</script>
    <script src="../../../js/theme.js" defer></script>
      <script src="../../../search/main.js" defer></script>

</body>
</html>
