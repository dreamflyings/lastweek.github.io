



<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-0.17.2, mkdocs-material-2.6.2">
    
    
      
        <title>April 2018 - Yizhou Shan's Home Page</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/application.9b572555.css">
      
    
    
      <script src="../../../assets/javascripts/modernizr.1aa3b519.js"></script>
    
    
      
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="search">
    <label class="md-overlay" data-md-component="overlay" for="drawer"></label>
    
      <a href="#april-2018" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../../.." title="Yizhou Shan's Home Page" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                Yizhou Shan's Home Page
              </span>
              <span class="md-header-nav__topic">
                April 2018
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="drawer">
    <span class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </span>
    Yizhou Shan's Home Page
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../misc/jasmine/" title="Jasmine" class="md-nav__link">
      Jasmine
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../misc/cheatsheet/" title="Cheatsheet" class="md-nav__link">
      Cheatsheet
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Read
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Read
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../read/fast18/" title="FAST 18" class="md-nav__link">
      FAST 18
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../read/asplos18/" title="ASPLOS 18" class="md-nav__link">
      ASPLOS 18
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5" checked>
    
    <label class="md-nav__link" for="nav-5">
      Lego
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        Lego
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-1" type="checkbox" id="nav-5-1" checked>
    
    <label class="md-nav__link" for="nav-5-1">
      Log
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-1">
        Log
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../TODO/" title="TODO" class="md-nav__link">
      TODO
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../misc/" title="MISC" class="md-nav__link">
      MISC
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="toc">
        April 2018
      </label>
    
    <a href="./" title="April 2018" class="md-nav__link md-nav__link--active">
      April 2018
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#0403-tue" title="04/03 Tue" class="md-nav__link">
    04/03 Tue
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#bug-bug-bug" title="BUG BUG BUG" class="md-nav__link">
    BUG BUG BUG
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ib_mad_completion_handler" title="ib_mad_completion_handler" class="md-nav__link">
    ib_mad_completion_handler
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fit_poll_cq" title="fit_poll_cq" class="md-nav__link">
    fit_poll_cq
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ib-spec-qp-cqe-wqe-send" title="IB Spec: QP, CQE, WQE, SEND" class="md-nav__link">
    IB Spec: QP, CQE, WQE, SEND
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#0402-mon" title="04/02 Mon" class="md-nav__link">
    04/02 Mon
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#0401-sun" title="04/01 Sun" class="md-nav__link">
    04/01 Sun
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../log-03-2018/" title="March 2018" class="md-nav__link">
      March 2018
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../log-02-2018/" title="Feb 2018" class="md-nav__link">
      Feb 2018
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-2" type="checkbox" id="nav-5-2">
    
    <label class="md-nav__link" for="nav-5-2">
      Kernel
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-2">
        Kernel
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/kconfig/" title="Kconfig" class="md-nav__link">
      Kconfig
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/debug/" title="Debug" class="md-nav__link">
      Debug
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/grub/" title="GRUB" class="md-nav__link">
      GRUB
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/trampoline/" title="Trampoline" class="md-nav__link">
      Trampoline
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/pagefault_disable/" title="Disable pgfault" class="md-nav__link">
      Disable pgfault
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/stop_machine/" title="Stop machine" class="md-nav__link">
      Stop machine
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/loader/" title="Program Loader" class="md-nav__link">
      Program Loader
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/vDSO/" title="vDSO" class="md-nav__link">
      vDSO
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/vfs/" title="Virtual File System" class="md-nav__link">
      Virtual File System
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/vm/" title="Process Virtual Memory" class="md-nav__link">
      Process Virtual Memory
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/fpu/" title="x86 FPU" class="md-nav__link">
      x86 FPU
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-3" type="checkbox" id="nav-5-3">
    
    <label class="md-nav__link" for="nav-5-3">
      Syscall
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-3">
        Syscall
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../syscall/facts/" title="Facts" class="md-nav__link">
      Facts
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../syscall/compat/" title="compat" class="md-nav__link">
      compat
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../syscall/msync/" title="msync()" class="md-nav__link">
      msync()
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../syscall/mremap/" title="mremap()" class="md-nav__link">
      mremap()
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../syscall/fork/" title="fork()" class="md-nav__link">
      fork()
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../syscall/getrusage/" title="getrusage()" class="md-nav__link">
      getrusage()
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../syscall/wait_and_exit/" title="wait4 and exit()" class="md-nav__link">
      wait4 and exit()
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-4" type="checkbox" id="nav-5-4">
    
    <label class="md-nav__link" for="nav-5-4">
      Pcache
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-4">
        Pcache
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/config/" title="Config" class="md-nav__link">
      Config
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/sweep/" title="Sweep" class="md-nav__link">
      Sweep
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/tlb/" title="TLB Coherence" class="md-nav__link">
      TLB Coherence
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/pgtable-lock/" title="PageTable Lock" class="md-nav__link">
      PageTable Lock
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/victim/" title="Victim Cache" class="md-nav__link">
      Victim Cache
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/virtual_cache/" title="Virtual Cache" class="md-nav__link">
      Virtual Cache
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/rmap/" title="Reverse Mapping" class="md-nav__link">
      Reverse Mapping
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/evict_and_ref/" title="Evict and Refcount" class="md-nav__link">
      Evict and Refcount
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/smp_design/" title="SMP Design" class="md-nav__link">
      SMP Design
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/replication/" title="Replication" class="md-nav__link">
      Replication
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-5" type="checkbox" id="nav-5-5">
    
    <label class="md-nav__link" for="nav-5-5">
      Paper
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-5">
        Paper
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../paper/nmp/" title="NMP" class="md-nav__link">
      NMP
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../paper/processor_oom/" title="Processor OOM" class="md-nav__link">
      Processor OOM
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../paper/genz/" title="Gen-Z" class="md-nav__link">
      Gen-Z
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../paper/replication/" title="Replication" class="md-nav__link">
      Replication
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../paper/related/" title="Related" class="md-nav__link">
      Related
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#0403-tue" title="04/03 Tue" class="md-nav__link">
    04/03 Tue
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#bug-bug-bug" title="BUG BUG BUG" class="md-nav__link">
    BUG BUG BUG
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ib_mad_completion_handler" title="ib_mad_completion_handler" class="md-nav__link">
    ib_mad_completion_handler
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fit_poll_cq" title="fit_poll_cq" class="md-nav__link">
    fit_poll_cq
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ib-spec-qp-cqe-wqe-send" title="IB Spec: QP, CQE, WQE, SEND" class="md-nav__link">
    IB Spec: QP, CQE, WQE, SEND
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#0402-mon" title="04/02 Mon" class="md-nav__link">
    04/02 Mon
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#0401-sun" title="04/01 Sun" class="md-nav__link">
    04/01 Sun
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="april-2018">April 2018</h1>
<h2 id="0403-tue">04/03 Tue</h2>
<h3 id="bug-bug-bug">BUG BUG BUG</h3>
<p>Finished basic replication mechanism last night.</p>
<p>Today merged several patches. And both Yilun and I think there is something wrong with <code class="codehilite">ib_mad_completion_handler</code>. It seems it will break things behind our back.</p>
<p>This is one bug catched today:</p>
<h4 id="ib_mad_completion_handler">ib_mad_completion_handler</h4>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">At</span> <span class="n">very</span> <span class="n">early</span> <span class="nl">stage</span><span class="p">:</span>

<span class="p">[</span> <span class="mf">1174.406177</span><span class="p">]</span> <span class="nl">newpid</span><span class="p">:</span> <span class="mi">20</span> <span class="nl">home</span><span class="p">:</span><span class="mi">1</span> <span class="nl">replica</span><span class="p">:</span> <span class="mi">1</span>
<span class="p">[</span> <span class="mf">1174.452983</span><span class="p">]</span> <span class="n">p2m_fork</span><span class="p">(</span><span class="n">cpu10</span><span class="p">)</span><span class="o">:</span> <span class="n">I</span> <span class="nl">cur</span><span class="p">:</span><span class="mi">20</span><span class="o">-</span><span class="n">exe</span><span class="p">.</span><span class="n">o</span> <span class="nl">new</span><span class="p">:</span><span class="mi">21</span>
<span class="p">[</span> <span class="mf">1177.462795</span><span class="p">]</span> <span class="n">ib_mad_completion_handler</span> <span class="mi">2324</span> <span class="n">got</span> <span class="n">successful</span> <span class="n">recv</span> <span class="n">cq</span> <span class="n">op</span> <span class="mi">128</span> <span class="n">mad_got_one</span> <span class="mi">22</span>
<span class="p">[</span> <span class="mf">1177.556502</span><span class="p">]</span> <span class="nl">BUG</span><span class="p">:</span> <span class="n">unable</span> <span class="n">to</span> <span class="n">handle</span> <span class="n">kernel</span> <span class="nb">NULL</span> <span class="n">pointer</span> <span class="n">dereference</span> <span class="n">at</span> <span class="mo">0000000000000020</span>
<span class="p">[</span> <span class="mf">1177.650101</span><span class="p">]</span> <span class="nl">IP</span><span class="p">:</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81059104</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">ib_mad_completion_handler</span><span class="o">+</span><span class="mh">0xb4</span><span class="o">/</span><span class="mh">0x8a0</span>

<span class="p">.</span><span class="o">/</span><span class="n">scripts</span><span class="o">/</span><span class="n">faddr2line</span> <span class="n">vmImage</span>  <span class="n">ib_mad_completion_handler</span><span class="o">+</span><span class="mh">0xb4</span>
<span class="n">ib_mad_completion_handler</span><span class="o">+</span><span class="mh">0xb4</span><span class="o">/</span><span class="mh">0x899</span><span class="o">:</span>
<span class="n">ib_mad_recv_done_handler</span> <span class="n">at</span> <span class="n">drivers</span><span class="o">/</span><span class="n">infiniband</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">mad</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span><span class="mi">1899</span>
 <span class="p">(</span><span class="n">inlined</span> <span class="n">by</span><span class="p">)</span> <span class="n">ib_mad_completion_handler</span> <span class="n">at</span> <span class="n">drivers</span><span class="o">/</span><span class="n">infiniband</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">mad</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span><span class="mi">2325</span>

<span class="n">ib_mad_recv_done_handler</span><span class="p">()</span><span class="o">:</span>
<span class="mi">1899</span><span class="o">:</span> <span class="n">qp_info</span> <span class="o">=</span> <span class="n">mad_list</span><span class="o">-&gt;</span><span class="n">mad_queue</span><span class="o">-&gt;</span><span class="n">qp_info</span><span class="p">;</span>
</pre></div>
</td></tr></table>

<p>A more scared one after I changed ib_mad_completion_handler. Note that recvcq is the only thread running on cpu4:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="p">[</span>  <span class="mf">863.887705</span><span class="p">]</span> <span class="n">p2m_fork</span><span class="p">(</span><span class="n">cpu10</span><span class="p">)</span><span class="o">:</span> <span class="n">I</span> <span class="nl">cur</span><span class="p">:</span><span class="mi">20</span><span class="o">-</span><span class="n">exe</span><span class="p">.</span><span class="n">o</span> <span class="nl">new</span><span class="p">:</span><span class="mi">21</span>
<span class="p">[</span>  <span class="mf">868.478424</span><span class="p">]</span> <span class="n">p2m_fork</span><span class="p">(</span><span class="n">cpu10</span><span class="p">)</span><span class="o">:</span> <span class="n">O</span> <span class="n">succeed</span> <span class="nl">cur</span><span class="p">:</span><span class="mi">20</span><span class="o">-</span><span class="n">exe</span><span class="p">.</span><span class="n">o</span> <span class="nl">new</span><span class="p">:</span><span class="mi">21</span>
<span class="p">[</span>  <span class="mf">868.541991</span><span class="p">]</span> <span class="nl">BUG</span><span class="p">:</span> <span class="n">unable</span> <span class="n">to</span> <span class="n">handle</span> <span class="n">kernel</span> <span class="nb">NULL</span> <span class="n">pointer</span> <span class="n">dereference</span> <span class="n">at</span> <span class="mo">000000000000000</span><span class="mi">8</span>
<span class="p">[</span>  <span class="mf">868.635569</span><span class="p">]</span> <span class="nl">IP</span><span class="p">:</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff810656d4</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">__schedule</span><span class="o">+</span><span class="mh">0x94</span><span class="o">/</span><span class="mh">0x1e0</span>
<span class="p">[</span>  <span class="mf">868.701090</span><span class="p">]</span> <span class="n">PGD</span> <span class="mi">0</span>
<span class="p">[</span>  <span class="mf">868.725010</span><span class="p">]</span> <span class="n">general</span> <span class="n">protection</span> <span class="nl">fault</span><span class="p">:</span> <span class="mo">0000</span> <span class="p">[</span><span class="err">#</span><span class="mi">1</span><span class="p">]</span> <span class="n">SMP</span> <span class="n">PROCESSOR</span>
<span class="p">[</span>  <span class="mf">868.793651</span><span class="p">]</span> <span class="nl">CPU</span><span class="p">:</span> <span class="mi">4</span> <span class="nl">PID</span><span class="p">:</span> <span class="mi">17</span> <span class="nl">Comm</span><span class="p">:</span> <span class="n">recvpollcq</span> <span class="mf">4.0.0</span><span class="o">-</span><span class="n">lego</span><span class="o">-</span><span class="n">ys</span><span class="o">+</span> <span class="err">#</span><span class="mi">737</span>

<span class="nl">Source</span><span class="p">:</span>
<span class="n">clear_tsk_need_resched</span><span class="p">(</span><span class="n">prev</span><span class="p">);</span>
</pre></div>
</td></tr></table></p>
<p>Even this one for Phoenix:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="p">[</span>  <span class="mf">763.442043</span><span class="p">]</span> <span class="nl">BUG</span><span class="p">:</span> <span class="n">unable</span> <span class="n">to</span> <span class="n">handle</span> <span class="n">kernel</span> <span class="nb">NULL</span> <span class="n">pointer</span> <span class="n">dereference</span> <span class="n">at</span> <span class="mo">0000000000000010</span>
<span class="p">[</span>  <span class="mf">763.535636</span><span class="p">]</span> <span class="nl">IP</span><span class="p">:</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81018d6f</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">task_curr</span><span class="o">+</span><span class="mh">0xf</span><span class="o">/</span><span class="mh">0x30</span>
<span class="p">[</span>  <span class="mf">763.598035</span><span class="p">]</span> <span class="n">PGD</span> <span class="mf">103e956067</span> <span class="n">PUD</span> <span class="mf">103e964067</span> <span class="n">PMD</span> <span class="mi">0</span>
<span class="p">[</span>  <span class="mf">763.653154</span><span class="p">]</span> <span class="nl">Oops</span><span class="p">:</span> <span class="mo">0000</span> <span class="p">[</span><span class="err">#</span><span class="mi">1</span><span class="p">]</span> <span class="n">SMP</span> <span class="n">PROCESSOR</span>
<span class="p">[</span>  <span class="mf">763.700992</span><span class="p">]</span> <span class="nl">CPU</span><span class="p">:</span> <span class="mi">12</span> <span class="nl">PID</span><span class="p">:</span> <span class="mi">21</span> <span class="nl">Comm</span><span class="p">:</span> <span class="n">word_count</span><span class="o">-</span><span class="n">pthr</span> <span class="mf">4.0.0</span><span class="o">-</span><span class="n">lego</span><span class="o">-</span><span class="n">ys</span><span class="o">+</span> <span class="err">#</span><span class="mi">740</span>
<span class="p">[</span>  <span class="mf">763.777950</span><span class="p">]</span> <span class="nl">RIP</span><span class="p">:</span> <span class="mo">0010</span><span class="o">:</span><span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81018d6f</span><span class="o">&gt;</span><span class="p">]</span>  <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81018d6f</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">task_curr</span><span class="o">+</span><span class="mh">0xf</span><span class="o">/</span><span class="mh">0x30</span>
</pre></div>
</td></tr></table></p>
<p>This NEVER happen before. And this part of code should be correct. We&rsquo;ve ran a
lot things.. I doubt if recent IB merge corrupt things.</p>
<h4 id="fit_poll_cq">fit_poll_cq</h4>
<p>Another one:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="p">[</span>  <span class="mf">690.401626</span><span class="p">]</span> <span class="nl">stat</span><span class="p">:</span> <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">ys</span><span class="o">/</span><span class="n">phoenix</span><span class="o">/</span><span class="n">phoenix</span><span class="o">-</span><span class="mf">2.0</span><span class="o">/</span><span class="n">tests</span><span class="o">/</span><span class="n">word_count</span><span class="o">/</span><span class="n">word_count_datafiles</span><span class="o">/</span><span class="n">word_1GB</span><span class="p">.</span><span class="n">txt</span>
<span class="p">[</span>  <span class="mf">690.507742</span><span class="p">]</span> <span class="n">SYSC_close</span><span class="p">()</span> <span class="n">CPU12</span> <span class="nl">PID</span><span class="p">:</span><span class="mi">21</span> <span class="p">[</span><span class="nl">fd</span><span class="p">:</span> <span class="mi">4</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">devices</span><span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">cpu</span><span class="o">/</span><span class="n">online</span><span class="p">]</span>
<span class="p">[</span>  <span class="mf">713.899884</span><span class="p">]</span> <span class="n">ib_mad_completion_handler</span> <span class="mi">2337</span> <span class="n">got</span> <span class="n">successful</span> <span class="n">recv</span> <span class="n">cq</span> <span class="n">op</span> <span class="mi">128</span> <span class="n">mad_got_one</span> <span class="mi">21</span>
<span class="p">[</span>  <span class="mf">713.995606</span><span class="p">]</span> <span class="n">ib_mad_completion_handler</span> <span class="mi">2331</span> <span class="n">got</span> <span class="n">successful</span> <span class="n">send</span> <span class="n">cq</span> <span class="n">op</span> <span class="mi">0</span> <span class="n">mad_got_one</span> <span class="mi">21</span>
<span class="p">[</span>  <span class="mf">714.087185</span><span class="p">]</span> <span class="n">ib_mad_completion_handler</span> <span class="mi">2337</span> <span class="n">got</span> <span class="n">successful</span> <span class="n">recv</span> <span class="n">cq</span> <span class="n">op</span> <span class="mi">128</span> <span class="n">mad_got_one</span> <span class="mi">22</span>
<span class="p">[</span>  <span class="mf">714.184871</span><span class="p">]</span> <span class="n">ib_mad_completion_handler</span> <span class="mi">2331</span> <span class="n">got</span> <span class="n">successful</span> <span class="n">send</span> <span class="n">cq</span> <span class="n">op</span> <span class="mi">0</span> <span class="n">mad_got_one</span> <span class="mi">22</span>
<span class="p">[</span>  <span class="mf">742.078102</span><span class="p">]</span> <span class="n">ib_mad_completion_handler</span> <span class="mi">2337</span> <span class="n">got</span> <span class="n">successful</span> <span class="n">recv</span> <span class="n">cq</span> <span class="n">op</span> <span class="mi">128</span> <span class="n">mad_got_one</span> <span class="mi">23</span>
<span class="p">[</span>  <span class="mf">742.173810</span><span class="p">]</span> <span class="n">ib_mad_completion_handler</span> <span class="mi">2331</span> <span class="n">got</span> <span class="n">successful</span> <span class="n">send</span> <span class="n">cq</span> <span class="n">op</span> <span class="mi">0</span> <span class="n">mad_got_one</span> <span class="mi">23</span>
<span class="p">[</span>  <span class="mf">742.265399</span><span class="p">]</span> <span class="n">ib_mad_completion_handler</span> <span class="mi">2337</span> <span class="n">got</span> <span class="n">successful</span> <span class="n">recv</span> <span class="n">cq</span> <span class="n">op</span> <span class="mi">128</span> <span class="n">mad_got_one</span> <span class="mi">24</span>
<span class="p">[</span>  <span class="mf">742.363085</span><span class="p">]</span> <span class="n">ib_mad_completion_handler</span> <span class="mi">2331</span> <span class="n">got</span> <span class="n">successful</span> <span class="n">send</span> <span class="n">cq</span> <span class="n">op</span> <span class="mi">0</span> <span class="n">mad_got_one</span> <span class="mi">24</span>
<span class="p">[</span>  <span class="mf">847.063372</span><span class="p">]</span> <span class="n">mlx4_ib_handle_error_cqe</span> <span class="n">syndrome</span> <span class="mi">21</span>
<span class="p">[</span>  <span class="mf">847.116511</span><span class="p">]</span> <span class="n">mlx4_ib_handle_error_cqe</span> <span class="n">syndrome</span> <span class="mi">5</span>
<span class="p">[</span>  <span class="mf">847.170590</span><span class="p">]</span> <span class="n">send</span> <span class="n">request</span> <span class="n">failed</span> <span class="n">at</span> <span class="n">connection</span> <span class="mi">7</span> <span class="n">as</span> <span class="mi">12</span>
<span class="p">[</span>  <span class="mf">847.230909</span><span class="p">]</span> <span class="n">mlx4_ib_handle_error_cqe</span> <span class="n">syndrome</span> <span class="mi">5</span>
<span class="p">[</span>  <span class="mf">847.284988</span><span class="p">]</span> <span class="n">mlx4_ib_handle_error_cqe</span> <span class="n">syndrome</span> <span class="mi">5</span>
<span class="p">[</span>  <span class="mf">847.339067</span><span class="p">]</span> <span class="n">mlx4_ib_handle_error_cqe</span> <span class="n">syndrome</span> <span class="mi">5</span>
<span class="p">[</span>  <span class="mf">847.393146</span><span class="p">]</span> <span class="nl">fit_poll_cq</span><span class="p">:</span> <span class="n">failed</span> <span class="n">status</span> <span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="k">for</span> <span class="n">wr_id</span> <span class="mi">1832</span>
<span class="p">[</span>  <span class="mf">847.457624</span><span class="p">]</span> <span class="nl">fit_poll_cq</span><span class="p">:</span> <span class="n">failed</span> <span class="n">status</span> <span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="k">for</span> <span class="n">wr_id</span> <span class="mi">1833</span>
<span class="p">[</span>  <span class="mf">847.522103</span><span class="p">]</span> <span class="nl">fit_poll_cq</span><span class="p">:</span> <span class="n">connection</span> <span class="mi">7</span> <span class="n">Recv</span> <span class="n">weird</span> <span class="n">event</span> <span class="n">as</span> <span class="o">-</span><span class="mi">1</span>
<span class="p">[</span>  <span class="mf">847.589701</span><span class="p">]</span> <span class="nl">fit_poll_cq</span><span class="p">:</span> <span class="n">failed</span> <span class="n">status</span> <span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="k">for</span> <span class="n">wr_id</span> <span class="mi">1834</span>
<span class="p">[</span>  <span class="mf">847.654179</span><span class="p">]</span> <span class="nl">fit_poll_cq</span><span class="p">:</span> <span class="n">connection</span> <span class="mi">7</span> <span class="n">Recv</span> <span class="n">weird</span> <span class="n">event</span> <span class="n">as</span> <span class="o">-</span><span class="mi">30704</span>
<span class="p">[</span>  <span class="mf">847.725938</span><span class="p">]</span> <span class="nl">fit_poll_cq</span><span class="p">:</span> <span class="n">failed</span> <span class="n">status</span> <span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="k">for</span> <span class="n">wr_id</span> <span class="mi">1835</span>
<span class="p">[</span>  <span class="mf">847.790416</span><span class="p">]</span> <span class="nl">fit_poll_cq</span><span class="p">:</span> <span class="n">connection</span> <span class="mi">7</span> <span class="n">Recv</span> <span class="n">weird</span> <span class="n">event</span> <span class="n">as</span> <span class="o">-</span><span class="mi">30704</span>
<span class="p">[</span>  <span class="mf">847.862174</span><span class="p">]</span> <span class="n">mlx4_ib_handle_error_cqe</span> <span class="n">syndrome</span> <span class="mi">5</span>
<span class="p">[</span>  <span class="mf">847.916252</span><span class="p">]</span> <span class="n">mlx4_ib_handle_error_cqe</span> <span class="n">syndrome</span> <span class="mi">5</span>
<span class="p">[</span>  <span class="mf">847.970331</span><span class="p">]</span> <span class="n">mlx4_ib_handle_error_cqe</span> <span class="n">syndrome</span> <span class="mi">5</span>
<span class="p">[</span>  <span class="mf">848.024410</span><span class="p">]</span> <span class="n">mlx4_ib_handle_error_cqe</span> <span class="n">syndrome</span> <span class="mi">5</span>
<span class="p">[</span>  <span class="mf">848.078490</span><span class="p">]</span> <span class="nl">fit_poll_cq</span><span class="p">:</span> <span class="n">failed</span> <span class="n">status</span> <span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="k">for</span> <span class="n">wr_id</span> <span class="mi">1836</span>
<span class="p">[</span>  <span class="mf">848.142967</span><span class="p">]</span> <span class="nl">fit_poll_cq</span><span class="p">:</span> <span class="n">failed</span> <span class="n">status</span> <span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="k">for</span> <span class="n">wr_id</span> <span class="mi">1837</span>
<span class="p">[</span>  <span class="mf">848.207446</span><span class="p">]</span> <span class="nl">fit_poll_cq</span><span class="p">:</span> <span class="n">connection</span> <span class="mi">7</span> <span class="n">Recv</span> <span class="n">weird</span> <span class="n">event</span> <span class="n">as</span> <span class="o">-</span><span class="mi">1</span>
<span class="p">[</span>  <span class="mf">848.275044</span><span class="p">]</span> <span class="nl">fit_poll_cq</span><span class="p">:</span> <span class="n">failed</span> <span class="n">status</span> <span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="k">for</span> <span class="n">wr_id</span> <span class="mi">1838</span>
<span class="p">[</span>  <span class="mf">848.339523</span><span class="p">]</span> <span class="nl">fit_poll_cq</span><span class="p">:</span> <span class="n">connection</span> <span class="mi">7</span> <span class="n">Recv</span> <span class="n">weird</span> <span class="n">event</span> <span class="n">as</span> <span class="o">-</span><span class="mi">30704</span>
<span class="p">[</span>  <span class="mf">848.411281</span><span class="p">]</span> <span class="nl">fit_poll_cq</span><span class="p">:</span> <span class="n">failed</span> <span class="n">status</span> <span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="k">for</span> <span class="n">wr_id</span> <span class="mi">1839</span>
<span class="p">[</span>  <span class="mf">848.475760</span><span class="p">]</span> <span class="nl">fit_poll_cq</span><span class="p">:</span> <span class="n">connection</span> <span class="mi">7</span> <span class="n">Recv</span> <span class="n">weird</span> <span class="n">event</span> <span class="n">as</span> <span class="o">-</span><span class="mi">30704</span>
<span class="p">[</span>  <span class="mf">848.547517</span><span class="p">]</span> <span class="n">mlx4_ib_handle_error_cqe</span> <span class="n">syndrome</span> <span class="mi">5</span>
<span class="p">[</span>  <span class="mf">848.601596</span><span class="p">]</span> <span class="n">mlx4_ib_handle_error_cqe</span> <span class="n">syndrome</span> <span class="mi">5</span>
<span class="p">[</span>  <span class="mf">848.655675</span><span class="p">]</span> <span class="n">mlx4_ib_handle_error_cqe</span> <span class="n">syndrome</span> <span class="mi">5</span>
<span class="p">[</span>  <span class="mf">848.709753</span><span class="p">]</span> <span class="n">mlx4_ib_handle_error_cqe</span> <span class="n">syndrome</span> <span class="mi">5</span>
<span class="p">[</span>  <span class="mf">848.763832</span><span class="p">]</span> <span class="nl">fit_poll_cq</span><span class="p">:</span> <span class="n">failed</span> <span class="n">status</span> <span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="k">for</span> <span class="n">wr_id</span> <span class="mi">1840</span>

<span class="p">[</span>  <span class="mf">848.828313</span><span class="p">]</span> <span class="nl">BUG</span><span class="p">:</span> <span class="n">unable</span> <span class="n">to</span> <span class="n">handle</span> <span class="n">kernel</span> <span class="nb">NULL</span> <span class="n">pointer</span> <span class="n">dereference</span> <span class="n">at</span>           <span class="p">(</span><span class="n">null</span><span class="p">)</span>
<span class="p">[</span>  <span class="mf">848.921908</span><span class="p">]</span> <span class="nl">IP</span><span class="p">:</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8106346d</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">fit_poll_cq</span><span class="o">+</span><span class="mh">0x4ad</span><span class="o">/</span><span class="mh">0x510</span>
<span class="p">[</span>  <span class="mf">848.989507</span><span class="p">]</span> <span class="n">PGD</span> <span class="mi">0</span>
<span class="p">[</span>  <span class="mf">849.013426</span><span class="p">]</span> <span class="nl">Oops</span><span class="p">:</span> <span class="mo">0002</span> <span class="p">[</span><span class="err">#</span><span class="mi">1</span><span class="p">]</span> <span class="n">SMP</span> <span class="n">PROCESSOR</span>
<span class="p">[</span>  <span class="mf">849.061265</span><span class="p">]</span> <span class="nl">CPU</span><span class="p">:</span> <span class="mi">4</span> <span class="nl">PID</span><span class="p">:</span> <span class="mi">17</span> <span class="nl">Comm</span><span class="p">:</span> <span class="n">recvpollcq</span> <span class="mf">4.0.0</span><span class="o">-</span><span class="n">lego</span><span class="o">-</span><span class="n">ys</span><span class="o">+</span> <span class="err">#</span><span class="mi">744</span>
<span class="p">[</span>  <span class="mf">849.131983</span><span class="p">]</span> <span class="nl">RIP</span><span class="p">:</span> <span class="mo">0010</span><span class="o">:</span><span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8106346d</span><span class="o">&gt;</span><span class="p">]</span>  <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8106346d</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">fit_poll_cq</span><span class="o">+</span><span class="mh">0x4ad</span><span class="o">/</span><span class="mh">0x510</span>
<span class="p">[</span>  <span class="mf">849.228700</span><span class="p">]</span> <span class="nl">RSP</span><span class="p">:</span> <span class="mo">0000</span><span class="o">:</span><span class="n">ffff88103e813d88</span>  <span class="nl">EFLAGS</span><span class="p">:</span> <span class="mo">00010246</span>
<span class="p">[</span>  <span class="mf">849.292139</span><span class="p">]</span> <span class="nl">RAX</span><span class="p">:</span> <span class="mo">000000000000100</span><span class="mi">8</span> <span class="nl">RBX</span><span class="p">:</span> <span class="n">ffff88103effbad0</span> <span class="nl">RCX</span><span class="p">:</span> <span class="mo">0000000000000000</span>
<span class="p">[</span>  <span class="mf">849.377418</span><span class="p">]</span> <span class="nl">RDX</span><span class="p">:</span> <span class="mo">0000000000000000</span> <span class="nl">RSI</span><span class="p">:</span> <span class="n">ffffffff811d46e0</span> <span class="nl">RDI</span><span class="p">:</span> <span class="n">ffffffff811dbc08</span>
<span class="p">[</span>  <span class="mf">849.462695</span><span class="p">]</span> <span class="nl">RBP</span><span class="p">:</span> <span class="n">ffff88103e813ea8</span> <span class="nl">R08</span><span class="p">:</span> <span class="mo">0000000000000000</span> <span class="nl">R09</span><span class="p">:</span> <span class="mo">0000000000000000</span>
<span class="p">[</span>  <span class="mf">849.547973</span><span class="p">]</span> <span class="nl">R10</span><span class="p">:</span> <span class="mo">0000000000000002</span> <span class="nl">R11</span><span class="p">:</span> <span class="mo">0000000000000004</span> <span class="nl">R12</span><span class="p">:</span> <span class="mo">0000000000000000</span>
<span class="p">[</span>  <span class="mf">849.633251</span><span class="p">]</span> <span class="nl">R13</span><span class="p">:</span> <span class="n">ffff88103e801008</span> <span class="nl">R14</span><span class="p">:</span> <span class="mo">0000000000000004</span> <span class="nl">R15</span><span class="p">:</span> <span class="n">ffff88103e813da0</span>
<span class="p">[</span>  <span class="mf">849.718529</span><span class="p">]</span> <span class="nl">FS</span><span class="p">:</span>  <span class="mo">0000000000000000</span><span class="p">(</span><span class="mo">0000</span><span class="p">)</span> <span class="nl">GS</span><span class="p">:</span><span class="n">ffff88107fc40000</span><span class="p">(</span><span class="mo">0000</span><span class="p">)</span> <span class="nl">knlGS</span><span class="p">:</span><span class="mo">0000000000000000</span>
<span class="p">[</span>  <span class="mf">849.815246</span><span class="p">]</span> <span class="nl">CS</span><span class="p">:</span>  <span class="mo">0010</span> <span class="nl">DS</span><span class="p">:</span> <span class="mo">0000</span> <span class="nl">ES</span><span class="p">:</span> <span class="mo">0000</span> <span class="nl">CR0</span><span class="p">:</span> <span class="mo">00000000</span><span class="mi">80050033</span>
<span class="p">[</span>  <span class="mf">849.883884</span><span class="p">]</span> <span class="nl">CR2</span><span class="p">:</span> <span class="mo">0000000000000000</span> <span class="nl">CR3</span><span class="p">:</span> <span class="mo">000000000113</span><span class="n">d000</span> <span class="nl">CR4</span><span class="p">:</span> <span class="mo">00000000000406</span><span class="n">a0</span>
<span class="p">[</span>  <span class="mf">849.969163</span><span class="p">]</span> <span class="nl">Stack</span><span class="p">:</span>
<span class="p">[</span>  <span class="mf">849.993082</span><span class="p">]</span> <span class="n">ffffffff81003299</span> <span class="mo">000001</span><span class="n">b03e813da0</span> <span class="mo">0000000000000004</span> <span class="mo">0000000000000730</span>
<span class="p">[</span>  <span class="mf">850.080440</span><span class="p">]</span> <span class="mo">000000</span><span class="mi">8100000005</span> <span class="mf">00001008000000f</span><span class="mi">9</span> <span class="n">ffff88103eff8c50</span> <span class="mo">002</span><span class="n">c222040000000</span>
<span class="p">[</span>  <span class="mf">850.167798</span><span class="p">]</span> <span class="mo">0010004000000002</span> <span class="n">ffff88107fc20000</span> <span class="mo">0000000000000731</span> <span class="n">ffffffff00000005</span>
<span class="p">[</span>  <span class="mf">850.255156</span><span class="p">]</span> <span class="n">ffff8810000000f9</span> <span class="n">ffff88103eff8c50</span> <span class="mo">0000000000000000</span> <span class="n">ffff88103e813e38</span>
<span class="p">[</span>  <span class="mf">850.342513</span><span class="p">]</span> <span class="n">ffffffff81019854</span> <span class="mo">0000000000000732</span> <span class="n">ffff881000000005</span> <span class="n">ffff8810000000f9</span>
<span class="p">[</span>  <span class="mf">850.429871</span><span class="p">]</span> <span class="n">Call</span> <span class="nl">Trace</span><span class="p">:</span>
<span class="p">[</span>  <span class="mf">850.458992</span><span class="p">]</span> <span class="o">&lt;</span><span class="n">TSK</span><span class="o">&gt;</span>
<span class="p">[</span>  <span class="mf">850.481870</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81003299</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">native_smp_send_reschedule</span><span class="o">+</span><span class="mh">0x39</span><span class="o">/</span><span class="mh">0x50</span>
<span class="p">[</span>  <span class="mf">850.560909</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81019854</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">try_to_wake_up</span><span class="o">+</span><span class="mh">0xe4</span><span class="o">/</span><span class="mh">0x1f0</span>
<span class="p">[</span>  <span class="mf">850.628506</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81065708</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">__schedule</span><span class="o">+</span><span class="mh">0xf8</span><span class="o">/</span><span class="mh">0x1e0</span>
<span class="p">[</span>  <span class="mf">850.691945</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff810634d0</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">fit_poll_cq</span><span class="o">+</span><span class="mh">0x510</span><span class="o">/</span><span class="mh">0x510</span>
<span class="p">[</span>  <span class="mf">850.757464</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff810634e4</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">fit_poll_cq_pass</span><span class="o">+</span><span class="mh">0x14</span><span class="o">/</span><span class="mh">0x30</span>
<span class="p">[</span>  <span class="mf">850.824021</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81020636</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">kthread</span><span class="o">+</span><span class="mh">0xf6</span><span class="o">/</span><span class="mh">0x120</span>
<span class="p">[</span>  <span class="mf">850.882260</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81020540</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">__kthread_parkme</span><span class="o">+</span><span class="mh">0x70</span><span class="o">/</span><span class="mh">0x70</span>
<span class="p">[</span>  <span class="mf">850.950898</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8100e572</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">ret_from_fork</span><span class="o">+</span><span class="mh">0x22</span><span class="o">/</span><span class="mh">0x30</span>

<span class="cm">/* handle normal reply */</span>
<span class="p">...</span>
<span class="n">memcpy</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">reply_ready_indicators</span><span class="p">[</span><span class="n">reply_indicator_index</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">length</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
<span class="p">...</span>
<span class="p">(</span><span class="n">This</span> <span class="n">is</span> <span class="n">a</span> <span class="n">bad</span> <span class="nl">memcpy</span><span class="p">:</span> <span class="n">reply_indicator_index</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">etc</span> <span class="n">should</span> <span class="n">be</span> <span class="n">checked</span><span class="p">.)</span>
</pre></div>
</td></tr></table></p>
<h3 id="ib-spec-qp-cqe-wqe-send">IB Spec: QP, CQE, WQE, SEND</h3>
<p>The channel adapter detects the WQE posting and accesses the WQE.
The channel adapter interprets the command, validates the WQE’s virtual 12
addresses, translates it to physical addresses, and accesses the data.
The outgoing message buffer is split into one or more packets. To each packet the channel adapter adds a transport header (sequence numbers, opcode, etc.). If the destination resides on a remote subnet the channel adapter adds a network header (source &amp; destination GIDs). The channel adapter then adds the local route header and calculates both the variant
and invariant checksums.</p>
<p>For a Send operation, the QP retrieves the address of
the receive buffer from the next WQE on its receive queue, translates it to physical addresses, and accesses memory writing the data. If this is not
the last packet of the message, the QP saves the current write location in 38 its context and waits for the next packet at which time it continues writing
the receive buffer until it receives a packet that indicates it is the last packet of the operation. It then updates the receive WQE, retires it, and sends an acknowledge message to the originator.</p>
<p>When the originator receives an acknowledgment, it creates a CQE on the 5
CQ and retires the WQE from the send queue.</p>
<p>A QP can have multiple outstanding messages at any one time but the 8
target always acknowledges in the order sent, thus WQEs are retired in the order that they are posted.</p>
<h2 id="0402-mon">04/02 Mon</h2>
<p>Patching storage replica handler, able to finish today.</p>
<h2 id="0401-sun">04/01 Sun</h2>
<p>Anyway. Summary of the day: replication at M almost done. Only flush part left. Storage also need a handler. But we still need code to recover.</p>
<p>I&rsquo;m tired. :-( A month to go.</p>
<p>Record a IB error. Using wuklab12 (P) and wuklab14(M+RAMFS), running usr/pcache_conflic.o:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">P</span>
<span class="p">[</span><span class="mf">30801.296160</span><span class="p">]</span> <span class="n">ibapi_send_reply</span><span class="p">()</span> <span class="nl">CPU</span><span class="p">:</span><span class="mi">8</span> <span class="nl">PID</span><span class="p">:</span><span class="mi">19</span> <span class="n">timeout</span> <span class="p">(</span><span class="mi">30010</span> <span class="n">ms</span><span class="p">),</span> <span class="nl">caller</span><span class="p">:</span> <span class="n">clflush_one</span><span class="o">+</span><span class="mh">0x1c9</span><span class="o">/</span><span class="mh">0x370</span>
<span class="p">[</span><span class="mf">30938.564843</span><span class="p">]</span> <span class="n">mlx4_ib_handle_error_cqe</span> <span class="n">syndrome</span> <span class="mi">21</span>
<span class="p">[</span><span class="mf">30938.617988</span><span class="p">]</span> <span class="n">mlx4_ib_handle_error_cqe</span> <span class="n">syndrome</span> <span class="mi">5</span>
<span class="p">[</span><span class="mf">30938.672068</span><span class="p">]</span> <span class="n">send</span> <span class="n">request</span> <span class="n">failed</span> <span class="n">at</span> <span class="n">connection</span> <span class="mi">6</span> <span class="n">as</span> <span class="mi">12</span>
<span class="p">[</span><span class="mf">30938.732389</span><span class="p">]</span> <span class="n">mlx4_ib_handle_error_cqe</span> <span class="n">syndrome</span> <span class="mi">5</span>
<span class="p">[</span><span class="mf">30938.786470</span><span class="p">]</span> <span class="n">mlx4_ib_handle_error_cqe</span> <span class="n">syndrome</span> <span class="mi">5</span>
<span class="p">[</span><span class="mf">30938.840551</span><span class="p">]</span> <span class="n">mlx4_ib_handle_error_cqe</span> <span class="n">syndrome</span> <span class="mi">5</span>
<span class="p">[</span><span class="mf">30938.894632</span><span class="p">]</span> <span class="nl">fit_poll_cq</span><span class="p">:</span> <span class="n">failed</span> <span class="n">status</span> <span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="k">for</span> <span class="n">wr_id</span> <span class="mi">1584</span>
<span class="p">[</span><span class="mf">30938.959112</span><span class="p">]</span> <span class="nl">fit_poll_cq</span><span class="p">:</span> <span class="n">failed</span> <span class="n">status</span> <span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="k">for</span> <span class="n">wr_id</span> <span class="mi">1585</span>
<span class="p">[</span><span class="mf">30939.023593</span><span class="p">]</span> <span class="nl">fit_poll_cq</span><span class="p">:</span> <span class="n">connection</span> <span class="mi">6</span> <span class="n">Recv</span> <span class="n">weird</span> <span class="n">event</span> <span class="n">as</span> <span class="o">-</span><span class="mi">1</span>
<span class="p">[</span><span class="mf">30939.091194</span><span class="p">]</span> <span class="nl">fit_poll_cq</span><span class="p">:</span> <span class="n">failed</span> <span class="n">status</span> <span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="k">for</span> <span class="n">wr_id</span> <span class="mi">1586</span>
<span class="p">[</span><span class="mf">30939.155676</span><span class="p">]</span> <span class="nl">fit_poll_cq</span><span class="p">:</span> <span class="n">connection</span> <span class="mi">6</span> <span class="n">Recv</span> <span class="n">weird</span> <span class="n">event</span> <span class="n">as</span> <span class="o">-</span><span class="mi">30704</span>
<span class="p">[</span><span class="mf">30939.227436</span><span class="p">]</span> <span class="nl">fit_poll_cq</span><span class="p">:</span> <span class="n">failed</span> <span class="n">status</span> <span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="k">for</span> <span class="n">wr_id</span> <span class="mi">1587</span>
<span class="p">[</span><span class="mf">30939.291917</span><span class="p">]</span> <span class="nl">fit_poll_cq</span><span class="p">:</span> <span class="n">connection</span> <span class="mi">6</span> <span class="n">Recv</span> <span class="n">weird</span> <span class="n">event</span> <span class="n">as</span> <span class="o">-</span><span class="mi">30704</span>
<span class="p">[</span><span class="mf">30939.363678</span><span class="p">]</span> <span class="n">mlx4_ib_handle_error_cqe</span> <span class="n">syndrome</span> <span class="mi">5</span>
<span class="p">[</span><span class="mf">30939.417759</span><span class="p">]</span> <span class="n">mlx4_ib_handle_error_cqe</span> <span class="n">syndrome</span> <span class="mi">5</span>
<span class="p">[</span><span class="mf">30939.471839</span><span class="p">]</span> <span class="n">mlx4_ib_handle_error_cqe</span> <span class="n">syndrome</span> <span class="mi">5</span>
<span class="p">[</span><span class="mf">30939.525921</span><span class="p">]</span> <span class="n">mlx4_ib_handle_error_cqe</span> <span class="n">syndrome</span> <span class="mi">5</span>
<span class="p">[</span><span class="mf">30939.580002</span><span class="p">]</span> <span class="nl">fit_poll_cq</span><span class="p">:</span> <span class="n">failed</span> <span class="n">status</span> <span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="k">for</span> <span class="n">wr_id</span> <span class="mi">1588</span>
<span class="p">[</span><span class="mf">30939.644483</span><span class="p">]</span> <span class="nl">BUG</span><span class="p">:</span> <span class="n">unable</span> <span class="n">to</span> <span class="n">handle</span> <span class="n">kernel</span> <span class="nb">NULL</span> <span class="n">pointer</span> <span class="n">dereference</span> <span class="n">at</span>           <span class="p">(</span><span class="n">null</span><span class="p">)</span>
<span class="p">[</span><span class="mf">30939.738083</span><span class="p">]</span> <span class="nl">IP</span><span class="p">:</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81062fcd</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">fit_poll_cq</span><span class="o">+</span><span class="mh">0x4ad</span><span class="o">/</span><span class="mh">0x510</span>
<span class="p">[</span><span class="mf">30939.805684</span><span class="p">]</span> <span class="n">PGD</span> <span class="mi">0</span>
<span class="p">[</span><span class="mf">30939.829604</span><span class="p">]</span> <span class="nl">Oops</span><span class="p">:</span> <span class="mo">0002</span> <span class="p">[</span><span class="err">#</span><span class="mi">1</span><span class="p">]</span> <span class="n">SMP</span> <span class="n">PROCESSOR</span>
<span class="p">[</span><span class="mf">30939.877445</span><span class="p">]</span> <span class="nl">CPU</span><span class="p">:</span> <span class="mi">4</span> <span class="nl">PID</span><span class="p">:</span> <span class="mi">17</span> <span class="nl">Comm</span><span class="p">:</span> <span class="n">recvpollcq</span> <span class="mf">4.0.0</span><span class="o">-</span><span class="n">lego</span><span class="o">-</span><span class="n">ys</span><span class="o">+</span> <span class="err">#</span><span class="mi">715</span>
<span class="p">[</span><span class="mf">30939.948166</span><span class="p">]</span> <span class="nl">RIP</span><span class="p">:</span> <span class="mo">0010</span><span class="o">:</span><span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81062fcd</span><span class="o">&gt;</span><span class="p">]</span>  <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81062fcd</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">fit_poll_cq</span><span class="o">+</span><span class="mh">0x4ad</span><span class="o">/</span><span class="mh">0x510</span>

<span class="n">fit_poll_cq</span> <span class="n">at</span> <span class="n">net</span><span class="o">/</span><span class="n">lego</span><span class="o">/</span><span class="n">fit_internal</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span><span class="mi">1734</span>
<span class="n">memcpy</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">reply_ready_indicators</span><span class="p">[</span><span class="n">reply_indicator_index</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">length</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>

<span class="n">M</span>
<span class="p">[</span><span class="mf">30913.642698</span><span class="p">]</span> <span class="n">mlx4_ib_handle_error_cqe</span> <span class="n">syndrome</span> <span class="mi">21</span>
<span class="p">[</span><span class="mf">30913.695839</span><span class="p">]</span> <span class="n">mlx4_ib_handle_error_cqe</span> <span class="n">syndrome</span> <span class="mi">5</span>
<span class="p">[</span><span class="mf">30913.749919</span><span class="p">]</span> <span class="n">send</span> <span class="n">request</span> <span class="n">failed</span> <span class="n">at</span> <span class="n">connection</span> <span class="mi">1</span> <span class="n">as</span> <span class="mi">12</span>
<span class="p">[</span><span class="mf">30913.810236</span><span class="p">]</span> <span class="n">mlx4_ib_handle_error_cqe</span> <span class="n">syndrome</span> <span class="mi">5</span>
<span class="p">[</span><span class="mf">30913.864315</span><span class="p">]</span> <span class="n">mlx4_ib_handle_error_cqe</span> <span class="n">syndrome</span> <span class="mi">5</span>
<span class="p">[</span><span class="mf">30913.918395</span><span class="p">]</span> <span class="n">mlx4_ib_handle_error_cqe</span> <span class="n">syndrome</span> <span class="mi">5</span>
<span class="p">[</span><span class="mf">30913.972474</span><span class="p">]</span> <span class="nl">fit_poll_cq</span><span class="p">:</span> <span class="n">failed</span> <span class="n">status</span> <span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="k">for</span> <span class="n">wr_id</span> <span class="mi">305</span>
<span class="p">[</span><span class="mf">30914.035912</span><span class="p">]</span> <span class="nl">fit_poll_cq</span><span class="p">:</span> <span class="n">failed</span> <span class="n">status</span> <span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="k">for</span> <span class="n">wr_id</span> <span class="mi">306</span>
</pre></div>
</td></tr></table></p>
                
                  
                
              
              
                
              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../misc/" title="MISC" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                MISC
              </span>
            </div>
          </a>
        
        
          <a href="../log-03-2018/" title="March 2018" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                March 2018
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="http://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../../assets/javascripts/application.abd7b172.js"></script>
      
      <script>app.initialize({version:"0.17.2",url:{base:"../../.."}})</script>
      
    
    
      
    
  </body>
</html>