



<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-0.17.2, mkdocs-material-2.6.2">
    
    
      
        <title>Feb 2018 - Yizhou Shan's Home Page</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/application.9b572555.css">
      
    
    
      <script src="../../../assets/javascripts/modernizr.1aa3b519.js"></script>
    
    
      
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="search">
    <label class="md-overlay" data-md-component="overlay" for="drawer"></label>
    
      <a href="#feb-2018" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../../.." title="Yizhou Shan's Home Page" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                Yizhou Shan's Home Page
              </span>
              <span class="md-header-nav__topic">
                Feb 2018
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="drawer">
    <span class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </span>
    Yizhou Shan's Home Page
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Misc
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Misc
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../misc/cheatsheet/" title="Cheatsheet" class="md-nav__link">
      Cheatsheet
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../misc/jasmine/" title="Jasmine" class="md-nav__link">
      Jasmine
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      Lego
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Lego
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-1" type="checkbox" id="nav-3-1" checked>
    
    <label class="md-nav__link" for="nav-3-1">
      Log
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-1">
        Log
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="toc">
        Feb 2018
      </label>
    
    <a href="./" title="Feb 2018" class="md-nav__link md-nav__link--active">
      Feb 2018
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#0214-wed-rainy" title="02/14 Wed Rainy" class="md-nav__link">
    02/14 Wed Rainy
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#0213-tue-sunny" title="02/13 Tue Sunny" class="md-nav__link">
    02/13 Tue Sunny
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#0212-mon-cloudy" title="02/12 Mon Cloudy" class="md-nav__link">
    02/12 Mon Cloudy
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#0209-fri-cloudy" title="02/09 Fri Cloudy" class="md-nav__link">
    02/09 Fri Cloudy
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#0208-thur-cloudy" title="02/08 Thur Cloudy" class="md-nav__link">
    02/08 Thur Cloudy
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#0207-wed-cloudy" title="02/07 Wed Cloudy" class="md-nav__link">
    02/07 Wed Cloudy
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#0206-tue-sunny" title="02/06 Tue Sunny" class="md-nav__link">
    02/06 Tue Sunny
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#0205-mon-sunny" title="02/05 Mon Sunny" class="md-nav__link">
    02/05 Mon Sunny
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-2" type="checkbox" id="nav-3-2">
    
    <label class="md-nav__link" for="nav-3-2">
      Boot
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-2">
        Boot
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../boot/grub/" title="GRUB" class="md-nav__link">
      GRUB
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../boot/trampoline/" title="Trampoline" class="md-nav__link">
      Trampoline
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-3" type="checkbox" id="nav-3-3">
    
    <label class="md-nav__link" for="nav-3-3">
      Kernel
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-3">
        Kernel
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/kconfig/" title="Kconfig" class="md-nav__link">
      Kconfig
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/debug/" title="Debug" class="md-nav__link">
      Debug
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/pagefault_disable/" title="pagefault_disable" class="md-nav__link">
      pagefault_disable
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/stop_machine/" title="stop_machine" class="md-nav__link">
      stop_machine
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-4" type="checkbox" id="nav-3-4">
    
    <label class="md-nav__link" for="nav-3-4">
      Syscall
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-4">
        Syscall
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../syscall/msync/" title="msync()" class="md-nav__link">
      msync()
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../syscall/mremap/" title="mremap()" class="md-nav__link">
      mremap()
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../syscall/fork/" title="fork()" class="md-nav__link">
      fork()
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-5" type="checkbox" id="nav-3-5">
    
    <label class="md-nav__link" for="nav-3-5">
      Pcache
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-5">
        Pcache
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/config/" title="Config" class="md-nav__link">
      Config
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/rmap/" title="Reverse Mapping" class="md-nav__link">
      Reverse Mapping
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/smp_design/" title="SMP Design" class="md-nav__link">
      SMP Design
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-6" type="checkbox" id="nav-3-6">
    
    <label class="md-nav__link" for="nav-3-6">
      Paper
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-6">
        Paper
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../paper/nmp/" title="NMP" class="md-nav__link">
      NMP
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#0214-wed-rainy" title="02/14 Wed Rainy" class="md-nav__link">
    02/14 Wed Rainy
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#0213-tue-sunny" title="02/13 Tue Sunny" class="md-nav__link">
    02/13 Tue Sunny
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#0212-mon-cloudy" title="02/12 Mon Cloudy" class="md-nav__link">
    02/12 Mon Cloudy
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#0209-fri-cloudy" title="02/09 Fri Cloudy" class="md-nav__link">
    02/09 Fri Cloudy
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#0208-thur-cloudy" title="02/08 Thur Cloudy" class="md-nav__link">
    02/08 Thur Cloudy
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#0207-wed-cloudy" title="02/07 Wed Cloudy" class="md-nav__link">
    02/07 Wed Cloudy
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#0206-tue-sunny" title="02/06 Tue Sunny" class="md-nav__link">
    02/06 Tue Sunny
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#0205-mon-sunny" title="02/05 Mon Sunny" class="md-nav__link">
    02/05 Mon Sunny
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="feb-2018">Feb 2018</h1>
<hr />
<h2 id="0214-wed-rainy">02/14 Wed Rainy</h2>
<p>Hmm, tried to make kmalloc behave as kzalloc, and bind all threads to one core, still gave the same old bug:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="hll">  42731a:       f3 0f 6f 16             movdqu (%rsi),%xmm2
</span>
  [93182.657376] word_count-pthr[85] general protection ip:42731a sp:7fffe3ffed28 error:0
  [93182.747959] CPU: 8 PID: 85 Comm: word_count-pthr 4.0.0-lego+ #170
  [93182.820758] RIP: 0033:[&lt;000000000042731a&gt;]  [&lt;000000000042731a&gt;] 0x42731a
  [93182.901878] RSP: 002b:00007fffe3ffed28  EFLAGS: 00010283
  [93182.965317] RAX: 000000000000001f RBX: 00007ffff001b010 RCX: 0000000000000005
  [93183.050596] RDX: 0000000000000000 RSI: 5345485355420045 RDI: 00007ffff294791f
  [93183.135876] RBP: 00007ffff294791f R08: 000000000000ffff R09: 0000000000000008
  [93183.221156] R10: fffffffffffff048 R11: 00000000004acfc0 R12: 0000000000001cde
  [93183.306435] R13: 00000000006e4a8c R14: 0000000000001cd7 R15: 0000000000001cda
  [93183.391716] FS:  00007fffe3fff700(0000) GS:ffff88107fc80000(0000) knlGS:0000000000000000
  [93183.488434] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
  [93183.557075] CR2: 00007ffff27a4000 CR3: 000000107e924000 CR4: 00000000000406a0
</pre></div>
</td></tr></table></p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="hll">  427377:       66 0f 6f 17             movdqa (%rdi),%xmm2
</span>
  [93180.527248] word_count-pthr[93]: segfault at 0x0 ip 0000000000427377 sp 00007fffdfff6d28 error 4
  [93180.630314] CPU: 8 PID: 93 Comm: word_count-pthr 4.0.0-lego+ #170
  [93180.703114] RIP: 0033:[&lt;0000000000427377&gt;]  [&lt;0000000000427377&gt;] 0x427377
  [93180.784234] RSP: 002b:00007fffdfff6d28  EFLAGS: 00010297
  [93180.847674] RAX: 0000000000000000 RBX: 000000000073c4c0 RCX: 000000000000000d
  [93180.932953] RDX: 000000000000ffff RSI: 00007ffff4999070 RDI: 0000000000000000
  [93181.018233] RBP: 00007ffff499907d R08: 000000000000ffff R09: 0000000000000000
  [93181.103513] R10: 0000000000427760 R11: 00007ffff49982c0 R12: 0000000000000118
  [93181.188791] R13: 00000000006e4aac R14: 0000000000000116 R15: 0000000000000117
  [93181.274072] FS:  00007fffdfff7700(0000) GS:ffff88107fc80000(0000) knlGS:0000000000000000
  [93181.370790] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
  [93181.439430] CR2: 0000000000000000 CR3: 000000107e924000 CR4: 00000000000406a0
</pre></div>
</td></tr></table>

<hr />
<h2 id="0213-tue-sunny">02/13 Tue Sunny</h2>
<p>Checking our SLOB allocator today. So I found Yutong&rsquo;s code is using <code class="codehilite">set_page_private</code> when slob get a new page from buddy. This private field is only intended to be used by buddy to record the <code class="codehilite">order</code>. This mixed usage will confuse buddy and create bug.</p>
<p>Even though I removed the <code class="codehilite"><span class="n">set_page_private</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span></code> after <code class="codehilite">free_page</code>, word_count-pthread still fails. Damn.</p>
<hr />
<h2 id="0212-mon-cloudy">02/12 Mon Cloudy</h2>
<p>Add this commit <code class="codehilite">4cb3a8b6a943c90714fd9bb5e5465ee315f0aa30</code>:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>    memory: Use kzalloc instead of kmalloc in __bprm_mm_init (loader)

    This was an potentionl bug that was not triggered previously.
    It is simply because kmalloc&#39;ed vma contains some garbage area,
    while later in the pgfault code, we use
            if (vma-&gt;vm_ops &amp;&amp; vma-&gt;vm_ops-&gt;fault)
                    ...
    to check if it is an file-backed fault.

    Fortunately the vma-&gt;vm_ops happens to have some leftover value.
    So this bug was triggered.

    This actually reminds me that this is a series of potential bugs!
    Even though before I&#39;ve added things like force GFP_ZERO in all
    physical page allocation, I missed the kmalloc&#39;s case!
</pre></div>
</td></tr></table></p>
<p>The story is:</p>
<p>I patched the stop_machine code today, and tried to run code with P+M on VM, everything works fine. However, when I tried to run the new code with P+M+S on physical machine, M crashed at a very weird point:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>[ 7791.998168] handle_p2m_execve(): pid:81,argc:2,envc:2,file:/root/ys/phoenix/phoenix-2.0/tests/word_count/word_count-pthread
[ 7792.129312] BUG: unable to handle kernel NULL pointer dereference at 0000000000000031
[ 7792.222889] IP: [&lt;ffffffff8102c180&gt;] handle_lego_mm_fault+0x160/0x4b0
[ 7792.299842] PGD 0
[ 7792.323760] Oops: 0000 [#1] PREEMPT SMP MEMORY
[ 7792.376794] CPU: 4 PID: 79 Comm: mc-manager 4.0.0-lego+ #29
<span class="hll">[ 7792.443349] RIP: .. [&lt;ffffffff8102c180&gt;] handle_lego_mm_fault+0x160/0x4b0
</span>......
....
[ 7793.750506] Call Trace:
[ 7793.779623] &lt;TSK&gt;
<span class="hll">[ 7793.802501] [&lt;ffffffff810053f4&gt;] ? apic_timer_interrupt+0x54/0x90
</span><span class="hll">[ 7793.875295] [&lt;ffffffff8102e469&gt;] faultin_page+0x9/0x70
</span><span class="hll">[ 7793.936649] [&lt;ffffffff8102ef01&gt;] copy_strings.isra.1+0xe1/0x130
</span><span class="hll">[ 7794.007362] [&lt;ffffffff8102f11e&gt;] exec_loader+0x1ce/0x340
</span><span class="hll">[ 7794.070796] [&lt;ffffffff81027def&gt;] handle_p2m_execve+0x12f/0x200
</span>[ 7794.140469] [&lt;ffffffff810274fb&gt;] mc_manager+0x1ab/0x2b0
[ 7794.202864] [&lt;ffffffff81027350&gt;] ? bitmap_fill+0x33/0x33
[ 7794.266298] [&lt;ffffffff8101c6b7&gt;] kthread+0x107/0x130
[ 7794.325572] [&lt;ffffffff8101c5b0&gt;] ? __kthread_parkme+0x90/0x90
[ 7794.394205] [&lt;ffffffff8100b462&gt;] ret_from_fork+0x22/0x30
</pre></div>
</td></tr></table></p>
<p>So faulting source code is:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="k">static</span> <span class="kt">int</span> <span class="nf">handle_pte_fault</span><span class="p">(</span><span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">address</span><span class="p">,</span>
                            <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="n">pte_t</span> <span class="o">*</span><span class="n">pte</span><span class="p">,</span> <span class="n">pmd_t</span> <span class="o">*</span><span class="n">pmd</span><span class="p">)</span>
<span class="p">{</span>
    <span class="p">....</span>
<span class="hll">        <span class="k">if</span> <span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_ops</span> <span class="o">&amp;&amp;</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_ops</span><span class="o">-&gt;</span><span class="n">fault</span><span class="p">)</span>
</span><span class="hll">                <span class="k">return</span> <span class="n">do_linear_fault</span><span class="p">(</span><span class="n">vma</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span>
</span>                                       <span class="n">pte</span><span class="p">,</span> <span class="n">pmd</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span>
    <span class="p">....</span>
</pre></div>
</td></tr></table></p>
<p>Something wrong with <code class="codehilite">vma</code>? At this loader stage, this vma is a temporaty stack vma created for saving <code class="codehilite">argv</code> and <code class="codehilite">envp</code>. So I look back into the code that created this vma:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">managers</span><span class="o">/</span><span class="n">memory</span><span class="o">/</span><span class="n">loader</span><span class="o">/</span><span class="n">core</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__bprm_mm_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">lego_binprm</span> <span class="o">*</span><span class="n">bprm</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">lego_mm_struct</span> <span class="o">*</span><span class="n">mm</span> <span class="o">=</span> <span class="n">bprm</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">;</span>

<span class="hll">        <span class="n">bprm</span><span class="o">-&gt;</span><span class="n">vma</span> <span class="o">=</span> <span class="n">vma</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">vma</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
</span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vma</span><span class="p">)</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
</pre></div>
</td></tr></table></p>
<p>The code after this does NOT do necessary cleanup. The <code class="codehilite">vm_ops</code> happens to have some garbage value from last user. So it is not 0, so the above <code class="codehilite">vma-&gt;vm_ops</code> is true, and it will try to read <code class="codehilite">vma-&gt;vm_ops-&gt;fault</code>. And that, my friend, is where garbage turns into crash.</p>
<p>This presents a series of potential bugs. Ugh, <code class="codehilite">memory safety</code>!</p>
<hr />
<h2 id="0209-fri-cloudy"><code class="codehilite">02/09 Fri Cloudy</code></h2>
<p>Tried to modify Phoneix code: replace <code class="codehilite">realloc</code> with <code class="codehilite">malloc+mempcy</code>. Thus the <code class="codehilite">mremap</code> syscall is avoided, but it still has general protection fault. Same with yesterday, corrupted at <code class="codehilite">__strcmp_sse42</code>, with corrupted <code class="codehilite">RSI</code> or <code class="codehilite">RDI</code>. So I guess it is not about <code class="codehilite">mremap</code> itself at all. I will follow yesterday&rsquo;s checking list.</p>
<hr />
<h2 id="0208-thur-cloudy"><code class="codehilite">02/08 Thur Cloudy</code></h2>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>00000000004272d0 &lt;__strcmp_sse42&gt;:

  4272d0:       89 f1                   mov    %esi,%ecx
  4272d2:       89 f8                   mov    %edi,%eax
  4272d4:       48 83 e1 3f             and    $0x3f,%rcx
  4272d8:       48 83 e0 3f             and    $0x3f,%rax
  4272dc:       83 f9 30                cmp    $0x30,%ecx
  4272df:       77 3f                   ja     427320 &lt;__strcmp_sse42+0x50&gt;
  4272e1:       83 f8 30                cmp    $0x30,%eax
  4272e4:       77 3a                   ja     427320 &lt;__strcmp_sse42+0x50&gt;
  4272e6:       f3 0f 6f 0f             movdqu (%rdi),%xmm1
<span class="hll">* 4272ea:       f3 0f 6f 16             movdqu (%rsi),%xmm2
</span>  4272ee:       66 0f ef c0             pxor   %xmm0,%xmm0
  4272f2:       66 0f 74 c1             pcmpeqb %xmm1,%xmm0
  4272f6:       66 0f 74 ca             pcmpeqb %xmm2,%xmm1
  4272fa:       66 0f f8 c8             psubb  %xmm0,%xmm1
  4272fe:       66 0f d7 d1             pmovmskb %xmm1,%edx
  427302:       81 ea ff ff 00 00       sub    $0xffff,%edx
  427308:       0f 85 42 0d 00 00       jne    428050 &lt;__strcmp_sse42+0xd80&gt;
  42730e:       48 83 c6 10             add    $0x10,%rsi
  427312:       48 83 c7 10             add    $0x10,%rdi
  427316:       66 2e 0f 1f 84 00 00    nopw   %cs:0x0(%rax,%rax,1)
  42731d:       00 00 00  
  427320:       48 83 e6 f0             and    $0xfffffffffffffff0,%rsi
  427324:       48 83 e7 f0             and    $0xfffffffffffffff0,%rdi
  427328:       ba ff ff 00 00          mov    $0xffff,%edx
  42732d:       45 31 c0                xor    %r8d,%r8d
  427330:       83 e1 0f                and    $0xf,%ecx
  427333:       83 e0 0f                and    $0xf,%eax
  427336:       66 0f ef c0             pxor   %xmm0,%xmm0
  42733a:       39 c1                   cmp    %eax,%ecx
  42733c:       74 32                   je     427370 &lt;__strcmp_sse42+0xa0&gt;
  42733e:       77 07                   ja     427347 &lt;__strcmp_sse42+0x77&gt;
  427340:       41 89 d0                mov    %edx,%r8d
  427343:       91                      xchg   %eax,%ecx
  427344:       48 87 f7                xchg   %rsi,%rdi
<span class="hll">* 427347:       66 0f 6f 17             movdqa (%rdi),%xmm2
</span>  (RDI: 0000000000000000)
</pre></div>
</td></tr></table>

<p>Frustrating! What is wrong with multithread program? Because of broken FPU-switch code? of inappropriate TLB flush? of IB corrupts memory? of what? ugh?</p>
<p>I&rsquo;m done with this random guess and frustrated general protection or segfault, I need to first make sure underlying kernel is 100%  percent correct, this is a checking list:</p>
<ul>
<li>fpu save/restore<ul>
<li>always fail at some XMM instruction</li>
<li>always with corrupted RDI or RSI</li>
</ul>
</li>
<li>switch_to_asm<ul>
<li>%gs and %fs</li>
<li>switch_mm (pgd)</li>
<li>stack frame</li>
</ul>
</li>
<li>set_arch_tls (%fs)<ul>
<li>glibc&rsquo;s way of using per thread data</li>
</ul>
</li>
<li>some cpu may miss tlb flush</li>
<li>kernel entry/exit assembly<ul>
<li>current_task macro</li>
<li>stack_stratch</li>
<li>per-cpu data in entry.S</li>
</ul>
</li>
<li>futex<ul>
<li>clear_tid</li>
<li>set_tid</li>
<li>shared mm</li>
<li>robust list</li>
</ul>
</li>
<li>interrupts<ul>
<li>vector array</li>
<li>APIC setup</li>
<li>IO-APIC</li>
<li>timer interrupt</li>
</ul>
</li>
<li>cpu_init and Trampoline</li>
<li>faked kernel version</li>
<li>P side pgfault handling code (SMP)</li>
<li>and M side pgfault handling (SMP)</li>
<li>mremap, munmap<ul>
<li>check pgtable boundary</li>
</ul>
</li>
<li>In all, check SMP implications</li>
</ul>
<p>Is there any code, that is solely used to test if the underlying kernel has appropriate behaviors? Like glibc test code?</p>
<p>How to protect kernel virtual memory? Any existing solutions in Linux?</p>
<p>What is the implication of multiple CPU entering kernel at the same time? How can it corrupt user pages? Maybe: kernel entry code, per-cpu data in entry code, fpu code, switch_to, scheduler.</p>
<p>Why it always fail at those FPU code i.e. the strcmp function? I failed to compile without those sse, any solution? How it hurt performance?</p>
<hr />
<h2 id="0207-wed-cloudy"><code class="codehilite">02/07 Wed Cloudy</code></h2>
<p><code class="codehilite"><span class="mi">20</span><span class="o">:</span><span class="mi">07</span></code><br />
Pushed a small patch on mremap issue. Hope it will work. mremap really makes the whole thing very interesting, will be a very good research finding on combing virtual cache and operating system. Need to go gym with a friend, will be back on debugging late tonight.</p>
<p><code class="codehilite"><span class="mi">9</span><span class="o">:</span><span class="mi">30</span></code><br />
Have two meetings to do today, and an security class, won&rsquo;t have too much time coding during daytime.</p>
<hr />
<h2 id="0206-tue-sunny"><code class="codehilite">02/06 Tue Sunny</code></h2>
<p>Well. We&rsquo;ve ruled out both <code class="codehilite">smp_call_function</code> and <code class="codehilite">workqueue</code> yesterday with Yiying&rsquo;s help. But the multi-thread word-count still fails <code class="codehilite"><span class="p">:-(</span></code> Single thread word-count just finished 4GB dataset (with 8GB pcache). So what could be still wrong with multithread one????</p>
<ul>
<li>chill</li>
<li>check exit code</li>
<li><code class="codehilite">(Checked)</code> check pcache&rsquo;s usage of task_struct, should always use the group_leader</li>
<li>check cpu boot code and check the switch code again</li>
<li>I believe pinpoint the issue in multithread word-count can solve a lot issues, it must be some thread creation, removal, schedule things.</li>
<li>How about adding a lock for ibapi, make it sequential? Sweet, I tried, finally it is <code class="codehilite">a bug that we are able to debug</code>.</li>
</ul>
<p><code class="codehilite"><span class="mi">22</span><span class="o">:</span><span class="mi">39</span></code><br />
Done for today. I&rsquo;m trying to patch <code class="codehilite">move_pte</code> and <code class="codehilite">pcache_move_pte</code>. Although in theory we defenitly need to patch it, I keep thinking the code before should not trigger any serious bus or memory corruption. Ugh. Maybe it is concurrent <code class="codehilite">mremap</code> that one of them remap from A to B, while another one remap from C to A. It is possible. But my dead brain can not think of this anymore. I&rsquo;m going to hit the gym and do some squats.</p>
<p><code class="codehilite"><span class="mi">17</span><span class="o">:</span><span class="mi">01</span></code><br />
Criminal found: <code class="codehilite">mremap()</code> and <code class="codehilite">virtual cache</code> did the crime. Interesting, I have not seen any research paper, tech-reports, writeup, code about this, not even the OVC paper, which, by the way, I think they must consider this case. Otherwise, a mremap will simply crash its virtual cache. Many thanks went to my smoke-and-think time.</p>
<p><code class="codehilite"><span class="mi">15</span><span class="o">:</span><span class="mi">14</span></code><br />
Something new came up! After adding a spinlock for ibapi, this showed up (I tried one more time after this, which does not show up). We are lucky to catch this. At least I know where to look at. Also, this is defenitly triggered by <code class="codehilite">mremap</code>. It is seems it is overlapped <code class="codehilite">mremap()</code>. One thing I did not know is which thread trigger this bug, the sweep thread? Cause mremap related pcache rmap functions do not use <code class="codehilite">rmap_get_locked_pte</code>.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>[ 3826.048774] normal_p2s_open(): f_name: word_100MB.txt, mode: 04400, flags: 0
[ 3827.891622] SYSC_mremap(cpu18): move: [0x7fffe5788000 - 0x7fffe5806000] -&gt; [0x7fffe531b000 - 0x7fffe5399000]
[ 3828.178643] SYSC_mremap(cpu14): move: [0x7fffe5941000 - 0x7fffe5980000] -&gt; [0x7fffe57c7000 - 0x7fffe5806000]

****    ERROR: mismatched PTE and rmap
****    rmap-&gt;owner_process: word_count-pthr uva: 0x7fffe57c8000 ptep: ffff88107efe0e40, rmap-&gt;page_table: ffff88107efe0e40
****    pcache_pfn: 0x1257c8, pte_pfn: 0x125942
</pre></div>
</td></tr></table>

<p><code class="codehilite"><span class="mi">14</span><span class="o">:</span><span class="mi">00</span></code> <br />
<code class="codehilite">word_count-pthread</code>: 100MB dataset
<code class="codehilite">pcache</code>: 8GB, 8-way
<code class="codehilite">victim</code>: 8 entries
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>[ 1294.845313] STDOUT: ---[
Wordcount: Running...
]---
[ 1294.903661] STDOUT: ---[

o;
]---
[ 1294.946301] normal_p2s_open(): f_name: /root/ys/phoenix/phoenix-2.0/tests/word_count/word_count_datafiles/word_100MB.txt, mode: 04400, flags: 0
[ 1295.100517] SYSC_close(): [4] -&gt; [/sys/devices/system/cpu/online]
[ 1295.594658] word_count-pthr[59] general protection ip:4272ea sp:7ffff1b8ed28 error:0
[ 1295.685236] CPU: 10 PID: 59 Comm: word_count-pthr 4.0.0-lego+ #113
[ 1295.759070] RIP: 0033:[&lt;00000000004272ea&gt;]  [&lt;00000000004272ea&gt;] 0x4272ea
[ 1295.840184] RSP: 002b:00007ffff1b8ed28  EFLAGS: 00010283
[ 1295.903621] RAX: 000000000000000f RBX: 00007fffe5a3d010 RCX: 0000000000000001
[ 1295.988893] RDX: 0000000000000000 RSI: 4854005942004441 RDI: 00007ffff1c1e80f
[ 1296.074166] RBP: 00007ffff1c1e80f R08: 0000000000000000 R09: 0000000000000010
[ 1296.211435] R10: 0000000000427ce0 R11: 00007ffff1bbb3ba R12: 0000000000001de4
[ 1296.296711] R13: 00000000006e4a80 R14: 0000000000001d9e R15: 0000000000001dc1
[ 1296.433978] FS:  00007ffff1b8f700(0000) GS:ffff88107fca0000(0000) knlGS:0000000000000000
[ 1296.582686] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 1296.963297] CR2: 00007ffff1c1e000 CR3: 000000207fd8a000 CR4: 00000000000406a0
</pre></div>
</td></tr></table>
So what is this <code class="codehilite"><span class="n">ip</span><span class="o">:</span><span class="mi">4272</span><span class="n">ea</span></code>, let us objdump the binary:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>0000000000425e60 &lt;strcmp&gt;:
  425e60:       48 8d 05 69 14 00 00    lea    0x1469(%rip),%rax        # 4272d0 &lt;__strcmp_sse42&gt;
  425e67:       f7 05 5f b8 2b 00 00    testl  $0x100000,0x2bb85f(%rip)        # 6e16d0 &lt;_dl_x86_cpu_features+0x10&gt;
  425e6e:       00 10 00
  425e71:       75 1a                   jne    425e8d &lt;strcmp+0x2d&gt;
  425e73:       48 8d 05 46 b0 00 00    lea    0xb046(%rip),%rax        # 430ec0 &lt;__strcmp_ssse3&gt;
  425e7a:       f7 05 4c b8 2b 00 00    testl  $0x200,0x2bb84c(%rip)        # 6e16d0 &lt;_dl_x86_cpu_features+0x10&gt;
  425e81:       02 00 00
  425e84:       75 07                   jne    425e8d &lt;strcmp+0x2d&gt;
  425e86:       48 8d 05 03 00 00 00    lea    0x3(%rip),%rax        # 425e90 &lt;__GI_strcmp&gt;
  425e8d:       c3                      retq
  425e8e:       66 90                   xchg   %ax,%ax
 .. ..
 .. ..
00000000004272d0 &lt;__strcmp_sse42&gt;:
  4272d0:       89 f1                   mov    %esi,%ecx
  4272d2:       89 f8                   mov    %edi,%eax
  4272d4:       48 83 e1 3f             and    $0x3f,%rcx
  4272d8:       48 83 e0 3f             and    $0x3f,%rax
  4272dc:       83 f9 30                cmp    $0x30,%ecx
  4272df:       77 3f                   ja     427320 &lt;__strcmp_sse42+0x50&gt;
  4272e1:       83 f8 30                cmp    $0x30,%eax
  4272e4:       77 3a                   ja     427320 &lt;__strcmp_sse42+0x50&gt;
  4272e6:       f3 0f 6f 0f             movdqu (%rdi),%xmm1
* 4272ea:       f3 0f 6f 16             movdqu (%rsi),%xmm2
  4272ee:       66 0f ef c0             pxor   %xmm0,%xmm0
</pre></div>
</td></tr></table>
You can see <code class="codehilite"><span class="nf">%rsi</span></code> has some garbage value <code class="codehilite"><span class="n">RSI</span><span class="o">:</span> <span class="mi">4854005942004441</span></code>. Something went wrong. Will it be our FPU? I&rsquo;m not quite sure. If FPU code has error, why single-thread one succeed? Why it only shows up at multithread ones?</p>
<hr />
<h2 id="0205-mon-sunny"><code class="codehilite">02/05 Mon Sunny</code></h2>
<p>From yesterday&rsquo;s testing of Phoenix, it looks like something is wrong in <code class="codehilite">smp_call_functions()</code>. They are invoked through <code class="codehilite">tlb flush</code>, which was further invoked by <code class="codehilite">mremap</code>, or <code class="codehilite">munmap</code>. The warning from smp is:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="p">[</span> <span class="mf">1260.586696</span><span class="p">]</span> <span class="nl">WARNING</span><span class="p">:</span> <span class="nl">CPU</span><span class="p">:</span> <span class="mi">0</span> <span class="nl">PID</span><span class="p">:</span> <span class="mi">73</span> <span class="n">at</span> <span class="n">kernel</span><span class="o">/</span><span class="n">smp</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span><span class="mi">129</span> <span class="n">generic_smp_call_function_single_interrupt</span><span class="o">+</span><span class="mh">0xb8</span><span class="o">/</span><span class="mh">0x160</span>
<span class="p">[</span> <span class="mf">1260.705251</span><span class="p">]</span> <span class="nl">CPU</span><span class="p">:</span> <span class="mi">0</span> <span class="nl">PID</span><span class="p">:</span> <span class="mi">73</span> <span class="nl">Comm</span><span class="p">:</span> <span class="n">word_count</span><span class="o">-</span><span class="n">pthr</span> <span class="mf">4.0.0</span><span class="o">-</span><span class="n">lego</span><span class="o">+</span> <span class="err">#</span><span class="mi">99</span>
<span class="p">[</span> <span class="mf">1260.777008</span><span class="p">]</span> <span class="nl">Stack</span><span class="p">:</span>
<span class="p">[</span> <span class="mf">1260.800927</span><span class="p">]</span> <span class="n">ffff88207fdffef8</span> <span class="n">ffffffff8100ec67</span> <span class="n">ffff88107fc00000</span> <span class="n">ffff88107fc00000</span>
<span class="p">[</span> <span class="mf">1260.888283</span><span class="p">]</span> <span class="n">ffffffff8100d410</span> <span class="n">ffff88207fe23df0</span> <span class="n">ffff88207fdfff08</span> <span class="n">ffffffff8100ed5f</span>
<span class="p">[</span> <span class="mf">1260.975639</span><span class="p">]</span> <span class="n">ffff88207fdfff38</span> <span class="n">ffffffff8100fe68</span> <span class="mf">00007ff</span><span class="n">fe58c3010</span> <span class="mf">0000000000000f</span><span class="mi">96</span>
<span class="p">[</span> <span class="mf">1261.062995</span><span class="p">]</span> <span class="mf">000000000000f</span><span class="mi">960</span> <span class="mf">0000000000000f</span><span class="mi">95</span> <span class="n">ffff88207fdfff48</span> <span class="n">ffffffff810020dd</span>
<span class="p">[</span> <span class="mf">1261.150351</span><span class="p">]</span> <span class="mf">00007ff</span><span class="n">ff58869c1</span> <span class="n">ffffffff8100b2e9</span> <span class="mf">0000000000000f</span><span class="mi">96</span> <span class="mf">0000000000000f</span><span class="mi">95</span>
<span class="p">[</span> <span class="mf">1261.237707</span><span class="p">]</span> <span class="n">Call</span> <span class="nl">Trace</span><span class="p">:</span>
<span class="p">[</span> <span class="mf">1261.266825</span><span class="p">]</span> <span class="o">&lt;</span><span class="n">TSK</span><span class="o">&gt;</span>
<span class="p">[</span> <span class="mf">1261.289704</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8100ec76</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">__warn</span><span class="p">.</span><span class="n">constprop</span><span class="mf">.0</span><span class="o">+</span><span class="mh">0xa6</span><span class="o">/</span><span class="mh">0x100</span>
<span class="p">[</span> <span class="mf">1261.359381</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8100d410</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">pgd_free</span><span class="o">+</span><span class="mh">0x90</span><span class="o">/</span><span class="mh">0x90</span>
<span class="p">[</span> <span class="mf">1261.419699</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8100ed5f</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">warn_slowpath_null</span><span class="o">+</span><span class="mh">0xf</span><span class="o">/</span><span class="mh">0x20</span>
<span class="p">[</span> <span class="mf">1261.487295</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8100fe68</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">generic_smp_call_function_single_interrupt</span><span class="o">+</span><span class="mh">0xb8</span><span class="o">/</span><span class="mh">0x160</span>
<span class="p">[</span> <span class="mf">1261.581931</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff810020dd</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">call_function_interrupt</span><span class="o">+</span><span class="mh">0x1d</span><span class="o">/</span><span class="mh">0x20</span>
<span class="p">[</span> <span class="mf">1261.655767</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8100b2e9</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">smp__call_function_interrupt</span><span class="o">+</span><span class="mh">0x69</span><span class="o">/</span><span class="mh">0x70</span>
</pre></div>
</td></tr></table>

<p>So I decided to look into smp.c a little bit to find out if there is something wrong (I wrote it long time ago). The warning itself is true, it means some inconsistent behavior.. I saw <code class="codehilite">alloc_percpu</code> stuff during <code class="codehilite">call_function_init</code>, hence probably I also need to check percpu code a little code cause I&rsquo;m not sure if I port all the functionalities.</p>
<p>In all, today&rsquo;s task, check <code class="codehilite">percpu</code> and <code class="codehilite">smp_call_function</code> code. Esp, <code class="codehilite">percpu</code> code, they are crucial and very hard to relate real bugs to it.</p>
<p>Well&hellip; things changed. I found a more serious bug: something about <code class="codehilite">cpuhotplug</code>, even though lego is not using it. <code class="codehilite">cpuhotplug</code> is a set of implict callbacks to all different subsystems who want to do some initialization work on each <code class="codehilite">offline-&gt;online</code> cpu.</p>
<p>Let us dig into how secondary cpu boots:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">Trampoline</span><span class="p">..</span> <span class="n">setup</span> <span class="mi">64</span><span class="n">bit</span> <span class="n">mode</span>
<span class="n">start_secondary</span><span class="p">()</span>
  <span class="n">smp_callin</span><span class="p">()</span>
        <span class="n">notify_cpu_starting</span><span class="p">()</span>
              <span class="p">...</span>
              <span class="k">while</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&lt;</span> <span class="n">target</span><span class="p">)</span> <span class="p">{</span>
                      <span class="n">st</span><span class="o">-&gt;</span><span class="n">state</span><span class="o">++</span><span class="p">;</span>
                      <span class="n">cpuhp_invoke_callback</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
              <span class="p">}</span>
          <span class="n">cpuhp_invoke_callback</span><span class="p">()</span>
</pre></div>
</td></tr></table></p>
<p>See? There will be some callbacks! What are those callbacks exactly? Well, they are predefined at the <code class="codehilite">kernel/cpu.c</code>. To save the trouble of reading code, I just print what functions are executed, the log is:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>[    0.118235] cpuhp_invoke_callback(): 136  CPU:0  page_writeback_cpu_online+0x0/0x20

[    0.368478] cpuhp_invoke_callback(): 136  CPU:1  smpboot_create_threads+0x0/0x90
[    0.370196] cpuhp_invoke_callback(): 136  CPU:1  perf_event_init_cpu+0x0/0xa0
[    0.370403] cpuhp_invoke_callback(): 136  CPU:1  workqueue_prepare_cpu+0x0/0x80
[    0.371112] cpuhp_invoke_callback(): 136  CPU:1  hrtimers_prepare_cpu+0x0/0x60
[    0.371339] cpuhp_invoke_callback(): 136  CPU:1  smpcfd_prepare_cpu+0x0/0x80
[    0.371584] cpuhp_invoke_callback(): 136  CPU:1  relay_prepare_cpu+0x0/0xe0
[    0.371794] cpuhp_invoke_callback(): 136  CPU:1  rcutree_prepare_cpu+0x0/0x170
[    0.372333] cpuhp_invoke_callback(): 136  CPU:1  notify_prepare+0x0/0xa0
[    0.372744] cpuhp_invoke_callback(): 136  CPU:1  bringup_cpu+0x0/0x100
[    0.008000] cpuhp_invoke_callback(): 136  CPU:1  sched_cpu_starting+0x0/0x60
[    0.926124] cpuhp_invoke_callback(): 136  CPU:1  smpboot_unpark_threads+0x0/0x90
[    0.926124] cpuhp_invoke_callback(): 136  CPU:1  perf_event_init_cpu+0x0/0xa0
[    0.927028] cpuhp_invoke_callback(): 136  CPU:1  workqueue_online_cpu+0x0/0x2a0
[    0.927768] cpuhp_invoke_callback(): 136  CPU:1  rcutree_online_cpu+0x0/0x70
[    0.928045] cpuhp_invoke_callback(): 136  CPU:1  notify_online+0x0/0x20
[    0.928256] cpuhp_invoke_callback(): 136  CPU:1  page_writeback_cpu_online+0x0/0x20
[    0.928527] cpuhp_invoke_callback(): 136  CPU:1  sched_cpu_activate+0x0/0x190

[    0.929084] cpuhp_invoke_callback(): 136  CPU:2  smpboot_create_threads+0x0/0x90
[    0.930240] cpuhp_invoke_callback(): 136  CPU:2  perf_event_init_cpu+0x0/0xa0
[    0.930434] cpuhp_invoke_callback(): 136  CPU:2  workqueue_prepare_cpu+0x0/0x80
[    0.931070] cpuhp_invoke_callback(): 136  CPU:2  hrtimers_prepare_cpu+0x0/0x60
[    0.931264] cpuhp_invoke_callback(): 136  CPU:2  smpcfd_prepare_cpu+0x0/0x80
[    0.931464] cpuhp_invoke_callback(): 136  CPU:2  relay_prepare_cpu+0x0/0xe0
[    0.931649] cpuhp_invoke_callback(): 136  CPU:2  rcutree_prepare_cpu+0x0/0x170
[    0.932245] cpuhp_invoke_callback(): 136  CPU:2  notify_prepare+0x0/0xa0
[    0.932475] cpuhp_invoke_callback(): 136  CPU:2  bringup_cpu+0x0/0x100
[    0.008000] cpuhp_invoke_callback(): 136  CPU:2  sched_cpu_starting+0x0/0x60
[    1.005023] cpuhp_invoke_callback(): 136  CPU:2  smpboot_unpark_threads+0x0/0x90
[    1.005065] cpuhp_invoke_callback(): 136  CPU:2  perf_event_init_cpu+0x0/0xa0
[    1.005408] cpuhp_invoke_callback(): 136  CPU:2  workqueue_online_cpu+0x0/0x2a0
[    1.005729] cpuhp_invoke_callback(): 136  CPU:2  rcutree_online_cpu+0x0/0x70
[    1.006029] cpuhp_invoke_callback(): 136  CPU:2  notify_online+0x0/0x20
[    1.006206] cpuhp_invoke_callback(): 136  CPU:2  page_writeback_cpu_online+0x0/0x20
[    1.006549] cpuhp_invoke_callback(): 136  CPU:2  sched_cpu_activate+0x0/0x190
</pre></div>
</td></tr></table></p>
<p>Interesting! Currently, Lego need to add the <code class="codehilite">smpboot_create_threads()</code>, <code class="codehilite">workqueue_prepare_cpu()</code>, <code class="codehilite">workqueue_prepare_cpu()</code>, <code class="codehilite">bringup_cpu()</code>, <code class="codehilite">smpboot_unpark_threads()</code>, <code class="codehilite">workqueue_online_cpu()</code>.</p>
<p>This hidden things is really hard to find and not easy to track during boot. Especially during boot, they should do something like <code class="codehilite">for_each_online_cpu</code> and init one by one. But I guess, after adding support of cpu hotplug, code kind of merged. Some stuff will be executed whenever a cpu has been teardown or bought up. And bang, why not use the same set of hotplug during boot, right?
Well.</p>
<hr />
                
                  
                
              
              
                
              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../../../misc/jasmine/" title="Jasmine" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Jasmine
              </span>
            </div>
          </a>
        
        
          <a href="../../boot/grub/" title="GRUB" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                GRUB
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="http://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../../assets/javascripts/application.abd7b172.js"></script>
      
      <script>app.initialize({version:"0.17.2",url:{base:"../../.."}})</script>
      
    
    
      
    
  </body>
</html>