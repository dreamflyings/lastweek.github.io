



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
        <link rel="canonical" href="http://lastweek.io/lego/log/log-02-2018/">
      
      
        <meta name="author" content="Yizhou Shan">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.4.3">
    
    
      
        <title>Feb 2018 - Yizhou Shan's Home Page</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/application.30686662.css">
      
      
    
    
      <script src="../../../assets/javascripts/modernizr.74668098.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,400i,700|&display=fallback">
        <style>body,input{font-family:"Open Sans","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../../assets/fonts/material-icons.css">
    
    
    
      
        
<script>
  window.ga = window.ga || function() {
    (ga.q = ga.q || []).push(arguments)
  }
  ga.l = +new Date
  /* Setup integration and send page view */
  ga("create", "UA-143772066-1", "auto")
  ga("set", "anonymizeIp", true)
  ga("send", "pageview")
  /* Register handler to log search on blur */
  document.addEventListener("DOMContentLoaded", () => {
    if (document.forms.search) {
      var query = document.forms.search.query
      query.addEventListener("blur", function() {
        if (this.value) {
          var path = document.location.pathname;
          ga("send", "pageview", path + "?q=" + this.value)
        }
      })
    }
  })
</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#feb-2018" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="http://lastweek.io" title="Yizhou Shan's Home Page" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Yizhou Shan's Home Page
            </span>
            <span class="md-header-nav__topic">
              
                Feb 2018
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="http://lastweek.io" title="Yizhou Shan's Home Page" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Yizhou Shan's Home Page
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Blog
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Blog
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../blog/20200501-on-graphic-softwares/" title="2020-05 On-Unix-Graphic-Softwares" class="md-nav__link">
      2020-05 On-Unix-Graphic-Softwares
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../blog/20200404-on-read-once/" title="2020-04 On-Read-Once-and-Compiler-Opts" class="md-nav__link">
      2020-04 On-Read-Once-and-Compiler-Opts
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../blog/20200404-on-net-transport/" title="2020-04 On-Hardware-based-Network-Transport" class="md-nav__link">
      2020-04 On-Hardware-based-Network-Transport
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Notes
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Notes
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/source_code/" title="Open-Source-Code-Study" class="md-nav__link">
      Open-Source-Code-Study
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/program_advice/" title="Programming-Guidelines-and-Advice" class="md-nav__link">
      Programming-Guidelines-and-Advice
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/virt/" title="Virtualization-Software" class="md-nav__link">
      Virtualization-Software
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/cache_coherence/" title="Practical-Cache-Coherence" class="md-nav__link">
      Practical-Cache-Coherence
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/xperf/" title="Measure-x86-Ring-Switch-Overhead" class="md-nav__link">
      Measure-x86-Ring-Switch-Overhead
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/paper_perf_shadows/" title="Performance-Shadows" class="md-nav__link">
      Performance-Shadows
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/rmap/" title="Linux Reverse Map (rmap)" class="md-nav__link">
      Linux Reverse Map (rmap)
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/userfaultfd/" title="Linux Userfaultfd" class="md-nav__link">
      Linux Userfaultfd
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/trace/" title="Linux Trace/Profile" class="md-nav__link">
      Linux Trace/Profile
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/cgroup-swap/" title="Linux Cgroup and Swap" class="md-nav__link">
      Linux Cgroup and Swap
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/proc/" title="Linux Special Files" class="md-nav__link">
      Linux Special Files
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/linux-resource/" title="Linux Resource" class="md-nav__link">
      Linux Resource
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/kvm-basic/" title="Linux KVM" class="md-nav__link">
      Linux KVM
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../misc/essential/" title="Essential" class="md-nav__link">
      Essential
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/benchmark/" title="Benchmarks" class="md-nav__link">
      Benchmarks
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../misc/cheatsheet/" title="Cheatsheet" class="md-nav__link">
      Cheatsheet
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      FPGA
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        FPGA
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../notes/paper_fpga/" title="Papers" class="md-nav__link">
      Papers
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../fpga/bitstream/" title="Bitstream Explained" class="md-nav__link">
      Bitstream Explained
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../fpga/pr/" title="Morphous PR" class="md-nav__link">
      Morphous PR
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../fpga/vivado/" title="Vivado Practice" class="md-nav__link">
      Vivado Practice
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../fpga/hls_axi/" title="Efficient AXI-MM" class="md-nav__link">
      Efficient AXI-MM
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      LegoOS
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        LegoOS
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-1" type="checkbox" id="nav-5-1">
    
    <label class="md-nav__link" for="nav-5-1">
      Kernel
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-1">
        Kernel
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/boot/" title="GRUB2 and Boot" class="md-nav__link">
      GRUB2 and Boot
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/kconfig/" title="Kconfig" class="md-nav__link">
      Kconfig
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/debug/" title="Debug" class="md-nav__link">
      Debug
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/grub/" title="GRUB" class="md-nav__link">
      GRUB
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/profile/" title="Profile" class="md-nav__link">
      Profile
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/profile_strace/" title="Profile strace" class="md-nav__link">
      Profile strace
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/profile_heatmap/" title="Profile heatmap" class="md-nav__link">
      Profile heatmap
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/profile_points/" title="Profile points" class="md-nav__link">
      Profile points
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/trampoline/" title="Trampoline" class="md-nav__link">
      Trampoline
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/pagefault_disable/" title="Disable pgfault" class="md-nav__link">
      Disable pgfault
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/stop_machine/" title="Stop machine" class="md-nav__link">
      Stop machine
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/loader/" title="Program Loader" class="md-nav__link">
      Program Loader
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/vDSO/" title="vDSO" class="md-nav__link">
      vDSO
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/vfs/" title="Virtual File System" class="md-nav__link">
      Virtual File System
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/vm/" title="Process Virtual Memory" class="md-nav__link">
      Process Virtual Memory
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/fpu/" title="x86 FPU" class="md-nav__link">
      x86 FPU
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/irq/" title="IRQ" class="md-nav__link">
      IRQ
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/net_thpool/" title="Network Thpool" class="md-nav__link">
      Network Thpool
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-2" type="checkbox" id="nav-5-2">
    
    <label class="md-nav__link" for="nav-5-2">
      Syscall
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-2">
        Syscall
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../syscall/facts/" title="Facts" class="md-nav__link">
      Facts
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/profile_strace/" title="strace" class="md-nav__link">
      strace
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../syscall/compat/" title="compat" class="md-nav__link">
      compat
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../syscall/msync/" title="msync()" class="md-nav__link">
      msync()
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../syscall/mremap/" title="mremap()" class="md-nav__link">
      mremap()
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../syscall/fork/" title="fork()" class="md-nav__link">
      fork()
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../syscall/getrusage/" title="getrusage()" class="md-nav__link">
      getrusage()
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../syscall/wait_and_exit/" title="wait4 and exit()" class="md-nav__link">
      wait4 and exit()
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-3" type="checkbox" id="nav-5-3">
    
    <label class="md-nav__link" for="nav-5-3">
      Pcache
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-3">
        Pcache
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/config/" title="Config" class="md-nav__link">
      Config
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/sweep/" title="Sweep" class="md-nav__link">
      Sweep
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/tlb/" title="TLB Coherence" class="md-nav__link">
      TLB Coherence
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/pgtable-lock/" title="PageTable Lock" class="md-nav__link">
      PageTable Lock
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/victim/" title="Victim Cache" class="md-nav__link">
      Victim Cache
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/virtual_cache/" title="Virtual Cache" class="md-nav__link">
      Virtual Cache
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/rmap/" title="Reverse Mapping" class="md-nav__link">
      Reverse Mapping
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/evict_and_ref/" title="Evict and Refcount" class="md-nav__link">
      Evict and Refcount
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/smp_design/" title="SMP Design" class="md-nav__link">
      SMP Design
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../pcache/replication/" title="Replication" class="md-nav__link">
      Replication
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-4" type="checkbox" id="nav-5-4">
    
    <label class="md-nav__link" for="nav-5-4">
      Driver
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-4">
        Driver
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../driver/pci/" title="PCI" class="md-nav__link">
      PCI
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../driver/ib/" title="Infiniband" class="md-nav__link">
      Infiniband
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-5" type="checkbox" id="nav-5-5">
    
    <label class="md-nav__link" for="nav-5-5">
      Paper
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-5">
        Paper
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../paper/nmp/" title="NMP" class="md-nav__link">
      NMP
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../paper/processor_oom/" title="Processor OOM" class="md-nav__link">
      Processor OOM
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../paper/genz/" title="Gen-Z" class="md-nav__link">
      Gen-Z
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../paper/replication/" title="Replication" class="md-nav__link">
      Replication
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../paper/related/" title="Related" class="md-nav__link">
      Related
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#0228-wed" class="md-nav__link">
    02/28 Wed
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#0227-tue" class="md-nav__link">
    02/27 Tue
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#0224-sat" class="md-nav__link">
    02/24 Sat
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#0223-fri" class="md-nav__link">
    02/23 Fri
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#solved-fpu-bug" class="md-nav__link">
    Solved FPU BUG
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ib" class="md-nav__link">
    IB
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pcache" class="md-nav__link">
    pcache
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#0222-thur" class="md-nav__link">
    02/22 Thur
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#0221-wed" class="md-nav__link">
    02/21 Wed
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#0220-tue-cloudy" class="md-nav__link">
    02/20 Tue Cloudy
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#0219-mon-rainy" class="md-nav__link">
    02/19 Mon Rainy
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#0218-sun-sunny" class="md-nav__link">
    02/18 Sun Sunny
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#0217-sat-snowy" class="md-nav__link">
    02/17 Sat Snowy
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#0216-fri-cloudy" class="md-nav__link">
    02/16 Fri Cloudy
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#0215-thur-rainy" class="md-nav__link">
    02/15 Thur Rainy
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#0214-wed-rainy" class="md-nav__link">
    02/14 Wed Rainy
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#0213-tue-sunny" class="md-nav__link">
    02/13 Tue Sunny
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#0212-mon-cloudy" class="md-nav__link">
    02/12 Mon Cloudy
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#0209-fri-cloudy" class="md-nav__link">
    02/09 Fri Cloudy
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#0208-thur-cloudy" class="md-nav__link">
    02/08 Thur Cloudy
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#0207-wed-cloudy" class="md-nav__link">
    02/07 Wed Cloudy
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#0206-tue-sunny" class="md-nav__link">
    02/06 Tue Sunny
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#0205-mon-sunny" class="md-nav__link">
    02/05 Mon Sunny
  </a>
  
</li>
      
      
      
      
      
        <li class="md-nav__item">
          <a href="#__comments" class="md-nav__link md-nav__link--active">
            Comments
          </a>
        </li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="feb-2018">Feb 2018<a class="headerlink" href="#feb-2018" title="Permanent link">&para;</a></h1>
<hr />
<h2 id="0228-wed">02/28 Wed<a class="headerlink" href="#0228-wed" title="Permanent link">&para;</a></h2>
<ul>
<li>patch fork, and cow handler</li>
<li>debug pcache, while running python hello world</li>
<li>add vDSO, gettimeofday</li>
</ul>
<p>So, it is end of the day. After adding wp handler, I now have the whole picture of pcache activities, and the interactions between them. The reclaim, zap, move, copy, add, operations needs to be carefully synchronized. Also the refcount etc. I feel the ground rule is we need to make sure a PCM that a function is currently using, can not suddenly become invalid due to other operations. This has to be synced by: refcount, lock, flags. Oh well, mm is hard with SMP, but also fun.</p>
<p>We are very close to have a fully working OS.</p>
<p>I did not have time to look into the python hello world bug issue. It is a very serious one. It may also rule out some root bugs.</p>
<hr />
<h2 id="0227-tue">02/27 Tue<a class="headerlink" href="#0227-tue" title="Permanent link">&para;</a></h2>
<p>Spent two days on CS527 source project, implemented a small SSHD and SSD client. And we have to inject exactly five bugs, or vulnerabilities into the systems. Lol, it is really hard to intentionally plant BUGs!</p>
<p>Anyway, back to Lego. Since others are having a hard time compile program statically, I will try to add dynamic loader today.</p>
<p>The interpreter: <code class="codehilite"><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">ld</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">x86</span><span class="o">-</span><span class="mi">64</span><span class="p">.</span><span class="n">so</span><span class="p">.</span><span class="mi">2</span></code>.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">Linux</span><span class="w"> </span><span class="n">seq</span><span class="p">.</span><span class="n">c</span><span class="w"> </span><span class="n">maps</span><span class="w"> </span><span class="p">(</span><span class="k">no</span><span class="w"> </span><span class="n">randomization</span><span class="p">)</span><span class="err">:</span><span class="w"></span>
<span class="mi">00400000</span><span class="o">-</span><span class="mi">00401000</span><span class="w"> </span><span class="n">r</span><span class="o">-</span><span class="n">xp</span><span class="w"> </span><span class="mi">00000000</span><span class="w"> </span><span class="nl">fd</span><span class="p">:</span><span class="mi">00</span><span class="w"> </span><span class="mi">18752683</span><span class="w">                           </span><span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">ys</span><span class="o">/</span><span class="n">LegoOS</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">a</span><span class="p">.</span><span class="k">out</span><span class="w"></span>
<span class="mi">00600000</span><span class="o">-</span><span class="mi">00601000</span><span class="w"> </span><span class="n">r</span><span class="c1">--p 00000000 fd:00 18752683                           /root/ys/LegoOS/usr/a.out</span>
<span class="mi">00601000</span><span class="o">-</span><span class="mi">00602000</span><span class="w"> </span><span class="n">rw</span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="mi">00001000</span><span class="w"> </span><span class="nl">fd</span><span class="p">:</span><span class="mi">00</span><span class="w"> </span><span class="mi">18752683</span><span class="w">                           </span><span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">ys</span><span class="o">/</span><span class="n">LegoOS</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">a</span><span class="p">.</span><span class="k">out</span><span class="w"></span>
<span class="mi">00602000</span><span class="o">-</span><span class="mi">00604000</span><span class="w"> </span><span class="n">rw</span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="mi">00000000</span><span class="w"> </span><span class="mi">00</span><span class="err">:</span><span class="mi">00</span><span class="w"> </span><span class="mi">0</span><span class="w">                                  </span><span class="o">[</span><span class="n">heap</span><span class="o">]</span><span class="w"></span>
<span class="mi">7</span><span class="n">ffff7a18000</span><span class="o">-</span><span class="mi">7</span><span class="n">ffff7bd0000</span><span class="w"> </span><span class="n">r</span><span class="o">-</span><span class="n">xp</span><span class="w"> </span><span class="mi">00000000</span><span class="w"> </span><span class="nl">fd</span><span class="p">:</span><span class="mi">00</span><span class="w"> </span><span class="mi">55051990</span><span class="w">                   </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">libc</span><span class="o">-</span><span class="mf">2.17</span><span class="p">.</span><span class="n">so</span><span class="w"></span>
<span class="mi">7</span><span class="n">ffff7bd0000</span><span class="o">-</span><span class="mi">7</span><span class="n">ffff7dd0000</span><span class="w"> </span><span class="c1">---p 001b8000 fd:00 55051990                   /usr/lib64/libc-2.17.so</span>
<span class="mi">7</span><span class="n">ffff7dd0000</span><span class="o">-</span><span class="mi">7</span><span class="n">ffff7dd4000</span><span class="w"> </span><span class="n">r</span><span class="c1">--p 001b8000 fd:00 55051990                   /usr/lib64/libc-2.17.so</span>
<span class="mi">7</span><span class="n">ffff7dd4000</span><span class="o">-</span><span class="mi">7</span><span class="n">ffff7dd6000</span><span class="w"> </span><span class="n">rw</span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="mi">001</span><span class="n">bc000</span><span class="w"> </span><span class="nl">fd</span><span class="p">:</span><span class="mi">00</span><span class="w"> </span><span class="mi">55051990</span><span class="w">                   </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">libc</span><span class="o">-</span><span class="mf">2.17</span><span class="p">.</span><span class="n">so</span><span class="w"></span>
<span class="mi">7</span><span class="n">ffff7dd6000</span><span class="o">-</span><span class="mi">7</span><span class="n">ffff7ddb000</span><span class="w"> </span><span class="n">rw</span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="mi">00000000</span><span class="w"> </span><span class="mi">00</span><span class="err">:</span><span class="mi">00</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="hll"><span class="mi">7</span><span class="n">ffff7ddb000</span><span class="o">-</span><span class="mi">7</span><span class="n">ffff7dfc000</span><span class="w"> </span><span class="n">r</span><span class="o">-</span><span class="n">xp</span><span class="w"> </span><span class="mi">00000000</span><span class="w"> </span><span class="nl">fd</span><span class="p">:</span><span class="mi">00</span><span class="w"> </span><span class="mi">55051983</span><span class="w">                   </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">ld</span><span class="o">-</span><span class="mf">2.17</span><span class="p">.</span><span class="n">so</span><span class="w"></span>
</span><span class="mi">7</span><span class="n">ffff7fde000</span><span class="o">-</span><span class="mi">7</span><span class="n">ffff7fe1000</span><span class="w"> </span><span class="n">rw</span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="mi">00000000</span><span class="w"> </span><span class="mi">00</span><span class="err">:</span><span class="mi">00</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="mi">7</span><span class="n">ffff7ff9000</span><span class="o">-</span><span class="mi">7</span><span class="n">ffff7ffa000</span><span class="w"> </span><span class="n">rw</span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="mi">00000000</span><span class="w"> </span><span class="mi">00</span><span class="err">:</span><span class="mi">00</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="mi">7</span><span class="n">ffff7ffa000</span><span class="o">-</span><span class="mi">7</span><span class="n">ffff7ffc000</span><span class="w"> </span><span class="n">r</span><span class="o">-</span><span class="n">xp</span><span class="w"> </span><span class="mi">00000000</span><span class="w"> </span><span class="mi">00</span><span class="err">:</span><span class="mi">00</span><span class="w"> </span><span class="mi">0</span><span class="w">                          </span><span class="o">[</span><span class="n">vdso</span><span class="o">]</span><span class="w"></span>
<span class="hll"><span class="mi">7</span><span class="n">ffff7ffc000</span><span class="o">-</span><span class="mi">7</span><span class="n">ffff7ffd000</span><span class="w"> </span><span class="n">r</span><span class="c1">--p 00021000 fd:00 55051983                   /usr/lib64/ld-2.17.so</span>
</span><span class="mi">7</span><span class="n">ffff7ffd000</span><span class="o">-</span><span class="mi">7</span><span class="n">ffff7ffe000</span><span class="w"> </span><span class="n">rw</span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="mi">00022000</span><span class="w"> </span><span class="nl">fd</span><span class="p">:</span><span class="mi">00</span><span class="w"> </span><span class="mi">55051983</span><span class="w">                   </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">ld</span><span class="o">-</span><span class="mf">2.17</span><span class="p">.</span><span class="n">so</span><span class="w"></span>
<span class="hll"><span class="mi">7</span><span class="n">ffff7ffe000</span><span class="o">-</span><span class="mi">7</span><span class="n">ffff7fff000</span><span class="w"> </span><span class="n">rw</span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="mi">00000000</span><span class="w"> </span><span class="mi">00</span><span class="err">:</span><span class="mi">00</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
</span><span class="hll"><span class="mi">7</span><span class="n">ffffffde000</span><span class="o">-</span><span class="mi">7</span><span class="n">ffffffff000</span><span class="w"> </span><span class="n">rw</span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="mi">00000000</span><span class="w"> </span><span class="mi">00</span><span class="err">:</span><span class="mi">00</span><span class="w"> </span><span class="mi">0</span><span class="w">                          </span><span class="o">[</span><span class="n">stack</span><span class="o">]</span><span class="w"></span>
</span><span class="n">ffffffffff600000</span><span class="o">-</span><span class="n">ffffffffff601000</span><span class="w"> </span><span class="n">r</span><span class="o">-</span><span class="n">xp</span><span class="w"> </span><span class="mi">00000000</span><span class="w"> </span><span class="mi">00</span><span class="err">:</span><span class="mi">00</span><span class="w"> </span><span class="mi">0</span><span class="w">                  </span><span class="o">[</span><span class="n">vsyscall</span><span class="o">]</span><span class="w"></span>
</pre></div>
</td></tr></table>

<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">lego</span> <span class="n">after</span> <span class="n">loading</span>
<span class="mo">00400000</span><span class="o">-</span><span class="mo">00401000</span> <span class="n">r</span><span class="o">-</span><span class="n">xp</span> <span class="mo">00000000</span> <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">ys</span><span class="o">/</span><span class="n">LegoOS</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">a</span><span class="p">.</span><span class="k">out</span>
<span class="mo">00600000</span><span class="o">-</span><span class="mo">00602000</span> <span class="n">rw</span><span class="o">-</span><span class="n">p</span> <span class="mo">00000000</span> <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">ys</span><span class="o">/</span><span class="n">LegoOS</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">a</span><span class="p">.</span><span class="k">out</span>
<span class="mo">00602000</span><span class="o">-</span><span class="mo">00604000</span> <span class="n">rw</span><span class="o">-</span><span class="n">p</span> <span class="mo">00000000</span> <span class="p">[</span><span class="n">heap</span><span class="p">]</span>
<span class="mf">7ff</span><span class="n">ff7ddb000</span><span class="o">-</span><span class="mf">7ff</span><span class="n">ff7dfc000</span> <span class="n">r</span><span class="o">-</span><span class="n">xp</span> <span class="mo">00000000</span> <span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">ld</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">x86</span><span class="o">-</span><span class="mf">64.</span><span class="n">so</span><span class="mf">.2</span>
<span class="mf">7ff</span><span class="n">ff7ffc000</span><span class="o">-</span><span class="mf">7ff</span><span class="n">ff7ffe000</span> <span class="n">rw</span><span class="o">-</span><span class="n">p</span> <span class="mo">00021000</span> <span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">ld</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">x86</span><span class="o">-</span><span class="mf">64.</span><span class="n">so</span><span class="mf">.2</span>
<span class="mf">7ff</span><span class="n">ff7ffe000</span><span class="o">-</span><span class="mf">7ff</span><span class="n">ff7fff000</span> <span class="n">rw</span><span class="o">-</span><span class="n">p</span> <span class="mo">00000000</span>
<span class="mf">7ff</span><span class="n">ffffde000</span><span class="o">-</span><span class="mf">7ff</span><span class="n">ffffff000</span> <span class="n">rw</span><span class="o">-</span><span class="n">p</span> <span class="mo">00000000</span> <span class="p">[</span><span class="n">stack</span><span class="p">]</span>


<span class="p">[</span> <span class="mf">2066.379224</span><span class="p">]</span> <span class="o">****</span>    <span class="n">Finish</span> <span class="n">dump</span> <span class="n">final</span> <span class="n">mm</span>
<span class="p">[</span> <span class="mf">2066.426023</span><span class="p">]</span> <span class="n">handle_p2m_execve</span><span class="p">()</span><span class="o">:</span> <span class="nl">reply_status</span><span class="p">:</span> <span class="n">OKAY</span><span class="p">,</span> <span class="nl">new_ip</span><span class="p">:</span> <span class="mh">0x7ffff7ddc170</span><span class="p">,</span> <span class="nl">new_sp</span><span class="p">:</span> <span class="mh">0x7fffffffede0</span>
<span class="p">[</span> <span class="mf">2066.628949</span><span class="p">]</span> <span class="n">handle_p2m_pcache_miss</span><span class="p">()</span> <span class="n">cpu</span> <span class="mi">4</span> <span class="n">I</span> <span class="nl">nid</span><span class="p">:</span><span class="mi">0</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">tgid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">flags</span><span class="p">:</span><span class="mi">150</span> <span class="nl">vaddr</span><span class="p">:</span><span class="mh">0x7ffff7ddc170</span>
<span class="p">[</span> <span class="mf">2066.732034</span><span class="p">]</span> <span class="n">handle_p2m_pcache_miss</span><span class="p">()</span> <span class="n">cpu</span> <span class="mi">4</span> <span class="n">O</span> <span class="nl">nid</span><span class="p">:</span><span class="mi">0</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">tgid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">flags</span><span class="p">:</span><span class="mi">150</span> <span class="nl">vaddr</span><span class="p">:</span><span class="mh">0x7ffff7ddc170</span>
<span class="p">[</span> <span class="mf">2066.934947</span><span class="p">]</span> <span class="n">handle_p2m_pcache_miss</span><span class="p">()</span> <span class="n">cpu</span> <span class="mi">4</span> <span class="n">I</span> <span class="nl">nid</span><span class="p">:</span><span class="mi">0</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">tgid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">flags</span><span class="p">:</span><span class="mi">51</span> <span class="nl">vaddr</span><span class="p">:</span><span class="mh">0x7fffffffedd8</span>
<span class="p">[</span> <span class="mf">2067.036978</span><span class="p">]</span> <span class="n">handle_p2m_pcache_miss</span><span class="p">()</span> <span class="n">cpu</span> <span class="mi">4</span> <span class="n">O</span> <span class="nl">nid</span><span class="p">:</span><span class="mi">0</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">tgid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">flags</span><span class="p">:</span><span class="mi">51</span> <span class="nl">vaddr</span><span class="p">:</span><span class="mh">0x7fffffffedd8</span>
<span class="p">[</span> <span class="mf">2067.238842</span><span class="p">]</span> <span class="n">handle_p2m_pcache_miss</span><span class="p">()</span> <span class="n">cpu</span> <span class="mi">4</span> <span class="n">I</span> <span class="nl">nid</span><span class="p">:</span><span class="mi">0</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">tgid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">flags</span><span class="p">:</span><span class="mi">50</span> <span class="nl">vaddr</span><span class="p">:</span><span class="mh">0x7ffff7ffce00</span>
<span class="p">[</span> <span class="mf">2067.340880</span><span class="p">]</span> <span class="n">handle_p2m_pcache_miss</span><span class="p">()</span> <span class="n">cpu</span> <span class="mi">4</span> <span class="n">O</span> <span class="nl">nid</span><span class="p">:</span><span class="mi">0</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">tgid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">flags</span><span class="p">:</span><span class="mi">50</span> <span class="nl">vaddr</span><span class="p">:</span><span class="mh">0x7ffff7ffce00</span>
<span class="p">[</span> <span class="mf">2067.542747</span><span class="p">]</span> <span class="n">handle_p2m_pcache_miss</span><span class="p">()</span> <span class="n">cpu</span> <span class="mi">4</span> <span class="n">I</span> <span class="nl">nid</span><span class="p">:</span><span class="mi">0</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">tgid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">flags</span><span class="p">:</span><span class="mi">51</span> <span class="nl">vaddr</span><span class="p">:</span><span class="mh">0x7ffff7ffd9a8</span>
<span class="p">[</span> <span class="mf">2067.644774</span><span class="p">]</span> <span class="n">handle_p2m_pcache_miss</span><span class="p">()</span> <span class="n">cpu</span> <span class="mi">4</span> <span class="n">O</span> <span class="nl">nid</span><span class="p">:</span><span class="mi">0</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">tgid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">flags</span><span class="p">:</span><span class="mi">51</span> <span class="nl">vaddr</span><span class="p">:</span><span class="mh">0x7ffff7ffd9a8</span>
<span class="p">[</span> <span class="mf">2067.846640</span><span class="p">]</span> <span class="n">handle_p2m_pcache_miss</span><span class="p">()</span> <span class="n">cpu</span> <span class="mi">4</span> <span class="n">I</span> <span class="nl">nid</span><span class="p">:</span><span class="mi">0</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">tgid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">flags</span><span class="p">:</span><span class="mi">50</span> <span class="nl">vaddr</span><span class="p">:</span><span class="mh">0x7ffff7ddb8e0</span>
<span class="p">[</span> <span class="mf">2067.948679</span><span class="p">]</span> <span class="n">handle_p2m_pcache_miss</span><span class="p">()</span> <span class="n">cpu</span> <span class="mi">4</span> <span class="n">O</span> <span class="nl">nid</span><span class="p">:</span><span class="mi">0</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">tgid</span><span class="p">:</span><span class="mi">32</span> <span class="nl">flags</span><span class="p">:</span><span class="mi">50</span> <span class="nl">vaddr</span><span class="p">:</span><span class="mh">0x7ffff7ddb8e0</span>
<span class="p">[</span> <span class="mf">2068.355424</span><span class="p">]</span> <span class="o">------------</span><span class="p">[</span> <span class="n">cut</span> <span class="n">here</span> <span class="p">]</span><span class="o">------------</span>
<span class="p">[</span> <span class="mf">2068.408568</span><span class="p">]</span> <span class="nl">WARNING</span><span class="p">:</span> <span class="nl">CPU</span><span class="p">:</span> <span class="mi">4</span> <span class="nl">PID</span><span class="p">:</span> <span class="mi">31</span> <span class="n">at</span> <span class="n">managers</span><span class="o">/</span><span class="n">memory</span><span class="o">/</span><span class="n">handle_pcache</span><span class="o">/</span><span class="n">fault</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span><span class="mi">54</span> <span class="n">handle_p2m_pcache_miss</span><span class="o">+</span><span class="mh">0x29d</span><span class="o">/</span><span class="mh">0x380</span>
<span class="hll"><span class="p">[</span> <span class="mf">2068.532327</span><span class="p">]</span> <span class="nl">src_nid</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="nl">pid</span><span class="p">:</span><span class="mi">32</span><span class="p">,</span><span class="nl">vaddr</span><span class="p">:</span><span class="mh">0x7ffff7e0e000</span>
</span><span class="p">[</span> <span class="mf">2068.588487</span><span class="p">]</span> <span class="nl">CPU</span><span class="p">:</span> <span class="mi">4</span> <span class="nl">PID</span><span class="p">:</span> <span class="mi">31</span> <span class="nl">Comm</span><span class="p">:</span> <span class="n">mc</span><span class="o">-</span><span class="n">manager</span> <span class="mf">4.0.0</span><span class="o">-</span><span class="n">lego</span><span class="o">-</span><span class="n">ys</span><span class="o">+</span> <span class="err">#</span><span class="mi">100</span>
<span class="p">[</span> <span class="mf">2068.659207</span><span class="p">]</span> <span class="nl">Stack</span><span class="p">:</span>
</pre></div>
</td></tr></table>

<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="o">[</span><span class="n">root@wuklab13: lib64</span><span class="o">]</span><span class="w"> </span><span class="err">$</span><span class="w"> </span><span class="n">ll</span><span class="w"> </span><span class="n">ld</span><span class="o">-*</span><span class="w"></span>
<span class="o">-</span><span class="n">rwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">root</span><span class="w"> </span><span class="n">root</span><span class="w"> </span><span class="mi">164112</span><span class="w"> </span><span class="n">Nov</span><span class="w"> </span><span class="mi">30</span><span class="w"> </span><span class="mi">13</span><span class="err">:</span><span class="mi">53</span><span class="w"> </span><span class="n">ld</span><span class="o">-</span><span class="mf">2.17</span><span class="p">.</span><span class="n">so</span><span class="w"></span>
<span class="n">lrwxrwxrwx</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">root</span><span class="w"> </span><span class="n">root</span><span class="w">     </span><span class="mi">10</span><span class="w"> </span><span class="n">Jan</span><span class="w">  </span><span class="mi">8</span><span class="w"> </span><span class="mi">12</span><span class="err">:</span><span class="mi">34</span><span class="w"> </span><span class="n">ld</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">x86</span><span class="o">-</span><span class="mf">64.</span><span class="n">so</span><span class="mf">.2</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">ld</span><span class="o">-</span><span class="mf">2.17</span><span class="p">.</span><span class="n">so</span><span class="w"></span>
<span class="o">[</span><span class="n">root@wuklab13: lib64</span><span class="o">]</span><span class="w"></span>
</pre></div>
</td></tr></table>

<p>It turns out there is a bug in mmap code: forgot to increment the file ref count when a file-backed vma is created. Some put_file in loader accidentally free the ld-linux file. Bug fixed, dyloader works like a charm.</p>
<hr />
<h2 id="0224-sat">02/24 Sat<a class="headerlink" href="#0224-sat" title="Permanent link">&para;</a></h2>
<p>Well. PhDs do not have weekends.
Anyway, it is Saturday after all, relaxed a little bit. I was looking into the pcache issue.
Also added our own kernel version strace.</p>
<hr />
<h2 id="0223-fri">02/23 Fri<a class="headerlink" href="#0223-fri" title="Permanent link">&para;</a></h2>
<h3 id="solved-fpu-bug">Solved FPU BUG<a class="headerlink" href="#solved-fpu-bug" title="Permanent link">&para;</a></h3>
<p><code class="codehilite"><span class="k">current</span></code> is fine. I should not compare the old implementation with the new per-cpu current. I forgot that the kernel stack is switched in the <code class="codehilite"><span class="n">__switch_to_asm</span></code>. This means in <code class="codehilite"><span class="n">__switch_to</span><span class="p">()</span></code>, we are actually using the <code class="codehilite"><span class="n">next_p</span></code>&lsquo;s kernel stack. So there is small time frame, where <code class="codehilite"><span class="n">current_thread_info</span><span class="p">()</span></code> points to <code class="codehilite"><span class="n">next_p</span></code>, while <code class="codehilite"><span class="n">current_task</span></code> is still <code class="codehilite"><span class="n">prev_p</span></code>. Since interrupts are disabled during context switch, we are good with this mismatch.</p>
<p>Rule out current, the only thing left is <code class="codehilite"><span class="n">fpu__copy</span></code> warning, which happens during <code class="codehilite"><span class="n">copy_process</span><span class="p">()</span></code>. One weird thing is this function has been called multiple times before it showed a warning. System itself use this function to create a lot background threads, which are fine. Only when it was triggered by <code class="codehilite"><span class="n">sys_clone</span></code> then we have the warning:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="p">[</span> <span class="mf">3213.055639</span><span class="p">]</span> <span class="nl">CPU</span><span class="p">:</span> <span class="mi">6</span> <span class="nl">PID</span><span class="p">:</span> <span class="mi">17</span> <span class="n">sys_clone</span><span class="o">+</span><span class="mh">0x0</span><span class="o">/</span><span class="mh">0x30</span>
<span class="p">[</span> <span class="mf">3213.056584</span><span class="p">]</span> <span class="n">new</span> <span class="nl">task_struct</span><span class="p">:</span> <span class="n">ffff88083e4c9838</span>
<span class="hll"><span class="p">[</span> <span class="mf">3213.057530</span><span class="p">]</span> <span class="n">arch_dup_task_struct</span> <span class="n">cpu6</span> <span class="nl">dst</span><span class="p">:</span><span class="n">ffff88083e4c9838</span> <span class="mi">17</span> <span class="n">word_count</span><span class="o">-</span><span class="n">seq</span> <span class="nl">src</span><span class="p">:</span><span class="n">ffff88083e457838</span> <span class="mi">17</span> <span class="n">word_count</span><span class="o">-</span><span class="n">seq</span>
</span><span class="hll"><span class="p">[</span> <span class="mf">3213.059536</span><span class="p">]</span> <span class="n">TRAP</span> <span class="n">do_general_protection</span> <span class="n">in</span> <span class="n">CPU6</span><span class="p">,</span> <span class="nl">error_code</span><span class="p">:</span> <span class="mi">0</span> <span class="nl">current</span><span class="p">:</span><span class="n">ffff88083e457838</span> <span class="mi">17</span> <span class="n">word_count</span><span class="o">-</span><span class="n">seq</span>
</span><span class="hll"><span class="p">[</span> <span class="mf">3213.061289</span><span class="p">]</span> <span class="n">fixup_exception</span> <span class="n">pid</span><span class="p">(</span><span class="mi">17</span><span class="p">)</span> <span class="n">cpu</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="nl">insn</span><span class="p">:</span><span class="mh">0xffffffff81009a21</span><span class="p">(</span><span class="n">fpu__copy</span><span class="o">+</span><span class="mh">0x81</span><span class="o">/</span><span class="mh">0x260</span><span class="p">)</span> <span class="nl">fixup</span><span class="p">:</span><span class="mh">0xffffffff8105d9b2</span><span class="p">(</span><span class="n">__fixup_text_start</span><span class="o">+</span><span class="mh">0xc2</span><span class="o">/</span><span class="mh">0x322</span><span class="p">)</span> <span class="nl">handler</span><span class="p">:</span><span class="n">ex_handler_default</span><span class="o">+</span><span class="mh">0x0</span><span class="o">/</span><span class="mh">0x20</span>
</span><span class="p">[</span> <span class="mf">3213.064114</span><span class="p">]</span> <span class="o">------------</span><span class="p">[</span> <span class="n">cut</span> <span class="n">here</span> <span class="p">]</span><span class="o">------------</span>
<span class="p">[</span> <span class="mf">3213.065040</span><span class="p">]</span> <span class="nl">WARNING</span><span class="p">:</span> <span class="nl">CPU</span><span class="p">:</span> <span class="mi">6</span> <span class="nl">PID</span><span class="p">:</span> <span class="mi">17</span> <span class="n">at</span> <span class="p">.</span><span class="o">/</span><span class="n">arch</span><span class="o">/</span><span class="n">x86</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="k">asm</span><span class="o">/</span><span class="n">fpu</span><span class="o">/</span><span class="n">internal</span><span class="p">.</span><span class="nl">h</span><span class="p">:</span><span class="mi">354</span> <span class="n">fpu__copy</span><span class="o">+</span><span class="mh">0xc3</span><span class="o">/</span><span class="mh">0x260</span>
<span class="p">[</span> <span class="mf">3213.066760</span><span class="p">]</span> <span class="nl">CPU</span><span class="p">:</span> <span class="mi">6</span> <span class="nl">PID</span><span class="p">:</span> <span class="mi">17</span> <span class="nl">Comm</span><span class="p">:</span> <span class="n">word_count</span><span class="o">-</span><span class="n">seq</span> <span class="mf">4.0.0</span><span class="o">-</span><span class="n">lego</span><span class="o">+</span> <span class="err">#</span><span class="mi">6</span>
<span class="p">[</span> <span class="mf">3213.067855</span><span class="p">]</span> <span class="nl">Stack</span><span class="p">:</span>
<span class="p">[</span> <span class="mf">3213.068424</span><span class="p">]</span> <span class="n">ffff88083e4c7dd0</span> <span class="n">ffffffff810124b5</span> <span class="n">ffff88083e4c9bf8</span> <span class="n">ffff88083e4c9c38</span>
<span class="p">[</span> <span class="mf">3213.070133</span><span class="p">]</span> <span class="n">ffff88083e4c9838</span> <span class="mf">00007ff</span><span class="n">ff7ffd700</span> <span class="n">ffff88083e4c7de0</span> <span class="n">ffffffff8101258f</span>
<span class="p">[</span> <span class="mf">3213.071775</span><span class="p">]</span> <span class="n">ffff88083e4c7e08</span> <span class="n">ffffffff81009a63</span> <span class="n">ffff88083e457838</span> <span class="n">ffff88083e4c9838</span>
<span class="p">[</span> <span class="mf">3213.073419</span><span class="p">]</span> <span class="n">ffff88083e457838</span> <span class="n">ffff88083e4c7e40</span> <span class="n">ffffffff81000ebb</span> <span class="n">ffff88083e457838</span>
<span class="p">[</span> <span class="mf">3213.075057</span><span class="p">]</span> <span class="n">ffff880800000011</span> <span class="n">ffff88083e457a68</span> <span class="mo">00000000003</span><span class="n">d0f00</span> <span class="n">ffff88083e457838</span>
<span class="p">[</span> <span class="mf">3213.076703</span><span class="p">]</span> <span class="n">Call</span> <span class="nl">Trace</span><span class="p">:</span>
<span class="p">[</span> <span class="mf">3213.077295</span><span class="p">]</span> <span class="o">&lt;</span><span class="n">TSK</span><span class="o">&gt;</span>
<span class="p">[</span> <span class="mf">3213.077828</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff810124c1</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">__warn</span><span class="p">.</span><span class="n">constprop</span><span class="mf">.0</span><span class="o">+</span><span class="mh">0x91</span><span class="o">/</span><span class="mh">0xd0</span>
<span class="p">[</span> <span class="mf">3213.078855</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8101258f</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">warn_slowpath_null</span><span class="o">+</span><span class="mh">0xf</span><span class="o">/</span><span class="mh">0x20</span>
<span class="p">[</span> <span class="mf">3213.081653</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81009a63</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">fpu__copy</span><span class="o">+</span><span class="mh">0xc3</span><span class="o">/</span><span class="mh">0x260</span>
<span class="p">[</span> <span class="mf">3213.082543</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81000ebb</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">arch_dup_task_struct</span><span class="o">+</span><span class="mh">0x7b</span><span class="o">/</span><span class="mh">0x90</span>
<span class="p">[</span> <span class="mf">3213.083667</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8101d32e</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">copy_process</span><span class="o">+</span><span class="mh">0x14e</span><span class="o">/</span><span class="mh">0x10e0</span>
<span class="p">[</span> <span class="mf">3213.084618</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8103a3c6</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">n_tty_write</span><span class="o">+</span><span class="mh">0x166</span><span class="o">/</span><span class="mh">0x3c0</span>
<span class="p">[</span> <span class="mf">3213.085564</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8101e2e6</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">do_fork</span><span class="o">+</span><span class="mh">0x26</span><span class="o">/</span><span class="mh">0x140</span>
<span class="p">[</span> <span class="mf">3213.086439</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8101e4a0</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">sys_vfork</span><span class="o">+</span><span class="mh">0x40</span><span class="o">/</span><span class="mh">0x40</span>
<span class="p">[</span> <span class="mf">3213.087333</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8101e4a0</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">sys_vfork</span><span class="o">+</span><span class="mh">0x40</span><span class="o">/</span><span class="mh">0x40</span>
<span class="p">[</span> <span class="mf">3213.088232</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8101e4c9</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">sys_clone</span><span class="o">+</span><span class="mh">0x29</span><span class="o">/</span><span class="mh">0x30</span>
<span class="p">[</span> <span class="mf">3213.089109</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8100e719</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">do_syscall_64</span><span class="o">+</span><span class="mh">0x69</span><span class="o">/</span><span class="mh">0xf0</span>
<span class="p">[</span> <span class="mf">3213.090030</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8100d5ec</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">entry_SYSCALL64_slow_path</span><span class="o">+</span><span class="mh">0x25</span><span class="o">/</span><span class="mh">0x25</span>
<span class="p">[</span> <span class="mf">3213.091078</span><span class="p">]</span> <span class="o">&lt;</span><span class="n">EOT</span><span class="o">&gt;</span>
<span class="p">[</span> <span class="mf">3213.091580</span><span class="p">]</span> <span class="o">---</span><span class="p">[</span> <span class="n">end</span> <span class="n">trace</span> <span class="mo">0000000000000000</span> <span class="p">]</span><span class="o">---</span>
<span class="hll"><span class="p">[</span> <span class="mf">3213.093250</span><span class="p">]</span> <span class="n">TRAP</span> <span class="n">do_general_protection</span> <span class="n">in</span> <span class="n">CPU7</span><span class="p">,</span> <span class="nl">error_code</span><span class="p">:</span> <span class="mi">0</span> <span class="nl">current</span><span class="p">:</span><span class="n">ffff88083fd0f008</span> <span class="mi">0</span> <span class="n">swapper</span><span class="o">/</span><span class="mi">7</span>
</span><span class="hll"><span class="p">[</span> <span class="mf">3213.096526</span><span class="p">]</span> <span class="n">fixup_exception</span> <span class="n">pid</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="n">cpu</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="nl">insn</span><span class="p">:</span><span class="mh">0xffffffff81000c62</span><span class="p">(</span><span class="n">__switch_to</span><span class="o">+</span><span class="mh">0x452</span><span class="o">/</span><span class="mh">0x630</span><span class="p">)</span> <span class="nl">fixup</span><span class="p">:</span><span class="mh">0xffffffff8105d922</span><span class="p">(</span><span class="n">__fixup_text_start</span><span class="o">+</span><span class="mh">0x32</span><span class="o">/</span><span class="mh">0x322</span><span class="p">)</span> <span class="nl">handler</span><span class="p">:</span><span class="n">ex_handler_default</span><span class="o">+</span><span class="mh">0x0</span><span class="o">/</span><span class="mh">0x20</span>
</span><span class="hll"><span class="p">[</span> <span class="mf">3213.101241</span><span class="p">]</span> <span class="o">------------</span><span class="p">[</span> <span class="n">cut</span> <span class="n">here</span> <span class="p">]</span><span class="o">------------</span>
</span><span class="hll"><span class="p">[</span> <span class="mf">3213.103285</span><span class="p">]</span> <span class="nl">WARNING</span><span class="p">:</span> <span class="nl">CPU</span><span class="p">:</span> <span class="mi">7</span> <span class="nl">PID</span><span class="p">:</span> <span class="mi">0</span> <span class="n">at</span> <span class="p">.</span><span class="o">/</span><span class="n">arch</span><span class="o">/</span><span class="n">x86</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="k">asm</span><span class="o">/</span><span class="n">fpu</span><span class="o">/</span><span class="n">internal</span><span class="p">.</span><span class="nl">h</span><span class="p">:</span><span class="mi">369</span> <span class="n">__switch_to</span><span class="o">+</span><span class="mh">0x47e</span><span class="o">/</span><span class="mh">0x630</span>
</span></pre></div>
</td></tr></table></p>
<p>So, dig into <code class="codehilite"><span class="n">fpu__copy</span><span class="p">()</span></code>, find out why it fails at this certain point. Glad I have something to dig into. <img alt="😏" class="emojione" src="https://cdn.jsdelivr.net/emojione/assets/svg/1f60f.svg" title=":smirk:" /></p>
<p>The instruction leads to GP is:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nl">ffffffff8100b0f5</span><span class="p">:</span>       <span class="mi">48</span> <span class="mf">0f</span> <span class="n">ae</span> <span class="mi">27</span>             <span class="n">xsave64</span> <span class="p">(</span><span class="o">%</span><span class="n">rdi</span><span class="p">)</span>
</pre></div>
</td></tr></table></p>
<p>which is generated by:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="cp">#define XSTATE_XSAVE(st, lmask, hmask, err)                             \</span>
<span class="cp">        asm volatile(ALTERNATIVE_2(XSAVE,                               \</span>
<span class="cp">                                   XSAVEOPT, X86_FEATURE_XSAVEOPT,      \</span>
<span class="cp">                                   XSAVES,   X86_FEATURE_XSAVES)        \</span>
<span class="cp">                     &quot;\n&quot;                                               \</span>
<span class="cp">                     &quot;xor %[err], %[err]\n&quot;                             \</span>
<span class="cp">                     &quot;3:\n&quot;                                             \</span>
<span class="cp">                     &quot;.pushsection .fixup,\&quot;ax\&quot;\n&quot;                     \</span>
<span class="cp">                     &quot;4: movl $-2, %[err]\n&quot;                            \</span>
<span class="cp">                     &quot;jmp 3b\n&quot;                                         \</span>
<span class="cp">                     &quot;.popsection\n&quot;                                    \</span>
<span class="cp">                     _ASM_EXTABLE(661b, 4b)                             \</span>
<span class="cp">                     : [err] &quot;=r&quot; (err)                                 \</span>
<span class="cp">                     : &quot;D&quot; (st), &quot;m&quot; (*st), &quot;a&quot; (lmask), &quot;d&quot; (hmask)    \</span>
<span class="cp">                     : &quot;memory&quot;)</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">copy_xregs_to_kernel</span><span class="p">(</span><span class="k">struct</span> <span class="n">xregs_state</span> <span class="o">*</span><span class="n">xstate</span><span class="p">)</span>
<span class="p">{</span>
        <span class="n">u64</span> <span class="n">mask</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="n">u32</span> <span class="n">lmask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">;</span>
        <span class="n">u32</span> <span class="n">hmask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

        <span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">alternatives_patched</span><span class="p">);</span>

        <span class="n">XSTATE_XSAVE</span><span class="p">(</span><span class="n">xstate</span><span class="p">,</span> <span class="n">lmask</span><span class="p">,</span> <span class="n">hmask</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

        <span class="cm">/* We should never fault when copying to a kernel buffer: */</span>
        <span class="n">WARN_ON_FPU</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></p>
<p>From SDM on <code class="codehilite"><span class="n">XSAVE</span></code>: <strong><mark>Use of a destination operand not aligned to 64-byte boundary (in either 64-bit or 32-bit modes) results in a general-protection (#GP) exception. In 64-bit mode, the upper 32 bits of RDX and RAX are ignored.</mark></strong></p>
<p><code class="codehilite"><span class="nf">%rdi</span></code> is <code class="codehilite"><span class="n">struct</span> <span class="n">xregs_state</span> <span class="o">*</span><span class="n">xstate</span></code> in above code. Thus, check if <code class="codehilite"><span class="n">xstate</span></code> if 64-bytes aligned. Of course, it is not:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="p">[</span><span class="mi">10894</span><span class="p">.</span><span class="mi">999997</span><span class="p">]</span> <span class="n">copy_xregs_to_kernel</span> <span class="n">CPU6</span> <span class="n">xstate</span><span class="p">:</span> <span class="n">ffff88083e4c8c38</span>
</pre></div>
</td></tr></table></p>
<p>Hehe. Criminal identified. But why? The xstate structure is already marked as <code class="codehilite"><span class="n">__attribute__</span><span class="p">(</span><span class="n">aliged</span> <span class="mi">64</span><span class="p">)</span></code> in the code. <mark>It is the task_struct</mark>, which is <strong>NOT</strong> 0x40 aligned. But god why? Because we currently use <code class="codehilite"><span class="n">kmalloc</span></code> to allocate new task_struct, whose minimum alignment is <code class="codehilite"><span class="mi">8</span> <span class="n">bytes</span></code>. Anyway, use <code class="codehilite"><span class="n">__alloc_pages</span></code> instead.</p>
<p>Such an deeply hidden bug. Took me almost a month to find out.</p>
<h3 id="ib">IB<a class="headerlink" href="#ib" title="Permanent link">&para;</a></h3>
<p>Seen this during boot (at both P and M, although lego continue running correctly):
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="p">[</span><span class="mf">54017.712533</span><span class="p">]</span> <span class="o">***</span>    <span class="n">NodeID</span>    <span class="n">Hostname</span>    <span class="n">LID</span>    <span class="n">QPN</span>
<span class="p">[</span><span class="mf">54017.770776</span><span class="p">]</span> <span class="o">***</span>    <span class="o">-------------------------------------</span>
<span class="p">[</span><span class="mf">54017.834220</span><span class="p">]</span> <span class="o">***</span>         <span class="mi">0</span>    <span class="n">wuklab12</span>     <span class="mi">13</span>     <span class="mi">72</span>
<span class="p">[</span><span class="mf">54017.892462</span><span class="p">]</span> <span class="o">***</span>         <span class="mi">1</span>    <span class="n">wuklab14</span>     <span class="mi">16</span>     <span class="mi">72</span> <span class="o">&lt;---</span>
<span class="p">[</span><span class="mf">54017.955906</span><span class="p">]</span> <span class="o">***</span>         <span class="mi">2</span>    <span class="n">wuklab16</span>     <span class="mi">20</span>     <span class="mi">74</span>
<span class="p">[</span><span class="mf">54018.014149</span><span class="p">]</span> <span class="o">***</span>
<span class="p">[</span><span class="mf">54074.552844</span><span class="p">]</span> <span class="o">***</span>  <span class="n">Start</span> <span class="n">establish</span> <span class="n">connection</span> <span class="p">(</span><span class="nl">mynodeid</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>
<span class="hll"><span class="p">[</span><span class="mf">54102.554407</span><span class="p">]</span> <span class="n">ib_process_mad</span> <span class="n">mad_ifc</span> <span class="n">fails</span>
</span><span class="p">[</span><span class="mf">54130.960691</span><span class="p">]</span> <span class="o">***</span>  <span class="n">recvpollcq</span> <span class="n">runs</span> <span class="n">on</span> <span class="n">CPU2</span>
<span class="p">[</span><span class="mf">54131.070918</span><span class="p">]</span> <span class="o">***</span>  <span class="n">Successfully</span> <span class="n">built</span> <span class="n">QP</span> <span class="k">for</span> <span class="n">node</span>  <span class="mi">0</span> <span class="p">[</span><span class="nl">LID</span><span class="p">:</span> <span class="mi">13</span> <span class="nl">QPN</span><span class="p">:</span> <span class="mi">72</span><span class="p">]</span>
<span class="p">[</span><span class="mf">54131.152936</span><span class="p">]</span> <span class="o">***</span>  <span class="n">Successfully</span> <span class="n">built</span> <span class="n">QP</span> <span class="k">for</span> <span class="n">node</span>  <span class="mi">2</span> <span class="p">[</span><span class="nl">LID</span><span class="p">:</span> <span class="mi">20</span> <span class="nl">QPN</span><span class="p">:</span> <span class="mi">74</span><span class="p">]</span>
<span class="p">[</span><span class="mf">54161.228245</span><span class="p">]</span> <span class="o">***</span>  <span class="n">FIT</span> <span class="n">layer</span> <span class="n">ready</span> <span class="n">to</span> <span class="n">go</span><span class="o">!</span>
<span class="p">[</span><span class="mf">54161.272034</span><span class="p">]</span> <span class="o">***</span>
</pre></div>
</td></tr></table>
Another one:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="p">[</span> <span class="mf">1966.930409</span><span class="p">]</span> <span class="o">***</span>
<span class="p">[</span> <span class="mf">1966.951210</span><span class="p">]</span> <span class="o">***</span>  <span class="nl">FIT_initial_timeout_s</span><span class="p">:</span>   <span class="mi">30</span>
<span class="p">[</span> <span class="mf">1967.002168</span><span class="p">]</span> <span class="o">***</span>  <span class="nl">FIT_local_id</span><span class="p">:</span>            <span class="mi">0</span>
<span class="p">[</span> <span class="mf">1967.052087</span><span class="p">]</span> <span class="o">***</span>
<span class="p">[</span> <span class="mf">1967.072887</span><span class="p">]</span> <span class="o">***</span>    <span class="n">NodeID</span>    <span class="n">Hostname</span>    <span class="n">LID</span>    <span class="n">QPN</span>
<span class="p">[</span> <span class="mf">1967.131126</span><span class="p">]</span> <span class="o">***</span>    <span class="o">-------------------------------------</span>
<span class="p">[</span> <span class="mf">1967.194567</span><span class="p">]</span> <span class="o">***</span>         <span class="mi">0</span>    <span class="n">wuklab12</span>     <span class="mi">13</span>     <span class="mi">72</span> <span class="o">&lt;---</span>
<span class="p">[</span> <span class="mf">1967.258005</span><span class="p">]</span> <span class="o">***</span>         <span class="mi">1</span>    <span class="n">wuklab14</span>     <span class="mi">16</span>     <span class="mi">72</span>
<span class="p">[</span> <span class="mf">1967.316244</span><span class="p">]</span> <span class="o">***</span>         <span class="mi">2</span>    <span class="n">wuklab16</span>     <span class="mi">20</span>     <span class="mi">74</span>
<span class="p">[</span> <span class="mf">1967.374484</span><span class="p">]</span> <span class="o">***</span>
<span class="p">[</span> <span class="mf">2032.926448</span><span class="p">]</span> <span class="o">***</span>  <span class="n">Start</span> <span class="n">establish</span> <span class="n">connection</span> <span class="p">(</span><span class="nl">mynodeid</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">[</span> <span class="mf">2032.996068</span><span class="p">]</span> <span class="n">Fail</span> <span class="n">to</span> <span class="n">modify</span> <span class="n">qp</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
<span class="p">[</span> <span class="mf">2033.032572</span><span class="p">]</span> <span class="n">Fail</span> <span class="n">to</span> <span class="k">do</span> <span class="n">client_init_ctx</span>
<span class="p">[</span> <span class="mf">2033.077287</span><span class="p">]</span> <span class="nl">client_establish_conn</span><span class="p">:</span> <span class="n">ctx</span>           <span class="p">(</span><span class="n">null</span><span class="p">)</span> <span class="n">fail</span> <span class="n">to</span> <span class="n">init_interface</span>
<span class="p">[</span> <span class="mf">2033.164646</span><span class="p">]</span> <span class="nl">ibapi_establish_conn</span><span class="p">:</span> <span class="n">ctx</span>           <span class="p">(</span><span class="n">null</span><span class="p">)</span> <span class="n">fail</span> <span class="n">to</span> <span class="n">init_interface</span>
<span class="p">[</span> <span class="mf">2033.250967</span><span class="p">]</span> <span class="o">***</span>
<span class="p">[</span> <span class="mf">2035.620167</span><span class="p">]</span> <span class="nl">BUG</span><span class="p">:</span> <span class="n">unable</span> <span class="n">to</span> <span class="n">handle</span> <span class="n">kernel</span> <span class="nb">NULL</span> <span class="n">pointer</span> <span class="n">dereference</span> <span class="n">at</span> <span class="mo">0000000000000004</span>
<span class="p">[</span> <span class="mf">2035.713763</span><span class="p">]</span> <span class="nl">IP</span><span class="p">:</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8105c589</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">client_send_reply_with_rdma_write_with_imm</span><span class="o">+</span><span class="mh">0x69</span><span class="o">/</span><span class="mh">0x3b0</span>
<span class="p">[</span> <span class="mf">2035.812562</span><span class="p">]</span> <span class="n">PGD</span> <span class="mi">0</span>
<span class="p">[</span> <span class="mf">2035.836482</span><span class="p">]</span> <span class="nl">Oops</span><span class="p">:</span> <span class="mo">0002</span> <span class="p">[</span><span class="err">#</span><span class="mi">1</span><span class="p">]</span> <span class="n">SMP</span> <span class="n">PROCESSOR</span>
<span class="p">[</span> <span class="mf">2035.884321</span><span class="p">]</span> <span class="nl">CPU</span><span class="p">:</span> <span class="mi">0</span> <span class="nl">PID</span><span class="p">:</span> <span class="mi">1</span> <span class="nl">Comm</span><span class="p">:</span> <span class="n">kernel_init</span> <span class="mf">4.0.0</span><span class="o">-</span><span class="n">lego</span><span class="o">-</span><span class="n">ys</span><span class="o">+</span> <span class="err">#</span><span class="mi">253</span>
<span class="p">[</span> <span class="mf">2035.955041</span><span class="p">]</span> <span class="nl">RIP</span><span class="p">:</span> <span class="mo">0010</span><span class="o">:</span><span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8105c589</span><span class="o">&gt;</span><span class="p">]</span>  <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8105c589</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">client_send_reply_with_rdma_write_with_imm</span><span class="o">+</span><span class="mh">0x69</span><span class="o">/</span><span class="mh">0x3b0</span>
<span class="p">...</span>
<span class="p">[</span> <span class="mf">2037.313267</span><span class="p">]</span> <span class="o">&lt;</span><span class="n">TSK</span><span class="o">&gt;</span>
<span class="p">[</span> <span class="mf">2037.336146</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8105a377</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">ibapi_send_reply_timeout</span><span class="o">+</span><span class="mh">0x57</span><span class="o">/</span><span class="mh">0x70</span>
<span class="p">[</span> <span class="mf">2037.411025</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81033d24</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">net_send_reply_timeout</span><span class="o">+</span><span class="mh">0x94</span><span class="o">/</span><span class="mh">0x132</span>
<span class="p">[</span> <span class="mf">2037.486944</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81033d24</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">net_send_reply_timeout</span><span class="o">+</span><span class="mh">0x94</span><span class="o">/</span><span class="mh">0x132</span>
</pre></div>
</td></tr></table></p>
<h3 id="pcache">pcache<a class="headerlink" href="#pcache" title="Permanent link">&para;</a></h3>
<p>Running word_count-pthread, with 100MB dataset, finally got some reasonable bug:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="p">[</span><span class="mf">54211.243181</span><span class="p">]</span> <span class="n">pcache_evict_line</span><span class="p">()</span><span class="o">:</span> <span class="nl">pset</span><span class="p">:</span> <span class="n">ffff88207f86e3c0</span><span class="p">,</span> <span class="k">for</span> <span class="nl">uva</span><span class="p">:</span> <span class="mh">0x7ffff1b8f000</span>
<span class="p">[</span><span class="mf">54211.385654</span><span class="p">]</span> <span class="nl">pcache</span><span class="p">:</span><span class="n">ffff88207f86e3a8</span> <span class="nl">mapcount</span><span class="p">:</span><span class="mi">8</span> <span class="nl">refcount</span><span class="p">:</span><span class="mi">0</span> <span class="nl">flags</span><span class="p">:()</span>
<span class="p">[</span><span class="mf">54211.510447</span><span class="p">]</span> <span class="n">pcache</span> <span class="n">dumped</span> <span class="nl">because</span><span class="p">:</span> <span class="n">PCACHE_BUG_ON_PCM</span><span class="p">(</span><span class="o">!</span><span class="n">PcacheLocked</span><span class="p">(</span><span class="n">pcm</span><span class="p">))</span>
<span class="p">[</span><span class="mf">54212.080336</span><span class="p">]</span> <span class="nl">BUG</span><span class="p">:</span> <span class="n">failure</span> <span class="n">at</span> <span class="n">managers</span><span class="o">/</span><span class="n">processor</span><span class="o">/</span><span class="n">pcache</span><span class="o">/</span><span class="n">evict</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span><span class="mi">240</span><span class="o">/</span><span class="n">pcache_evict_line</span><span class="p">()</span><span class="o">!</span>
<span class="p">[</span><span class="mf">54212.664785</span><span class="p">]</span> <span class="n">Kernel</span> <span class="n">Panic</span> <span class="o">-</span> <span class="n">not</span> <span class="nl">syncing</span><span class="p">:</span> <span class="n">BUG</span><span class="o">!</span>
<span class="p">[</span><span class="mf">54212.715742</span><span class="p">]</span> <span class="nl">CPU</span><span class="p">:</span> <span class="mi">8</span> <span class="nl">PID</span><span class="p">:</span> <span class="mi">81</span> <span class="nl">Comm</span><span class="p">:</span> <span class="n">word_count</span><span class="o">-</span><span class="n">pthr</span> <span class="mf">4.0.0</span><span class="o">-</span><span class="n">lego</span><span class="o">-</span><span class="n">ys</span><span class="o">+</span> <span class="err">#</span><span class="mi">252</span>
<span class="p">...</span>
<span class="p">[</span><span class="mf">54213.391706</span><span class="p">]</span> <span class="o">&lt;</span><span class="n">TSK</span><span class="o">&gt;</span>
<span class="p">[</span><span class="mf">54213.414584</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81024180</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">panic</span><span class="o">+</span><span class="mh">0xc2</span><span class="o">/</span><span class="mh">0xeb</span>
<span class="p">[</span><span class="mf">54213.524818</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8101b81c</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">task_tick_rt</span><span class="o">+</span><span class="mh">0x2c</span><span class="o">/</span><span class="mh">0xd0</span>
<span class="p">[</span><span class="mf">54213.589295</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81018f75</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">scheduler_tick</span><span class="o">+</span><span class="mh">0x55</span><span class="o">/</span><span class="mh">0x60</span>
<span class="p">[</span><span class="mf">54213.655850</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81016625</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">tick_handle_periodic</span><span class="o">+</span><span class="mh">0x45</span><span class="o">/</span><span class="mh">0x70</span>
<span class="p">[</span><span class="mf">54213.728647</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81006634</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">apic_timer_interrupt</span><span class="o">+</span><span class="mh">0x54</span><span class="o">/</span><span class="mh">0x90</span>
<span class="p">[</span><span class="mf">54213.801443</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8100e22a</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">smp__apic_timer_interrupt</span><span class="o">+</span><span class="mh">0x6a</span><span class="o">/</span><span class="mh">0x70</span>
<span class="p">[</span><span class="mf">54213.879439</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8101256d</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">printk</span><span class="o">+</span><span class="mh">0x11d</span><span class="o">/</span><span class="mh">0x1b0</span>
<span class="p">[</span><span class="mf">54214.103027</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8102ecf4</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">pcache_evict_line</span><span class="o">+</span><span class="mh">0x134</span><span class="o">/</span><span class="mh">0x220</span>
<span class="p">[</span><span class="mf">54214.172703</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8102c6ae</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">pcache_alloc</span><span class="o">+</span><span class="mh">0x22e</span><span class="o">/</span><span class="mh">0x2e0</span>
<span class="p">[</span><span class="mf">54214.237179</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8102be0a</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">common_do_fill_page</span><span class="o">+</span><span class="mh">0x2a</span><span class="o">/</span><span class="mh">0x1f0</span>
<span class="p">[</span><span class="mf">54214.307895</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8102baf0</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">move_page_tables</span><span class="o">+</span><span class="mh">0x4c0</span><span class="o">/</span><span class="mh">0x4c0</span>
<span class="p">[</span><span class="mf">54214.378612</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8102c172</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">pcache_handle_fault</span><span class="o">+</span><span class="mh">0x1a2</span><span class="o">/</span><span class="mh">0x3a0</span>
<span class="p">[</span><span class="mf">54214.450367</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8100fc02</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">do_page_fault</span><span class="o">+</span><span class="mh">0xa2</span><span class="o">/</span><span class="mh">0x1a0</span>
<span class="p">[</span><span class="mf">54214.514843</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8100d85f</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">page_fault</span><span class="o">+</span><span class="mh">0x1f</span><span class="o">/</span><span class="mh">0x30</span>
<span class="p">[</span><span class="mf">54214.575161</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81034842</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">copy_user_enhanced_fast_string</span><span class="o">+</span><span class="mh">0x2</span><span class="o">/</span><span class="mh">0x10</span>
<span class="p">[</span><span class="mf">54214.657316</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81032368</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">seq_read</span><span class="o">+</span><span class="mh">0x248</span><span class="o">/</span><span class="mh">0x360</span>
<span class="p">[</span><span class="mf">54214.719714</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff810307af</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">sys_read</span><span class="o">+</span><span class="mh">0x3f</span><span class="o">/</span><span class="mh">0xc0</span>
<span class="p">[</span><span class="mf">54214.777949</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81030770</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">sweep_pset_lru</span><span class="o">+</span><span class="mh">0x220</span><span class="o">/</span><span class="mh">0x220</span>
<span class="p">[</span><span class="mf">54214.846587</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8100e619</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">do_syscall_64</span><span class="o">+</span><span class="mh">0x69</span><span class="o">/</span><span class="mh">0xf0</span>
<span class="p">[</span><span class="mf">54214.910022</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8100d4ec</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">entry_SYSCALL64_slow_path</span><span class="o">+</span><span class="mh">0x25</span><span class="o">/</span><span class="mh">0x25</span>
<span class="p">[</span><span class="mf">54214.985939</span><span class="p">]</span> <span class="o">&lt;</span><span class="n">EOT</span><span class="o">&gt;</span>
</pre></div>
</td></tr></table></p>
<p>Another one:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="p">[</span>  <span class="mf">735.393244</span><span class="p">]</span> <span class="n">pcache_evict_line</span><span class="p">()</span><span class="o">:</span> <span class="nl">pset</span><span class="p">:</span> <span class="n">ffff88207f86e3c0</span><span class="p">,</span> <span class="k">for</span> <span class="nl">uva</span><span class="p">:</span> <span class="mh">0x7ffff1b8fd90</span>
<span class="p">[</span>  <span class="mf">735.537804</span><span class="p">]</span> <span class="nl">pcache</span><span class="p">:</span><span class="n">ffff88207f86e3a8</span> <span class="nl">mapcount</span><span class="p">:</span><span class="mi">8</span> <span class="nl">refcount</span><span class="p">:</span><span class="mi">0</span> <span class="nl">flags</span><span class="p">:()</span>
<span class="p">[</span>  <span class="mf">735.663642</span><span class="p">]</span> <span class="n">pcache</span> <span class="n">dumped</span> <span class="nl">because</span><span class="p">:</span> <span class="n">PCACHE_BUG_ON_PCM</span><span class="p">(</span><span class="o">!</span><span class="n">PcacheLocked</span><span class="p">(</span><span class="n">pcm</span><span class="p">))</span>
</pre></div>
</td></tr></table></p>
<p>Do note this happens after computation. This happens when phoenix create a lot threads to sort the results.</p>
<p>Both bug happen to the same set, same user page. The pcache is clearly corrupted: <code class="codehilite"><span class="n">mapcount</span><span class="o">:</span><span class="mi">8</span><span class="o">,</span> <span class="n">refcount</span><span class="o">:</span><span class="mi">0</span><span class="o">,</span> <span class="n">flags</span><span class="o">:().</span></code></p>
<p>Come back after dinner.
Remember to check altenative, cause the XSAVE above should be XSAVEOPT. Make sure it does not override other memory. Also, check linker script. Do not forget to link any sections.</p>
<p>Another several bug logs in wuklab13 and wuklab15: <code class="codehilite"><span class="mi">022318</span><span class="o">-*</span></code>. I&rsquo;m really tired today after fixing the FPU bug. But I&rsquo;m also pretty confident pcache is something I&rsquo;m able to debug. Even thought it is hard in SMP case.</p>
<p>Anyway, I gonna call for the day.</p>
<hr />
<h2 id="0222-thur">02/22 Thur<a class="headerlink" href="#0222-thur" title="Permanent link">&para;</a></h2>
<ul>
<li><del class="critic">context switch fpu</del></li>
<li><del class="critic">signal compat check, all good.</del></li>
<li><del class="critic"> make <code class="codehilite"><span class="k">current</span></code> use percpu current_task, so all code in Lego is consistent.</del></li>
<li><del class="critic">checked <code class="codehilite"><span class="n">entry_SYSCALL</span><span class="o">-</span><span class="mi">64</span></code> again, which looks good to me.</del></li>
<li>The only concern is <code class="codehilite"><span class="n">rsp_scratch</span></code> and <code class="codehilite"><span class="n">current_top_of_stack</span></code>, which are per-cpu variables. If these per-cpu is setup wrong, then we are doomed.</li>
<li>Also check if per-cpu is all cleared up?</li>
<li>try big syscall lock</li>
<li>does x86 has to use different kernel stacks? Interrupt is using different stack in Linux, has to do so???</li>
<li>check current is correct. compare with old implementation.</li>
</ul>
<p>First of all, FPU is definitely functional for now.
Since I replaced the current macro today, I add some code to check if this current matches our old implementation:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nv">static</span> <span class="nv">__always_inline</span> <span class="nv">struct</span> <span class="nv">task_struct</span> <span class="o">*</span><span class="nv">get_current</span><span class="ss">(</span><span class="nv">void</span><span class="ss">)</span>                                                           
{                                                                                                                      
        <span class="k">return</span> <span class="nv">this_cpu_read_stable</span><span class="ss">(</span><span class="nv">current_task</span><span class="ss">)</span><span class="c1">;                                                                     </span>
}

<span class="o">//</span>#<span class="nv">define</span> <span class="nv">current</span> <span class="nv">get_current</span><span class="ss">()</span>

#<span class="nv">define</span> <span class="nv">current</span>                                                 \
<span class="ss">(</span>{                                                              \
        <span class="nv">struct</span> <span class="nv">task_struct</span> <span class="o">*</span><span class="nv">old</span> <span class="o">=</span> <span class="nv">current_thread_info</span><span class="ss">()</span><span class="o">-&gt;</span><span class="nv">task</span><span class="c1">;  \</span>
        <span class="nv">struct</span> <span class="nv">task_struct</span> <span class="o">*</span><span class="nv">new</span> <span class="o">=</span> <span class="nv">get_current</span><span class="ss">()</span><span class="c1">;                \</span>
                                                                \
        <span class="k">if</span> <span class="ss">(</span><span class="nv">old</span> <span class="o">!=</span> <span class="nv">new</span><span class="ss">)</span> {                                       \
                <span class="nv">printk</span><span class="ss">(</span><span class="s2">&quot;</span><span class="s">%s:%d() cpu:%d old:%pS %d %s new:%pS %d %s</span><span class="se">\n</span><span class="s2">&quot;</span>,  \
                        <span class="nv">__func__</span>, <span class="nv">__LINE__</span>, <span class="nv">smp_processor_id</span><span class="ss">()</span>, <span class="nv">old</span>, <span class="nv">old</span><span class="o">-&gt;</span><span class="nv">pid</span>, <span class="nv">old</span><span class="o">-&gt;</span><span class="nv">comm</span>, \
                        <span class="nv">new</span>, <span class="nv">new</span><span class="o">-&gt;</span><span class="nv">pid</span>, <span class="nv">new</span><span class="o">-&gt;</span><span class="nv">comm</span><span class="ss">)</span><span class="c1">;              \</span>
                <span class="nv">BUG</span><span class="ss">()</span><span class="c1">;                                          \</span>
        }                                                       \
        <span class="nv">get_current</span><span class="ss">()</span><span class="c1">;                                          \</span>
}<span class="ss">)</span>
</pre></div>
</td></tr></table></p>
<p>Combined with some FPU warning, it is now like this:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="hll"><span class="p">[</span> <span class="mf">3273.748819</span><span class="p">]</span> <span class="nl">CPU</span><span class="p">:</span><span class="mi">5</span> <span class="nl">PID</span><span class="p">:</span><span class="mi">32</span>   <span class="n">sys_clone</span><span class="o">+</span><span class="mh">0x0</span><span class="o">/</span><span class="mh">0x30</span>
</span><span class="p">[</span> <span class="mf">3273.800808</span><span class="p">]</span> <span class="nl">alloc_task_struct_node</span><span class="p">:</span> <span class="nl">size</span><span class="p">:</span><span class="mi">740</span> <span class="n">ffff88107e831838</span>
<span class="p">[</span> <span class="mf">3273.869451</span><span class="p">]</span> <span class="n">arch_dup_task_struct</span><span class="p">()</span> <span class="n">CPU5</span> <span class="nl">current</span><span class="p">:</span><span class="mi">32</span> <span class="nl">new</span><span class="p">:</span> <span class="n">ffff88107e831838</span> <span class="nl">old</span><span class="p">:</span> <span class="n">ffff88107e827838</span> <span class="mi">32</span>
<span class="p">[</span> <span class="mf">3273.975533</span><span class="p">]</span> <span class="o">------------</span><span class="p">[</span> <span class="n">cut</span> <span class="n">here</span> <span class="p">]</span><span class="o">------------</span>
<span class="hll"><span class="p">[</span> <span class="mf">3274.030651</span><span class="p">]</span> <span class="nl">WARNING</span><span class="p">:</span> <span class="nl">CPU</span><span class="p">:</span> <span class="mi">5</span> <span class="nl">PID</span><span class="p">:</span> <span class="mi">32</span> <span class="n">at</span> <span class="p">.</span><span class="o">/</span><span class="n">arch</span><span class="o">/</span><span class="n">x86</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="k">asm</span><span class="o">/</span><span class="n">fpu</span><span class="o">/</span><span class="n">internal</span><span class="p">.</span><span class="nl">h</span><span class="p">:</span><span class="mi">354</span> <span class="n">fpu__copy</span><span class="o">+</span><span class="mh">0xe2</span><span class="o">/</span><span class="mh">0x310</span>
</span><span class="p">[</span> <span class="mf">3274.140895</span><span class="p">]</span> <span class="nl">CPU</span><span class="p">:</span> <span class="mi">5</span> <span class="nl">PID</span><span class="p">:</span> <span class="mi">32</span> <span class="nl">Comm</span><span class="p">:</span> <span class="n">word_count</span><span class="o">-</span><span class="n">pthr</span> <span class="mf">4.0.0</span><span class="o">-</span><span class="n">lego</span><span class="o">-</span><span class="n">ys</span><span class="o">-</span><span class="n">gdbe6dbe</span><span class="o">-</span><span class="n">dirty</span> <span class="err">#</span><span class="mi">249</span>
<span class="p">[</span> <span class="mf">3274.231377</span><span class="p">]</span> <span class="nl">Stack</span><span class="p">:</span>
<span class="p">[</span> <span class="mf">3274.255298</span><span class="p">]</span> <span class="n">ffff88107e82fd68</span> <span class="n">ffffffff81016dbf</span> <span class="mf">00000000ff</span><span class="n">ffffff</span> <span class="mo">0000000000000000</span>
<span class="p">[</span> <span class="mf">3274.342659</span><span class="p">]</span> <span class="mf">00000000ff</span><span class="n">ffffff</span> <span class="mo">0000000000000000</span> <span class="n">ffff88107e831bf8</span> <span class="n">ffff88107e831c38</span>
<span class="p">[</span> <span class="mf">3274.430021</span><span class="p">]</span> <span class="n">ffff88107e831838</span> <span class="mf">000000207f</span><span class="n">e64000</span> <span class="n">ffff88107e82fd78</span> <span class="n">ffffffff810170af</span>
<span class="p">[</span> <span class="mf">3274.517382</span><span class="p">]</span> <span class="n">ffff88107e82fdc0</span> <span class="n">ffffffff8100b052</span> <span class="mo">0000000000000020</span> <span class="n">ffff88107e831838</span>
<span class="p">[</span> <span class="mf">3274.604745</span><span class="p">]</span> <span class="n">ffff88107e827838</span> <span class="n">ffff88107e827838</span> <span class="n">ffff88107e831838</span> <span class="n">ffff88107e827838</span>
<span class="p">[</span> <span class="mf">3274.692106</span><span class="p">]</span> <span class="n">Call</span> <span class="nl">Trace</span><span class="p">:</span>
<span class="p">[</span> <span class="mf">3274.721229</span><span class="p">]</span> <span class="o">&lt;</span><span class="n">TSK</span><span class="o">&gt;</span>
<span class="p">[</span> <span class="mf">3274.744109</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81016dd8</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">__warn</span><span class="p">.</span><span class="n">constprop</span><span class="mf">.0</span><span class="o">+</span><span class="mh">0xe8</span><span class="o">/</span><span class="mh">0x3b0</span>
<span class="p">[</span> <span class="mf">3274.813790</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff810170af</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">warn_slowpath_null</span><span class="o">+</span><span class="mh">0xf</span><span class="o">/</span><span class="mh">0x20</span>
<span class="p">[</span> <span class="mf">3274.881391</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8100b052</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">fpu__copy</span><span class="o">+</span><span class="mh">0xe2</span><span class="o">/</span><span class="mh">0x310</span>
<span class="p">[</span> <span class="mf">3274.941713</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff810012e4</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">arch_dup_task_struct</span><span class="o">+</span><span class="mh">0x84</span><span class="o">/</span><span class="mh">0x120</span>
<span class="p">[</span> <span class="mf">3275.013475</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81022c10</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">copy_process</span><span class="o">+</span><span class="mh">0x160</span><span class="o">/</span><span class="mh">0x1e60</span>
<span class="p">[</span> <span class="mf">3275.078996</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81024936</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">do_fork</span><span class="o">+</span><span class="mh">0x26</span><span class="o">/</span><span class="mh">0x140</span>
<span class="p">[</span> <span class="mf">3275.137238</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81024af0</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">sys_vfork</span><span class="o">+</span><span class="mh">0x40</span><span class="o">/</span><span class="mh">0x40</span>
<span class="p">[</span> <span class="mf">3275.198599</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81024af0</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">sys_vfork</span><span class="o">+</span><span class="mh">0x40</span><span class="o">/</span><span class="mh">0x40</span>
<span class="p">[</span> <span class="mf">3275.259960</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81024b19</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">sys_clone</span><span class="o">+</span><span class="mh">0x29</span><span class="o">/</span><span class="mh">0x30</span>
<span class="p">[</span> <span class="mf">3275.319242</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81012314</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">do_syscall_64</span><span class="o">+</span><span class="mh">0x84</span><span class="o">/</span><span class="mh">0x240</span>
<span class="p">[</span> <span class="mf">3275.383723</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8101106c</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">entry_SYSCALL64_slow_path</span><span class="o">+</span><span class="mh">0x25</span><span class="o">/</span><span class="mh">0x25</span>
<span class="p">[</span> <span class="mf">3275.459645</span><span class="p">]</span> <span class="o">&lt;</span><span class="n">EOT</span><span class="o">&gt;</span>
<span class="p">[</span> <span class="mf">3275.482526</span><span class="p">]</span> <span class="o">---</span><span class="p">[</span> <span class="n">end</span> <span class="n">trace</span> <span class="mo">0000000000000000</span> <span class="p">]</span><span class="o">---</span>
<span class="hll"><span class="p">[</span> <span class="mf">3275.537648</span><span class="p">]</span> <span class="n">wake_up_new_task</span> <span class="n">CPU5</span> <span class="nl">task</span><span class="p">:</span><span class="n">ffff88107e831838</span><span class="p">,</span> <span class="nl">dest_cpu</span><span class="p">:</span><span class="mi">6</span> <span class="nl">current</span><span class="p">:</span><span class="mi">32</span>
</span><span class="hll"><span class="p">[</span> <span class="mf">3275.623970</span><span class="p">]</span> <span class="n">SMP</span> <span class="nl">IPI</span><span class="p">:</span> <span class="n">reschedule_interrupt</span><span class="p">()</span> <span class="n">CPU</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="n">PID</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class="hll"><span class="p">[</span> <span class="mf">3275.739412</span><span class="p">]</span> <span class="nl">do_general_protection</span><span class="p">:</span><span class="mi">186</span><span class="p">()</span> <span class="nl">cpu</span><span class="p">:</span><span class="mi">6</span> <span class="nl">old</span><span class="p">:</span><span class="mh">0xffff88107e831838</span> <span class="mi">33</span> <span class="n">word_count</span><span class="o">-</span><span class="n">pthr</span> <span class="nl">new</span><span class="p">:</span><span class="mh">0xffff88107fcaf008</span> <span class="mi">0</span> <span class="n">swapper</span><span class="o">/</span><span class="mi">6</span>
</span>
<span class="p">[</span> <span class="mf">3275.871493</span><span class="p">]</span> <span class="o">------------</span><span class="p">[</span> <span class="n">cut</span> <span class="n">here</span> <span class="p">]</span><span class="o">------------</span>
<span class="p">[</span> <span class="mf">3275.926614</span><span class="p">]</span> <span class="nl">BUG</span><span class="p">:</span> <span class="n">failure</span> <span class="n">at</span> <span class="n">arch</span><span class="o">/</span><span class="n">x86</span><span class="o">/</span><span class="n">kernel</span><span class="o">/</span><span class="n">traps</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span><span class="mi">186</span><span class="o">/</span><span class="n">do_general_protection</span><span class="p">()</span><span class="o">!</span>
<span class="p">[</span> <span class="mf">3276.015018</span><span class="p">]</span> <span class="n">Kernel</span> <span class="n">Panic</span> <span class="o">-</span> <span class="n">not</span> <span class="nl">syncing</span><span class="p">:</span> <span class="n">BUG</span><span class="o">!</span>
<span class="p">[</span> <span class="mf">3276.065978</span><span class="p">]</span> <span class="nl">panic</span><span class="p">:</span><span class="mi">107</span><span class="p">()</span> <span class="nl">cpu</span><span class="p">:</span><span class="mi">6</span> <span class="nl">old</span><span class="p">:</span><span class="mh">0xffff88107e831838</span> <span class="mi">33</span> <span class="n">word_count</span><span class="o">-</span><span class="n">pthr</span> <span class="nl">new</span><span class="p">:</span><span class="mh">0xffff88107fcaf008</span> <span class="mi">0</span> <span class="n">swapper</span><span class="o">/</span><span class="mi">6</span>
</pre></div>
</td></tr></table></p>
<p>Based on the switch code:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">__switch_to</span><span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">prev_p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">next_p</span><span class="p">)</span>
<span class="p">{</span>
        <span class="n">this_cpu_write</span><span class="p">(</span><span class="n">current_task</span><span class="p">,</span> <span class="n">next_p</span><span class="p">);</span>

        <span class="cm">/* Reload sp0 This changes current_thread_info(). */</span>
        <span class="n">load_sp0</span><span class="p">(</span><span class="n">tss</span><span class="p">,</span> <span class="n">next</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></p>
<p>Based on log line 30, <code class="codehilite"><span class="n">load_sp0</span><span class="p">()</span></code> already happened, which means <code class="codehilite"><span class="n">this_cpu_write</span><span class="p">(..)</span></code> happened too. If <code class="codehilite"><span class="n">this_cpu_write</span><span class="p">(..)</span></code> happened, then log line 30&rsquo;s new should have been updated to <code class="codehilite"><span class="mi">0</span><span class="n">xffff88107e831838</span></code>. Something wrong with percpu?</p>
<hr />
<h2 id="0221-wed">02/21 Wed<a class="headerlink" href="#0221-wed" title="Permanent link">&para;</a></h2>
<ul>
<li>irq_regs, old code, check</li>
<li>signal frame, and fpu hook together Done</li>
<li><code class="codehilite"><span class="n">in_interrupt</span><span class="p">()</span></code>, it is empty, TODO</li>
<li>check arch/x86/Makefile, it introduce a lot FPU flags.</li>
<li>added more than 4K lines today. Damn FPU. Ugh go home sleep.</li>
</ul>
<hr />
<h2 id="0220-tue-cloudy">02/20 Tue Cloudy<a class="headerlink" href="#0220-tue-cloudy" title="Permanent link">&para;</a></h2>
<p>Not too many Sunny days recently. Well, continue yesterday&rsquo;s work. I don&rsquo;t think I can easily find out why so many <code class="codehilite"><span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="n">memoinfo</span></code> open happened. Instead, I&rsquo;m trying to enable the <code class="codehilite"><span class="n">flush_thread</span></code> in P&rsquo;s exec code.</p>
<p>During the way, I found some issue related to <code class="codehilite"><span class="n">__ARCH_HAS_SA_RESTORER</span></code> in signal code. I need to check if these x86 macros are defined, but lego does not port them.</p>
<p>Well, it turns out flush_thread does not make too much difference. Next I&rsquo;m going to try to disable <code class="codehilite"><span class="n">exit_thread</span></code>, which uses <code class="codehilite"><span class="n">fpu__drop</span><span class="p">()</span></code>.</p>
<p>Hmm, disable <code class="codehilite"><span class="n">exit_thread</span></code> also does not work.</p>
<hr />
<h2 id="0219-mon-rainy">02/19 Mon Rainy<a class="headerlink" href="#0219-mon-rainy" title="Permanent link">&para;</a></h2>
<p>It is another week. I can not deny I&rsquo;m a little tired about the bug. Tried so many possible solutions, but none of them work. Well, today I first need to test the vma changes (pgoff and anon_vma) thing. Especially the vma merge and split.</p>
<p>This morning I fixed a bug in kernel_init process: make kernel_init able to run all possible CPUs. Because the first user process is forked from kernel_init, it is quite important that it gets the right cpu affinity:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="k">static</span> <span class="kt">int</span> <span class="nf">kernel_init</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
        <span class="p">...</span>
        <span class="n">set_cpus_allowed_ptr</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">cpu_possible_mask</span><span class="p">);</span>
        <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></p>
<p>Well, interestingly, the unmodified word_count-pthread succeed with 50MB dataset&hellip; with or without any DEBUG option! Amazing! I need to find out why the cpus_allowed becomes 0 at the beginning of kernel_init. Because <code class="codehilite"><span class="n">init_task</span></code> actually has:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>    <span class="p">.</span><span class="n">cpus_allowed</span>   <span class="o">=</span> <span class="n">CPU_MASK_ALL</span><span class="p">,</span>
    <span class="p">.</span><span class="n">nr_cpus_allowed</span><span class="o">=</span> <span class="n">NR_CPUS</span><span class="p">,</span>
</pre></div>
</td></tr></table></p>
<p>Things to do next:</p>
<ul>
<li>check why the cpus_allowed changed</li>
<li>check why word_count-pthread open <code class="codehilite"><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="n">cpu</span></code> so many times. Anything wrong with our <code class="codehilite"><span class="n">copy_files</span></code>, or open, close?</li>
<li>here is an idea, to verify if FPU code is correct, run some scientific benchmarks.</li>
</ul>
<p>Okay, findings:</p>
<ul>
<li>
<p>cpus_allowd is fine, it is reset inside <code class="codehilite"><span class="n">sched_init</span><span class="p">()</span></code>, when it tries make the <code class="codehilite"><span class="n">init_task</span></code> as the <code class="codehilite"><span class="n">idle</span></code> thread. Thus it is reasonable to set cpus_allowed again at <code class="codehilite"><span class="n">kernel_init</span></code> thread. And it should NOTHING to do with the bug.</p>
</li>
<li>
<p>about the second, check the following log:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="p">[</span><span class="mf">11838.364543</span><span class="p">]</span> <span class="nl">STDOUT</span><span class="p">:</span> <span class="o">---</span><span class="p">[</span>
<span class="nl">Wordcount</span><span class="p">:</span> <span class="n">Running</span><span class="p">...</span>
<span class="p">]</span><span class="o">---</span>
<span class="p">[</span><span class="mf">11838.422886</span><span class="p">]</span> <span class="nl">STDOUT</span><span class="p">:</span> <span class="o">---</span><span class="p">[</span>


<span class="p">]</span><span class="o">---</span>
<span class="p">[</span><span class="mf">11838.463445</span><span class="p">]</span> <span class="n">SYSC_open</span><span class="p">(</span><span class="n">cpu5</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span><span class="p">)</span><span class="o">:</span> <span class="nl">f_name</span><span class="p">:</span> <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">ys</span><span class="o">/</span><span class="n">phoenix</span><span class="o">/</span><span class="n">phoenix</span><span class="o">-</span><span class="mf">2.0</span><span class="o">/</span><span class="n">tests</span><span class="o">/</span><span class="n">word_count</span><span class="o">/</span><span class="n">word_count_datafiles</span><span class="o">/</span><span class="n">word_50MB</span><span class="p">.</span><span class="n">txt</span><span class="p">,</span> <span class="nl">flags</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nl">mode</span><span class="p">:</span> <span class="mi">900</span>
<span class="p">[</span><span class="mf">11838.619460</span><span class="p">]</span> <span class="n">SYSC_open</span><span class="p">(</span><span class="n">cpu5</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span><span class="p">)</span><span class="o">:</span> <span class="nl">fd</span><span class="p">:</span> <span class="mi">3</span>
<span class="p">[</span><span class="mf">11838.667406</span><span class="p">]</span> <span class="n">SYSC_open</span><span class="p">(</span><span class="n">cpu5</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span><span class="p">)</span><span class="o">:</span> <span class="nl">f_name</span><span class="p">:</span> <span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">devices</span><span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">cpu</span><span class="o">/</span><span class="n">online</span><span class="p">,</span> <span class="nl">flags</span><span class="p">:</span> <span class="mi">80000</span><span class="p">,</span> <span class="nl">mode</span><span class="p">:</span> <span class="mi">0</span>
<span class="p">[</span><span class="mf">11838.773351</span><span class="p">]</span> <span class="n">SYSC_open</span><span class="p">(</span><span class="n">cpu5</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span><span class="p">)</span><span class="o">:</span> <span class="nl">fd</span><span class="p">:</span> <span class="mi">4</span>
<span class="p">[</span><span class="mf">11838.821239</span><span class="p">]</span> <span class="nl">seq_file</span><span class="p">:</span>
  <span class="nl">dest_uva</span><span class="p">:</span> <span class="mf">00007ff</span><span class="n">fffffc8d0</span><span class="p">,</span> <span class="nl">nr_chars</span><span class="p">:</span> <span class="mi">5</span>
  <span class="nl">string</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="o">-</span><span class="mi">23</span>
<span class="p">]</span>
<span class="p">[</span><span class="mf">11838.913791</span><span class="p">]</span> <span class="n">SYSC_close</span><span class="p">(</span><span class="n">cpu5</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span><span class="p">)</span><span class="o">:</span> <span class="nl">fd</span><span class="p">:</span> <span class="mi">4</span>
<span class="p">[</span><span class="mf">11838.962622</span><span class="p">]</span> <span class="n">SYSC_close</span><span class="p">()</span><span class="o">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">devices</span><span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">cpu</span><span class="o">/</span><span class="n">online</span><span class="p">]</span>
<span class="p">[</span><span class="mf">11840.223255</span><span class="p">]</span> <span class="nl">STDOUT</span><span class="p">:</span> <span class="o">---</span><span class="p">[</span>
<span class="n">Word</span> <span class="nl">Count</span><span class="p">:</span> <span class="n">Computation</span> <span class="n">Completed</span> <span class="mf">1.555581</span> <span class="n">sec</span>

<span class="p">]</span><span class="o">---</span>
<span class="p">[</span><span class="mf">11840.309678</span><span class="p">]</span> <span class="n">SYSC_open</span><span class="p">(</span><span class="n">cpu5</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span><span class="p">)</span><span class="o">:</span> <span class="nl">f_name</span><span class="p">:</span> <span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">devices</span><span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">cpu</span><span class="o">/</span><span class="n">online</span><span class="p">,</span> <span class="nl">flags</span><span class="p">:</span> <span class="mi">80000</span><span class="p">,</span> <span class="nl">mode</span><span class="p">:</span> <span class="mi">0</span>
<span class="p">[</span><span class="mf">11840.415754</span><span class="p">]</span> <span class="n">SYSC_open</span><span class="p">(</span><span class="n">cpu5</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span><span class="p">)</span><span class="o">:</span> <span class="nl">fd</span><span class="p">:</span> <span class="mi">4</span>
<span class="p">[</span><span class="mf">11840.463593</span><span class="p">]</span> <span class="nl">seq_file</span><span class="p">:</span>
  <span class="nl">dest_uva</span><span class="p">:</span> <span class="mf">00007ff</span><span class="n">fffffc8a0</span><span class="p">,</span> <span class="nl">nr_chars</span><span class="p">:</span> <span class="mi">5</span>
  <span class="nl">string</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="o">-</span><span class="mi">23</span>
<span class="p">]</span>
<span class="p">[</span><span class="mf">11840.556147</span><span class="p">]</span> <span class="n">SYSC_close</span><span class="p">(</span><span class="n">cpu5</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">32</span><span class="p">)</span><span class="o">:</span> <span class="nl">fd</span><span class="p">:</span> <span class="mi">4</span>
<span class="p">[</span><span class="mf">11840.605024</span><span class="p">]</span> <span class="n">SYSC_close</span><span class="p">()</span><span class="o">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">devices</span><span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">cpu</span><span class="o">/</span><span class="n">online</span><span class="p">]</span>
<span class="p">[</span><span class="mf">11840.677821</span><span class="p">]</span> <span class="nl">STDOUT</span><span class="p">:</span> <span class="o">---</span><span class="p">[</span>
<span class="n">THe</span> <span class="n">number</span> <span class="n">of</span> <span class="n">processors</span> <span class="n">is</span> <span class="mi">24</span>

<span class="err">ô</span>
<span class="p">]</span><span class="o">---</span>
<span class="hll"><span class="p">[</span><span class="mf">11840.753769</span><span class="p">]</span> <span class="n">SYSC_open</span><span class="p">(</span><span class="n">cpu7</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">80</span><span class="p">)</span><span class="o">:</span> <span class="nl">f_name</span><span class="p">:</span> <span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="n">meminfo</span><span class="p">,</span> <span class="nl">flags</span><span class="p">:</span> <span class="mi">80000</span><span class="p">,</span> <span class="nl">mode</span><span class="p">:</span> <span class="mi">1</span><span class="n">b6</span>
</span><span class="hll"><span class="p">[</span><span class="mf">11840.844212</span><span class="p">]</span> <span class="n">SYSC_open</span><span class="p">(</span><span class="n">cpu19</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">92</span><span class="p">)</span><span class="o">:</span> <span class="nl">f_name</span><span class="p">:</span> <span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="n">meminfo</span><span class="p">,</span> <span class="nl">flags</span><span class="p">:</span> <span class="mi">80000</span><span class="p">,</span> <span class="nl">mode</span><span class="p">:</span> <span class="mi">1</span><span class="n">b6</span>
</span><span class="p">[</span><span class="mf">11840.935728</span><span class="p">]</span> <span class="n">SYSC_open</span><span class="p">(</span><span class="n">cpu7</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">80</span><span class="p">)</span><span class="o">:</span> <span class="nl">fd</span><span class="p">:</span> <span class="mi">4</span>
<span class="p">[</span><span class="mf">11840.983567</span><span class="p">]</span> <span class="n">SYSC_open</span><span class="p">(</span><span class="n">cpu19</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">92</span><span class="p">)</span><span class="o">:</span> <span class="nl">fd</span><span class="p">:</span> <span class="mi">5</span>
<span class="p">[</span><span class="mf">11841.032444</span><span class="p">]</span> <span class="nl">seq_file</span><span class="p">:</span>
  <span class="nl">dest_uva</span><span class="p">:</span> <span class="mf">00007ff</span><span class="n">ff444c000</span><span class="p">,</span> <span class="nl">nr_chars</span><span class="p">:</span> <span class="mi">172</span>
  <span class="nl">string</span><span class="p">:</span> <span class="p">[</span><span class="nl">MemTotal</span><span class="p">:</span>       <span class="mi">115355128</span> <span class="n">kB</span>
<span class="nl">MemFree</span><span class="p">:</span>        <span class="mi">115355128</span> <span class="n">kB</span>
<span class="nl">MemAvailable</span><span class="p">:</span>   <span class="mi">115355128</span> <span class="n">kB</span>
<span class="nl">DirectMap4k</span><span class="p">:</span>        <span class="mi">5812</span> <span class="n">kB</span>
<span class="nl">DirectMap2M</span><span class="p">:</span>     <span class="mi">1861632</span> <span class="n">kB</span>
<span class="nl">DirectMap1G</span><span class="p">:</span>    <span class="mi">134217728</span> <span class="n">kB</span>
<span class="p">]</span>
<span class="p">[</span><span class="mf">11841.305953</span><span class="p">]</span> <span class="nl">seq_file</span><span class="p">:</span>
  <span class="nl">dest_uva</span><span class="p">:</span> <span class="mf">00007ff</span><span class="n">ff444b000</span><span class="p">,</span> <span class="nl">nr_chars</span><span class="p">:</span> <span class="mi">172</span>
  <span class="nl">string</span><span class="p">:</span> <span class="p">[</span><span class="nl">MemTotal</span><span class="p">:</span>       <span class="mi">115355128</span> <span class="n">kB</span>
<span class="nl">MemFree</span><span class="p">:</span>        <span class="mi">115355128</span> <span class="n">kB</span>
<span class="nl">MemAvailable</span><span class="p">:</span>   <span class="mi">115355128</span> <span class="n">kB</span>
<span class="nl">DirectMap4k</span><span class="p">:</span>        <span class="mi">5812</span> <span class="n">kB</span>
<span class="nl">DirectMap2M</span><span class="p">:</span>     <span class="mi">1861632</span> <span class="n">kB</span>
<span class="nl">DirectMap1G</span><span class="p">:</span>    <span class="mi">134217728</span> <span class="n">kB</span>
<span class="p">]</span>
<span class="p">[</span><span class="mf">11841.579460</span><span class="p">]</span> <span class="n">SYSC_close</span><span class="p">(</span><span class="n">cpu7</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">80</span><span class="p">)</span><span class="o">:</span> <span class="nl">fd</span><span class="p">:</span> <span class="mi">4</span>
<span class="p">[</span><span class="mf">11841.628339</span><span class="p">]</span> <span class="n">SYSC_close</span><span class="p">(</span><span class="n">cpu19</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">92</span><span class="p">)</span><span class="o">:</span> <span class="nl">fd</span><span class="p">:</span> <span class="mi">5</span>
<span class="p">[</span><span class="mf">11841.678257</span><span class="p">]</span> <span class="n">SYSC_close</span><span class="p">()</span><span class="o">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="n">meminfo</span><span class="p">]</span>
<span class="p">[</span><span class="mf">11841.733375</span><span class="p">]</span> <span class="n">SYSC_close</span><span class="p">()</span><span class="o">:</span> <span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="n">meminfo</span><span class="p">]</span>
<span class="hll"><span class="p">[</span><span class="mf">11841.788493</span><span class="p">]</span> <span class="n">SYSC_open</span><span class="p">(</span><span class="n">cpu18</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">91</span><span class="p">)</span><span class="o">:</span> <span class="nl">f_name</span><span class="p">:</span> <span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="n">meminfo</span><span class="p">,</span> <span class="nl">flags</span><span class="p">:</span> <span class="mi">80000</span><span class="p">,</span> <span class="nl">mode</span><span class="p">:</span> <span class="mi">1</span><span class="n">b6</span>
</span><span class="hll"><span class="p">[</span><span class="mf">11841.880008</span><span class="p">]</span> <span class="n">SYSC_open</span><span class="p">(</span><span class="n">cpu6</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">102</span><span class="p">)</span><span class="o">:</span> <span class="nl">f_name</span><span class="p">:</span> <span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="n">meminfo</span><span class="p">,</span> <span class="nl">flags</span><span class="p">:</span> <span class="mi">80000</span><span class="p">,</span> <span class="nl">mode</span><span class="p">:</span> <span class="mi">1</span><span class="n">b6</span>
</span><span class="hll"><span class="p">[</span><span class="mf">11841.971523</span><span class="p">]</span> <span class="n">SYSC_open</span><span class="p">(</span><span class="n">cpu12</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">85</span><span class="p">)</span><span class="o">:</span> <span class="nl">f_name</span><span class="p">:</span> <span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="n">meminfo</span><span class="p">,</span> <span class="nl">flags</span><span class="p">:</span> <span class="mi">80000</span><span class="p">,</span> <span class="nl">mode</span><span class="p">:</span> <span class="mi">1</span><span class="n">b6</span>
</span><span class="hll"><span class="p">[</span><span class="mf">11842.063040</span><span class="p">]</span> <span class="n">SYSC_open</span><span class="p">(</span><span class="n">cpu0</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">97</span><span class="p">)</span><span class="o">:</span> <span class="nl">f_name</span><span class="p">:</span> <span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="n">meminfo</span><span class="p">,</span> <span class="nl">flags</span><span class="p">:</span> <span class="mi">80000</span><span class="p">,</span> <span class="nl">mode</span><span class="p">:</span> <span class="mi">1</span><span class="n">b6</span>
</span><span class="hll"><span class="p">[</span><span class="mf">11842.153516</span><span class="p">]</span> <span class="n">SYSC_open</span><span class="p">(</span><span class="n">cpu14</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">87</span><span class="p">)</span><span class="o">:</span> <span class="nl">f_name</span><span class="p">:</span> <span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="n">meminfo</span><span class="p">,</span> <span class="nl">flags</span><span class="p">:</span> <span class="mi">80000</span><span class="p">,</span> <span class="nl">mode</span><span class="p">:</span> <span class="mi">1</span><span class="n">b6</span>
</span><span class="hll"><span class="p">[</span><span class="mf">11842.245032</span><span class="p">]</span> <span class="n">SYSC_open</span><span class="p">(</span><span class="n">cpu16</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">89</span><span class="p">)</span><span class="o">:</span> <span class="nl">f_name</span><span class="p">:</span> <span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="n">meminfo</span><span class="p">,</span> <span class="nl">flags</span><span class="p">:</span> <span class="mi">80000</span><span class="p">,</span> <span class="nl">mode</span><span class="p">:</span> <span class="mi">1</span><span class="n">b6</span>
</span><span class="hll"><span class="p">[</span><span class="mf">11842.336548</span><span class="p">]</span> <span class="n">SYSC_open</span><span class="p">(</span><span class="n">cpu4</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">100</span><span class="p">)</span><span class="o">:</span> <span class="nl">f_name</span><span class="p">:</span> <span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="n">meminfo</span><span class="p">,</span> <span class="nl">flags</span><span class="p">:</span> <span class="mi">80000</span><span class="p">,</span> <span class="nl">mode</span><span class="p">:</span> <span class="mi">1</span><span class="n">b6</span>
</span><span class="p">[</span><span class="mf">11842.428064</span><span class="p">]</span> <span class="n">SYSC_open</span><span class="p">(</span><span class="n">cpu16</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">89</span><span class="p">)</span><span class="o">:</span> <span class="nl">fd</span><span class="p">:</span> <span class="mi">9</span>
<span class="p">[</span><span class="mf">11842.476942</span><span class="p">]</span> <span class="n">SYSC_open</span><span class="p">(</span><span class="n">cpu4</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">100</span><span class="p">)</span><span class="o">:</span> <span class="nl">fd</span><span class="p">:</span> <span class="mi">10</span>
<span class="p">[</span><span class="mf">11842.526860</span><span class="p">]</span> <span class="nl">seq_file</span><span class="p">:</span>
  <span class="nl">dest_uva</span><span class="p">:</span> <span class="mf">00007ff</span><span class="n">ff444c000</span><span class="p">,</span> <span class="nl">nr_chars</span><span class="p">:</span> <span class="mi">172</span>
  <span class="nl">string</span><span class="p">:</span> <span class="p">[</span><span class="nl">MemTotal</span><span class="p">:</span>       <span class="mi">115355128</span> <span class="n">kB</span>
<span class="nl">MemFree</span><span class="p">:</span>        <span class="mi">115355128</span> <span class="n">kB</span>
<span class="nl">MemAvailable</span><span class="p">:</span>   <span class="mi">115355128</span> <span class="n">kB</span>
<span class="nl">DirectMap4k</span><span class="p">:</span>        <span class="mi">5812</span> <span class="n">kB</span>
<span class="nl">DirectMap2M</span><span class="p">:</span>     <span class="mi">1861632</span> <span class="n">kB</span>
<span class="nl">DirectMap1G</span><span class="p">:</span>    <span class="mi">134217728</span> <span class="n">kB</span>
<span class="p">]</span>
<span class="p">[</span><span class="mf">11842.800368</span><span class="p">]</span> <span class="nl">seq_file</span><span class="p">:</span>
  <span class="nl">dest_uva</span><span class="p">:</span> <span class="mf">00007ff</span><span class="n">ff444b000</span><span class="p">,</span> <span class="nl">nr_chars</span><span class="p">:</span> <span class="mi">172</span>
  <span class="nl">string</span><span class="p">:</span> <span class="p">[</span><span class="nl">MemTotal</span><span class="p">:</span>       <span class="mi">115355128</span> <span class="n">kB</span>
<span class="nl">MemFree</span><span class="p">:</span>        <span class="mi">115355128</span> <span class="n">kB</span>
<span class="nl">MemAvailable</span><span class="p">:</span>   <span class="mi">115355128</span> <span class="n">kB</span>
<span class="nl">DirectMap4k</span><span class="p">:</span>        <span class="mi">5812</span> <span class="n">kB</span>
<span class="nl">DirectMap2M</span><span class="p">:</span>     <span class="mi">1861632</span> <span class="n">kB</span>
<span class="nl">DirectMap1G</span><span class="p">:</span>    <span class="mi">134217728</span> <span class="n">kB</span>
<span class="p">]</span>
<span class="p">[</span><span class="mf">11843.073877</span><span class="p">]</span> <span class="n">SYSC_close</span><span class="p">(</span><span class="n">cpu16</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">89</span><span class="p">)</span><span class="o">:</span> <span class="nl">fd</span><span class="p">:</span> <span class="mi">9</span>
</pre></div>
</td></tr></table></p>
</li>
<li>
<p>However, in a normal Linux exeution:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">strace</span> <span class="o">-</span><span class="n">C</span> <span class="o">-</span><span class="n">o</span> <span class="n">strace_2</span> <span class="p">.</span><span class="o">/</span><span class="n">word_count</span><span class="o">-</span><span class="n">pthread</span> <span class="p">.</span><span class="o">/</span><span class="n">word_count_datafiles</span><span class="o">/</span><span class="n">word_50MB</span><span class="p">.</span><span class="n">txt</span>

<span class="o">%</span> <span class="n">time</span>     <span class="n">seconds</span>  <span class="n">usecs</span><span class="o">/</span><span class="n">call</span>     <span class="n">calls</span>    <span class="n">errors</span> <span class="n">syscall</span>
<span class="o">------</span> <span class="o">-----------</span> <span class="o">-----------</span> <span class="o">---------</span> <span class="o">---------</span> <span class="o">----------------</span>
 <span class="mf">86.41</span>    <span class="mf">0.052074</span>        <span class="mi">1736</span>        <span class="mi">30</span>           <span class="n">futex</span>
  <span class="mf">6.89</span>    <span class="mf">0.004151</span>          <span class="mi">67</span>        <span class="mi">62</span>           <span class="n">munmap</span>
  <span class="mf">2.47</span>    <span class="mf">0.001490</span>          <span class="mi">17</span>        <span class="mi">88</span>           <span class="n">mmap</span>
  <span class="mf">2.12</span>    <span class="mf">0.001278</span>          <span class="mi">14</span>        <span class="mi">93</span>           <span class="n">clone</span>
  <span class="mf">1.51</span>    <span class="mf">0.000912</span>          <span class="mi">14</span>        <span class="mi">64</span>           <span class="n">mprotect</span>
  <span class="mf">0.19</span>    <span class="mf">0.000117</span>           <span class="mi">7</span>        <span class="mi">16</span>           <span class="n">write</span>
<span class="hll">  <span class="mf">0.15</span>    <span class="mf">0.000092</span>          <span class="mi">46</span>         <span class="mi">2</span>           <span class="n">open</span>
</span>
<span class="err">$</span> <span class="n">cat</span> <span class="n">strace_2</span> <span class="o">|</span> <span class="n">grep</span> <span class="n">open</span>
<span class="hll">  <span class="n">open</span><span class="p">(</span><span class="s">&quot;./word_count_datafiles/word_50MB.txt&quot;</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">)</span> <span class="o">=</span> <span class="mi">3</span>
</span><span class="hll">  <span class="n">open</span><span class="p">(</span><span class="s">&quot;/sys/devices/system/cpu/online&quot;</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="o">|</span><span class="n">O_CLOEXEC</span><span class="p">)</span> <span class="o">=</span> <span class="mi">4</span>
</span></pre></div>
</td></tr></table></p>
</li>
<li>
<p>It opened the <code class="codehilite"><span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="n">meminfo</span></code> for way too many times. In the normal Linux execution, this should not happen. Is it because our meminfo is faked, so glibs is complaining? But why it does not open meminfo while running in Linux? Or does our entry assembly messed up some stuff in stack, so the return path changed?</p>
</li>
<li>
<p>oh, about the FPU. It reminds our <code class="codehilite"><span class="n">flush_thread</span></code> function actually has an issue before. When I enabled this function during loading in P, the P will crash. Within <code class="codehilite"><span class="n">flush_thread</span></code>, there is a <code class="codehilite"><span class="n">fpu_clear</span></code>!!! So, check this tomorrow! (12:00am, need to go home)</p>
</li>
</ul>
<hr />
<h2 id="0218-sun-sunny">02/18 Sun Sunny<a class="headerlink" href="#0218-sun-sunny" title="Permanent link">&para;</a></h2>
<p>It is a nice day. Yesterday I&rsquo;ve changed one line of code in mmap code path: change anonymous vma&rsquo;s pgoff from some value to 0. The result is I got several succeed work-count-pthread(bind to one core) testing. However, it still fail with unmodified word-count-pthread.</p>
<p>It brings me to inspect pgoff manipulation code and all mmap.c code. We ported everything from linux without almost zero modification. That means we ported all those useless <code class="codehilite"><span class="n">anon_vma</span></code> and pgoff code, which is used a lot by vma_merge, vma_split code. The thing is: our memory manager, our vma code do not need such <code class="codehilite"><span class="n">anon_vma</span></code> structure, and do not maintain pgoff. Thus, I&rsquo;m a little bit worried linux code may doing some crazy behind our back: mess vma and pages, then pcache miss gets some wrong pages</p>
<p>Well. Lego does not use <code class="codehilite"><span class="n">anon_vma</span></code>, and pgoff should only be used by file-backed vma. So, I decided to remove <code class="codehilite"><span class="n">anon_vma</span></code> from our code, and make sure pgoff is used properly. Of course, the goal is to make vma_merge, split,
copy, do the things we intended.</p>
<p>Lesson learned.</p>
<hr />
<h2 id="0217-sat-snowy">02/17 Sat Snowy<a class="headerlink" href="#0217-sat-snowy" title="Permanent link">&para;</a></h2>
<p>Fixed the bss bug. It comes from loader. We did not implement the <code class="codehilite"><span class="n">lego_clear_user</span></code> function, so some part of bss is non-zero.</p>
<p>Bad news is word_count-pthread still fail at same fpu instruction. Have to look into memory code more.</p>
<p>This is actually a fun debugging story. We should always add TODO or XXX or some warnings to unfinished code, no matter what. Lesson learned.</p>
<hr />
<h2 id="0216-fri-cloudy">02/16 Fri Cloudy<a class="headerlink" href="#0216-fri-cloudy" title="Permanent link">&para;</a></h2>
<p>Yilun found a major loader bug yesterday: the <code class="codehilite"><span class="na">.bss</span></code> section variables are not 0, in the <code class="codehilite"><span class="n">iozone</span></code> benchmark. I did not encounter this issue before with simple test program. This is pretty serious.</p>
<hr />
<h2 id="0215-thur-rainy">02/15 Thur Rainy<a class="headerlink" href="#0215-thur-rainy" title="Permanent link">&para;</a></h2>
<p>Today is Chinese New Year.</p>
<p>Line 7 and 8 show the uva belong to the same page. Need to revisit <code class="codehilite"><span class="n">get_arg_pages</span></code> etc functions.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="p">[</span>  <span class="mi">108</span><span class="p">.</span><span class="mi">393991</span><span class="p">]</span> <span class="n">handle_p2m_execve</span><span class="p">():</span> <span class="n">pid</span><span class="p">:</span><span class="mi">22</span><span class="p">,</span><span class="n">argc</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="n">envc</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="n">file</span><span class="p">:</span><span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">ys</span><span class="o">/</span><span class="n">phoenix</span><span class="o">/</span><span class="n">phoenix</span><span class="o">-</span><span class="mi">2</span><span class="p">.</span><span class="mi">0</span><span class="o">/</span><span class="n">tests</span><span class="o">/</span><span class="n">word_count</span><span class="o">/</span><span class="n">word_count</span><span class="o">-</span><span class="n">pthread</span>
<span class="p">[</span>  <span class="mi">108</span><span class="p">.</span><span class="mi">395255</span><span class="p">]</span>     <span class="n">argc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">(</span><span class="n">len</span><span class="p">:</span> <span class="mi">65</span><span class="p">):</span>  <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">ys</span><span class="o">/</span><span class="n">phoenix</span><span class="o">/</span><span class="n">phoenix</span><span class="o">-</span><span class="mi">2</span><span class="p">.</span><span class="mi">0</span><span class="o">/</span><span class="n">tests</span><span class="o">/</span><span class="n">word_count</span><span class="o">/</span><span class="n">word_count</span><span class="o">-</span><span class="n">pthread</span>
<span class="p">[</span>  <span class="mi">108</span><span class="p">.</span><span class="mi">396329</span><span class="p">]</span>     <span class="n">argc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">(</span><span class="n">len</span><span class="p">:</span> <span class="mi">82</span><span class="p">):</span>  <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">ys</span><span class="o">/</span><span class="n">phoenix</span><span class="o">/</span><span class="n">phoenix</span><span class="o">-</span><span class="mi">2</span><span class="p">.</span><span class="mi">0</span><span class="o">/</span><span class="n">tests</span><span class="o">/</span><span class="n">word_count</span><span class="o">/</span><span class="n">word_count_datafiles</span><span class="o">/</span><span class="n">word_100MB</span><span class="p">.</span><span class="n">txt</span>
<span class="p">[</span>  <span class="mi">108</span><span class="p">.</span><span class="mi">397530</span><span class="p">]</span>     <span class="n">envc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">(</span><span class="n">len</span><span class="p">:</span>  <span class="mi">7</span><span class="p">):</span>  <span class="n">HOME</span><span class="o">=/</span>
<span class="p">[</span>  <span class="mi">108</span><span class="p">.</span><span class="mi">398069</span><span class="p">]</span>     <span class="n">envc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">(</span><span class="n">len</span><span class="p">:</span> <span class="mi">11</span><span class="p">):</span>  <span class="n">TERM</span><span class="o">=</span><span class="n">linux</span>
<span class="p">[</span>  <span class="mi">108</span><span class="p">.</span><span class="mi">398640</span><span class="p">]</span> <span class="n">__bprm_mm_init</span> <span class="n">vma</span><span class="p">:</span> <span class="n">ffff88083effe6b8</span>
<span class="hll"><span class="p">[</span>  <span class="mi">108</span><span class="p">.</span><span class="mi">399226</span><span class="p">]</span> <span class="n">faultin_page</span> <span class="n">vma</span><span class="p">:</span> <span class="n">ffff88083effe6b8</span> <span class="n">uva</span><span class="p">:</span> <span class="mi">0</span><span class="n">x7fffffffefed</span>
</span><span class="hll"><span class="p">[</span>  <span class="mi">108</span><span class="p">.</span><span class="mi">399949</span><span class="p">]</span> <span class="n">faultin_page</span> <span class="n">vma</span><span class="p">:</span> <span class="n">ffff88083effe6b8</span> <span class="n">uva</span><span class="p">:</span> <span class="mi">0</span><span class="n">x7fffffffef94</span>
</span></pre></div>
</td></tr></table>

<p>Well, this is 100% fine. I wrote this loader code long time ago and need some time to pickup. So, after I read the loader code, especially the <code class="codehilite"><span class="n">copy_strings</span></code> function, I found this is okay. Because copy_strings will be invoked three times, so the <code class="codehilite"><span class="n">faultin_page</span></code> basically will be invoked at least three times. That is why it went to that pte fault handling code.</p>
<p>Although actually I think <code class="codehilite"><span class="n">copy_strings</span></code> should <em>not</em> use <code class="codehilite"><span class="n">faultin_page</span></code>, instead, it should use <code class="codehilite"><span class="n">get_user_pages</span></code>, which will walk through the pgtable first, then went to <code class="codehilite"><span class="n">handle_lego_mm_fault</span></code>.</p>
<hr />
<h2 id="0214-wed-rainy">02/14 Wed Rainy<a class="headerlink" href="#0214-wed-rainy" title="Permanent link">&para;</a></h2>
<p>Hmm, tried to make kmalloc behave as kzalloc, and bind all threads to one core, still gave the same old bug:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="hll">  <span class="mi">42731</span><span class="n">a</span><span class="p">:</span>       <span class="n">f3</span> <span class="mi">0</span><span class="n">f</span> <span class="mi">6</span><span class="n">f</span> <span class="mi">16</span>             <span class="n">movdqu</span> <span class="p">(</span><span class="o">%</span><span class="n">rsi</span><span class="p">),</span><span class="o">%</span><span class="n">xmm2</span>
</span>
  <span class="p">[</span><span class="mi">93182</span><span class="p">.</span><span class="mi">657376</span><span class="p">]</span> <span class="n">word_count</span><span class="o">-</span><span class="n">pthr</span><span class="p">[</span><span class="mi">85</span><span class="p">]</span> <span class="k">general</span> <span class="n">protection</span> <span class="n">ip</span><span class="p">:</span><span class="mi">42731</span><span class="n">a</span> <span class="n">sp</span><span class="p">:</span><span class="mi">7</span><span class="n">fffe3ffed28</span> <span class="n">error</span><span class="p">:</span><span class="mi">0</span>
  <span class="p">[</span><span class="mi">93182</span><span class="p">.</span><span class="mi">747959</span><span class="p">]</span> <span class="n">CPU</span><span class="p">:</span> <span class="mi">8</span> <span class="n">PID</span><span class="p">:</span> <span class="mi">85</span> <span class="n">Comm</span><span class="p">:</span> <span class="n">word_count</span><span class="o">-</span><span class="n">pthr</span> <span class="mi">4</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="o">-</span><span class="n">lego</span><span class="o">+</span> <span class="o">#</span><span class="mi">170</span>
  <span class="p">[</span><span class="mi">93182</span><span class="p">.</span><span class="mi">820758</span><span class="p">]</span> <span class="n">RIP</span><span class="p">:</span> <span class="mi">0033</span><span class="p">:[</span><span class="o">&lt;</span><span class="mi">000000000042731</span><span class="n">a</span><span class="o">&gt;</span><span class="p">]</span>  <span class="p">[</span><span class="o">&lt;</span><span class="mi">000000000042731</span><span class="n">a</span><span class="o">&gt;</span><span class="p">]</span> <span class="mi">0</span><span class="n">x42731a</span>
  <span class="p">[</span><span class="mi">93182</span><span class="p">.</span><span class="mi">901878</span><span class="p">]</span> <span class="n">RSP</span><span class="p">:</span> <span class="mi">002</span><span class="n">b</span><span class="p">:</span><span class="mi">00007</span><span class="n">fffe3ffed28</span>  <span class="n">EFLAGS</span><span class="p">:</span> <span class="mi">00010283</span>
  <span class="p">[</span><span class="mi">93182</span><span class="p">.</span><span class="mi">965317</span><span class="p">]</span> <span class="n">RAX</span><span class="p">:</span> <span class="mi">000000000000001</span><span class="n">f</span> <span class="n">RBX</span><span class="p">:</span> <span class="mi">00007</span><span class="n">ffff001b010</span> <span class="n">RCX</span><span class="p">:</span> <span class="mi">0000000000000005</span>
  <span class="p">[</span><span class="mi">93183</span><span class="p">.</span><span class="mi">050596</span><span class="p">]</span> <span class="n">RDX</span><span class="p">:</span> <span class="mi">0000000000000000</span> <span class="n">RSI</span><span class="p">:</span> <span class="mi">5345485355420045</span> <span class="n">RDI</span><span class="p">:</span> <span class="mi">00007</span><span class="n">ffff294791f</span>
  <span class="p">[</span><span class="mi">93183</span><span class="p">.</span><span class="mi">135876</span><span class="p">]</span> <span class="n">RBP</span><span class="p">:</span> <span class="mi">00007</span><span class="n">ffff294791f</span> <span class="n">R08</span><span class="p">:</span> <span class="mi">000000000000</span><span class="n">ffff</span> <span class="n">R09</span><span class="p">:</span> <span class="mi">0000000000000008</span>
  <span class="p">[</span><span class="mi">93183</span><span class="p">.</span><span class="mi">221156</span><span class="p">]</span> <span class="n">R10</span><span class="p">:</span> <span class="n">fffffffffffff048</span> <span class="n">R11</span><span class="p">:</span> <span class="mi">00000000004</span><span class="n">acfc0</span> <span class="n">R12</span><span class="p">:</span> <span class="mi">0000000000001</span><span class="n">cde</span>
  <span class="p">[</span><span class="mi">93183</span><span class="p">.</span><span class="mi">306435</span><span class="p">]</span> <span class="n">R13</span><span class="p">:</span> <span class="mi">00000000006</span><span class="n">e4a8c</span> <span class="n">R14</span><span class="p">:</span> <span class="mi">0000000000001</span><span class="n">cd7</span> <span class="n">R15</span><span class="p">:</span> <span class="mi">0000000000001</span><span class="n">cda</span>
  <span class="p">[</span><span class="mi">93183</span><span class="p">.</span><span class="mi">391716</span><span class="p">]</span> <span class="n">FS</span><span class="p">:</span>  <span class="mi">00007</span><span class="n">fffe3fff700</span><span class="p">(</span><span class="mi">0000</span><span class="p">)</span> <span class="n">GS</span><span class="p">:</span><span class="n">ffff88107fc80000</span><span class="p">(</span><span class="mi">0000</span><span class="p">)</span> <span class="n">knlGS</span><span class="p">:</span><span class="mi">0000000000000000</span>
  <span class="p">[</span><span class="mi">93183</span><span class="p">.</span><span class="mi">488434</span><span class="p">]</span> <span class="n">CS</span><span class="p">:</span>  <span class="mi">0010</span> <span class="n">DS</span><span class="p">:</span> <span class="mi">0000</span> <span class="n">ES</span><span class="p">:</span> <span class="mi">0000</span> <span class="n">CR0</span><span class="p">:</span> <span class="mi">0000000080050033</span>
  <span class="p">[</span><span class="mi">93183</span><span class="p">.</span><span class="mi">557075</span><span class="p">]</span> <span class="n">CR2</span><span class="p">:</span> <span class="mi">00007</span><span class="n">ffff27a4000</span> <span class="n">CR3</span><span class="p">:</span> <span class="mi">000000107</span><span class="n">e924000</span> <span class="n">CR4</span><span class="p">:</span> <span class="mi">00000000000406</span><span class="n">a0</span>
</pre></div>
</td></tr></table></p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="hll">  <span class="mi">427377</span><span class="p">:</span>       <span class="mi">66</span> <span class="mi">0</span><span class="n">f</span> <span class="mi">6</span><span class="n">f</span> <span class="mi">17</span>             <span class="n">movdqa</span> <span class="p">(</span><span class="o">%</span><span class="n">rdi</span><span class="p">),</span><span class="o">%</span><span class="n">xmm2</span>
</span>
  <span class="p">[</span><span class="mi">93180</span><span class="p">.</span><span class="mi">527248</span><span class="p">]</span> <span class="n">word_count</span><span class="o">-</span><span class="n">pthr</span><span class="p">[</span><span class="mi">93</span><span class="p">]:</span> <span class="n">segfault</span> <span class="k">at</span> <span class="mi">0</span><span class="n">x0</span> <span class="n">ip</span> <span class="mi">0000000000427377</span> <span class="n">sp</span> <span class="mi">00007</span><span class="n">fffdfff6d28</span> <span class="n">error</span> <span class="mi">4</span>
  <span class="p">[</span><span class="mi">93180</span><span class="p">.</span><span class="mi">630314</span><span class="p">]</span> <span class="n">CPU</span><span class="p">:</span> <span class="mi">8</span> <span class="n">PID</span><span class="p">:</span> <span class="mi">93</span> <span class="n">Comm</span><span class="p">:</span> <span class="n">word_count</span><span class="o">-</span><span class="n">pthr</span> <span class="mi">4</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="o">-</span><span class="n">lego</span><span class="o">+</span> <span class="o">#</span><span class="mi">170</span>
  <span class="p">[</span><span class="mi">93180</span><span class="p">.</span><span class="mi">703114</span><span class="p">]</span> <span class="n">RIP</span><span class="p">:</span> <span class="mi">0033</span><span class="p">:[</span><span class="o">&lt;</span><span class="mi">0000000000427377</span><span class="o">&gt;</span><span class="p">]</span>  <span class="p">[</span><span class="o">&lt;</span><span class="mi">0000000000427377</span><span class="o">&gt;</span><span class="p">]</span> <span class="mi">0</span><span class="n">x427377</span>
  <span class="p">[</span><span class="mi">93180</span><span class="p">.</span><span class="mi">784234</span><span class="p">]</span> <span class="n">RSP</span><span class="p">:</span> <span class="mi">002</span><span class="n">b</span><span class="p">:</span><span class="mi">00007</span><span class="n">fffdfff6d28</span>  <span class="n">EFLAGS</span><span class="p">:</span> <span class="mi">00010297</span>
  <span class="p">[</span><span class="mi">93180</span><span class="p">.</span><span class="mi">847674</span><span class="p">]</span> <span class="n">RAX</span><span class="p">:</span> <span class="mi">0000000000000000</span> <span class="n">RBX</span><span class="p">:</span> <span class="mi">000000000073</span><span class="n">c4c0</span> <span class="n">RCX</span><span class="p">:</span> <span class="mi">000000000000000</span><span class="n">d</span>
  <span class="p">[</span><span class="mi">93180</span><span class="p">.</span><span class="mi">932953</span><span class="p">]</span> <span class="n">RDX</span><span class="p">:</span> <span class="mi">000000000000</span><span class="n">ffff</span> <span class="n">RSI</span><span class="p">:</span> <span class="mi">00007</span><span class="n">ffff4999070</span> <span class="n">RDI</span><span class="p">:</span> <span class="mi">0000000000000000</span>
  <span class="p">[</span><span class="mi">93181</span><span class="p">.</span><span class="mi">018233</span><span class="p">]</span> <span class="n">RBP</span><span class="p">:</span> <span class="mi">00007</span><span class="n">ffff499907d</span> <span class="n">R08</span><span class="p">:</span> <span class="mi">000000000000</span><span class="n">ffff</span> <span class="n">R09</span><span class="p">:</span> <span class="mi">0000000000000000</span>
  <span class="p">[</span><span class="mi">93181</span><span class="p">.</span><span class="mi">103513</span><span class="p">]</span> <span class="n">R10</span><span class="p">:</span> <span class="mi">0000000000427760</span> <span class="n">R11</span><span class="p">:</span> <span class="mi">00007</span><span class="n">ffff49982c0</span> <span class="n">R12</span><span class="p">:</span> <span class="mi">0000000000000118</span>
  <span class="p">[</span><span class="mi">93181</span><span class="p">.</span><span class="mi">188791</span><span class="p">]</span> <span class="n">R13</span><span class="p">:</span> <span class="mi">00000000006</span><span class="n">e4aac</span> <span class="n">R14</span><span class="p">:</span> <span class="mi">0000000000000116</span> <span class="n">R15</span><span class="p">:</span> <span class="mi">0000000000000117</span>
  <span class="p">[</span><span class="mi">93181</span><span class="p">.</span><span class="mi">274072</span><span class="p">]</span> <span class="n">FS</span><span class="p">:</span>  <span class="mi">00007</span><span class="n">fffdfff7700</span><span class="p">(</span><span class="mi">0000</span><span class="p">)</span> <span class="n">GS</span><span class="p">:</span><span class="n">ffff88107fc80000</span><span class="p">(</span><span class="mi">0000</span><span class="p">)</span> <span class="n">knlGS</span><span class="p">:</span><span class="mi">0000000000000000</span>
  <span class="p">[</span><span class="mi">93181</span><span class="p">.</span><span class="mi">370790</span><span class="p">]</span> <span class="n">CS</span><span class="p">:</span>  <span class="mi">0010</span> <span class="n">DS</span><span class="p">:</span> <span class="mi">0000</span> <span class="n">ES</span><span class="p">:</span> <span class="mi">0000</span> <span class="n">CR0</span><span class="p">:</span> <span class="mi">0000000080050033</span>
  <span class="p">[</span><span class="mi">93181</span><span class="p">.</span><span class="mi">439430</span><span class="p">]</span> <span class="n">CR2</span><span class="p">:</span> <span class="mi">0000000000000000</span> <span class="n">CR3</span><span class="p">:</span> <span class="mi">000000107</span><span class="n">e924000</span> <span class="n">CR4</span><span class="p">:</span> <span class="mi">00000000000406</span><span class="n">a0</span>
</pre></div>
</td></tr></table>

<p>Tried several ways to ensure memory safety. It still failed even if I enabled all of them. So, I guess the memory safety is ensured? Still some other things?</p>
<ul>
<li>force <code class="codehilite"><span class="n">alloc_pages</span></code> to use <code class="codehilite"><span class="n">__GFP_ZERO</span></code></li>
<li>make <code class="codehilite"><span class="n">kmalloc</span></code> behave as <code class="codehilite"><span class="n">kzalloc</span></code></li>
<li>make <code class="codehilite"><span class="n">kfree</span></code> empty</li>
</ul>
<p>I also suspect <code class="codehilite"><span class="n">munmap</span></code> may free extra wrong pgtable entries. Although I&rsquo;ve went through all the code and checked, but in addition to the above things, I&rsquo;m going to:</p>
<ul>
<li>make munmap dummy (no p2m_munmap, return 0 directly)</li>
</ul>
<p>Failed.</p>
<p>Next, I&rsquo;m going to:</p>
<ul>
<li>add checksum for every page transferred across network.</li>
<li>add warning for unnormal cases</li>
</ul>
<p>Bang! I found something while running P+M:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="p">[</span>  <span class="mf">115.727597</span><span class="p">]</span> <span class="n">Memory</span><span class="o">-</span><span class="n">component</span> <span class="n">manager</span> <span class="n">is</span> <span class="n">up</span> <span class="n">and</span> <span class="n">running</span><span class="p">.</span>
<span class="p">[</span>  <span class="mf">116.691723</span><span class="p">]</span> <span class="n">handle_p2m_fork</span><span class="p">()</span><span class="o">:</span> <span class="nl">nid</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="nl">pid</span><span class="p">:</span><span class="mi">22</span><span class="p">,</span><span class="nl">tgid</span><span class="p">:</span><span class="mi">22</span><span class="p">,</span><span class="nl">parent_tgid</span><span class="p">:</span><span class="mi">1</span>
<span class="p">[</span>  <span class="mf">116.697038</span><span class="p">]</span> <span class="n">handle_p2m_fork</span><span class="p">()</span><span class="o">:</span> <span class="nl">reply</span><span class="p">:</span> <span class="mi">0</span><span class="o">:</span><span class="n">OKAY</span>
<span class="p">[</span>  <span class="mf">116.791088</span><span class="p">]</span> <span class="n">handle_p2m_execve</span><span class="p">()</span><span class="o">:</span> <span class="nl">pid</span><span class="p">:</span><span class="mi">22</span><span class="p">,</span><span class="nl">argc</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="nl">envc</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="nl">file</span><span class="p">:</span><span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">ys</span><span class="o">/</span><span class="n">phoenix</span><span class="o">/</span><span class="n">phoenix</span><span class="o">-</span><span class="mf">2.0</span><span class="o">/</span><span class="n">tests</span><span class="o">/</span><span class="n">word_count</span><span class="o">/</span><span class="n">word_count</span><span class="o">-</span><span class="n">pthread</span>
<span class="p">[</span>  <span class="mf">116.792357</span><span class="p">]</span>     <span class="n">argc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">(</span><span class="nl">len</span><span class="p">:</span> <span class="mi">65</span><span class="p">)</span><span class="o">:</span>  <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">ys</span><span class="o">/</span><span class="n">phoenix</span><span class="o">/</span><span class="n">phoenix</span><span class="o">-</span><span class="mf">2.0</span><span class="o">/</span><span class="n">tests</span><span class="o">/</span><span class="n">word_count</span><span class="o">/</span><span class="n">word_count</span><span class="o">-</span><span class="n">pthread</span>
<span class="p">[</span>  <span class="mf">116.793439</span><span class="p">]</span>     <span class="n">argc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">(</span><span class="nl">len</span><span class="p">:</span> <span class="mi">82</span><span class="p">)</span><span class="o">:</span>  <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">ys</span><span class="o">/</span><span class="n">phoenix</span><span class="o">/</span><span class="n">phoenix</span><span class="o">-</span><span class="mf">2.0</span><span class="o">/</span><span class="n">tests</span><span class="o">/</span><span class="n">word_count</span><span class="o">/</span><span class="n">word_count_datafiles</span><span class="o">/</span><span class="n">word_100MB</span><span class="p">.</span><span class="n">txt</span>
<span class="p">[</span>  <span class="mf">116.794653</span><span class="p">]</span>     <span class="n">envc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">(</span><span class="nl">len</span><span class="p">:</span>  <span class="mi">7</span><span class="p">)</span><span class="o">:</span>  <span class="n">HOME</span><span class="o">=/</span>
<span class="p">[</span>  <span class="mf">116.795196</span><span class="p">]</span>     <span class="n">envc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">(</span><span class="nl">len</span><span class="p">:</span> <span class="mi">11</span><span class="p">)</span><span class="o">:</span>  <span class="n">TERM</span><span class="o">=</span><span class="n">linux</span>
<span class="hll"><span class="p">[</span>  <span class="mf">116.795772</span><span class="p">]</span> <span class="n">__bprm_mm_init</span> <span class="nl">vma</span><span class="p">:</span> <span class="n">ffff88083effe6b8</span>
</span><span class="hll"><span class="p">[</span>  <span class="mf">116.796209</span><span class="p">]</span> <span class="n">faultin_page</span> <span class="nl">vma</span><span class="p">:</span> <span class="n">ffff88083effe6b8</span>
</span><span class="hll"><span class="p">[</span>  <span class="mf">116.796729</span><span class="p">]</span> <span class="n">faultin_page</span> <span class="nl">vma</span><span class="p">:</span> <span class="n">ffff88083effe6b8</span>
</span><span class="hll"><span class="p">[</span>  <span class="mf">116.797150</span><span class="p">]</span> <span class="n">handle_pte_fault</span> <span class="nl">vma</span><span class="p">:</span> <span class="n">ffff88083effe6b8</span> <span class="nl">entry</span><span class="p">:</span> <span class="mh">0xffff88083e8c1067</span>
</span><span class="hll"><span class="p">[</span>  <span class="mf">116.798044</span><span class="p">]</span> <span class="nl">pte</span><span class="p">:</span><span class="n">ffff88083e8c0ff0</span> <span class="nl">pfn</span><span class="p">:</span><span class="mh">0x8083e8c1</span> <span class="nl">flags</span><span class="p">:(</span><span class="n">present</span><span class="o">|</span><span class="n">writable</span><span class="o">|</span><span class="n">user</span><span class="o">|</span><span class="n">accessed</span><span class="o">|</span><span class="n">dirty</span><span class="o">|</span><span class="n">softw4</span><span class="o">|</span><span class="n">pkey0</span><span class="o">|</span><span class="n">pkey1</span><span class="o">|</span><span class="n">pkey2</span><span class="o">|</span><span class="n">pkey3</span><span class="o">|</span><span class="n">nx</span><span class="o">|</span><span class="mh">0x3ff800000000000</span><span class="p">)</span>
</span><span class="p">[</span>  <span class="mf">116.799462</span><span class="p">]</span> <span class="o">------------</span><span class="p">[</span> <span class="n">cut</span> <span class="n">here</span> <span class="p">]</span><span class="o">------------</span>
<span class="p">[</span>  <span class="mf">116.800049</span><span class="p">]</span> <span class="nl">WARNING</span><span class="p">:</span> <span class="nl">CPU</span><span class="p">:</span> <span class="mi">4</span> <span class="nl">PID</span><span class="p">:</span> <span class="mi">15</span> <span class="n">at</span> <span class="n">managers</span><span class="o">/</span><span class="n">memory</span><span class="o">/</span><span class="n">vm</span><span class="o">/</span><span class="n">fault</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span><span class="mi">148</span> <span class="n">handle_lego_mm_fault</span><span class="o">+</span><span class="mh">0x4d8</span><span class="o">/</span><span class="mh">0x550</span>
<span class="p">[</span>  <span class="mf">116.801148</span><span class="p">]</span> <span class="nl">CPU</span><span class="p">:</span> <span class="mi">4</span> <span class="nl">PID</span><span class="p">:</span> <span class="mi">15</span> <span class="nl">Comm</span><span class="p">:</span> <span class="n">mc</span><span class="o">-</span><span class="n">manager</span> <span class="mf">4.0.0</span><span class="o">-</span><span class="n">lego</span><span class="o">+</span> <span class="err">#</span><span class="mi">78</span>
<span class="p">[</span>  <span class="mf">116.801818</span><span class="p">]</span> <span class="nl">Stack</span><span class="p">:</span>
<span class="p">[</span>  <span class="mf">116.802179</span><span class="p">]</span> <span class="n">ffff88083e893c50</span> <span class="n">ffffffff8100e827</span> <span class="mf">00007ff</span><span class="n">fffffef94</span> <span class="n">ffff88083effe6b8</span>
<span class="p">[</span>  <span class="mf">116.803283</span><span class="p">]</span> <span class="n">ffff88083e894008</span> <span class="n">ffff88083e8c1067</span> <span class="n">ffff88083e893c60</span> <span class="n">ffffffff8100e91f</span>
<span class="p">[</span>  <span class="mf">116.804387</span><span class="p">]</span> <span class="n">ffff88083e893cf0</span> <span class="n">ffffffff8102b008</span> <span class="mo">0000000000000031</span> <span class="n">ffff88083e893cf0</span>
<span class="p">[</span>  <span class="mf">116.805488</span><span class="p">]</span> <span class="mo">00000000000002</span><span class="mi">96</span> <span class="mf">00003ff</span><span class="n">fffe00000</span> <span class="n">ffff800000000067</span> <span class="n">ffff88083e893d50</span>
<span class="p">[</span>  <span class="mf">116.806590</span><span class="p">]</span> <span class="n">ffff880000000001</span> <span class="n">ffffffff81066798</span> <span class="n">ffff88083effe6b8</span> <span class="n">ffff88083e893d50</span>
<span class="p">[</span>  <span class="mf">116.807691</span><span class="p">]</span> <span class="n">Call</span> <span class="nl">Trace</span><span class="p">:</span>
<span class="p">[</span>  <span class="mf">116.808087</span><span class="p">]</span> <span class="o">&lt;</span><span class="n">TSK</span><span class="o">&gt;</span>
<span class="p">[</span>  <span class="mf">116.808448</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8100e836</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">__warn</span><span class="p">.</span><span class="n">constprop</span><span class="mf">.0</span><span class="o">+</span><span class="mh">0xa6</span><span class="o">/</span><span class="mh">0x100</span>
<span class="p">[</span>  <span class="mf">116.809126</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8100e91f</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">warn_slowpath_null</span><span class="o">+</span><span class="mh">0xf</span><span class="o">/</span><span class="mh">0x20</span>
<span class="p">[</span>  <span class="mf">116.809802</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8102b008</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">handle_lego_mm_fault</span><span class="o">+</span><span class="mh">0x4d8</span><span class="o">/</span><span class="mh">0x550</span>
<span class="p">[</span>  <span class="mf">116.810505</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8102cfe3</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">faultin_page</span><span class="o">+</span><span class="mh">0x43</span><span class="o">/</span><span class="mh">0xb0</span>
<span class="p">[</span>  <span class="mf">116.811131</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8102dab1</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">copy_strings</span><span class="p">.</span><span class="n">isra</span><span class="mf">.1</span><span class="o">+</span><span class="mh">0xe1</span><span class="o">/</span><span class="mh">0x130</span>
<span class="p">[</span>  <span class="mf">116.811819</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8102dd1e</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">exec_loader</span><span class="o">+</span><span class="mh">0x21e</span><span class="o">/</span><span class="mh">0x350</span>
<span class="p">[</span>  <span class="mf">116.812457</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8102680a</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">handle_p2m_execve</span><span class="o">+</span><span class="mh">0x1aa</span><span class="o">/</span><span class="mh">0x290</span>
</pre></div>
</td></tr></table></p>
<p>This is a temporary stack vma that loader created for saving argv and envp. So, this vma was created here:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="k">static</span> <span class="kt">int</span> <span class="nf">__bprm_mm_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">lego_binprm</span> <span class="o">*</span><span class="n">bprm</span><span class="p">)</span>
<span class="p">{</span>
        <span class="p">...</span>
        <span class="n">bprm</span><span class="o">-&gt;</span><span class="n">vma</span> <span class="o">=</span> <span class="n">vma</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">vma</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
        <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<p>And then <code class="codehilite"><span class="n">copy_strings</span></code> will call <code class="codehilite"><span class="n">faultin_page</span></code> to populate a page for a specific user virtual adddress:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kt">int</span> <span class="nf">faultin_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start</span><span class="p">,</span>
                 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">kvaddr</span><span class="p">)</span>
<span class="p">{</span>
        <span class="p">...</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">handle_lego_mm_fault</span><span class="p">(</span><span class="n">vma</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">kvaddr</span><span class="p">);</span>
        <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<p>Eventually, the <code class="codehilite"><span class="n">handle_lego_mm_fault</span></code> will call <code class="codehilite"><span class="n">handle_pte_fault</span></code>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="k">static</span> <span class="kt">int</span> <span class="nf">handle_pte_fault</span><span class="p">(</span><span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">address</span><span class="p">,</span>
                            <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="n">pte_t</span> <span class="o">*</span><span class="n">pte</span><span class="p">,</span> <span class="n">pmd_t</span> <span class="o">*</span><span class="n">pmd</span><span class="p">,</span>
                            <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">mapping_flags</span><span class="p">)</span>
<span class="p">{</span>
        <span class="p">...</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pte_present</span><span class="p">(</span><span class="n">entry</span><span class="p">))</span> <span class="p">{</span>
                <span class="p">...</span>
        <span class="p">}</span>

        <span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s vma: %p entry: %#lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">FUNC</span><span class="p">,</span> <span class="n">vma</span><span class="p">,</span> <span class="n">entry</span><span class="p">.</span><span class="n">pte</span><span class="p">);</span>
        <span class="n">dump_pte</span><span class="p">(</span><span class="n">pte</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
        <span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<p>Apparently, pte is wrong! But I don&rsquo;t have time today. Continue tomorrow.
Hmm forgot that we are saving kernel virtual addresses in the pte. Just take a quick look at the lego_pud_alloc things, seems will have some issues. I defenitly need to check all these stuff tomorrow. I&rsquo;ve not touch this part for too long!</p>
<hr />
<h2 id="0213-tue-sunny">02/13 Tue Sunny<a class="headerlink" href="#0213-tue-sunny" title="Permanent link">&para;</a></h2>
<p>Checking our SLOB allocator today. So I found Yutong&rsquo;s code is using <code class="codehilite"><span class="n">set_page_private</span></code> when slob get a new page from buddy. This private field is only intended to be used by buddy to record the <code class="codehilite"><span class="k">order</span></code>. This mixed usage will confuse buddy and create bug.</p>
<p>Even though I removed the <code class="codehilite"><span class="n">set_page_private</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span></code> after <code class="codehilite"><span class="n">free_page</span></code>, word_count-pthread still fails. Damn.</p>
<hr />
<h2 id="0212-mon-cloudy">02/12 Mon Cloudy<a class="headerlink" href="#0212-mon-cloudy" title="Permanent link">&para;</a></h2>
<p>Add this commit <code class="codehilite"><span class="mi">4</span><span class="n">cb3a8b6a943c90714fd9bb5e5465ee315f0aa30</span></code>:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>    <span class="nv">memory</span>: <span class="nv">Use</span> <span class="nv">kzalloc</span> <span class="nv">instead</span> <span class="nv">of</span> <span class="nv">kmalloc</span> <span class="nv">in</span> <span class="nv">__bprm_mm_init</span> <span class="ss">(</span><span class="nv">loader</span><span class="ss">)</span>

    <span class="nv">This</span> <span class="nv">was</span> <span class="nv">an</span> <span class="nv">potentionl</span> <span class="nv">bug</span> <span class="nv">that</span> <span class="nv">was</span> <span class="nv">not</span> <span class="nv">triggered</span> <span class="nv">previously</span>.
    <span class="nv">It</span> <span class="nv">is</span> <span class="nv">simply</span> <span class="nv">because</span> <span class="nv">kmalloc</span><span class="s1">&#39;</span><span class="s">ed vma contains some garbage area,</span>
    <span class="k">while</span> <span class="nv">later</span> <span class="nv">in</span> <span class="nv">the</span> <span class="nv">pgfault</span> <span class="nv">code</span>, <span class="nv">we</span> <span class="nv">use</span>
            <span class="k">if</span> <span class="ss">(</span><span class="nv">vma</span><span class="o">-&gt;</span><span class="nv">vm_ops</span> <span class="o">&amp;&amp;</span> <span class="nv">vma</span><span class="o">-&gt;</span><span class="nv">vm_ops</span><span class="o">-&gt;</span><span class="nv">fault</span><span class="ss">)</span>
                    ...
    <span class="nv">to</span> <span class="nv">check</span> <span class="k">if</span> <span class="nv">it</span> <span class="nv">is</span> <span class="nv">an</span> <span class="nv">file</span><span class="o">-</span><span class="nv">backed</span> <span class="nv">fault</span>.

    <span class="nv">Fortunately</span> <span class="nv">the</span> <span class="nv">vma</span><span class="o">-&gt;</span><span class="nv">vm_ops</span> <span class="nv">happens</span> <span class="nv">to</span> <span class="nv">have</span> <span class="nv">some</span> <span class="nv">leftover</span> <span class="nv">value</span>.
    <span class="nv">So</span> <span class="nv">this</span> <span class="nv">bug</span> <span class="nv">was</span> <span class="nv">triggered</span>.

    <span class="nv">This</span> <span class="nv">actually</span> <span class="nv">reminds</span> <span class="nv">me</span> <span class="nv">that</span> <span class="nv">this</span> <span class="nv">is</span> <span class="nv">a</span> <span class="nv">series</span> <span class="nv">of</span> <span class="nv">potential</span> <span class="nv">bugs</span><span class="o">!</span>
    <span class="nv">Even</span> <span class="nv">though</span> <span class="nv">before</span> <span class="nv">I</span><span class="s1">&#39;</span><span class="s">ve added things like force GFP_ZERO in all</span>
    <span class="nv">physical</span> <span class="nv">page</span> <span class="nv">allocation</span>, <span class="nv">I</span> <span class="nv">missed</span> <span class="nv">the</span> <span class="nv">kmalloc</span><span class="s1">&#39;</span><span class="s">s case!</span>
</pre></div>
</td></tr></table></p>
<p>The story is:</p>
<p>I patched the stop_machine code today, and tried to run code with P+M on VM, everything works fine. However, when I tried to run the new code with P+M+S on physical machine, M crashed at a very weird point:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="p">[</span> <span class="mi">7791</span><span class="p">.</span><span class="mi">998168</span><span class="p">]</span> <span class="n">handle_p2m_execve</span><span class="p">():</span> <span class="n">pid</span><span class="p">:</span><span class="mi">81</span><span class="p">,</span><span class="n">argc</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="n">envc</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="n">file</span><span class="p">:</span><span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">ys</span><span class="o">/</span><span class="n">phoenix</span><span class="o">/</span><span class="n">phoenix</span><span class="o">-</span><span class="mi">2</span><span class="p">.</span><span class="mi">0</span><span class="o">/</span><span class="n">tests</span><span class="o">/</span><span class="n">word_count</span><span class="o">/</span><span class="n">word_count</span><span class="o">-</span><span class="n">pthread</span>
<span class="p">[</span> <span class="mi">7792</span><span class="p">.</span><span class="mi">129312</span><span class="p">]</span> <span class="n">BUG</span><span class="p">:</span> <span class="n">unable</span> <span class="k">to</span> <span class="n">handle</span> <span class="n">kernel</span> <span class="k">NULL</span> <span class="n">pointer</span> <span class="n">dereference</span> <span class="k">at</span> <span class="mi">0000000000000031</span>
<span class="p">[</span> <span class="mi">7792</span><span class="p">.</span><span class="mi">222889</span><span class="p">]</span> <span class="n">IP</span><span class="p">:</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8102c180</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">handle_lego_mm_fault</span><span class="o">+</span><span class="mi">0</span><span class="n">x160</span><span class="o">/</span><span class="mi">0</span><span class="n">x4b0</span>
<span class="p">[</span> <span class="mi">7792</span><span class="p">.</span><span class="mi">299842</span><span class="p">]</span> <span class="n">PGD</span> <span class="mi">0</span>
<span class="p">[</span> <span class="mi">7792</span><span class="p">.</span><span class="mi">323760</span><span class="p">]</span> <span class="n">Oops</span><span class="p">:</span> <span class="mi">0000</span> <span class="p">[</span><span class="o">#</span><span class="mi">1</span><span class="p">]</span> <span class="n">PREEMPT</span> <span class="n">SMP</span> <span class="n">MEMORY</span>
<span class="p">[</span> <span class="mi">7792</span><span class="p">.</span><span class="mi">376794</span><span class="p">]</span> <span class="n">CPU</span><span class="p">:</span> <span class="mi">4</span> <span class="n">PID</span><span class="p">:</span> <span class="mi">79</span> <span class="n">Comm</span><span class="p">:</span> <span class="n">mc</span><span class="o">-</span><span class="n">manager</span> <span class="mi">4</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="o">-</span><span class="n">lego</span><span class="o">+</span> <span class="o">#</span><span class="mi">29</span>
<span class="hll"><span class="p">[</span> <span class="mi">7792</span><span class="p">.</span><span class="mi">443349</span><span class="p">]</span> <span class="n">RIP</span><span class="p">:</span> <span class="p">..</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8102c180</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">handle_lego_mm_fault</span><span class="o">+</span><span class="mi">0</span><span class="n">x160</span><span class="o">/</span><span class="mi">0</span><span class="n">x4b0</span>
</span><span class="p">......</span>
<span class="p">....</span>
<span class="p">[</span> <span class="mi">7793</span><span class="p">.</span><span class="mi">750506</span><span class="p">]</span> <span class="k">Call</span> <span class="n">Trace</span><span class="p">:</span>
<span class="p">[</span> <span class="mi">7793</span><span class="p">.</span><span class="mi">779623</span><span class="p">]</span> <span class="o">&lt;</span><span class="n">TSK</span><span class="o">&gt;</span>
<span class="hll"><span class="p">[</span> <span class="mi">7793</span><span class="p">.</span><span class="mi">802501</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff810053f4</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">apic_timer_interrupt</span><span class="o">+</span><span class="mi">0</span><span class="n">x54</span><span class="o">/</span><span class="mi">0</span><span class="n">x90</span>
</span><span class="hll"><span class="p">[</span> <span class="mi">7793</span><span class="p">.</span><span class="mi">875295</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8102e469</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">faultin_page</span><span class="o">+</span><span class="mi">0</span><span class="n">x9</span><span class="o">/</span><span class="mi">0</span><span class="n">x70</span>
</span><span class="hll"><span class="p">[</span> <span class="mi">7793</span><span class="p">.</span><span class="mi">936649</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8102ef01</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">copy_strings</span><span class="p">.</span><span class="n">isra</span><span class="p">.</span><span class="mi">1</span><span class="o">+</span><span class="mi">0</span><span class="n">xe1</span><span class="o">/</span><span class="mi">0</span><span class="n">x130</span>
</span><span class="hll"><span class="p">[</span> <span class="mi">7794</span><span class="p">.</span><span class="mi">007362</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8102f11e</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">exec_loader</span><span class="o">+</span><span class="mi">0</span><span class="n">x1ce</span><span class="o">/</span><span class="mi">0</span><span class="n">x340</span>
</span><span class="hll"><span class="p">[</span> <span class="mi">7794</span><span class="p">.</span><span class="mi">070796</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81027def</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">handle_p2m_execve</span><span class="o">+</span><span class="mi">0</span><span class="n">x12f</span><span class="o">/</span><span class="mi">0</span><span class="n">x200</span>
</span><span class="p">[</span> <span class="mi">7794</span><span class="p">.</span><span class="mi">140469</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff810274fb</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">mc_manager</span><span class="o">+</span><span class="mi">0</span><span class="n">x1ab</span><span class="o">/</span><span class="mi">0</span><span class="n">x2b0</span>
<span class="p">[</span> <span class="mi">7794</span><span class="p">.</span><span class="mi">202864</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff81027350</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">bitmap_fill</span><span class="o">+</span><span class="mi">0</span><span class="n">x33</span><span class="o">/</span><span class="mi">0</span><span class="n">x33</span>
<span class="p">[</span> <span class="mi">7794</span><span class="p">.</span><span class="mi">266298</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8101c6b7</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">kthread</span><span class="o">+</span><span class="mi">0</span><span class="n">x107</span><span class="o">/</span><span class="mi">0</span><span class="n">x130</span>
<span class="p">[</span> <span class="mi">7794</span><span class="p">.</span><span class="mi">325572</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8101c5b0</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">__kthread_parkme</span><span class="o">+</span><span class="mi">0</span><span class="n">x90</span><span class="o">/</span><span class="mi">0</span><span class="n">x90</span>
<span class="p">[</span> <span class="mi">7794</span><span class="p">.</span><span class="mi">394205</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8100b462</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">ret_from_fork</span><span class="o">+</span><span class="mi">0</span><span class="n">x22</span><span class="o">/</span><span class="mi">0</span><span class="n">x30</span>
</pre></div>
</td></tr></table></p>
<p>So faulting source code is:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="k">static</span> <span class="kt">int</span> <span class="nf">handle_pte_fault</span><span class="p">(</span><span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">address</span><span class="p">,</span>
                            <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="n">pte_t</span> <span class="o">*</span><span class="n">pte</span><span class="p">,</span> <span class="n">pmd_t</span> <span class="o">*</span><span class="n">pmd</span><span class="p">)</span>
<span class="p">{</span>
    <span class="p">....</span>
<span class="hll">        <span class="k">if</span> <span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_ops</span> <span class="o">&amp;&amp;</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_ops</span><span class="o">-&gt;</span><span class="n">fault</span><span class="p">)</span>
</span><span class="hll">                <span class="k">return</span> <span class="n">do_linear_fault</span><span class="p">(</span><span class="n">vma</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span>
</span>                                       <span class="n">pte</span><span class="p">,</span> <span class="n">pmd</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span>
    <span class="p">....</span>
</pre></div>
</td></tr></table></p>
<p>Something wrong with <code class="codehilite"><span class="n">vma</span></code>? At this loader stage, this vma is a temporaty stack vma created for saving <code class="codehilite"><span class="n">argv</span></code> and <code class="codehilite"><span class="n">envp</span></code>. So I look back into the code that created this vma:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">managers</span><span class="o">/</span><span class="n">memory</span><span class="o">/</span><span class="n">loader</span><span class="o">/</span><span class="n">core</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__bprm_mm_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">lego_binprm</span> <span class="o">*</span><span class="n">bprm</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">lego_mm_struct</span> <span class="o">*</span><span class="n">mm</span> <span class="o">=</span> <span class="n">bprm</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">;</span>

<span class="hll">        <span class="n">bprm</span><span class="o">-&gt;</span><span class="n">vma</span> <span class="o">=</span> <span class="n">vma</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">vma</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
</span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vma</span><span class="p">)</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
</pre></div>
</td></tr></table></p>
<p>The code after this does NOT do necessary cleanup. The <code class="codehilite"><span class="n">vm_ops</span></code> happens to have some garbage value from last user. So it is not 0, so the above <code class="codehilite"><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_ops</span></code> is true, and it will try to read <code class="codehilite"><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_ops</span><span class="o">-&gt;</span><span class="n">fault</span></code>. And that, my friend, is where garbage turns into crash.</p>
<p>This presents a series of potential bugs. Ugh, <code class="codehilite"><span class="n">memory</span> <span class="n">safety</span></code>!</p>
<hr />
<h2 id="0209-fri-cloudy"><code class="codehilite"><span class="mi">02</span><span class="o">/</span><span class="mi">09</span> <span class="n">Fri</span> <span class="n">Cloudy</span></code><a class="headerlink" href="#0209-fri-cloudy" title="Permanent link">&para;</a></h2>
<p>Tried to modify Phoneix code: replace <code class="codehilite"><span class="n">realloc</span></code> with <code class="codehilite"><span class="n">malloc</span><span class="o">+</span><span class="n">mempcy</span></code>. Thus the <code class="codehilite"><span class="n">mremap</span></code> syscall is avoided, but it still has general protection fault. Same with yesterday, corrupted at <code class="codehilite"><span class="n">__strcmp_sse42</span></code>, with corrupted <code class="codehilite"><span class="n">RSI</span></code> or <code class="codehilite"><span class="n">RDI</span></code>. So I guess it is not about <code class="codehilite"><span class="n">mremap</span></code> itself at all. I will follow yesterday&rsquo;s checking list.</p>
<hr />
<h2 id="0208-thur-cloudy"><code class="codehilite"><span class="mi">02</span><span class="o">/</span><span class="mi">08</span> <span class="n">Thur</span> <span class="n">Cloudy</span></code><a class="headerlink" href="#0208-thur-cloudy" title="Permanent link">&para;</a></h2>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="mi">00000000004272</span><span class="n">d0</span> <span class="o">&lt;</span><span class="n">__strcmp_sse42</span><span class="o">&gt;</span><span class="p">:</span>

  <span class="mi">4272</span><span class="n">d0</span><span class="p">:</span>       <span class="mi">89</span> <span class="n">f1</span>                   <span class="n">mov</span>    <span class="o">%</span><span class="n">esi</span><span class="p">,</span><span class="o">%</span><span class="n">ecx</span>
  <span class="mi">4272</span><span class="n">d2</span><span class="p">:</span>       <span class="mi">89</span> <span class="n">f8</span>                   <span class="n">mov</span>    <span class="o">%</span><span class="n">edi</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span>
  <span class="mi">4272</span><span class="n">d4</span><span class="p">:</span>       <span class="mi">48</span> <span class="mi">83</span> <span class="n">e1</span> <span class="mi">3</span><span class="n">f</span>             <span class="k">and</span>    <span class="err">$</span><span class="mi">0</span><span class="n">x3f</span><span class="p">,</span><span class="o">%</span><span class="n">rcx</span>
  <span class="mi">4272</span><span class="n">d8</span><span class="p">:</span>       <span class="mi">48</span> <span class="mi">83</span> <span class="n">e0</span> <span class="mi">3</span><span class="n">f</span>             <span class="k">and</span>    <span class="err">$</span><span class="mi">0</span><span class="n">x3f</span><span class="p">,</span><span class="o">%</span><span class="n">rax</span>
  <span class="mi">4272</span><span class="n">dc</span><span class="p">:</span>       <span class="mi">83</span> <span class="n">f9</span> <span class="mi">30</span>                <span class="n">cmp</span>    <span class="err">$</span><span class="mi">0</span><span class="n">x30</span><span class="p">,</span><span class="o">%</span><span class="n">ecx</span>
  <span class="mi">4272</span><span class="n">df</span><span class="p">:</span>       <span class="mi">77</span> <span class="mi">3</span><span class="n">f</span>                   <span class="n">ja</span>     <span class="mi">427320</span> <span class="o">&lt;</span><span class="n">__strcmp_sse42</span><span class="o">+</span><span class="mi">0</span><span class="n">x50</span><span class="o">&gt;</span>
  <span class="mi">4272</span><span class="n">e1</span><span class="p">:</span>       <span class="mi">83</span> <span class="n">f8</span> <span class="mi">30</span>                <span class="n">cmp</span>    <span class="err">$</span><span class="mi">0</span><span class="n">x30</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span>
  <span class="mi">4272</span><span class="n">e4</span><span class="p">:</span>       <span class="mi">77</span> <span class="mi">3</span><span class="n">a</span>                   <span class="n">ja</span>     <span class="mi">427320</span> <span class="o">&lt;</span><span class="n">__strcmp_sse42</span><span class="o">+</span><span class="mi">0</span><span class="n">x50</span><span class="o">&gt;</span>
  <span class="mi">4272</span><span class="n">e6</span><span class="p">:</span>       <span class="n">f3</span> <span class="mi">0</span><span class="n">f</span> <span class="mi">6</span><span class="n">f</span> <span class="mi">0</span><span class="n">f</span>             <span class="n">movdqu</span> <span class="p">(</span><span class="o">%</span><span class="n">rdi</span><span class="p">),</span><span class="o">%</span><span class="n">xmm1</span>
<span class="hll"><span class="o">*</span> <span class="mi">4272</span><span class="n">ea</span><span class="p">:</span>       <span class="n">f3</span> <span class="mi">0</span><span class="n">f</span> <span class="mi">6</span><span class="n">f</span> <span class="mi">16</span>             <span class="n">movdqu</span> <span class="p">(</span><span class="o">%</span><span class="n">rsi</span><span class="p">),</span><span class="o">%</span><span class="n">xmm2</span>
</span>  <span class="mi">4272</span><span class="n">ee</span><span class="p">:</span>       <span class="mi">66</span> <span class="mi">0</span><span class="n">f</span> <span class="n">ef</span> <span class="n">c0</span>             <span class="n">pxor</span>   <span class="o">%</span><span class="n">xmm0</span><span class="p">,</span><span class="o">%</span><span class="n">xmm0</span>
  <span class="mi">4272</span><span class="n">f2</span><span class="p">:</span>       <span class="mi">66</span> <span class="mi">0</span><span class="n">f</span> <span class="mi">74</span> <span class="n">c1</span>             <span class="n">pcmpeqb</span> <span class="o">%</span><span class="n">xmm1</span><span class="p">,</span><span class="o">%</span><span class="n">xmm0</span>
  <span class="mi">4272</span><span class="n">f6</span><span class="p">:</span>       <span class="mi">66</span> <span class="mi">0</span><span class="n">f</span> <span class="mi">74</span> <span class="n">ca</span>             <span class="n">pcmpeqb</span> <span class="o">%</span><span class="n">xmm2</span><span class="p">,</span><span class="o">%</span><span class="n">xmm1</span>
  <span class="mi">4272</span><span class="n">fa</span><span class="p">:</span>       <span class="mi">66</span> <span class="mi">0</span><span class="n">f</span> <span class="n">f8</span> <span class="n">c8</span>             <span class="n">psubb</span>  <span class="o">%</span><span class="n">xmm0</span><span class="p">,</span><span class="o">%</span><span class="n">xmm1</span>
  <span class="mi">4272</span><span class="n">fe</span><span class="p">:</span>       <span class="mi">66</span> <span class="mi">0</span><span class="n">f</span> <span class="n">d7</span> <span class="n">d1</span>             <span class="n">pmovmskb</span> <span class="o">%</span><span class="n">xmm1</span><span class="p">,</span><span class="o">%</span><span class="n">edx</span>
  <span class="mi">427302</span><span class="p">:</span>       <span class="mi">81</span> <span class="n">ea</span> <span class="n">ff</span> <span class="n">ff</span> <span class="mi">00</span> <span class="mi">00</span>       <span class="n">sub</span>    <span class="err">$</span><span class="mi">0</span><span class="n">xffff</span><span class="p">,</span><span class="o">%</span><span class="n">edx</span>
  <span class="mi">427308</span><span class="p">:</span>       <span class="mi">0</span><span class="n">f</span> <span class="mi">85</span> <span class="mi">42</span> <span class="mi">0</span><span class="n">d</span> <span class="mi">00</span> <span class="mi">00</span>       <span class="n">jne</span>    <span class="mi">428050</span> <span class="o">&lt;</span><span class="n">__strcmp_sse42</span><span class="o">+</span><span class="mi">0</span><span class="n">xd80</span><span class="o">&gt;</span>
  <span class="mi">42730</span><span class="n">e</span><span class="p">:</span>       <span class="mi">48</span> <span class="mi">83</span> <span class="n">c6</span> <span class="mi">10</span>             <span class="k">add</span>    <span class="err">$</span><span class="mi">0</span><span class="n">x10</span><span class="p">,</span><span class="o">%</span><span class="n">rsi</span>
  <span class="mi">427312</span><span class="p">:</span>       <span class="mi">48</span> <span class="mi">83</span> <span class="n">c7</span> <span class="mi">10</span>             <span class="k">add</span>    <span class="err">$</span><span class="mi">0</span><span class="n">x10</span><span class="p">,</span><span class="o">%</span><span class="n">rdi</span>
  <span class="mi">427316</span><span class="p">:</span>       <span class="mi">66</span> <span class="mi">2</span><span class="n">e</span> <span class="mi">0</span><span class="n">f</span> <span class="mi">1</span><span class="n">f</span> <span class="mi">84</span> <span class="mi">00</span> <span class="mi">00</span>    <span class="n">nopw</span>   <span class="o">%</span><span class="n">cs</span><span class="p">:</span><span class="mi">0</span><span class="n">x0</span><span class="p">(</span><span class="o">%</span><span class="n">rax</span><span class="p">,</span><span class="o">%</span><span class="n">rax</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
  <span class="mi">42731</span><span class="n">d</span><span class="p">:</span>       <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span>  
  <span class="mi">427320</span><span class="p">:</span>       <span class="mi">48</span> <span class="mi">83</span> <span class="n">e6</span> <span class="n">f0</span>             <span class="k">and</span>    <span class="err">$</span><span class="mi">0</span><span class="n">xfffffffffffffff0</span><span class="p">,</span><span class="o">%</span><span class="n">rsi</span>
  <span class="mi">427324</span><span class="p">:</span>       <span class="mi">48</span> <span class="mi">83</span> <span class="n">e7</span> <span class="n">f0</span>             <span class="k">and</span>    <span class="err">$</span><span class="mi">0</span><span class="n">xfffffffffffffff0</span><span class="p">,</span><span class="o">%</span><span class="n">rdi</span>
  <span class="mi">427328</span><span class="p">:</span>       <span class="n">ba</span> <span class="n">ff</span> <span class="n">ff</span> <span class="mi">00</span> <span class="mi">00</span>          <span class="n">mov</span>    <span class="err">$</span><span class="mi">0</span><span class="n">xffff</span><span class="p">,</span><span class="o">%</span><span class="n">edx</span>
  <span class="mi">42732</span><span class="n">d</span><span class="p">:</span>       <span class="mi">45</span> <span class="mi">31</span> <span class="n">c0</span>                <span class="n">xor</span>    <span class="o">%</span><span class="n">r8d</span><span class="p">,</span><span class="o">%</span><span class="n">r8d</span>
  <span class="mi">427330</span><span class="p">:</span>       <span class="mi">83</span> <span class="n">e1</span> <span class="mi">0</span><span class="n">f</span>                <span class="k">and</span>    <span class="err">$</span><span class="mi">0</span><span class="n">xf</span><span class="p">,</span><span class="o">%</span><span class="n">ecx</span>
  <span class="mi">427333</span><span class="p">:</span>       <span class="mi">83</span> <span class="n">e0</span> <span class="mi">0</span><span class="n">f</span>                <span class="k">and</span>    <span class="err">$</span><span class="mi">0</span><span class="n">xf</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span>
  <span class="mi">427336</span><span class="p">:</span>       <span class="mi">66</span> <span class="mi">0</span><span class="n">f</span> <span class="n">ef</span> <span class="n">c0</span>             <span class="n">pxor</span>   <span class="o">%</span><span class="n">xmm0</span><span class="p">,</span><span class="o">%</span><span class="n">xmm0</span>
  <span class="mi">42733</span><span class="n">a</span><span class="p">:</span>       <span class="mi">39</span> <span class="n">c1</span>                   <span class="n">cmp</span>    <span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="o">%</span><span class="n">ecx</span>
  <span class="mi">42733</span><span class="k">c</span><span class="p">:</span>       <span class="mi">74</span> <span class="mi">32</span>                   <span class="n">je</span>     <span class="mi">427370</span> <span class="o">&lt;</span><span class="n">__strcmp_sse42</span><span class="o">+</span><span class="mi">0</span><span class="n">xa0</span><span class="o">&gt;</span>
  <span class="mi">42733</span><span class="n">e</span><span class="p">:</span>       <span class="mi">77</span> <span class="mi">07</span>                   <span class="n">ja</span>     <span class="mi">427347</span> <span class="o">&lt;</span><span class="n">__strcmp_sse42</span><span class="o">+</span><span class="mi">0</span><span class="n">x77</span><span class="o">&gt;</span>
  <span class="mi">427340</span><span class="p">:</span>       <span class="mi">41</span> <span class="mi">89</span> <span class="n">d0</span>                <span class="n">mov</span>    <span class="o">%</span><span class="n">edx</span><span class="p">,</span><span class="o">%</span><span class="n">r8d</span>
  <span class="mi">427343</span><span class="p">:</span>       <span class="mi">91</span>                      <span class="n">xchg</span>   <span class="o">%</span><span class="n">eax</span><span class="p">,</span><span class="o">%</span><span class="n">ecx</span>
  <span class="mi">427344</span><span class="p">:</span>       <span class="mi">48</span> <span class="mi">87</span> <span class="n">f7</span>                <span class="n">xchg</span>   <span class="o">%</span><span class="n">rsi</span><span class="p">,</span><span class="o">%</span><span class="n">rdi</span>
<span class="hll"><span class="o">*</span> <span class="mi">427347</span><span class="p">:</span>       <span class="mi">66</span> <span class="mi">0</span><span class="n">f</span> <span class="mi">6</span><span class="n">f</span> <span class="mi">17</span>             <span class="n">movdqa</span> <span class="p">(</span><span class="o">%</span><span class="n">rdi</span><span class="p">),</span><span class="o">%</span><span class="n">xmm2</span>
</span>  <span class="p">(</span><span class="n">RDI</span><span class="p">:</span> <span class="mi">0000000000000000</span><span class="p">)</span>
</pre></div>
</td></tr></table>

<p>Frustrating! What is wrong with multithread program? Because of broken FPU-switch code? of inappropriate TLB flush? of IB corrupts memory? of what? ugh?</p>
<p>I&rsquo;m done with this random guess and frustrated general protection or segfault, I need to first make sure underlying kernel is 100%  percent correct, this is a checking list:</p>
<ul>
<li>fpu save/restore<ul>
<li>always fail at some XMM instruction</li>
<li>always with corrupted RDI or RSI</li>
</ul>
</li>
<li>switch_to_asm<ul>
<li>%gs and %fs</li>
<li>switch_mm (pgd)</li>
<li>stack frame</li>
</ul>
</li>
<li>set_arch_tls (%fs)<ul>
<li>glibc&rsquo;s way of using per thread data</li>
</ul>
</li>
<li>some cpu may miss tlb flush</li>
<li>kernel entry/exit assembly<ul>
<li>current_task macro</li>
<li>stack_stratch</li>
<li>per-cpu data in entry.S</li>
</ul>
</li>
<li>futex<ul>
<li>clear_tid</li>
<li>set_tid</li>
<li>shared mm</li>
<li>robust list</li>
</ul>
</li>
<li>interrupts<ul>
<li>vector array</li>
<li>APIC setup</li>
<li>IO-APIC</li>
<li>timer interrupt</li>
</ul>
</li>
<li>cpu_init and Trampoline</li>
<li>faked kernel version</li>
<li>P side pgfault handling code (SMP)</li>
<li>and M side pgfault handling (SMP)</li>
<li>mremap, munmap<ul>
<li>check pgtable boundary</li>
</ul>
</li>
<li>In all, check SMP implications</li>
</ul>
<p>Is there any code, that is solely used to test if the underlying kernel has appropriate behaviors? Like glibc test code?</p>
<p>How to protect kernel virtual memory? Any existing solutions in Linux?</p>
<p>What is the implication of multiple CPU entering kernel at the same time? How can it corrupt user pages? Maybe: kernel entry code, per-cpu data in entry code, fpu code, switch_to, scheduler.</p>
<p>Why it always fail at those FPU code i.e. the strcmp function? I failed to compile without those sse, any solution? How it hurt performance?</p>
<hr />
<h2 id="0207-wed-cloudy"><code class="codehilite"><span class="mi">02</span><span class="o">/</span><span class="mi">07</span> <span class="n">Wed</span> <span class="n">Cloudy</span></code><a class="headerlink" href="#0207-wed-cloudy" title="Permanent link">&para;</a></h2>
<p><code class="codehilite"><span class="mi">20</span><span class="o">:</span><span class="mi">07</span></code><br />
Pushed a small patch on mremap issue. Hope it will work. mremap really makes the whole thing very interesting, will be a very good research finding on combing virtual cache and operating system. Need to go gym with a friend, will be back on debugging late tonight.</p>
<p><code class="codehilite"><span class="mi">9</span><span class="o">:</span><span class="mi">30</span></code><br />
Have two meetings to do today, and an security class, won&rsquo;t have too much time coding during daytime.</p>
<hr />
<h2 id="0206-tue-sunny"><code class="codehilite"><span class="mi">02</span><span class="o">/</span><span class="mi">06</span> <span class="n">Tue</span> <span class="n">Sunny</span></code><a class="headerlink" href="#0206-tue-sunny" title="Permanent link">&para;</a></h2>
<p>Well. We&rsquo;ve ruled out both <code class="codehilite"><span class="n">smp_call_function</span></code> and <code class="codehilite"><span class="n">workqueue</span></code> yesterday with Yiying&rsquo;s help. But the multi-thread word-count still fails <code class="codehilite"><span class="p">:-(</span></code> Single thread word-count just finished 4GB dataset (with 8GB pcache). So what could be still wrong with multithread one????</p>
<ul>
<li>chill</li>
<li>check exit code</li>
<li><code class="codehilite"><span class="p">(</span><span class="k">Checked</span><span class="p">)</span></code> check pcache&rsquo;s usage of task_struct, should always use the group_leader</li>
<li>check cpu boot code and check the switch code again</li>
<li>I believe pinpoint the issue in multithread word-count can solve a lot issues, it must be some thread creation, removal, schedule things.</li>
<li>How about adding a lock for ibapi, make it sequential? Sweet, I tried, finally it is <code class="codehilite"><span class="n">a</span> <span class="n">bug</span> <span class="n">that</span> <span class="n">we</span> <span class="k">are</span> <span class="n">able</span> <span class="k">to</span> <span class="n">debug</span></code>.</li>
</ul>
<p><code class="codehilite"><span class="mi">22</span><span class="o">:</span><span class="mi">39</span></code><br />
Done for today. I&rsquo;m trying to patch <code class="codehilite"><span class="n">move_pte</span></code> and <code class="codehilite"><span class="n">pcache_move_pte</span></code>. Although in theory we defenitly need to patch it, I keep thinking the code before should not trigger any serious bus or memory corruption. Ugh. Maybe it is concurrent <code class="codehilite"><span class="n">mremap</span></code> that one of them remap from A to B, while another one remap from C to A. It is possible. But my dead brain can not think of this anymore. I&rsquo;m going to hit the gym and do some squats.</p>
<p><code class="codehilite"><span class="mi">17</span><span class="o">:</span><span class="mi">01</span></code><br />
Criminal found: <code class="codehilite"><span class="n">mremap</span><span class="p">()</span></code> and <code class="codehilite"><span class="n">virtual</span> <span class="k">cache</span></code> did the crime. Interesting, I have not seen any research paper, tech-reports, writeup, code about this, not even the OVC paper, which, by the way, I think they must consider this case. Otherwise, a mremap will simply crash its virtual cache. Many thanks went to my smoke-and-think time.</p>
<p><code class="codehilite"><span class="mi">15</span><span class="o">:</span><span class="mi">14</span></code><br />
Something new came up! After adding a spinlock for ibapi, this showed up (I tried one more time after this, which does not show up). We are lucky to catch this. At least I know where to look at. Also, this is defenitly triggered by <code class="codehilite"><span class="n">mremap</span></code>. It is seems it is overlapped <code class="codehilite"><span class="n">mremap</span><span class="p">()</span></code>. One thing I did not know is which thread trigger this bug, the sweep thread? Cause mremap related pcache rmap functions do not use <code class="codehilite"><span class="n">rmap_get_locked_pte</span></code>.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="p">[</span> <span class="mi">3826</span><span class="p">.</span><span class="mi">048774</span><span class="p">]</span> <span class="n">normal_p2s_open</span><span class="p">():</span> <span class="n">f_name</span><span class="p">:</span> <span class="n">word_100MB</span><span class="p">.</span><span class="n">txt</span><span class="p">,</span> <span class="k">mode</span><span class="p">:</span> <span class="mi">04400</span><span class="p">,</span> <span class="n">flags</span><span class="p">:</span> <span class="mi">0</span>
<span class="p">[</span> <span class="mi">3827</span><span class="p">.</span><span class="mi">891622</span><span class="p">]</span> <span class="n">SYSC_mremap</span><span class="p">(</span><span class="n">cpu18</span><span class="p">):</span> <span class="k">move</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="n">x7fffe5788000</span> <span class="o">-</span> <span class="mi">0</span><span class="n">x7fffe5806000</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="mi">0</span><span class="n">x7fffe531b000</span> <span class="o">-</span> <span class="mi">0</span><span class="n">x7fffe5399000</span><span class="p">]</span>
<span class="p">[</span> <span class="mi">3828</span><span class="p">.</span><span class="mi">178643</span><span class="p">]</span> <span class="n">SYSC_mremap</span><span class="p">(</span><span class="n">cpu14</span><span class="p">):</span> <span class="k">move</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="n">x7fffe5941000</span> <span class="o">-</span> <span class="mi">0</span><span class="n">x7fffe5980000</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="mi">0</span><span class="n">x7fffe57c7000</span> <span class="o">-</span> <span class="mi">0</span><span class="n">x7fffe5806000</span><span class="p">]</span>

<span class="o">****</span>    <span class="n">ERROR</span><span class="p">:</span> <span class="n">mismatched</span> <span class="n">PTE</span> <span class="k">and</span> <span class="n">rmap</span>
<span class="o">****</span>    <span class="n">rmap</span><span class="o">-&gt;</span><span class="n">owner_process</span><span class="p">:</span> <span class="n">word_count</span><span class="o">-</span><span class="n">pthr</span> <span class="n">uva</span><span class="p">:</span> <span class="mi">0</span><span class="n">x7fffe57c8000</span> <span class="n">ptep</span><span class="p">:</span> <span class="n">ffff88107efe0e40</span><span class="p">,</span> <span class="n">rmap</span><span class="o">-&gt;</span><span class="n">page_table</span><span class="p">:</span> <span class="n">ffff88107efe0e40</span>
<span class="o">****</span>    <span class="n">pcache_pfn</span><span class="p">:</span> <span class="mi">0</span><span class="n">x1257c8</span><span class="p">,</span> <span class="n">pte_pfn</span><span class="p">:</span> <span class="mi">0</span><span class="n">x125942</span>
</pre></div>
</td></tr></table>

<p><code class="codehilite"><span class="mi">14</span><span class="o">:</span><span class="mi">00</span></code> <br />
<code class="codehilite"><span class="n">word_count</span><span class="o">-</span><span class="n">pthread</span></code>: 100MB dataset
<code class="codehilite"><span class="n">pcache</span></code>: 8GB, 8-way
<code class="codehilite"><span class="n">victim</span></code>: 8 entries
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="p">[</span> <span class="mi">1294</span><span class="p">.</span><span class="mi">845313</span><span class="p">]</span> <span class="k">STDOUT</span><span class="p">:</span> <span class="c1">---[</span>
<span class="n">Wordcount</span><span class="p">:</span> <span class="n">Running</span><span class="p">...</span>
<span class="p">]</span><span class="c1">---</span>
<span class="p">[</span> <span class="mi">1294</span><span class="p">.</span><span class="mi">903661</span><span class="p">]</span> <span class="k">STDOUT</span><span class="p">:</span> <span class="c1">---[</span>

<span class="n">o</span><span class="p">;</span>
<span class="p">]</span><span class="c1">---</span>
<span class="p">[</span> <span class="mi">1294</span><span class="p">.</span><span class="mi">946301</span><span class="p">]</span> <span class="n">normal_p2s_open</span><span class="p">():</span> <span class="n">f_name</span><span class="p">:</span> <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">ys</span><span class="o">/</span><span class="n">phoenix</span><span class="o">/</span><span class="n">phoenix</span><span class="o">-</span><span class="mi">2</span><span class="p">.</span><span class="mi">0</span><span class="o">/</span><span class="n">tests</span><span class="o">/</span><span class="n">word_count</span><span class="o">/</span><span class="n">word_count_datafiles</span><span class="o">/</span><span class="n">word_100MB</span><span class="p">.</span><span class="n">txt</span><span class="p">,</span> <span class="k">mode</span><span class="p">:</span> <span class="mi">04400</span><span class="p">,</span> <span class="n">flags</span><span class="p">:</span> <span class="mi">0</span>
<span class="p">[</span> <span class="mi">1295</span><span class="p">.</span><span class="mi">100517</span><span class="p">]</span> <span class="n">SYSC_close</span><span class="p">():</span> <span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">devices</span><span class="o">/</span><span class="k">system</span><span class="o">/</span><span class="n">cpu</span><span class="o">/</span><span class="n">online</span><span class="p">]</span>
<span class="p">[</span> <span class="mi">1295</span><span class="p">.</span><span class="mi">594658</span><span class="p">]</span> <span class="n">word_count</span><span class="o">-</span><span class="n">pthr</span><span class="p">[</span><span class="mi">59</span><span class="p">]</span> <span class="k">general</span> <span class="n">protection</span> <span class="n">ip</span><span class="p">:</span><span class="mi">4272</span><span class="n">ea</span> <span class="n">sp</span><span class="p">:</span><span class="mi">7</span><span class="n">ffff1b8ed28</span> <span class="n">error</span><span class="p">:</span><span class="mi">0</span>
<span class="p">[</span> <span class="mi">1295</span><span class="p">.</span><span class="mi">685236</span><span class="p">]</span> <span class="n">CPU</span><span class="p">:</span> <span class="mi">10</span> <span class="n">PID</span><span class="p">:</span> <span class="mi">59</span> <span class="n">Comm</span><span class="p">:</span> <span class="n">word_count</span><span class="o">-</span><span class="n">pthr</span> <span class="mi">4</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="o">-</span><span class="n">lego</span><span class="o">+</span> <span class="o">#</span><span class="mi">113</span>
<span class="p">[</span> <span class="mi">1295</span><span class="p">.</span><span class="mi">759070</span><span class="p">]</span> <span class="n">RIP</span><span class="p">:</span> <span class="mi">0033</span><span class="p">:[</span><span class="o">&lt;</span><span class="mi">00000000004272</span><span class="n">ea</span><span class="o">&gt;</span><span class="p">]</span>  <span class="p">[</span><span class="o">&lt;</span><span class="mi">00000000004272</span><span class="n">ea</span><span class="o">&gt;</span><span class="p">]</span> <span class="mi">0</span><span class="n">x4272ea</span>
<span class="p">[</span> <span class="mi">1295</span><span class="p">.</span><span class="mi">840184</span><span class="p">]</span> <span class="n">RSP</span><span class="p">:</span> <span class="mi">002</span><span class="n">b</span><span class="p">:</span><span class="mi">00007</span><span class="n">ffff1b8ed28</span>  <span class="n">EFLAGS</span><span class="p">:</span> <span class="mi">00010283</span>
<span class="p">[</span> <span class="mi">1295</span><span class="p">.</span><span class="mi">903621</span><span class="p">]</span> <span class="n">RAX</span><span class="p">:</span> <span class="mi">000000000000000</span><span class="n">f</span> <span class="n">RBX</span><span class="p">:</span> <span class="mi">00007</span><span class="n">fffe5a3d010</span> <span class="n">RCX</span><span class="p">:</span> <span class="mi">0000000000000001</span>
<span class="p">[</span> <span class="mi">1295</span><span class="p">.</span><span class="mi">988893</span><span class="p">]</span> <span class="n">RDX</span><span class="p">:</span> <span class="mi">0000000000000000</span> <span class="n">RSI</span><span class="p">:</span> <span class="mi">4854005942004441</span> <span class="n">RDI</span><span class="p">:</span> <span class="mi">00007</span><span class="n">ffff1c1e80f</span>
<span class="p">[</span> <span class="mi">1296</span><span class="p">.</span><span class="mi">074166</span><span class="p">]</span> <span class="n">RBP</span><span class="p">:</span> <span class="mi">00007</span><span class="n">ffff1c1e80f</span> <span class="n">R08</span><span class="p">:</span> <span class="mi">0000000000000000</span> <span class="n">R09</span><span class="p">:</span> <span class="mi">0000000000000010</span>
<span class="p">[</span> <span class="mi">1296</span><span class="p">.</span><span class="mi">211435</span><span class="p">]</span> <span class="n">R10</span><span class="p">:</span> <span class="mi">0000000000427</span><span class="n">ce0</span> <span class="n">R11</span><span class="p">:</span> <span class="mi">00007</span><span class="n">ffff1bbb3ba</span> <span class="n">R12</span><span class="p">:</span> <span class="mi">0000000000001</span><span class="n">de4</span>
<span class="p">[</span> <span class="mi">1296</span><span class="p">.</span><span class="mi">296711</span><span class="p">]</span> <span class="n">R13</span><span class="p">:</span> <span class="mi">00000000006</span><span class="n">e4a80</span> <span class="n">R14</span><span class="p">:</span> <span class="mi">0000000000001</span><span class="n">d9e</span> <span class="n">R15</span><span class="p">:</span> <span class="mi">0000000000001</span><span class="n">dc1</span>
<span class="p">[</span> <span class="mi">1296</span><span class="p">.</span><span class="mi">433978</span><span class="p">]</span> <span class="n">FS</span><span class="p">:</span>  <span class="mi">00007</span><span class="n">ffff1b8f700</span><span class="p">(</span><span class="mi">0000</span><span class="p">)</span> <span class="n">GS</span><span class="p">:</span><span class="n">ffff88107fca0000</span><span class="p">(</span><span class="mi">0000</span><span class="p">)</span> <span class="n">knlGS</span><span class="p">:</span><span class="mi">0000000000000000</span>
<span class="p">[</span> <span class="mi">1296</span><span class="p">.</span><span class="mi">582686</span><span class="p">]</span> <span class="n">CS</span><span class="p">:</span>  <span class="mi">0010</span> <span class="n">DS</span><span class="p">:</span> <span class="mi">0000</span> <span class="n">ES</span><span class="p">:</span> <span class="mi">0000</span> <span class="n">CR0</span><span class="p">:</span> <span class="mi">0000000080050033</span>
<span class="p">[</span> <span class="mi">1296</span><span class="p">.</span><span class="mi">963297</span><span class="p">]</span> <span class="n">CR2</span><span class="p">:</span> <span class="mi">00007</span><span class="n">ffff1c1e000</span> <span class="n">CR3</span><span class="p">:</span> <span class="mi">000000207</span><span class="n">fd8a000</span> <span class="n">CR4</span><span class="p">:</span> <span class="mi">00000000000406</span><span class="n">a0</span>
</pre></div>
</td></tr></table>
So what is this <code class="codehilite"><span class="n">ip</span><span class="o">:</span><span class="mi">4272</span><span class="n">ea</span></code>, let us objdump the binary:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="mi">0000000000425</span><span class="n">e60</span> <span class="o">&lt;</span><span class="n">strcmp</span><span class="o">&gt;</span><span class="p">:</span>
  <span class="mi">425</span><span class="n">e60</span><span class="p">:</span>       <span class="mi">48</span> <span class="mi">8</span><span class="n">d</span> <span class="mi">05</span> <span class="mi">69</span> <span class="mi">14</span> <span class="mi">00</span> <span class="mi">00</span>    <span class="n">lea</span>    <span class="mi">0</span><span class="n">x1469</span><span class="p">(</span><span class="o">%</span><span class="n">rip</span><span class="p">),</span><span class="o">%</span><span class="n">rax</span>        <span class="o">#</span> <span class="mi">4272</span><span class="n">d0</span> <span class="o">&lt;</span><span class="n">__strcmp_sse42</span><span class="o">&gt;</span>
  <span class="mi">425</span><span class="n">e67</span><span class="p">:</span>       <span class="n">f7</span> <span class="mi">05</span> <span class="mi">5</span><span class="n">f</span> <span class="n">b8</span> <span class="mi">2</span><span class="n">b</span> <span class="mi">00</span> <span class="mi">00</span>    <span class="n">testl</span>  <span class="err">$</span><span class="mi">0</span><span class="n">x100000</span><span class="p">,</span><span class="mi">0</span><span class="n">x2bb85f</span><span class="p">(</span><span class="o">%</span><span class="n">rip</span><span class="p">)</span>        <span class="o">#</span> <span class="mi">6</span><span class="n">e16d0</span> <span class="o">&lt;</span><span class="n">_dl_x86_cpu_features</span><span class="o">+</span><span class="mi">0</span><span class="n">x10</span><span class="o">&gt;</span>
  <span class="mi">425</span><span class="n">e6e</span><span class="p">:</span>       <span class="mi">00</span> <span class="mi">10</span> <span class="mi">00</span>
  <span class="mi">425</span><span class="n">e71</span><span class="p">:</span>       <span class="mi">75</span> <span class="mi">1</span><span class="n">a</span>                   <span class="n">jne</span>    <span class="mi">425</span><span class="n">e8d</span> <span class="o">&lt;</span><span class="n">strcmp</span><span class="o">+</span><span class="mi">0</span><span class="n">x2d</span><span class="o">&gt;</span>
  <span class="mi">425</span><span class="n">e73</span><span class="p">:</span>       <span class="mi">48</span> <span class="mi">8</span><span class="n">d</span> <span class="mi">05</span> <span class="mi">46</span> <span class="n">b0</span> <span class="mi">00</span> <span class="mi">00</span>    <span class="n">lea</span>    <span class="mi">0</span><span class="n">xb046</span><span class="p">(</span><span class="o">%</span><span class="n">rip</span><span class="p">),</span><span class="o">%</span><span class="n">rax</span>        <span class="o">#</span> <span class="mi">430</span><span class="n">ec0</span> <span class="o">&lt;</span><span class="n">__strcmp_ssse3</span><span class="o">&gt;</span>
  <span class="mi">425</span><span class="n">e7a</span><span class="p">:</span>       <span class="n">f7</span> <span class="mi">05</span> <span class="mi">4</span><span class="k">c</span> <span class="n">b8</span> <span class="mi">2</span><span class="n">b</span> <span class="mi">00</span> <span class="mi">00</span>    <span class="n">testl</span>  <span class="err">$</span><span class="mi">0</span><span class="n">x200</span><span class="p">,</span><span class="mi">0</span><span class="n">x2bb84c</span><span class="p">(</span><span class="o">%</span><span class="n">rip</span><span class="p">)</span>        <span class="o">#</span> <span class="mi">6</span><span class="n">e16d0</span> <span class="o">&lt;</span><span class="n">_dl_x86_cpu_features</span><span class="o">+</span><span class="mi">0</span><span class="n">x10</span><span class="o">&gt;</span>
  <span class="mi">425</span><span class="n">e81</span><span class="p">:</span>       <span class="mi">02</span> <span class="mi">00</span> <span class="mi">00</span>
  <span class="mi">425</span><span class="n">e84</span><span class="p">:</span>       <span class="mi">75</span> <span class="mi">07</span>                   <span class="n">jne</span>    <span class="mi">425</span><span class="n">e8d</span> <span class="o">&lt;</span><span class="n">strcmp</span><span class="o">+</span><span class="mi">0</span><span class="n">x2d</span><span class="o">&gt;</span>
  <span class="mi">425</span><span class="n">e86</span><span class="p">:</span>       <span class="mi">48</span> <span class="mi">8</span><span class="n">d</span> <span class="mi">05</span> <span class="mi">03</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span>    <span class="n">lea</span>    <span class="mi">0</span><span class="n">x3</span><span class="p">(</span><span class="o">%</span><span class="n">rip</span><span class="p">),</span><span class="o">%</span><span class="n">rax</span>        <span class="o">#</span> <span class="mi">425</span><span class="n">e90</span> <span class="o">&lt;</span><span class="n">__GI_strcmp</span><span class="o">&gt;</span>
  <span class="mi">425</span><span class="n">e8d</span><span class="p">:</span>       <span class="n">c3</span>                      <span class="n">retq</span>
  <span class="mi">425</span><span class="n">e8e</span><span class="p">:</span>       <span class="mi">66</span> <span class="mi">90</span>                   <span class="n">xchg</span>   <span class="o">%</span><span class="n">ax</span><span class="p">,</span><span class="o">%</span><span class="n">ax</span>
 <span class="p">..</span> <span class="p">..</span>
 <span class="p">..</span> <span class="p">..</span>
<span class="mi">00000000004272</span><span class="n">d0</span> <span class="o">&lt;</span><span class="n">__strcmp_sse42</span><span class="o">&gt;</span><span class="p">:</span>
  <span class="mi">4272</span><span class="n">d0</span><span class="p">:</span>       <span class="mi">89</span> <span class="n">f1</span>                   <span class="n">mov</span>    <span class="o">%</span><span class="n">esi</span><span class="p">,</span><span class="o">%</span><span class="n">ecx</span>
  <span class="mi">4272</span><span class="n">d2</span><span class="p">:</span>       <span class="mi">89</span> <span class="n">f8</span>                   <span class="n">mov</span>    <span class="o">%</span><span class="n">edi</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span>
  <span class="mi">4272</span><span class="n">d4</span><span class="p">:</span>       <span class="mi">48</span> <span class="mi">83</span> <span class="n">e1</span> <span class="mi">3</span><span class="n">f</span>             <span class="k">and</span>    <span class="err">$</span><span class="mi">0</span><span class="n">x3f</span><span class="p">,</span><span class="o">%</span><span class="n">rcx</span>
  <span class="mi">4272</span><span class="n">d8</span><span class="p">:</span>       <span class="mi">48</span> <span class="mi">83</span> <span class="n">e0</span> <span class="mi">3</span><span class="n">f</span>             <span class="k">and</span>    <span class="err">$</span><span class="mi">0</span><span class="n">x3f</span><span class="p">,</span><span class="o">%</span><span class="n">rax</span>
  <span class="mi">4272</span><span class="n">dc</span><span class="p">:</span>       <span class="mi">83</span> <span class="n">f9</span> <span class="mi">30</span>                <span class="n">cmp</span>    <span class="err">$</span><span class="mi">0</span><span class="n">x30</span><span class="p">,</span><span class="o">%</span><span class="n">ecx</span>
  <span class="mi">4272</span><span class="n">df</span><span class="p">:</span>       <span class="mi">77</span> <span class="mi">3</span><span class="n">f</span>                   <span class="n">ja</span>     <span class="mi">427320</span> <span class="o">&lt;</span><span class="n">__strcmp_sse42</span><span class="o">+</span><span class="mi">0</span><span class="n">x50</span><span class="o">&gt;</span>
  <span class="mi">4272</span><span class="n">e1</span><span class="p">:</span>       <span class="mi">83</span> <span class="n">f8</span> <span class="mi">30</span>                <span class="n">cmp</span>    <span class="err">$</span><span class="mi">0</span><span class="n">x30</span><span class="p">,</span><span class="o">%</span><span class="n">eax</span>
  <span class="mi">4272</span><span class="n">e4</span><span class="p">:</span>       <span class="mi">77</span> <span class="mi">3</span><span class="n">a</span>                   <span class="n">ja</span>     <span class="mi">427320</span> <span class="o">&lt;</span><span class="n">__strcmp_sse42</span><span class="o">+</span><span class="mi">0</span><span class="n">x50</span><span class="o">&gt;</span>
  <span class="mi">4272</span><span class="n">e6</span><span class="p">:</span>       <span class="n">f3</span> <span class="mi">0</span><span class="n">f</span> <span class="mi">6</span><span class="n">f</span> <span class="mi">0</span><span class="n">f</span>             <span class="n">movdqu</span> <span class="p">(</span><span class="o">%</span><span class="n">rdi</span><span class="p">),</span><span class="o">%</span><span class="n">xmm1</span>
<span class="o">*</span> <span class="mi">4272</span><span class="n">ea</span><span class="p">:</span>       <span class="n">f3</span> <span class="mi">0</span><span class="n">f</span> <span class="mi">6</span><span class="n">f</span> <span class="mi">16</span>             <span class="n">movdqu</span> <span class="p">(</span><span class="o">%</span><span class="n">rsi</span><span class="p">),</span><span class="o">%</span><span class="n">xmm2</span>
  <span class="mi">4272</span><span class="n">ee</span><span class="p">:</span>       <span class="mi">66</span> <span class="mi">0</span><span class="n">f</span> <span class="n">ef</span> <span class="n">c0</span>             <span class="n">pxor</span>   <span class="o">%</span><span class="n">xmm0</span><span class="p">,</span><span class="o">%</span><span class="n">xmm0</span>
</pre></div>
</td></tr></table>
You can see <code class="codehilite"><span class="nf">%rsi</span></code> has some garbage value <code class="codehilite"><span class="n">RSI</span><span class="o">:</span> <span class="mi">4854005942004441</span></code>. Something went wrong. Will it be our FPU? I&rsquo;m not quite sure. If FPU code has error, why single-thread one succeed? Why it only shows up at multithread ones?</p>
<hr />
<h2 id="0205-mon-sunny"><code class="codehilite"><span class="mi">02</span><span class="o">/</span><span class="mi">05</span> <span class="n">Mon</span> <span class="n">Sunny</span></code><a class="headerlink" href="#0205-mon-sunny" title="Permanent link">&para;</a></h2>
<p>From yesterday&rsquo;s testing of Phoenix, it looks like something is wrong in <code class="codehilite"><span class="n">smp_call_functions</span><span class="p">()</span></code>. They are invoked through <code class="codehilite"><span class="n">tlb</span> <span class="n">flush</span></code>, which was further invoked by <code class="codehilite"><span class="n">mremap</span></code>, or <code class="codehilite"><span class="n">munmap</span></code>. The warning from smp is:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="p">[</span> <span class="mf">1260.586696</span><span class="p">]</span> <span class="nl">WARNING</span><span class="p">:</span> <span class="nl">CPU</span><span class="p">:</span> <span class="mi">0</span> <span class="nl">PID</span><span class="p">:</span> <span class="mi">73</span> <span class="n">at</span> <span class="n">kernel</span><span class="o">/</span><span class="n">smp</span><span class="p">.</span><span class="nl">c</span><span class="p">:</span><span class="mi">129</span> <span class="n">generic_smp_call_function_single_interrupt</span><span class="o">+</span><span class="mh">0xb8</span><span class="o">/</span><span class="mh">0x160</span>
<span class="p">[</span> <span class="mf">1260.705251</span><span class="p">]</span> <span class="nl">CPU</span><span class="p">:</span> <span class="mi">0</span> <span class="nl">PID</span><span class="p">:</span> <span class="mi">73</span> <span class="nl">Comm</span><span class="p">:</span> <span class="n">word_count</span><span class="o">-</span><span class="n">pthr</span> <span class="mf">4.0.0</span><span class="o">-</span><span class="n">lego</span><span class="o">+</span> <span class="err">#</span><span class="mi">99</span>
<span class="p">[</span> <span class="mf">1260.777008</span><span class="p">]</span> <span class="nl">Stack</span><span class="p">:</span>
<span class="p">[</span> <span class="mf">1260.800927</span><span class="p">]</span> <span class="n">ffff88207fdffef8</span> <span class="n">ffffffff8100ec67</span> <span class="n">ffff88107fc00000</span> <span class="n">ffff88107fc00000</span>
<span class="p">[</span> <span class="mf">1260.888283</span><span class="p">]</span> <span class="n">ffffffff8100d410</span> <span class="n">ffff88207fe23df0</span> <span class="n">ffff88207fdfff08</span> <span class="n">ffffffff8100ed5f</span>
<span class="p">[</span> <span class="mf">1260.975639</span><span class="p">]</span> <span class="n">ffff88207fdfff38</span> <span class="n">ffffffff8100fe68</span> <span class="mf">00007ff</span><span class="n">fe58c3010</span> <span class="mf">0000000000000f</span><span class="mi">96</span>
<span class="p">[</span> <span class="mf">1261.062995</span><span class="p">]</span> <span class="mf">000000000000f</span><span class="mi">960</span> <span class="mf">0000000000000f</span><span class="mi">95</span> <span class="n">ffff88207fdfff48</span> <span class="n">ffffffff810020dd</span>
<span class="p">[</span> <span class="mf">1261.150351</span><span class="p">]</span> <span class="mf">00007ff</span><span class="n">ff58869c1</span> <span class="n">ffffffff8100b2e9</span> <span class="mf">0000000000000f</span><span class="mi">96</span> <span class="mf">0000000000000f</span><span class="mi">95</span>
<span class="p">[</span> <span class="mf">1261.237707</span><span class="p">]</span> <span class="n">Call</span> <span class="nl">Trace</span><span class="p">:</span>
<span class="p">[</span> <span class="mf">1261.266825</span><span class="p">]</span> <span class="o">&lt;</span><span class="n">TSK</span><span class="o">&gt;</span>
<span class="p">[</span> <span class="mf">1261.289704</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8100ec76</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">__warn</span><span class="p">.</span><span class="n">constprop</span><span class="mf">.0</span><span class="o">+</span><span class="mh">0xa6</span><span class="o">/</span><span class="mh">0x100</span>
<span class="p">[</span> <span class="mf">1261.359381</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8100d410</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">?</span> <span class="n">pgd_free</span><span class="o">+</span><span class="mh">0x90</span><span class="o">/</span><span class="mh">0x90</span>
<span class="p">[</span> <span class="mf">1261.419699</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8100ed5f</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">warn_slowpath_null</span><span class="o">+</span><span class="mh">0xf</span><span class="o">/</span><span class="mh">0x20</span>
<span class="p">[</span> <span class="mf">1261.487295</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8100fe68</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">generic_smp_call_function_single_interrupt</span><span class="o">+</span><span class="mh">0xb8</span><span class="o">/</span><span class="mh">0x160</span>
<span class="p">[</span> <span class="mf">1261.581931</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff810020dd</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">call_function_interrupt</span><span class="o">+</span><span class="mh">0x1d</span><span class="o">/</span><span class="mh">0x20</span>
<span class="p">[</span> <span class="mf">1261.655767</span><span class="p">]</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ffffffff8100b2e9</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">smp__call_function_interrupt</span><span class="o">+</span><span class="mh">0x69</span><span class="o">/</span><span class="mh">0x70</span>
</pre></div>
</td></tr></table>

<p>So I decided to look into smp.c a little bit to find out if there is something wrong (I wrote it long time ago). The warning itself is true, it means some inconsistent behavior.. I saw <code class="codehilite"><span class="n">alloc_percpu</span></code> stuff during <code class="codehilite"><span class="n">call_function_init</span></code>, hence probably I also need to check percpu code a little code cause I&rsquo;m not sure if I port all the functionalities.</p>
<p>In all, today&rsquo;s task, check <code class="codehilite"><span class="n">percpu</span></code> and <code class="codehilite"><span class="n">smp_call_function</span></code> code. Esp, <code class="codehilite"><span class="n">percpu</span></code> code, they are crucial and very hard to relate real bugs to it.</p>
<p>Well&hellip; things changed. I found a more serious bug: something about <code class="codehilite"><span class="n">cpuhotplug</span></code>, even though lego is not using it. <code class="codehilite"><span class="n">cpuhotplug</span></code> is a set of implict callbacks to all different subsystems who want to do some initialization work on each <code class="codehilite"><span class="n">offline</span><span class="o">-&gt;</span><span class="n">online</span></code> cpu.</p>
<p>Let us dig into how secondary cpu boots:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">Trampoline</span><span class="p">..</span> <span class="n">setup</span> <span class="mi">64</span><span class="n">bit</span> <span class="n">mode</span>
<span class="n">start_secondary</span><span class="p">()</span>
  <span class="n">smp_callin</span><span class="p">()</span>
        <span class="n">notify_cpu_starting</span><span class="p">()</span>
              <span class="p">...</span>
              <span class="k">while</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&lt;</span> <span class="n">target</span><span class="p">)</span> <span class="p">{</span>
                      <span class="n">st</span><span class="o">-&gt;</span><span class="n">state</span><span class="o">++</span><span class="p">;</span>
                      <span class="n">cpuhp_invoke_callback</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
              <span class="p">}</span>
          <span class="n">cpuhp_invoke_callback</span><span class="p">()</span>
</pre></div>
</td></tr></table></p>
<p>See? There will be some callbacks! What are those callbacks exactly? Well, they are predefined at the <code class="codehilite"><span class="n">kernel</span><span class="o">/</span><span class="n">cpu</span><span class="p">.</span><span class="k">c</span></code>. To save the trouble of reading code, I just print what functions are executed, the log is:
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="p">[</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">118235</span><span class="p">]</span> <span class="n">cpuhp_invoke_callback</span><span class="p">():</span> <span class="mi">136</span>  <span class="n">CPU</span><span class="p">:</span><span class="mi">0</span>  <span class="n">page_writeback_cpu_online</span><span class="o">+</span><span class="mi">0</span><span class="n">x0</span><span class="o">/</span><span class="mi">0</span><span class="n">x20</span>

<span class="p">[</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">368478</span><span class="p">]</span> <span class="n">cpuhp_invoke_callback</span><span class="p">():</span> <span class="mi">136</span>  <span class="n">CPU</span><span class="p">:</span><span class="mi">1</span>  <span class="n">smpboot_create_threads</span><span class="o">+</span><span class="mi">0</span><span class="n">x0</span><span class="o">/</span><span class="mi">0</span><span class="n">x90</span>
<span class="p">[</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">370196</span><span class="p">]</span> <span class="n">cpuhp_invoke_callback</span><span class="p">():</span> <span class="mi">136</span>  <span class="n">CPU</span><span class="p">:</span><span class="mi">1</span>  <span class="n">perf_event_init_cpu</span><span class="o">+</span><span class="mi">0</span><span class="n">x0</span><span class="o">/</span><span class="mi">0</span><span class="n">xa0</span>
<span class="p">[</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">370403</span><span class="p">]</span> <span class="n">cpuhp_invoke_callback</span><span class="p">():</span> <span class="mi">136</span>  <span class="n">CPU</span><span class="p">:</span><span class="mi">1</span>  <span class="n">workqueue_prepare_cpu</span><span class="o">+</span><span class="mi">0</span><span class="n">x0</span><span class="o">/</span><span class="mi">0</span><span class="n">x80</span>
<span class="p">[</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">371112</span><span class="p">]</span> <span class="n">cpuhp_invoke_callback</span><span class="p">():</span> <span class="mi">136</span>  <span class="n">CPU</span><span class="p">:</span><span class="mi">1</span>  <span class="n">hrtimers_prepare_cpu</span><span class="o">+</span><span class="mi">0</span><span class="n">x0</span><span class="o">/</span><span class="mi">0</span><span class="n">x60</span>
<span class="p">[</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">371339</span><span class="p">]</span> <span class="n">cpuhp_invoke_callback</span><span class="p">():</span> <span class="mi">136</span>  <span class="n">CPU</span><span class="p">:</span><span class="mi">1</span>  <span class="n">smpcfd_prepare_cpu</span><span class="o">+</span><span class="mi">0</span><span class="n">x0</span><span class="o">/</span><span class="mi">0</span><span class="n">x80</span>
<span class="p">[</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">371584</span><span class="p">]</span> <span class="n">cpuhp_invoke_callback</span><span class="p">():</span> <span class="mi">136</span>  <span class="n">CPU</span><span class="p">:</span><span class="mi">1</span>  <span class="n">relay_prepare_cpu</span><span class="o">+</span><span class="mi">0</span><span class="n">x0</span><span class="o">/</span><span class="mi">0</span><span class="n">xe0</span>
<span class="p">[</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">371794</span><span class="p">]</span> <span class="n">cpuhp_invoke_callback</span><span class="p">():</span> <span class="mi">136</span>  <span class="n">CPU</span><span class="p">:</span><span class="mi">1</span>  <span class="n">rcutree_prepare_cpu</span><span class="o">+</span><span class="mi">0</span><span class="n">x0</span><span class="o">/</span><span class="mi">0</span><span class="n">x170</span>
<span class="p">[</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">372333</span><span class="p">]</span> <span class="n">cpuhp_invoke_callback</span><span class="p">():</span> <span class="mi">136</span>  <span class="n">CPU</span><span class="p">:</span><span class="mi">1</span>  <span class="n">notify_prepare</span><span class="o">+</span><span class="mi">0</span><span class="n">x0</span><span class="o">/</span><span class="mi">0</span><span class="n">xa0</span>
<span class="p">[</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">372744</span><span class="p">]</span> <span class="n">cpuhp_invoke_callback</span><span class="p">():</span> <span class="mi">136</span>  <span class="n">CPU</span><span class="p">:</span><span class="mi">1</span>  <span class="n">bringup_cpu</span><span class="o">+</span><span class="mi">0</span><span class="n">x0</span><span class="o">/</span><span class="mi">0</span><span class="n">x100</span>
<span class="p">[</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">008000</span><span class="p">]</span> <span class="n">cpuhp_invoke_callback</span><span class="p">():</span> <span class="mi">136</span>  <span class="n">CPU</span><span class="p">:</span><span class="mi">1</span>  <span class="n">sched_cpu_starting</span><span class="o">+</span><span class="mi">0</span><span class="n">x0</span><span class="o">/</span><span class="mi">0</span><span class="n">x60</span>
<span class="p">[</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">926124</span><span class="p">]</span> <span class="n">cpuhp_invoke_callback</span><span class="p">():</span> <span class="mi">136</span>  <span class="n">CPU</span><span class="p">:</span><span class="mi">1</span>  <span class="n">smpboot_unpark_threads</span><span class="o">+</span><span class="mi">0</span><span class="n">x0</span><span class="o">/</span><span class="mi">0</span><span class="n">x90</span>
<span class="p">[</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">926124</span><span class="p">]</span> <span class="n">cpuhp_invoke_callback</span><span class="p">():</span> <span class="mi">136</span>  <span class="n">CPU</span><span class="p">:</span><span class="mi">1</span>  <span class="n">perf_event_init_cpu</span><span class="o">+</span><span class="mi">0</span><span class="n">x0</span><span class="o">/</span><span class="mi">0</span><span class="n">xa0</span>
<span class="p">[</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">927028</span><span class="p">]</span> <span class="n">cpuhp_invoke_callback</span><span class="p">():</span> <span class="mi">136</span>  <span class="n">CPU</span><span class="p">:</span><span class="mi">1</span>  <span class="n">workqueue_online_cpu</span><span class="o">+</span><span class="mi">0</span><span class="n">x0</span><span class="o">/</span><span class="mi">0</span><span class="n">x2a0</span>
<span class="p">[</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">927768</span><span class="p">]</span> <span class="n">cpuhp_invoke_callback</span><span class="p">():</span> <span class="mi">136</span>  <span class="n">CPU</span><span class="p">:</span><span class="mi">1</span>  <span class="n">rcutree_online_cpu</span><span class="o">+</span><span class="mi">0</span><span class="n">x0</span><span class="o">/</span><span class="mi">0</span><span class="n">x70</span>
<span class="p">[</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">928045</span><span class="p">]</span> <span class="n">cpuhp_invoke_callback</span><span class="p">():</span> <span class="mi">136</span>  <span class="n">CPU</span><span class="p">:</span><span class="mi">1</span>  <span class="n">notify_online</span><span class="o">+</span><span class="mi">0</span><span class="n">x0</span><span class="o">/</span><span class="mi">0</span><span class="n">x20</span>
<span class="p">[</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">928256</span><span class="p">]</span> <span class="n">cpuhp_invoke_callback</span><span class="p">():</span> <span class="mi">136</span>  <span class="n">CPU</span><span class="p">:</span><span class="mi">1</span>  <span class="n">page_writeback_cpu_online</span><span class="o">+</span><span class="mi">0</span><span class="n">x0</span><span class="o">/</span><span class="mi">0</span><span class="n">x20</span>
<span class="p">[</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">928527</span><span class="p">]</span> <span class="n">cpuhp_invoke_callback</span><span class="p">():</span> <span class="mi">136</span>  <span class="n">CPU</span><span class="p">:</span><span class="mi">1</span>  <span class="n">sched_cpu_activate</span><span class="o">+</span><span class="mi">0</span><span class="n">x0</span><span class="o">/</span><span class="mi">0</span><span class="n">x190</span>

<span class="p">[</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">929084</span><span class="p">]</span> <span class="n">cpuhp_invoke_callback</span><span class="p">():</span> <span class="mi">136</span>  <span class="n">CPU</span><span class="p">:</span><span class="mi">2</span>  <span class="n">smpboot_create_threads</span><span class="o">+</span><span class="mi">0</span><span class="n">x0</span><span class="o">/</span><span class="mi">0</span><span class="n">x90</span>
<span class="p">[</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">930240</span><span class="p">]</span> <span class="n">cpuhp_invoke_callback</span><span class="p">():</span> <span class="mi">136</span>  <span class="n">CPU</span><span class="p">:</span><span class="mi">2</span>  <span class="n">perf_event_init_cpu</span><span class="o">+</span><span class="mi">0</span><span class="n">x0</span><span class="o">/</span><span class="mi">0</span><span class="n">xa0</span>
<span class="p">[</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">930434</span><span class="p">]</span> <span class="n">cpuhp_invoke_callback</span><span class="p">():</span> <span class="mi">136</span>  <span class="n">CPU</span><span class="p">:</span><span class="mi">2</span>  <span class="n">workqueue_prepare_cpu</span><span class="o">+</span><span class="mi">0</span><span class="n">x0</span><span class="o">/</span><span class="mi">0</span><span class="n">x80</span>
<span class="p">[</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">931070</span><span class="p">]</span> <span class="n">cpuhp_invoke_callback</span><span class="p">():</span> <span class="mi">136</span>  <span class="n">CPU</span><span class="p">:</span><span class="mi">2</span>  <span class="n">hrtimers_prepare_cpu</span><span class="o">+</span><span class="mi">0</span><span class="n">x0</span><span class="o">/</span><span class="mi">0</span><span class="n">x60</span>
<span class="p">[</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">931264</span><span class="p">]</span> <span class="n">cpuhp_invoke_callback</span><span class="p">():</span> <span class="mi">136</span>  <span class="n">CPU</span><span class="p">:</span><span class="mi">2</span>  <span class="n">smpcfd_prepare_cpu</span><span class="o">+</span><span class="mi">0</span><span class="n">x0</span><span class="o">/</span><span class="mi">0</span><span class="n">x80</span>
<span class="p">[</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">931464</span><span class="p">]</span> <span class="n">cpuhp_invoke_callback</span><span class="p">():</span> <span class="mi">136</span>  <span class="n">CPU</span><span class="p">:</span><span class="mi">2</span>  <span class="n">relay_prepare_cpu</span><span class="o">+</span><span class="mi">0</span><span class="n">x0</span><span class="o">/</span><span class="mi">0</span><span class="n">xe0</span>
<span class="p">[</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">931649</span><span class="p">]</span> <span class="n">cpuhp_invoke_callback</span><span class="p">():</span> <span class="mi">136</span>  <span class="n">CPU</span><span class="p">:</span><span class="mi">2</span>  <span class="n">rcutree_prepare_cpu</span><span class="o">+</span><span class="mi">0</span><span class="n">x0</span><span class="o">/</span><span class="mi">0</span><span class="n">x170</span>
<span class="p">[</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">932245</span><span class="p">]</span> <span class="n">cpuhp_invoke_callback</span><span class="p">():</span> <span class="mi">136</span>  <span class="n">CPU</span><span class="p">:</span><span class="mi">2</span>  <span class="n">notify_prepare</span><span class="o">+</span><span class="mi">0</span><span class="n">x0</span><span class="o">/</span><span class="mi">0</span><span class="n">xa0</span>
<span class="p">[</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">932475</span><span class="p">]</span> <span class="n">cpuhp_invoke_callback</span><span class="p">():</span> <span class="mi">136</span>  <span class="n">CPU</span><span class="p">:</span><span class="mi">2</span>  <span class="n">bringup_cpu</span><span class="o">+</span><span class="mi">0</span><span class="n">x0</span><span class="o">/</span><span class="mi">0</span><span class="n">x100</span>
<span class="p">[</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">008000</span><span class="p">]</span> <span class="n">cpuhp_invoke_callback</span><span class="p">():</span> <span class="mi">136</span>  <span class="n">CPU</span><span class="p">:</span><span class="mi">2</span>  <span class="n">sched_cpu_starting</span><span class="o">+</span><span class="mi">0</span><span class="n">x0</span><span class="o">/</span><span class="mi">0</span><span class="n">x60</span>
<span class="p">[</span>    <span class="mi">1</span><span class="p">.</span><span class="mi">005023</span><span class="p">]</span> <span class="n">cpuhp_invoke_callback</span><span class="p">():</span> <span class="mi">136</span>  <span class="n">CPU</span><span class="p">:</span><span class="mi">2</span>  <span class="n">smpboot_unpark_threads</span><span class="o">+</span><span class="mi">0</span><span class="n">x0</span><span class="o">/</span><span class="mi">0</span><span class="n">x90</span>
<span class="p">[</span>    <span class="mi">1</span><span class="p">.</span><span class="mi">005065</span><span class="p">]</span> <span class="n">cpuhp_invoke_callback</span><span class="p">():</span> <span class="mi">136</span>  <span class="n">CPU</span><span class="p">:</span><span class="mi">2</span>  <span class="n">perf_event_init_cpu</span><span class="o">+</span><span class="mi">0</span><span class="n">x0</span><span class="o">/</span><span class="mi">0</span><span class="n">xa0</span>
<span class="p">[</span>    <span class="mi">1</span><span class="p">.</span><span class="mi">005408</span><span class="p">]</span> <span class="n">cpuhp_invoke_callback</span><span class="p">():</span> <span class="mi">136</span>  <span class="n">CPU</span><span class="p">:</span><span class="mi">2</span>  <span class="n">workqueue_online_cpu</span><span class="o">+</span><span class="mi">0</span><span class="n">x0</span><span class="o">/</span><span class="mi">0</span><span class="n">x2a0</span>
<span class="p">[</span>    <span class="mi">1</span><span class="p">.</span><span class="mi">005729</span><span class="p">]</span> <span class="n">cpuhp_invoke_callback</span><span class="p">():</span> <span class="mi">136</span>  <span class="n">CPU</span><span class="p">:</span><span class="mi">2</span>  <span class="n">rcutree_online_cpu</span><span class="o">+</span><span class="mi">0</span><span class="n">x0</span><span class="o">/</span><span class="mi">0</span><span class="n">x70</span>
<span class="p">[</span>    <span class="mi">1</span><span class="p">.</span><span class="mi">006029</span><span class="p">]</span> <span class="n">cpuhp_invoke_callback</span><span class="p">():</span> <span class="mi">136</span>  <span class="n">CPU</span><span class="p">:</span><span class="mi">2</span>  <span class="n">notify_online</span><span class="o">+</span><span class="mi">0</span><span class="n">x0</span><span class="o">/</span><span class="mi">0</span><span class="n">x20</span>
<span class="p">[</span>    <span class="mi">1</span><span class="p">.</span><span class="mi">006206</span><span class="p">]</span> <span class="n">cpuhp_invoke_callback</span><span class="p">():</span> <span class="mi">136</span>  <span class="n">CPU</span><span class="p">:</span><span class="mi">2</span>  <span class="n">page_writeback_cpu_online</span><span class="o">+</span><span class="mi">0</span><span class="n">x0</span><span class="o">/</span><span class="mi">0</span><span class="n">x20</span>
<span class="p">[</span>    <span class="mi">1</span><span class="p">.</span><span class="mi">006549</span><span class="p">]</span> <span class="n">cpuhp_invoke_callback</span><span class="p">():</span> <span class="mi">136</span>  <span class="n">CPU</span><span class="p">:</span><span class="mi">2</span>  <span class="n">sched_cpu_activate</span><span class="o">+</span><span class="mi">0</span><span class="n">x0</span><span class="o">/</span><span class="mi">0</span><span class="n">x190</span>
</pre></div>
</td></tr></table></p>
<p>Interesting! Currently, Lego need to add the <code class="codehilite"><span class="n">smpboot_create_threads</span><span class="p">()</span></code>, <code class="codehilite"><span class="n">workqueue_prepare_cpu</span><span class="p">()</span></code>, <code class="codehilite"><span class="n">workqueue_prepare_cpu</span><span class="p">()</span></code>, <code class="codehilite"><span class="n">bringup_cpu</span><span class="p">()</span></code>, <code class="codehilite"><span class="n">smpboot_unpark_threads</span><span class="p">()</span></code>, <code class="codehilite"><span class="n">workqueue_online_cpu</span><span class="p">()</span></code>.</p>
<p>This hidden things is really hard to find and not easy to track during boot. Especially during boot, they should do something like <code class="codehilite"><span class="n">for_each_online_cpu</span></code> and init one by one. But I guess, after adding support of cpu hotplug, code kind of merged. Some stuff will be executed whenever a cpu has been teardown or bought up. And bang, why not use the same set of hotplug during boot, right?
Well.</p>
<hr />
                
                  
                
              
              
                


  <h2 id="__comments">Comments</h2>
  <div id="disqus_thread"></div>
  <script>
    var disqus_config = function () {
      this.page.url = "http://lastweek.io/lego/log/log-02-2018/";
      this.page.identifier =
        "/lego/log/log-02-2018/";
    };
    (function() {
      var d = document, s = d.createElement("script");
      s.src = "//lastweek-io.disqus.com/embed.js";
      s.setAttribute("data-timestamp", +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>

              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
  <div class="md-footer-social">
    <link rel="stylesheet" href="../../../assets/fonts/font-awesome.css">
    
      <a href="https://github.com/lastweek" class="md-footer-social__link fa fa-github"></a>
    
      <a href="https://twitter.com/Yizhou_Shan" class="md-footer-social__link fa fa-twitter"></a>
    
      <a href="https://www.linkedin.com/in/lastweek/" class="md-footer-social__link fa fa-linkedin"></a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../../assets/javascripts/application.ac79c3b0.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../../.."}})</script>
      
    
  </body>
</html>