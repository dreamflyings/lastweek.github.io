<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <meta name="author" content="Yizhou Shan">
  <link rel="shortcut icon" href="../../../img/favicon.ico">
  <title>Infiniband - Yizhou Shan's Home Page</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>
  <link href='https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../../../css/highlight.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Infiniband";
    var mkdocs_page_input_path = "lego/driver/ib.md";
    var mkdocs_page_url = "/lego/driver/ib/";
  </script>
  
  <script src="../../../js/jquery-2.1.1.min.js"></script>
  <script src="../../../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../../../js/highlight.pack.js"></script> 
  
  <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-143772066-1', 'auto');
      ga('send', 'pageview');
  </script>
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../../.." class="icon icon-home"> Yizhou Shan's Home Page</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	  
          
		  
  <ul class="" href="../../..">
    <li class="toctree-l1">
  <a class="" href="../../..">Home</a>
  </li></ul>
          
		  
  <p class="caption">Notes</p>
  <ul class="">
          <li class="toctree-l1">
            
  <a class="" href="../../../notes/paper_fpga/">FPGA Papers</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="../../../notes/cache_coherence/">Cache Coherence</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="../../../notes/benchmark/">Benchmarks</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="../../../notes/paper_perf_shadows/">Perf Shadows</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="../../../notes/linux-articles/">Linux Articles</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="../../../notes/proc/">[Linux] Special Files</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="../../../notes/rmap/">[Linux] Reverse Mmap (rmap)</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="../../../notes/trace/">[Linux] Trace/Profile</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="../../../notes/cgroup-swap/">[Linux] Cgroup and Swap</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="../../../notes/userfaultfd/">[Linux] Userfaultfd</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="../../../notes/xperf/">[Linux] User/kern Cross Perf</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="../../../notes/kvm-basic/">[Linux] KVM</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="../../../misc/essential/">Essential</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="../../../misc/cheatsheet/">Cheatsheet</a>
        </li>
  </ul>

          
		  
  <p class="caption">FPGA</p>
  <ul class="">
          <li class="toctree-l1">
            
  <a class="" href="../../../fpga/vivado/">Vivado Practice</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="../../../fpga/bitstream/">Bitstream Explained</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="../../../fpga/hls_axi/">HLS: Usage of AXI-Stream</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="../../../fpga/hls_axi/">HLS: High-performance AXI-MM</a>
        </li>
  </ul>

          
		  
  <p class="caption">LegoOS-Dev</p>
  <ul class="current">
          <li class="toctree-l1">
            
  <a class="" href="/lego/log/TODO">Log</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="/lego/kernel/kconfig">Kernel</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="/lego/syscall/facts">Syscall</a>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="/lego/pcache/config">Pcache</a>
        </li>
          <li class="toctree-l1 current">
            
  <a class="current" href="/lego/driver/pci">Driver</a>
  <ul class="subnav">
        <li class="toctree-l2 1">
            
  <a class="" href="../pci/">PCI</a>
        </li>
        <li class="toctree-l2 current 1">
            
  <a class="current" href="./">Infiniband</a>
  <ul class="subnav">
      
  <li class="toctree-l2 current">
  
    <a class="current"  href="#infiniband-subsystem">Infiniband Subsystem</a>
  
  
    <ul class="">
    
        <li class="toctree-l3 toc-item" >
          <a class="toctree-l3" href="#current-status">Current Status</a>
        </li>
    
        <li class="toctree-l3 toc-item" >
          <a class="toctree-l3" href="#random-summary">Random summary</a>
        </li>
    
        <li class="toctree-l3 toc-item" >
          <a class="toctree-l3" href="#init-sequence">Init Sequence</a>
        </li>
    
    </ul>
  
  </li>

  </ul>
        </li>
  </ul>
        </li>
          <li class="toctree-l1">
            
  <a class="" href="/lego/paper/nmp">Paper</a>
        </li>
  </ul>

          
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../..">Yizhou Shan's Home Page</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../..">Docs</a> &raquo;</li>
    
      
        
          <li>LegoOS-Dev &raquo;</li>
        
      
        
          <li>Driver &raquo;</li>
        
      
    
    <li>Infiniband</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="infiniband-subsystem">Infiniband Subsystem<a class="headerlink" href="#infiniband-subsystem" title="Permanent link">&para;</a></h1>
<h2 id="current-status">Current Status<a class="headerlink" href="#current-status" title="Permanent link">&para;</a></h2>
<p>Lego&rsquo;s IB stack is ported based on <code class="codehilite">linux-3.11.1</code>. We ported:</p>
<ul>
<li><code class="codehilite">ib_core</code></li>
<li><code class="codehilite">mlx4_ib</code></li>
<li><code class="codehilite">mlx4_core</code></li>
</ul>
<p>Lego does not support uverbs. At the time of writing, Lego IB stack has only been tested on <code class="codehilite">Mellanox Technologies MT27500 Family [ConnectX-3]</code>.</p>
<h2 id="random-summary">Random summary<a class="headerlink" href="#random-summary" title="Permanent link">&para;</a></h2>
<p>The stack is SUPER complex, a lot data structures and pointers fly all over. Good thing is the whole stack is layered clearly.</p>
<p>Top down</p>
<h3 id="ib_core"><code class="codehilite">ib_core</code><a class="headerlink" href="#ib_core" title="Permanent link">&para;</a></h3>
<ul>
<li>IB core code is in <code class="codehilite">driver/infiniband/core</code>, which exposes the major IB API to both user and kernel applications. Inside, it has two parts. The first part is function callback, that call back to underlying device-specific functions. The second part is the management stack, including communication manager (cm), management datagram (mad), and so on.</li>
<li>In IB, each port&rsquo;s QP0 and QP1 are reserved for management purpose. They will receive/send MAD from/to subnet manager, who typically runs on switch. All the IB management stuff is carried out by exchanging MAD.</li>
<li>There are several key data structures: ib_client, ib_device, and mad_agent. MAD, CM, and some others are ib_client, which means they use IB device, and will be called back whenever a device has been added. mad_agent is something that will be called back whenever a device received a MAD message from switch (see <code class="codehilite">ib_mad_completion_handler()</code>). A lot layers, huh?</li>
<li><code class="codehilite">ib_mad_completion_handler()</code>: we changed the behavior of it. we use busy polling instead of interrupt. Originally, it will be invoked by mlx4_core/eq.c</li>
</ul>
<h3 id="mlx4_ib-and-mlx4_core"><code class="codehilite">mlx4_ib and mlx4_core</code><a class="headerlink" href="#mlx4_ib-and-mlx4_core" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p>mlx4_core is actually the Ethernet driver for Mellanox NIC device (drivers/net/ethernet/mellanox/hw/mlx4), which do the actual dirty work of talking with device. On the other hand, mlx4_ib is the glue code between ib_core and mlx4_core, who do the translation.</p>
</li>
<li>
<p>A lot IB verbs are ultimately translated into <code class="codehilite">fw.c __mlx4_cmd()</code>, which actually send commands to device and get the result. There are two ways of getting result: 1) polling: after writing to device memory the command, the same thread keep polling. 2) sleep and wait for interrupt. By default, the interrupt way is used (obviously). But, at the time of writing (Aug 20, 2018), we don&rsquo;t really have a working IRQ subsystem, so we use polling instead. <strong>I&rsquo;m still a little concerned that without interrupt handler, we might lose some events and the NIC may behavave incorrectly if interrupts are not handled.</strong></p>
</li>
</ul>
<h2 id="init-sequence">Init Sequence<a class="headerlink" href="#init-sequence" title="Permanent link">&para;</a></h2>
<ol>
<li>Init PCI subsystem, build data structures</li>
<li>Core IB layer register <code class="codehilite">ib_client</code></li>
<li><code class="codehilite">mlx4_init()</code>: register PCI driver, provide a callback</li>
<li><code class="codehilite">__mlx4_init_one()</code>: initialize the hardware itself, register interrupt handler.</li>
<li><code class="codehilite">mlx4_ib_init()</code>: allocate a ib_device, and register, which will callback through all <code class="codehilite">ib_client</code> registered at step 1.</li>
</ol>
<p>&ndash;<br />
Yizhou Shan<br />
Created: Aug 20, 2018<br />
Last Updated: Aug 20, 2018</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../../paper/nmp/" class="btn btn-neutral float-right" title="NMP">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../pci/" class="btn btn-neutral" title="PCI"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../pci/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../../paper/nmp/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '../../..';</script>
    <script src="../../../js/theme.js"></script>
      <script src="../../../search/require.js"></script>
      <script src="../../../search/search.js"></script>

</body>
</html>
